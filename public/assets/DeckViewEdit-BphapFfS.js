const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-DtPQpl4u.js","assets/index-BNVg0lRc.js","assets/router-CYt2ycax.js","assets/vendor-Csw2ODfV.js","assets/index-6Wl1lZyG.css"])))=>i.map(i=>d[i]);
import{g as ho,P as Gt,a as Zn,s as In,j as s,y as P,f as Bn,O as fr,d as No,C as ur,_ as mr,i as pr}from"./index-BNVg0lRc.js";import{r as A,R as so,c as gr,a as yr}from"./router-CYt2ycax.js";import{E as hr}from"./jspdf.es.min-DtPQpl4u.js";import"./html2canvas.esm-CBrSDip1.js";import"./vendor-Csw2ODfV.js";const cn={Forest:"d232fcc2-12f6-401a-b1aa-ddff11cb9378",Island:"23635e40-d040-40b7-8b98-90ed362aa028",Mountain:"1edc5050-69bd-416d-b04c-7f82de2a1901",Plains:"4ef17ed4-a9b5-4b8e-b4cb-2ecb7e5898c3",Swamp:"13505c15-14e0-4200-82bd-fb9bce949e68",Wastes:"60682c00-c661-4a9d-8326-f3f014a04e3e","Snow-Covered Forest":"838c915d-8153-43c2-b513-dfbe4e9388a5","Snow-Covered Island":"6abf0692-07d1-4b72-af06-93d0e338589d","Snow-Covered Mountain":"0dc9a6d1-a1ca-4b8f-894d-71c2a9933f79","Snow-Covered Plains":"b1e3a010-dae3-41b6-8dd8-e31d14c3ac4a","Snow-Covered Swamp":"c4dacaf1-09b8-42bb-8064-990190fdaf81","Snow-Covered Wastes":"ad21a874-525e-4d11-bd8e-bc44918bec40","Basic Forest":"d232fcc2-12f6-401a-b1aa-ddff11cb9378","Basic Island":"ff0ba1cf-1b05-403e-8b5e-4bbe3cfa8a89","Basic Mountain":"b34bb2dc-c1af-4d77-b0b3-a0fb342a5fc6","Basic Plains":"8e592a1e-b5e1-497a-863d-9772d25d3b3f","Basic Swamp":"6b28e7a6-e0ed-4c45-85dd-7c1bbfe6b3e5"},_o="basic-land-printing-preferences",Ln=p=>{try{return JSON.parse(localStorage.getItem(_o)||"{}")[p]||cn[p]}catch(T){return console.warn("[BASIC LAND PREFS] Error reading preferences:",T),cn[p]}},_r=(p,T)=>{try{const m=JSON.parse(localStorage.getItem(_o)||"{}");m[p]=T,localStorage.setItem(_o,JSON.stringify(m)),console.log(`üèûÔ∏è [USER PREFS] Updated ${p} preferred printing to: ${T}`)}catch(m){console.error("[BASIC LAND PREFS] Error saving preferences:",m)}},xr=({isOpen:p,onClose:T,card:m,onUpdateCard:L,onRemoveCard:z,onMoveToSideboard:q,onMoveToTechIdeas:se,onAddToCollection:de,updatingPrinting:pe,cardPrice:fe,onPreviewUpdate:Q,onOracleTagSearch:ye,onNavigateToPrevious:he,onNavigateToNext:$e})=>{var nt,Dt,Wn,Jt,Yt,Pt;const Ke=A.useRef(null),Qe=A.useRef(null),[K,M]=A.useState([]),[H,ne]=A.useState([]),[n,Pe]=A.useState(20),[le,it]=A.useState(!1),[V,Re]=A.useState(null),[Ne,F]=A.useState(1),[Y,_e]=A.useState(!1),[be,Ve]=A.useState(!1),[oe,Le]=A.useState(!1),[lt,Be]=A.useState(!1),[St,en]=A.useState(0),[tn,Sn]=A.useState(0),[hn,$t]=A.useState(""),[_t,Fe]=A.useState(!1),dn="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==",[xt,nn]=A.useState(null),Ht=A.useCallback(()=>{if(!V)return null;const w={...V,scryfall_json:V,foil:Y};return ho(w,{preferStoredPrice:!1,fallbackPrice:null,debugLogging:!1}).price},[V,Y]),ut=A.useCallback(()=>{const w=Ht();return m&&w!==null?w:m&&m.modalPrice?m.modalPrice:w},[Ht,m]);A.useEffect(()=>{if(p){const w=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${w}px`,document.body.style.width="100%",()=>{document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,w)}}},[p]),A.useEffect(()=>{if(!p)return;const w=X=>{if(!(!he||!$e))switch(X.key){case"ArrowLeft":X.preventDefault(),X.stopPropagation(),he();break;case"ArrowRight":X.preventDefault(),X.stopPropagation(),$e();break}};return document.addEventListener("keydown",w,!0),()=>{document.removeEventListener("keydown",w,!0)}},[p,he,$e]);const jt=A.useCallback((w,X,J)=>w?ho({scryfall_json:w,foil:X,name:J},{preferStoredPrice:!1,fallbackPrice:null,debugLogging:!1}).price:null,[]),qt=A.useCallback(async w=>{var Ce,ce,We,we,ae,He,ot,Ue,Oe,rt,Nt,Je,ct,Te,Tt,It,Ye,mt,Ct,tt,Mt;if(!w)return;const X=((ce=(Ce=w.cardObj)==null?void 0:Ce.card)==null?void 0:ce.scryfall_json)||((We=w.cardObj)==null?void 0:We.scryfall_json)||w.scryfall_json||{};let J=null;if((ae=(we=w.cardObj)==null?void 0:we.card)!=null&&ae.name?J=w.cardObj.card.name:(He=w.cardObj)!=null&&He.name?J=w.cardObj.name:w.name?J=w.name:X.name&&(J=X.name),!J){console.error("[CardActionsModal] Failed to extract card name for printing search"),alert("Could not find card name information. Please try a different card or refresh the page.");return}const Z=Gt.get(J);if(console.log(`üèûÔ∏è [FETCH PRINTINGS] Cache check for ${J}: ${Z?`found ${((ot=Z.printings)==null?void 0:ot.length)||0} printings`:"no cache found"}`),Z){let pt=!1;(!Z.printings||Z.printings.length<=1)&&(pt=!0,`${((Ue=Z.printings)==null?void 0:Ue.length)||0}`);const Lt=Z.timestamp?Date.now()-Z.timestamp:1/0,dt=60*60*1e3;if(Lt>dt&&(pt=!0),Z.printings&&(!Array.isArray(Z.printings)||Z.printings.some(st=>!st||!st.id))&&(pt=!0),Z.printings&&Z.printings.length>0&&(Z.printings.every(ft=>ft&&ft.id&&ft.set&&ft.collector_number&&(ft.image_uris||ft.card_faces))||(pt=!0)),pt)Gt.remove(J);else{const st=Zn.get(J);let ft=Z.selectedPrinting,Ot=!0;if(cn[J]){const at=Ln(J);if(console.log(`üèûÔ∏è [MODAL CACHE] Checking basic land preference for ${J}: ${at}`),console.log(`üèûÔ∏è [MODAL CACHE] Available cached printings: ${Z.printings.length} cards`),console.log("üèûÔ∏è [MODAL CACHE] First 3 cached IDs:",Z.printings.slice(0,3).map(Me=>Me.id)),at){const Me=Z.printings.find(At=>At.id===at);Me?(ft=Me,console.log(`üèûÔ∏è [MODAL CACHE] ‚úÖ Found basic land preference in cache for ${J}: ${at}`)):(console.log(`üèûÔ∏è [MODAL CACHE] ‚ùå Basic land preference ${at} not in cache, forcing fresh fetch`),Gt.remove(J),Ot=!1)}}else if(st&&st.id&&Z.selectedPrinting.id!==st.id){const at=Z.printings.find(Me=>Me.id===st.id);at?ft=at:(console.log(`[CardActionsModal] ‚ùå User preference ${st.id} not found in cached printings, forcing fresh fetch`),Gt.remove(J),Ot=!1)}if(Ot){const at=Math.min(Z.printings.length,20);if(M(Z.printings.slice(0,at)),ne(Z.printings),Pe(at),Re(ft),nn(J),Q&&m&&ft){const Me={...m,printing:ft.id,scryfall_json:ft,image_uris:ft.image_uris,foil:Y};Q(Me)}if(L&&ft){const Me=jt(ft,Y,J);L(w,{scryfall_json:ft,printing:ft.id,modalPrice:Me,freshPriceDataOnly:!0})}Z.printings&&Z.printings.length<=20&&(console.log(`[CardActionsModal] üîÑ Background fetching full printing list for ${J} (cached: ${Z.printings.length})`),setTimeout(()=>{Ut(J,w)},100));return}}}it(!0);try{cn[J]&&console.log(`[CardActionsModal] ‚ö° Basic land detected: ${J}, but will fetch all printings for selection`);const Lt=`https://constant-lists-api.onrender.com/api/cards/printings?name=${encodeURIComponent(J)}`,dt=await fetch(Lt);if(!dt.ok)throw dt.status===404?new Error(`Card "${J}" not found on Scryfall`):new Error(`Scryfall API error: ${dt.status} ${dt.statusText}`);const st=await dt.json();if(!Array.isArray(st.data)||st.data.length===0)throw new Error("No printings found for this card.");const ft=st.data,Ot=st.data.slice(0,20);ne(ft),M(Ot),Pe(Ot.length);const at=Zn.get(J);let Me=null,At="";if(cn[J]){const Et=Ln(J);Et&&(Me=Et,At=`basic land preference: FDN #275 (${Et})`,console.log(`üèûÔ∏è [MODAL] Using basic land preference for ${J}: ${Et}`))}else at&&at.id?(Me=at.id,At=`user preference: ${(Oe=at.set)==null?void 0:Oe.toUpperCase()} #${at.collector_number}`,console.log(`[CardActionsModal] üéØ Using user preference: ${(rt=at.set)==null?void 0:rt.toUpperCase()} #${at.collector_number} (${at.id})`)):((ct=(Je=(Nt=w.cardObj)==null?void 0:Nt.card)==null?void 0:Je.scryfall_json)!=null&&ct.id?(Me=w.cardObj.card.scryfall_json.id,At="inherited from deck list (cardObj.cardObj.card.scryfall_json)"):w.printing?(Me=w.printing,At="inherited from deck list (cardObj.printing)"):(Te=w.cardObj)!=null&&Te.printing?(Me=w.cardObj.printing,At="inherited from deck list (cardObj.cardObj.printing)"):(It=(Tt=w.cardObj)==null?void 0:Tt.card)!=null&&It.printing?(Me=w.cardObj.card.printing,At="inherited from deck list (cardObj.cardObj.card.printing)"):(mt=(Ye=w.card)==null?void 0:Ye.scryfall_json)!=null&&mt.id?(Me=w.card.scryfall_json.id,At="inherited from deck list (cardObj.card.scryfall_json)"):(tt=(Ct=w.cardObj)==null?void 0:Ct.scryfall_json)!=null&&tt.id?(Me=w.cardObj.scryfall_json.id,At="inherited from deck list (cardObj.cardObj.scryfall_json)"):(Mt=w.scryfall_json)!=null&&Mt.id?(Me=w.scryfall_json.id,At="inherited from deck list (cardObj.scryfall_json)"):w.scryfall_id?(Me=w.scryfall_id,At="inherited from deck list (cardObj.scryfall_id)"):w.id&&(Me=w.id,At="inherited from deck list (cardObj.id)"),Me||(At="fallback to first available printing (no deck list printing found)",console.log("[CardActionsModal] ‚ö†Ô∏è No deck list printing found - will use first available printing")));const En=Me?Ot.find(Et=>Et.id===Me)||ft.find(Et=>Et.id===Me):null,Bt=En||Ot[0];if(Re(Bt),nn(J),!at&&En&&Zn.set(J,Bt),Gt.set(J,ft,Bt),Q&&m&&Bt){const Et={...m,printing:Bt.id,scryfall_json:Bt,image_uris:Bt.image_uris,foil:Y};Q(Et)}const zt=En||Ot[0];if(zt&&L){const Et=jt(zt,m.foil===!0,J);L(w,{scryfall_json:zt,printing:zt.id,modalPrice:Et,freshPriceDataOnly:!0})}}catch(pt){M([]),ne([]),Re(null),console.error("Failed to fetch card printings:",pt),pt.name==="AbortError"?alert("Request timed out. The Scryfall API may be slow. Please try again."):pt.message.includes("not found on Scryfall")?alert("Card not found on Scryfall. The card name might be incorrect or it might be a custom card."):pt.message.includes("Scryfall API error")?alert(`Scryfall API error: ${pt.message}. Please try again later.`):alert("Failed to fetch printings for this card. Please check your connection or try a different card.")}finally{it(!1)}},[L,Q,m,Y]),Ut=A.useCallback(async(w,X)=>{try{console.log(`[CardActionsModal] üîÑ Background fetch starting for ${w}`);const Z=`https://constant-lists-api.onrender.com/api/cards/printings?name=${encodeURIComponent(w)}`,Ce=await fetch(Z);if(!Ce.ok)throw new Error(`API error: ${Ce.status}`);const ce=await Ce.json();if(!Array.isArray(ce.data)||ce.data.length===0)throw new Error("No printings found");const We=ce.data,we=V;if(Gt.set(w,We,we),xt===w){ne(We);const ae=Math.min(K.length,20);M(We.slice(0,ae)),console.log(`[CardActionsModal] ‚úÖ Background update: ${w} now has ${We.length} total printings available (showing ${ae})`)}}catch(J){console.warn(`[CardActionsModal] Background fetch failed for ${w}:`,J.message)}},[V,xt]);A.useEffect(()=>{var w,X,J,Z,Ce,ce,We,we,ae,He,ot,Ue,Oe,rt,Nt,Je,ct,Te,Tt,It;if(p&&m){const Ye=m.name||((w=m.cardObj)==null?void 0:w.name)||((J=(X=m.cardObj)==null?void 0:X.card)==null?void 0:J.name);if(cn[Ye]){const tt=Ln(Ye),Mt=Gt.get(Ye);Mt&&Mt.printings?Mt.printings.some(Lt=>Lt.id===tt)?console.log(`üèûÔ∏è [MODAL INIT] Cache has preferred printing ${tt} for ${Ye}`):(console.log(`üèûÔ∏è [MODAL INIT] Cache missing preferred printing ${tt} for ${Ye}, clearing cache`),Gt.remove(Ye)):console.log(`üèûÔ∏è [MODAL INIT] No cache found for basic land: ${Ye}`)}const mt=Gt.get(Ye);if(mt&&(Ye!==xt||K.length===0||!V)){let tt=null,Mt=mt.selectedPrinting;if((ce=(Ce=(Z=m.cardObj)==null?void 0:Z.card)==null?void 0:Ce.scryfall_json)!=null&&ce.id?tt=m.cardObj.card.scryfall_json.id:m.printing?tt=m.printing:(We=m.cardObj)!=null&&We.printing&&(tt=m.cardObj.printing),cn[Ye]){const dt=Ln(Ye);dt&&(console.log(`üèûÔ∏è [MODAL SYNC] Overriding deck list printing for ${Ye}: ${tt} ‚Üí ${dt}`),tt=dt)}else(we=m.scryfall_json)!=null&&we.id?tt=m.scryfall_json.id:m.scryfall_id?tt=m.scryfall_id:m.id&&(tt=m.id);if(tt){const dt=mt.printings.find(st=>st.id===tt);dt?(Mt=dt,mt.selectedPrinting.id!==tt&&(console.log("[CardActionsModal] üìã Deck list shows different printing than cache - updating cache for consistency"),Gt.set(Ye,mt.printings,dt))):console.log(`[CardActionsModal] ‚ö†Ô∏è Deck list printing ${tt} not found in cache - using cached selection`)}else console.log("[CardActionsModal] ‚ÑπÔ∏è No deck list printing found - using cached selection");const pt=Math.min(mt.printings.length,20);if(M(mt.printings.slice(0,pt)),ne(mt.printings),Pe(pt),Re(Mt),nn(Ye),Q&&Mt){const dt={...m,printing:Mt.id,scryfall_json:Mt,image_uris:Mt.image_uris,foil:Y};Q(dt)}if(L&&mt.selectedPrinting){const dt=jt(mt.selectedPrinting,Y,Ye);L(m,{scryfall_json:mt.selectedPrinting,printing:mt.selectedPrinting.id,modalPrice:dt,freshPriceDataOnly:!0})}const Lt=m.count||m.quantity||((ae=m.cardObj)==null?void 0:ae.count)||((He=m.cardObj)==null?void 0:He.quantity)||((Ue=(ot=m.cardObj)==null?void 0:ot.card)==null?void 0:Ue.count)||((rt=(Oe=m.cardObj)==null?void 0:Oe.card)==null?void 0:rt.quantity)||1;F(typeof Lt=="number"&&!isNaN(Lt)?Lt:1);return}(Ye!==xt||K.length===0||!V)&&(Pe(20),qt(m));const Ct=m.count||m.quantity||((Nt=m.cardObj)==null?void 0:Nt.count)||((Je=m.cardObj)==null?void 0:Je.quantity)||((Te=(ct=m.cardObj)==null?void 0:ct.card)==null?void 0:Te.count)||((It=(Tt=m.cardObj)==null?void 0:Tt.card)==null?void 0:It.quantity)||1;F(typeof Ct=="number"&&!isNaN(Ct)?Ct:1)}},[p,m==null?void 0:m.name,m==null?void 0:m._id]),A.useEffect(()=>{var w,X,J,Z,Ce,ce,We,we,ae;if(!lt&&m){const He=((X=(w=m.cardObj)==null?void 0:w.card)==null?void 0:X.scryfall_json)||((J=m.cardObj)==null?void 0:J.scryfall_json)||m.scryfall_json||{};if(!He.name&&!He.finishes)return;const ot=Array.isArray(He.finishes)?He.finishes:[];let Ue=ot.includes("nonfoil"),Oe=ot.includes("foil")||ot.includes("etched");if(ot.length===0&&He.set){const Te=He.set.toLowerCase(),Tt=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(Te),It=["msc","cmb1","cmb2","plist"].includes(Te),Ye=["ocm1","pcm1","p30h","p30a","p30m"].includes(Te);Tt||It?(Ue=!0,Oe=!1):Ye?(Ue=!1,Oe=!0):(Ue=!0,Oe=!0)}const rt=Oe&&!Ue,Nt=Ue&&!Oe;let Je=!1;Je=[m.foil,m.isFoil,(Z=m.cardObj)==null?void 0:Z.foil,(Ce=m.cardObj)==null?void 0:Ce.isFoil,(We=(ce=m.cardObj)==null?void 0:ce.card)==null?void 0:We.foil,(ae=(we=m.cardObj)==null?void 0:we.card)==null?void 0:ae.isFoil].some(Te=>Te===!0),Je||(rt?Je=!0:Nt?Je=!1:Oe&&!Ue&&(Je=!0)),Ve(rt),Le(Nt),_e(Je),He.set}},[m==null?void 0:m.foil,m==null?void 0:m.isFoil,(nt=m==null?void 0:m.cardObj)==null?void 0:nt.foil,(Wn=(Dt=m==null?void 0:m.cardObj)==null?void 0:Dt.card)==null?void 0:Wn.foil,(Jt=m==null?void 0:m.cardObj)==null?void 0:Jt.isFoil,(Pt=(Yt=m==null?void 0:m.cardObj)==null?void 0:Yt.card)==null?void 0:Pt.isFoil,m==null?void 0:m._id,p]),A.useEffect(()=>{if(!lt&&V&&V.finishes&&Array.isArray(V.finishes)){const w=V.finishes,X=w.includes("nonfoil"),J=w.includes("foil")||w.includes("etched"),Z=J&&!X,Ce=X&&!J;(Z!==be||Ce!==oe)&&(Ve(Z),Le(Ce),Z&&!Y?_e(!0):Ce&&Y&&_e(!1))}},[V==null?void 0:V.id,lt,be,oe]),A.useEffect(()=>{if(V&&L&&m){const w=ut();w!=null&&L(m,{modalPrice:w,printing:V.id,foil:Y,freshPriceDataOnly:!0,scryfall_json:V})}},[V,Y,m==null?void 0:m.name]);const on=A.useCallback(w=>{try{const X=In.getChunkedItem("cardCollection")||[],J=X.filter(we=>we.printing_id===w.id&&we.foil===!0).reduce((we,ae)=>we+ae.quantity,0),Z=X.filter(we=>we.printing_id===w.id&&we.foil===!1).reduce((we,ae)=>we+ae.quantity,0);if(J+Z>0){const we=[];return Z>0&&we.push(`${Z} Regular`),J>0&&we.push(`${J} Foil`),{status:"exact-match",text:we.join(", ")}}const ce=w.name,We=w.oracle_id;if(ce&&We){const we=X.filter(ae=>(ae.oracle_id===We||ae.card_name===ce)&&ae.printing_id!==w.id);if(we.length>0){const ae=we.filter(Ue=>Ue.foil===!0).reduce((Ue,Oe)=>Ue+Oe.quantity,0),He=we.filter(Ue=>Ue.foil===!1).reduce((Ue,Oe)=>Ue+Oe.quantity,0),ot=[];return He>0&&ot.push(`${He} Regular`),ae>0&&ot.push(`${ae} Foil`),{status:"different-version",text:`${ot.join(", ")} (Other Printing)`}}}return{status:"not-owned",text:"Not Owned"}}catch(X){return console.error("Error checking collection status:",X),{status:"unknown",text:"Unknown"}}},[St]),jn=()=>{const w=Math.min(n+20,H.length);Pe(w),M(H.slice(0,w))},rn=(w,X)=>{var J;try{de(w,X),setTimeout(()=>{en(Z=>Z+1),console.log(`[CardActionsModal] Collection status refreshed after adding: ${X.name}`)},100),P.success("Added to collection!",{position:"top-center",autoClose:2e3,hideProgressBar:!0,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),console.log(`[CardActionsModal] Added to collection: ${X.name} (${(J=X.set)==null?void 0:J.toUpperCase()} #${X.collector_number})`)}catch(Z){console.error("[CardActionsModal] Error adding to collection:",Z),P.error("Failed to add to collection. Please try again.")}};if(!p||!m)return null;const Xt=w=>{var Z,Ce,ce,We,we;if(V&&V.id===w.id)return;const X=(m==null?void 0:m.name)||((Z=m==null?void 0:m.card)==null?void 0:Z.name);if(X&&cn[X]){const ae=Ln(X);ae!==w.id&&(_r(X,w.id),console.log(`üèûÔ∏è [MODAL] User changed preferred printing for ${X}: ${ae} -> ${w.id}`))}if(Re(w),Qe.current&&(Qe.current.scrollTop=0),L&&m){const ae=ut(w,Y);console.log(`[PRINTING SELECTION] Immediate sync: ${m.name} -> $${ae} (${w.set}/${w.collector_number}, foil: ${Y})`),L(m,{modalPrice:ae,printing:w.id,foil:Y,freshPriceDataOnly:!0,scryfall_json:w})}if(Q&&m){const ae={...m,printing:w.id,scryfall_json:w,image_uris:w.image_uris,foil:Y};console.log("[CardActionsModal] Calling onPreviewUpdate with:",{printingId:w.id,cardName:m.name||w.name,previewUpdateData:ae}),Q(ae)}else console.log("[CardActionsModal] NOT calling onPreviewUpdate:",{hasCallback:!!Q,hasCard:!!m,printingId:w.id});const J={id:w.id,name:w.name,set:w.set,set_name:w.set_name,collector_number:w.collector_number,rarity:w.rarity,released_at:w.released_at,image_uris:w.image_uris,mana_cost:w.mana_cost,type_line:w.type_line,oracle_text:w.oracle_text,power:w.power,toughness:w.toughness,colors:w.colors,color_identity:w.color_identity,prices:w.prices,games:w.games,legalities:w.legalities,finishes:w.finishes||[],foil:w.foil,nonfoil:w.nonfoil,frame_effects:w.frame_effects||[],promo_types:w.promo_types||[],oracle_id:w.oracle_id,card_faces:w.card_faces};try{const ae=w.prices||{},He=w.finishes||[],ot=w.promo_types||[];let Ue;Y?(He.includes("etched")||(Ce=w.frame_effects)!=null&&Ce.includes("etched")?Ue=ae.usd_etched||ae.usd_foil||ae.usd||null:(ot.includes("surgefoil")||ot.includes("rainbow")||ot.includes("textured")||ot.includes("boosterfun"),Ue=ae.usd_foil||ae.usd||null),!Ue&&be&&(Ue=ae.usd_foil||ae.usd_etched||null)):Ue=ae.usd||null;const Oe=w.finishes||[],rt=Oe.includes("nonfoil"),Nt=Oe.includes("foil")||Oe.includes("etched");let Je=rt,ct=Nt;if(Oe.length===0){const Ct=(ce=w.set)==null?void 0:ce.toLowerCase(),tt=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(Ct),Mt=["msc","cmb1","cmb2","plist"].includes(Ct),pt=["ocm1","pcm1","p30h","p30a","p30m"].includes(Ct);tt||Mt?(Je=!0,ct=!1):pt?(Je=!1,ct=!0):(Je=!0,ct=!0)}let Te;!Je&&ct?(Te=!0,console.log(`[CardActionsModal] New printing "${w.set_name}" is foil-only, forcing foil to true`)):Je&&!ct?(Te=!1,console.log(`[CardActionsModal] New printing "${w.set_name}" is non-foil-only, forcing foil to false`)):Je&&ct&&(Te=!1,console.log(`[CardActionsModal] New printing "${w.set_name}" supports both finishes, resetting to non-foil`));let Tt;Te?Oe.includes("etched")||(We=w.frame_effects)!=null&&We.includes("etched")?Tt=ae.usd_etched||ae.usd_foil||ae.usd||null:(ot.includes("surgefoil")||ot.includes("rainbow")||ot.includes("textured")||ot.includes("boosterfun"),Tt=ae.usd_foil||ae.usd||null):Tt=ae.usd||null,L(m,{printing:w.id,scryfall_json:J,price:Tt,modalPrice:Tt,foil:Te,modalFoilStatus:Te,image_uris:w.image_uris||null,card_faces:w.card_faces||null}),Te!==Y&&(console.log(`[CardActionsModal] Updating modal foil state from ${Y} to ${Te} due to printing change`),_e(Te));const It=!Je&&ct,Ye=Je&&!ct;It!==be&&(Ve(It),console.log(`[CardActionsModal] Updated foil-only status to: ${It} for set: ${w.set}`)),Ye!==oe&&(Le(Ye),console.log(`[CardActionsModal] Updated non-foil-only status to: ${Ye} for set: ${w.set}`));const mt=m.name||w.name;if(mt){const Ct={id:w.id,set:w.set,collector_number:w.collector_number,set_name:w.set_name,rarity:w.rarity};Zn.set(mt,Ct),console.log(`[CardActionsModal] üß† Learned preference for "${mt}": ${(we=w.set)==null?void 0:we.toUpperCase()} #${w.collector_number} (${w.set_name})`)}}catch(ae){console.error("[CardActionsModal] Error updating printing:",ae),alert("Error updating card printing. Please try again."),Re(V)}},ze=w=>{if(be||oe)return;const X=!!w.target.checked;_e(X),Be(!0),Sn(Z=>Z+1);const J=X?"Updated to foil":"Updated to non-foil";P.success(J,{position:"top-center",autoClose:1500,hideProgressBar:!0,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),setTimeout(()=>{var Z,Ce,ce;try{const We=V?jt(V,X,m.name):null,we=m.printing||((Z=m.cardObj)==null?void 0:Z.printing)||((ce=(Ce=m.cardObj)==null?void 0:Ce.card)==null?void 0:ce.printing)||(V==null?void 0:V.id),ae={foil:X,isFoil:X,modalPrice:We,printing:we,lastUpdated:Date.now()};L(m,ae)}catch(We){console.error("[CardActionsModal] Error updating foil status:",We),_e(!X),P.error("Failed to update foil status. Please try again.")}finally{setTimeout(()=>Be(!1),100)}},50)},Kt=w=>{const X=w.target.value;$t(X),Fe(!0)},_n=()=>{let w=parseInt(hn,10);if((isNaN(w)||w===0)&&(w=Ne),w>999&&(w=999),w<1){z(m);return}w!==Ne&&(F(w),L(m,{quantity:w}),P.success(`Updated quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0})),Fe(!1),$t("")},fn=()=>{$t(""),Fe(!1)},Qt=w=>{w.key==="Enter"?(w.preventDefault(),w.target.blur()):w.key==="Escape"&&(w.preventDefault(),fn(),w.target.blur())},un=w=>{$t(Ne.toString()),Fe(!0),setTimeout(()=>{w.target.select()},0)},bt=()=>{_t&&_n()},sn=()=>{const w=Math.min(Ne+1,999);w!==Ne&&(F(w),L(m,{quantity:w}),P.success(`Increased quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0}))},Se=()=>{const w=Ne-1;if(w<1){z(m),P.success("Removed card from deck",{position:"top-center",autoClose:1e3,hideProgressBar:!0});return}F(w),L(m,{quantity:w}),P.success(`Decreased quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0})};A.useEffect(()=>{const w=X=>{X.key==="cardCollection"&&en(J=>J+1)};return window.addEventListener("storage",w),()=>window.removeEventListener("storage",w)},[]),A.useEffect(()=>{p&&en(w=>w+1)},[p]),A.useEffect(()=>{const w=()=>{const Ce=document.querySelector(".toggle-switch"),ce=document.querySelector(".toggle-slider");Ce&&(Ce.style.display="inline-block",Ce.style.visibility="visible",Ce.style.opacity=be||oe?"0.6":"1",Ce.style.position="relative",Ce.style.width="50px",Ce.style.height="24px",Ce.style.zIndex="9999"),ce&&(ce.style.display="block",ce.style.visibility="visible",ce.style.opacity="1",ce.style.position="absolute",ce.style.top="0",ce.style.left="0",ce.style.right="0",ce.style.bottom="0")};w();const X=setTimeout(w,100),J=new MutationObserver(()=>{w()}),Z=document.querySelector(".toggle-switch");return Z&&J.observe(Z,{attributes:!0,attributeFilter:["style","class"]}),()=>{clearTimeout(X),J.disconnect()}},[be,oe,Y,V,p]);const Rt=A.useCallback(w=>{console.log(`[CardActionsModal] üîç Oracle tag search requested: ${w}`),ye?(T(),setTimeout(()=>{ye(w)},100)):(console.warn("[CardActionsModal] No onOracleTagSearch function provided"),alert(`Would search for oracle tag: "${w}"

Please implement the onOracleTagSearch prop in your parent component.`))},[ye,T]);return s.jsx("div",{className:"modal-backdrop card-actions-modal",onClick:T,children:s.jsxs("div",{className:"modal-content",onClick:w=>w.stopPropagation(),ref:Ke,children:[s.jsxs("div",{className:"modal-header",children:[he&&s.jsx("button",{onClick:he,className:"nav-arrow nav-arrow-left",title:"Previous card (Left arrow key)",children:"‚Äπ"}),s.jsx("button",{onClick:T,className:"close-button",children:"√ó"}),$e&&s.jsx("button",{onClick:$e,className:"nav-arrow nav-arrow-right",title:"Next card (Right arrow key)",children:"‚Ä∫"})]}),s.jsxs("div",{className:"modal-body",children:[s.jsxs("div",{className:"card-actions",ref:Qe,children:[s.jsxs("div",{className:"action-row foil-selector",children:[s.jsxs("label",{className:"control-label",children:["Foil:",be&&s.jsx("span",{className:"foil-only-indicator",children:" (Foil Only)"}),oe&&s.jsx("span",{className:"non-foil-only-indicator",children:" (Non-Foil Only)"})]}),s.jsxs("label",{className:`toggle-switch ${be||oe?"disabled":""}`,style:{display:"flex",alignItems:"center"},children:[s.jsx("input",{type:"checkbox",checked:Y,onChange:ze,disabled:be||oe,style:{opacity:1,visibility:"visible"}}),s.jsx("span",{className:`toggle-slider ${Y?"foil-active":""} ${be||oe?"disabled":""}`,style:{opacity:1,visibility:"visible"}})]})]}),s.jsxs("div",{className:"action-row quantity-row",children:[s.jsxs("label",{className:"control-label",style:{display:"flex",alignItems:"center"},children:["Quantity:",_t&&s.jsx("span",{style:{fontSize:"10px",color:"#666",marginLeft:"8px",fontStyle:"italic"},children:"Press Enter to save, Esc to cancel"})]}),s.jsxs("div",{className:"quantity-controls",children:[s.jsx("button",{className:"quantity-btn",onClick:Se,disabled:Ne<=1||_t,title:Ne<=1?"Cannot go below 1":"Decrease quantity",children:"‚àí"}),s.jsx("input",{type:"number",value:_t?hn:Ne,onChange:Kt,onFocus:un,onBlur:bt,onKeyDown:Qt,className:`quantity-input ${_t?"editing":""}`,min:"1",max:"999",step:"1",placeholder:"Enter quantity",title:"Click to edit, Enter to save, Esc to cancel"}),s.jsx("button",{className:"quantity-btn",onClick:sn,disabled:Ne>=999||_t,title:Ne>=999?"Maximum quantity reached":"Increase quantity",children:"+"})]}),_t&&s.jsxs("div",{style:{display:"flex",gap:"4px",marginLeft:"8px"},children:[s.jsx("button",{onClick:_n,style:{background:"#22c55e",color:"white",border:"none",borderRadius:"3px",padding:"2px 6px",fontSize:"12px",cursor:"pointer"},title:"Save changes",children:"‚úì"}),s.jsx("button",{onClick:fn,style:{background:"#ef4444",color:"white",border:"none",borderRadius:"3px",padding:"2px 6px",fontSize:"12px",cursor:"pointer"},title:"Cancel changes",children:"‚úï"})]})]}),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button",onClick:()=>{if(onAddCard&&V){const w={name:m.name,printing:V.id,foil:Y,quantity:Ne||1,cardObj:{scryfall_id:V.id,name:V.name,set:V.set,set_name:V.set_name,collector_number:V.collector_number,image_uris:V.image_uris,type_line:V.type_line,mana_cost:V.mana_cost,cmc:V.cmc,colors:V.colors,color_identity:V.color_identity,prices:V.prices},scryfall_json:V};onAddCard(w),P.success(`Added ${w.name} to deck`),T()}else P.error("Unable to add card to deck")},children:"Add to Main Board"}),s.jsx("button",{className:"action-button",onClick:()=>z(m),children:"Remove from Deck"}),s.jsx("button",{className:"action-button",onClick:()=>q(m),children:"Move to Sideboard"}),s.jsx("button",{className:"action-button",onClick:()=>{se?(se(m),T()):console.error("onMoveToTechIdeas function not provided")},children:"Move to Tech Ideas"}),s.jsx("button",{className:"action-button",onClick:()=>rn(m,{...V,foil:Y}),children:"Add to My Collection"}),s.jsx("button",{className:"action-button",onClick:()=>{if(V&&m){const w={name:m.name,printing:V.id,foil:Y,count:1,dateAdded:Date.now(),cardObj:{scryfall_id:V.id,name:V.name,set:V.set,set_name:V.set_name,collector_number:V.collector_number,image_uris:V.image_uris,type_line:V.type_line,mana_cost:V.mana_cost,cmc:V.cmc,colors:V.colors,color_identity:V.color_identity,prices:V.prices},scryfall_json:V},X=JSON.parse(localStorage.getItem("global-wishlist")||"[]"),J=X.findIndex(Z=>Z.name===m.name&&Z.printing===V.id);J!==-1?(X[J].count+=1,P.success(`Updated ${m.name} quantity in wishlist (now ${X[J].count})`)):(X.push(w),P.success(`Added ${m.name} to wishlist`)),localStorage.setItem("global-wishlist",JSON.stringify(X)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:X}))}else P.error("Unable to add card to wishlist")},children:"Add to Wishlist"})]}),s.jsxs("div",{className:"printings-section",children:[s.jsx("h3",{children:"Select Printing"}),s.jsxs("div",{className:"printings-list",children:[le?s.jsxs("div",{className:"loading-printings",children:[s.jsx("p",{children:"Loading printings..."}),s.jsx("div",{className:"spinner"})]}):K.length===0?s.jsx("p",{children:"No printings found for this card."}):(()=>{const w=[];return V&&w.push(V),K.forEach(X=>{(!V||X.id!==V.id)&&w.push(X)}),w.map((X,J)=>{let Z="";X.id&&(Z=`https://api.scryfall.com/cards/${X.id}?format=image&version=normal`),Z||(Z=dn);const Ce=(V==null?void 0:V.id)===X.id;return s.jsxs("div",{className:`printing-item ${Ce?"selected":""}`,title:`${X.name} - ${X.set.toUpperCase()} ${X.collector_number?`(#${X.collector_number})`:""}`,children:[s.jsx("img",{src:Z,alt:`${X.name} - ${X.set.toUpperCase()}`,onClick:()=>Xt(X),loading:"lazy",style:{maxWidth:"100%",maxHeight:"280px",objectFit:"contain",background:"#f8f8f8",transition:"opacity 0.2s"},onLoad:ce=>{ce.target.style.opacity="1"},onError:ce=>{ce.target.src=dn}}),Ce&&s.jsx("div",{className:"current-label",children:"CURRENT"}),s.jsxs("div",{className:"set-info",children:[s.jsxs("div",{className:"set-details-row",style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",marginBottom:"4px",width:"auto"},children:[s.jsx("img",{src:`/svgs/${X.set.toLowerCase()}.svg`,alt:X.set.toUpperCase(),className:"set-symbol",style:{width:"16px",height:"16px",flexShrink:0},onError:ce=>{ce.target.style.display="none"}}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"500"},children:[X.set.toUpperCase()," ",X.collector_number&&`#${X.collector_number}`]})]}),s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",marginTop:"4px",fontSize:"12px",minHeight:"16px",width:"auto",gap:"14px"},children:[s.jsx("span",{style:{color:"#666",fontWeight:"500",fontSize:"12px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"none"},children:(()=>{var We,we;if(V&&X.id===V.id){const ae=Ht();return Bn(ae)}const ce=((We=X.prices)==null?void 0:We.usd)||X.usd||((we=X.prices)==null?void 0:we.usd_foil)||X.usd_foil;return Bn(ce)})()}),s.jsx("span",{style:{fontSize:"18px",whiteSpace:"nowrap"},children:(()=>{const ce=on(X);return(ce==null?void 0:ce.status)==="exact-match"?s.jsx("span",{style:{color:"#22c55e",fontSize:"18px"},title:`Owned: ${ce.text}`,children:"‚óè"}):(ce==null?void 0:ce.status)==="different-version"?s.jsx("span",{style:{color:"#eab308",fontSize:"18px"},title:ce.text,children:"‚óè"}):(ce==null?void 0:ce.status)==="not-owned"?s.jsx("span",{style:{color:"#ef4444",fontSize:"18px"},title:"Not owned",children:"‚óè"}):s.jsx("span",{style:{color:"#6b7280",fontSize:"18px"},title:"Unknown status",children:"‚óè"})})()})]})]}),pe&&(V==null?void 0:V.id)===X.id&&s.jsxs("span",{className:"updating-indicator",children:[s.jsx("span",{className:"spinner-small"})," Updating..."]})]},X.id)})})(),H.length>K.length&&s.jsx("div",{style:{textAlign:"center",padding:"20px"},children:s.jsxs("button",{onClick:jn,style:{background:"#007bff",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",cursor:"pointer",fontSize:"14px"},onMouseEnter:w=>{w.target.style.background="#0056b3"},onMouseLeave:w=>{w.target.style.background="#007bff"},children:["Load More Printings (",H.length-K.length," remaining)"]})})]})]})]}),s.jsx("div",{className:"printings-container",children:V&&s.jsx("div",{className:"current-printing-container",children:s.jsxs("div",{className:"current-printing-info",children:[s.jsx("div",{className:"current-printing-name",children:s.jsx("strong",{children:V.name})}),s.jsxs("div",{className:"printing-price",children:["Price: ",(()=>{const w=ut();return Bn(w)})()]}),V.oracle_text&&s.jsx("div",{className:"oracle-text",children:V.oracle_text.split(`
`).map((w,X)=>s.jsx("p",{children:w},X))}),s.jsx(fr,{card:m,onOracleTagSearch:Rt})]})})})]})]})})},br=({isOpen:p,onClose:T,onImport:m})=>{const[L,z]=A.useState(""),[q,se]=A.useState(!1),de=async()=>{if(!L.trim()){P.warning("Please paste some text to import");return}se(!0);try{await m(L),z(""),T()}catch(Q){console.error("Import error:",Q)}finally{se(!1)}},pe=Q=>{const ye=Q.target.files[0];if(ye&&ye.type==="text/plain"){const he=new FileReader;he.onload=$e=>{z($e.target.result)},he.readAsText(ye)}else P.error("Please select a valid text file (.txt)")},fe=()=>`Sample Deck
Generated on ${new Date().toLocaleDateString()}
Format: TCGPlayer Mass Entry Compatible

MAIN DECK:
=========
4 Lightning Bolt [M11] 123
3 Counterspell [7ED] 54
2 Serra Angel
1 Black Lotus [LEA] 232

SIDEBOARD:
==========
2 Red Elemental Blast [4ED] 215
3 Disenchant [ICE] 110

TECH IDEAS:
===========
1 Ancestral Recall [LEA] 48
1 Time Walk [LEA] 371`;return p?s.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,padding:"20px"},onClick:Q=>{Q.target===Q.currentTarget&&T()},children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"24px",maxWidth:"800px",width:"100%",maxHeight:"90vh",overflow:"auto",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)"},onClick:Q=>Q.stopPropagation(),children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[s.jsx("h2",{style:{margin:0,color:"#333",fontSize:"24px",fontWeight:"600"},children:"Import Deck from Text"}),s.jsx("button",{onClick:T,style:{background:"none",border:"none",fontSize:"24px",cursor:"pointer",color:"#666",padding:"0",width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"6px"},onMouseEnter:Q=>Q.target.style.backgroundColor="#f5f5f5",onMouseLeave:Q=>Q.target.style.backgroundColor="transparent",children:"√ó"})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("p",{style:{color:"#666",margin:"0 0 16px 0",lineHeight:"1.5"},children:"Paste your deck list or upload a text file. Supports the export format from this application and other standard formats. Cards will be automatically searched and added to your deck."}),s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"inline-block",marginBottom:"8px",fontWeight:"500",color:"#333"},children:"Upload Text File:"}),s.jsx("input",{type:"file",accept:".txt",onChange:pe,style:{marginLeft:"12px",padding:"6px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:"#f9f9f9"}})]})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500",color:"#333"},children:"Deck List Text:"}),s.jsx("textarea",{value:L,onChange:Q=>z(Q.target.value),placeholder:fe(),style:{width:"100%",height:"300px",border:"2px solid #ddd",borderRadius:"8px",padding:"12px",fontSize:"14px",fontFamily:'Monaco, Consolas, "Courier New", monospace',resize:"vertical",outline:"none"},onFocus:Q=>Q.target.style.borderColor="#4caf50",onBlur:Q=>Q.target.style.borderColor="#ddd"})]}),s.jsxs("div",{style:{backgroundColor:"#f8f9fa",padding:"16px",borderRadius:"8px",marginBottom:"24px",border:"1px solid #e9ecef"},children:[s.jsx("h4",{style:{margin:"0 0 12px 0",color:"#495057",fontSize:"16px"},children:"Supported Formats:"}),s.jsxs("ul",{style:{margin:0,paddingLeft:"20px",color:"#6c757d",lineHeight:"1.6"},children:[s.jsxs("li",{children:[s.jsx("strong",{children:"Full Format:"})," ",s.jsx("code",{children:"4 Lightning Bolt [M11] 123"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"With Set:"})," ",s.jsx("code",{children:"4 Lightning Bolt [M11]"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Simple:"})," ",s.jsx("code",{children:"4 Lightning Bolt"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Sections:"})," MAIN DECK, SIDEBOARD, TECH IDEAS"]})]})]}),s.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:T,style:{padding:"12px 24px",border:"2px solid #ddd",borderRadius:"8px",backgroundColor:"white",color:"#666",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:Q=>{Q.target.style.borderColor="#999",Q.target.style.color="#333"},onMouseLeave:Q=>{Q.target.style.borderColor="#ddd",Q.target.style.color="#666"},children:"Cancel"}),s.jsx("button",{onClick:de,disabled:q||!L.trim(),style:{padding:"12px 24px",border:"none",borderRadius:"8px",backgroundColor:q||!L.trim()?"#ccc":"#4caf50",color:"white",fontSize:"14px",fontWeight:"500",cursor:q||!L.trim()?"not-allowed":"pointer",transition:"all 0.2s ease"},onMouseEnter:Q=>{!q&&L.trim()&&(Q.target.style.backgroundColor="#45a049")},onMouseLeave:Q=>{!q&&L.trim()&&(Q.target.style.backgroundColor="#4caf50")},children:q?"Importing...":"Import Cards"})]})]})}):null},Cr=({isOpen:p,onClose:T,onImport:m})=>{const[L,z]=A.useState([]),[q,se]=A.useState(!1),[de,pe]=A.useState(0),[fe,Q]=A.useState([]),ye=K=>{const M=Array.from(K.target.files),H=M.filter(ne=>ne.type.startsWith("image/")||ne.type==="application/pdf");H.length!==M.length&&P.warning("Some files were skipped. Only image and PDF files are supported."),z(H),Q([])},he=async()=>{if(L.length===0){P.warning("Please select some files to process");return}se(!0),pe(0);const K=[];try{for(let M=0;M<L.length;M++){const H=L[M];if(pe((M+1)/L.length*100),H.type==="application/pdf"){P.info(`PDF processing not yet implemented: ${H.name}`);continue}const ne=H.name.toLowerCase();let n=null;ne.includes("lightning")&&ne.includes("bolt")?n="Lightning Bolt":ne.includes("counterspell")?n="Counterspell":ne.includes("serra")&&ne.includes("angel")?n="Serra Angel":ne.includes("black")&&ne.includes("lotus")&&(n="Black Lotus"),n?K.push({fileName:H.name,cardName:n,confidence:.7,quantity:1}):K.push({fileName:H.name,cardName:`Unknown Card (${H.name})`,confidence:0,quantity:1,needsManualEntry:!0}),await new Promise(Pe=>setTimeout(Pe,500))}Q(K),P.success(`Processed ${L.length} files. Found ${K.filter(M=>M.confidence>.5).length} cards.`)}catch(M){console.error("Error processing images:",M),P.error("Error processing images")}finally{se(!1),pe(0)}},$e=async()=>{const K=fe.filter(H=>H.confidence>.5&&!H.needsManualEntry);if(K.length===0){P.warning("No valid cards detected to import");return}const M=["MAIN DECK:","=========",...K.map(H=>`${H.quantity} ${H.cardName}`),`
Main Deck Total: ${K.length} cards`].join(`
`);try{await m(M),z([]),Q([]),T()}catch(H){console.error("Import error:",H)}},Ke=(K,M)=>{const H=[...fe];H[K].cardName=M,H[K].needsManualEntry=!1,H[K].confidence=.9,Q(H)},Qe=(K,M)=>{const H=[...fe];H[K].quantity=parseInt(M)||1,Q(H)};return p?s.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,padding:"20px"},onClick:K=>{K.target===K.currentTarget&&T()},children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"24px",maxWidth:"900px",width:"100%",maxHeight:"90vh",overflow:"auto",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)"},onClick:K=>K.stopPropagation(),children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[s.jsx("h2",{style:{margin:0,color:"#333",fontSize:"24px",fontWeight:"600"},children:"Import from Photos/PDF"}),s.jsx("button",{onClick:T,style:{background:"none",border:"none",fontSize:"24px",cursor:"pointer",color:"#666",padding:"0",width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"6px"},onMouseEnter:K=>K.target.style.backgroundColor="#f5f5f5",onMouseLeave:K=>K.target.style.backgroundColor="transparent",children:"√ó"})]}),s.jsxs("div",{style:{marginBottom:"24px"},children:[s.jsxs("div",{style:{backgroundColor:"#fff3cd",border:"1px solid #ffeaa7",borderRadius:"8px",padding:"16px",marginBottom:"20px"},children:[s.jsx("h4",{style:{margin:"0 0 8px 0",color:"#856404"},children:"üöß Beta Feature"}),s.jsx("p",{style:{margin:0,color:"#856404",fontSize:"14px",lineHeight:"1.4"},children:"Photo recognition is currently in beta. For best results, use clear, well-lit photos of individual cards. You can manually edit any misidentified cards before importing."})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"12px",fontWeight:"500",color:"#333",fontSize:"16px"},children:"Select Card Photos or PDFs:"}),s.jsx("input",{type:"file",multiple:!0,accept:"image/*,.pdf",onChange:ye,style:{width:"100%",padding:"12px",border:"2px dashed #ddd",borderRadius:"8px",backgroundColor:"#f9f9f9",cursor:"pointer"}}),L.length>0&&s.jsxs("p",{style:{margin:"8px 0 0 0",color:"#666",fontSize:"14px"},children:["Selected ",L.length," file",L.length!==1?"s":""]})]}),L.length>0&&!q&&fe.length===0&&s.jsx("button",{onClick:he,style:{padding:"12px 24px",backgroundColor:"#ff9800",color:"white",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:"500",cursor:"pointer",marginBottom:"20px"},onMouseEnter:K=>K.target.style.backgroundColor="#f57c00",onMouseLeave:K=>K.target.style.backgroundColor="#ff9800",children:"Process Images"}),q&&s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsxs("div",{style:{marginBottom:"8px",color:"#666"},children:["Processing images... ",Math.round(de),"%"]}),s.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},children:s.jsx("div",{style:{width:`${de}%`,height:"100%",backgroundColor:"#ff9800",transition:"width 0.3s ease"}})})]}),fe.length>0&&s.jsxs("div",{children:[s.jsxs("h3",{style:{marginBottom:"16px",color:"#333"},children:["Detected Cards (",fe.length,"):"]}),s.jsx("div",{style:{maxHeight:"300px",overflow:"auto",border:"1px solid #ddd",borderRadius:"8px"},children:fe.map((K,M)=>s.jsxs("div",{style:{padding:"12px",borderBottom:M<fe.length-1?"1px solid #eee":"none",display:"flex",alignItems:"center",gap:"12px",backgroundColor:K.needsManualEntry?"#fff3cd":"white"},children:[s.jsx("div",{style:{flex:"0 0 120px",fontSize:"12px",color:"#666"},children:K.fileName}),s.jsx("div",{style:{flex:"0 0 60px"},children:s.jsx("input",{type:"number",min:"1",max:"20",value:K.quantity,onChange:H=>Qe(M,H.target.value),style:{width:"50px",padding:"4px",border:"1px solid #ddd",borderRadius:"4px",textAlign:"center"}})}),s.jsx("div",{style:{flex:"1"},children:s.jsx("input",{type:"text",value:K.cardName,onChange:H=>Ke(M,H.target.value),placeholder:"Enter card name",style:{width:"100%",padding:"8px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:K.needsManualEntry?"#fff9e6":"white"}})}),s.jsx("div",{style:{flex:"0 0 80px",fontSize:"12px",textAlign:"center"},children:K.confidence>.5?s.jsx("span",{style:{color:"#4caf50"},children:"‚úì Ready"}):s.jsx("span",{style:{color:"#ff9800"},children:"‚ö† Edit"})})]},M))})]})]}),s.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:T,style:{padding:"12px 24px",border:"2px solid #ddd",borderRadius:"8px",backgroundColor:"white",color:"#666",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:K=>{K.target.style.borderColor="#999",K.target.style.color="#333"},onMouseLeave:K=>{K.target.style.borderColor="#ddd",K.target.style.color="#666"},children:"Cancel"}),fe.length>0&&s.jsxs("button",{onClick:$e,disabled:fe.filter(K=>K.confidence>.5).length===0,style:{padding:"12px 24px",border:"none",borderRadius:"8px",backgroundColor:fe.filter(K=>K.confidence>.5).length===0?"#ccc":"#4caf50",color:"white",fontSize:"14px",fontWeight:"500",cursor:fe.filter(K=>K.confidence>.5).length===0?"not-allowed":"pointer",transition:"all 0.2s ease"},onMouseEnter:K=>{fe.filter(M=>M.confidence>.5).length>0&&(K.target.style.backgroundColor="#45a049")},onMouseLeave:K=>{fe.filter(M=>M.confidence>.5).length>0&&(K.target.style.backgroundColor="#4caf50")},children:["Import ",fe.filter(K=>K.confidence>.5).length," Cards"]})]})]})}):null},po={Island:"Land",Mountain:"Land",Plains:"Land",Swamp:"Land",Forest:"Land",Wastes:"Land","Halimar Depths":"Land","Izzet Boilerworks":"Land","Lonely Sandbar":"Land","Remote Isle":"Land","Temple of Epiphany":"Land","Accumulated Knowledge":"Instant",Brainstorm:"Instant",Dand√¢n:"Creature","Diminishing Returns":"Sorcery",Foil:"Instant","Magical Hack":"Instant","Memory Lapse":"Instant","Mental Note":"Instant","Mind Bend":"Instant",Miscalculation:"Instant","Mystic Retrieval":"Sorcery",Portent:"Sorcery","Ray of Command":"Instant","Supplant Form":"Instant","Telling Time":"Instant","Vision Charm":"Instant"};function Ao(p){if(!p||typeof p!="string")return"Other";const T=["Commander","Creature","Planeswalker","Battle","Sorcery","Instant","Artifact","Kindred","Enchantment","Land","Conspiracy","Dungeon","Emblem","Hero","Phenomenon","Plane","Scheme","Vanguard"];for(const m of T)if(p.includes(m))return m;return p.split("‚Äî")[0].trim().split(" ")[0]||"Other"}const wr=p=>{const T=p.toLowerCase();return T.includes("commander")?"/svgs/cmd.svg":T.includes("creature")?"/svgs/creature.svg":T.includes("planeswalker")?"/svgs/planeswalker.svg":T.includes("instant")?"/svgs/instant.svg":T.includes("sorcery")?"/svgs/sorcery.svg":T.includes("artifact")?"/svgs/artifact.svg":T.includes("enchantment")?"/svgs/enchantment.svg":T.includes("land")?"/svgs/land.svg":null};function go({type:p,count:T,onClick:m,isClickable:L=!1}){const z=wr(p);return s.jsxs("div",{className:`card-type-header ${L?"clickable-header":""}`,"data-type":p,onClick:m,style:{cursor:L?"pointer":"default",transition:"background-color 0.2s",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:q=>{L&&(q.target.style.backgroundColor="#f0f8ff")},onMouseLeave:q=>{L&&(q.target.style.backgroundColor="transparent")},title:L?`Click to select/deselect all ${p} cards`:void 0,children:[z&&s.jsx("img",{src:z,alt:p,style:{width:"16px",height:"16px",opacity:.8},onError:q=>{q.target.style.display="none"}}),s.jsx("span",{className:"card-type-name",children:p}),s.jsxs("span",{className:"card-type-count",children:["(",T,")"]}),L&&s.jsx("span",{style:{marginLeft:"auto",marginRight:"4px",marginTop:"2px",fontSize:"11px",color:"#666",fontWeight:"normal"},children:"click to select all"})]})}function Ir({groupBy:p,setGroupBy:T,sortBy:m,setSortBy:L,viewMode:z,setViewMode:q,hidePrices:se,setHidePrices:de,showMana:pe,setShowMana:fe}){return s.jsxs("div",{style:{background:"#fff",borderRadius:"8px",padding:"0 12px",marginBottom:"0",display:"flex",flexDirection:"column",gap:"10px"},children:[s.jsx("h3",{style:{fontSize:"14px",margin:"0 0 4px 0",padding:"0 0 4px 0",borderBottom:"1px solid #eee",fontWeight:"600",color:"#333"},children:"Display Options"}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{htmlFor:"groupBy",style:{fontSize:"12px",color:"#666"},children:"Group by:"}),s.jsxs("select",{id:"groupBy",value:p,onChange:Q=>T(Q.target.value),style:{padding:"6px 8px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:"#f9f9f9"},children:[s.jsx("option",{value:"type",children:"Card Type"}),s.jsx("option",{value:"manaValue",children:"Mana Value"}),s.jsx("option",{value:"colorIdentity",children:"Color Identity"})]})]}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{htmlFor:"sortBy",style:{fontSize:"12px",color:"#666"},children:"Sort by:"}),s.jsxs("select",{id:"sortBy",value:m,onChange:Q=>L(Q.target.value),style:{padding:"6px 8px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:"#f9f9f9",marginBottom:"12px"},children:[s.jsx("option",{value:"name-asc",children:"Name (A-Z)"}),s.jsx("option",{value:"name-desc",children:"Name (Z-A)"}),s.jsx("option",{value:"price-asc",children:"Price ($-$$$)"}),s.jsx("option",{value:"price-desc",children:"Price ($$$-$)"})]})]}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{style:{fontSize:"12px",color:"#666"},children:"View:"}),s.jsxs("div",{style:{display:"flex",gap:"4px"},children:[s.jsx("button",{onClick:()=>q("list"),style:{padding:"6px 12px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:z==="list"?"#1976d2":"#f9f9f9",color:z==="list"?"white":"#333",cursor:"pointer",transition:"all 0.2s ease"},children:"üìã List"}),s.jsx("button",{onClick:()=>q("grid"),style:{padding:"6px 12px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:z==="grid"?"#1976d2":"#f9f9f9",color:z==="grid"?"white":"#333",cursor:"pointer",transition:"all 0.2s ease"},children:"üñºÔ∏è Grid"})]})]}),se!==void 0&&de&&pe!==void 0&&fe&&s.jsxs("div",{style:{display:"flex",gap:"8px"},children:[s.jsx("button",{onClick:()=>de(!se),className:`toggle-button ${se?"inactive":"active"}`,children:se?"Show Prices":"Hide Prices"}),s.jsx("button",{onClick:()=>fe(!pe),className:`toggle-button ${pe?"active":"inactive"}`,children:pe?"Hide Mana":"Show Mana"})]})]})}const To=so.memo(({manaCost:p})=>{if(!p)return null;const T=p.match(/\{([^}]+)\}/g)||[];return s.jsx("span",{className:"mana-cost",children:T.map((m,L)=>{const z=m.substring(1,m.length-1).replace("/","");return s.jsx("img",{src:`/svgs/${z.toLowerCase()}.svg`,alt:m,className:"mana-symbol",onError:q=>{q.target.outerHTML=m},"data-no-qr-scan":"true",loading:"lazy"},L)})})});To.displayName="ManaCost";const Sr=p=>{var m,L;const T=(p==null?void 0:p.scryfall_json)||((m=p==null?void 0:p.card)==null?void 0:m.scryfall_json);return T!=null&&T.cmc?T.cmc:(L=p==null?void 0:p.card)!=null&&L.cmc?p.card.cmc:p!=null&&p.cmc?p.cmc:0},jr=p=>{var z,q;const T=(p==null?void 0:p.scryfall_json)||((z=p==null?void 0:p.card)==null?void 0:z.scryfall_json),m=(T==null?void 0:T.color_identity)||((q=p==null?void 0:p.card)==null?void 0:q.color_identity)||[];if(m.length===0)return"C";const L=["W","U","B","R","G"];return m.sort((se,de)=>L.indexOf(se)-L.indexOf(de)).join("")};function eo(p){if(!Array.isArray(p))return console.error("[FOREACH DEBUG] groupCardsByManaValue: cards is not an array:",typeof p,p),[];const T={};for(const m of p){if(!m)continue;const z=`${Sr(m)}`;T[z]||(T[z]=[]),T[z].push(m)}return Object.entries(T).map(([m,L])=>({type:`${m} CMC`,cards:L})).sort((m,L)=>parseInt(m.type)-parseInt(L.type))}function to(p){if(!Array.isArray(p))return console.error("[FOREACH DEBUG] groupCardsByColorIdentity: cards is not an array:",typeof p,p),[];const T={},m={C:"Colorless",W:"White",U:"Blue",B:"Black",R:"Red",G:"Green",WU:"Azorius",WB:"Orzhov",WR:"Boros",WG:"Selesnya",UB:"Dimir",UR:"Izzet",UG:"Simic",BR:"Rakdos",BG:"Golgari",RG:"Gruul",WUB:"Esper",UBR:"Grixis",BRG:"Jund",WRG:"Naya",WUG:"Bant",WBG:"Abzan",WUR:"Jeskai",UBG:"Sultai",WBR:"Mardu",URG:"Temur",WUBR:"Non-Green",UBRG:"Non-White",WBRG:"Non-Blue",WURG:"Non-Black",WUBG:"Non-Red",WUBRG:"Five-Color"},L=["C","W","U","B","R","G","WU","UB","BR","RG","WG","WB","UR","BG","WR","UG","WUG","WUB","UBR","BRG","WRG","WBG","WUR","UBG","WBR","URG","WUBR","UBRG","WBRG","WURG","WUBG","WUBRG"];for(const q of p){if(!q)continue;const se=jr(q);T[se]||(T[se]=[]),T[se].push(q)}return Object.keys(T).map(q=>({type:m[q]||q,cards:T[q],originalKey:q})).sort((q,se)=>{const de=L.indexOf(q.originalKey),pe=L.indexOf(se.originalKey);return de===-1&&pe===-1?q.originalKey.length!==se.originalKey.length?q.originalKey.length-se.originalKey.length:q.originalKey.localeCompare(se.originalKey):de===-1?1:pe===-1?-1:de-pe})}function yo(p){var T,m,L,z,q,se,de,pe,fe,Q,ye,he,$e,Ke,Qe,K,M,H,ne,n,Pe,le,it,V;if(!Array.isArray(p))return console.error("[FOREACH DEBUG] groupCardsByCollectionStatus: cards is not an array:",typeof p,p),[];console.log("[CollectionGrouping] Regrouping cards by collection status, total cards:",p.length);try{const Re=JSON.parse(localStorage.getItem("cardCollection")||"[]");console.log("[CollectionGrouping] Current collection size:",Re.length);const Ne=new Map,F=new Map;Re.forEach(oe=>{const Le=`${oe.printing_id}_${oe.foil}`;Ne.set(Le,(Ne.get(Le)||0)+oe.quantity);const lt=oe.name||oe.card_name||oe.cardName;lt&&(F.has(lt)||F.set(lt,new Set),F.get(lt).add(`${oe.printing_id}_${oe.foil}`))}),console.log("[CollectionGrouping] Card name map:",Array.from(F.keys()).slice(0,10));const Y=[],_e=[],be=[];for(const oe of p){if(!oe){be.push(oe);continue}const Le=oe.name||((T=oe.cardObj)==null?void 0:T.name)||((L=(m=oe.cardObj)==null?void 0:m.card)==null?void 0:L.name)||((z=oe.card)==null?void 0:z.name)||((de=(se=(q=oe.cardObj)==null?void 0:q.card)==null?void 0:se.scryfall_json)==null?void 0:de.name)||((pe=oe.scryfall_json)==null?void 0:pe.name),lt=oe.printing||((fe=oe.cardObj)==null?void 0:fe.printing)||((ye=(Q=oe.cardObj)==null?void 0:Q.card)==null?void 0:ye.printing)||((he=oe.card)==null?void 0:he.printing)||oe.scryfall_id||oe.id||(($e=oe.cardObj)==null?void 0:$e.scryfall_id)||((Ke=oe.cardObj)==null?void 0:Ke.id)||((K=(Qe=oe.cardObj)==null?void 0:Qe.card)==null?void 0:K.scryfall_id)||((H=(M=oe.cardObj)==null?void 0:M.card)==null?void 0:H.id),Be=oe.foil===!0||oe.isFoil===!0||((ne=oe.cardObj)==null?void 0:ne.foil)===!0||((n=oe.cardObj)==null?void 0:n.isFoil)===!0||((le=(Pe=oe.cardObj)==null?void 0:Pe.card)==null?void 0:le.foil)===!0||((V=(it=oe.cardObj)==null?void 0:it.card)==null?void 0:V.isFoil)===!0;if(!lt||!Le){console.log("[CollectionGrouping] Missing data for card:",{cardName:Le,printingId:lt,cardStructure:Object.keys(oe)}),be.push(oe);continue}console.log("[CollectionGrouping] Processing card:",{cardName:Le,printingId:lt,isFoil:Be,ownedVersions:F.get(Le)});const St=`${lt}_${Be}`;if((Ne.get(St)||0)>0)console.log("[CollectionGrouping] Exact match found for:",Le),Y.push(oe);else{const tn=F.get(Le);tn&&tn.size>0?(console.log("[CollectionGrouping] Different version owned for:",Le,"versions:",Array.from(tn)),_e.push(oe)):(console.log("[CollectionGrouping] Not owned:",Le),be.push(oe))}}const Ve=[];return Y.length>0&&Ve.push({type:"Exact Match",cards:Y}),_e.length>0&&Ve.push({type:"Different Version Owned",cards:_e}),be.length>0&&Ve.push({type:"Not Owned",cards:be}),Ve}catch(Re){return console.error("Error checking collection status:",Re),[{type:"Not Owned",cards:p}]}}const yn=(p,T,m="unknown")=>{var L;try{if(!p){console.warn(`[ULTRA SAFE] ${m}: null/undefined array`);return}if(!Array.isArray(p)){const z={type:typeof p,constructor:(L=p==null?void 0:p.constructor)==null?void 0:L.name,hasLength:"length"in p,length:p==null?void 0:p.length,keys:p&&typeof p=="object"?Object.keys(p).slice(0,3):[],isIterable:p&&typeof p[Symbol.iterator]=="function"};if(m!=="unknown"&&(z.hasLength||z.isIterable)&&console.warn(`[ULTRA SAFE] ${m}: converting non-array:`,z),p&&typeof p.length=="number"&&p.length>=0)p=Array.from(p);else if(p&&typeof p[Symbol.iterator]=="function")p=Array.from(p);else{m!=="unknown"&&console.error(`[ULTRA SAFE] ${m}: cannot convert to array:`,z);return}}for(let z=0;z<p.length;z++)try{T(p[z],z,p)}catch(q){console.error(`[ULTRA SAFE] ${m}: callback error at index ${z}:`,q)}}catch(z){console.error(`[ULTRA SAFE] ${m}: critical error:`,z)}},Er=()=>{console.log("[DEBUG] forEach debugging disabled to prevent interference")},vr=()=>{};typeof window<"u"&&(window.enableForEachDebugging=Er,window.disableForEachDebugging=vr);const Mo=p=>p?p.startsWith("https://cards.scryfall.io/")||p.startsWith("https://c1.scryfall.com/")?`http://localhost:3001/api/cards/image-proxy?url=${encodeURIComponent(p)}`:p:null,gt={Forest:"d232fcc2-12f6-401a-b1aa-ddff11cb9378",Island:"23635e40-d040-40b7-8b98-90ed362aa028",Mountain:"1edc5050-69bd-416d-b04c-7f82de2a1901",Plains:"4ef17ed4-a9b5-4b8e-b4cb-2ecb7e5898c3",Swamp:"13505c15-14e0-4200-82bd-fb9bce949e68",Wastes:"60682c00-c661-4a9d-8326-f3f014a04e3e","Snow-Covered Forest":"838c915d-8153-43c2-b513-dfbe4e9388a5","Snow-Covered Island":"6abf0692-07d1-4b72-af06-93d0e338589d","Snow-Covered Mountain":"0dc9a6d1-a1ca-4b8f-894d-71c2a9933f79","Snow-Covered Plains":"b1e3a010-dae3-41b6-8dd8-e31d14c3ac4a","Snow-Covered Swamp":"c4dacaf1-09b8-42bb-8064-990190fdaf81","Snow-Covered Wastes":"ad21a874-525e-4d11-bd8e-bc44918bec40","Basic Forest":"d232fcc2-12f6-401a-b1aa-ddff11cb9378","Basic Island":"ff0ba1cf-1b05-403e-8b5e-4bbe3cfa8a89","Basic Mountain":"b34bb2dc-c1af-4d77-b0b3-a0fb342a5fc6","Basic Plains":"8e592a1e-b5e1-497a-863d-9772d25d3b3f","Basic Swamp":"6b28e7a6-e0ed-4c45-85dd-7c1bbfe6b3e5"},ao=new Set,wn=p=>Array.isArray(p)?p.filter(T=>{var q;if(!T)return!1;const m=((q=T.card)==null?void 0:q.name)||T.name||"";return!(/^(test|example|placeholder|unknown|null|undefined|sample)/i.test(m)||m.length<=2)}):[];typeof window<"u"&&(window.getInvalidCardCacheStats=()=>(console.log(`[Invalid Card Cache] Currently tracking ${ao.size} invalid cards/combinations`),Array.from(ao)));const zn="basic-land-printing-preferences",ln=p=>{try{const m=JSON.parse(localStorage.getItem(zn)||"{}")[p],L=gt[p],z=m||L;return console.log(`üèûÔ∏è [GET PREF] ${p}: user=${m}, default=${L}, result=${z}`),z}catch(T){return console.warn("[BASIC LAND PREFS] Error reading preferences:",T),gt[p]}},kr=(p,T)=>{try{const m=JSON.parse(localStorage.getItem(zn)||"{}");m[p]=T,localStorage.setItem(zn,JSON.stringify(m)),console.log(`üèûÔ∏è [USER PREFS] Updated ${p} preferred printing to: ${T}`)}catch(m){console.error("[BASIC LAND PREFS] Error saving preferences:",m)}},$r=()=>{try{return JSON.parse(localStorage.getItem(zn)||"{}")}catch(p){return console.warn("[BASIC LAND PREFS] Error reading all preferences:",p),{}}},Pr=()=>{localStorage.removeItem(zn),console.log("üèûÔ∏è [USER PREFS] Reset all basic land preferences to defaults")};typeof window<"u"&&(window.basicLandPrefs={get:ln,set:kr,getAll:$r,reset:Pr});const no=["Commander","Planeswalker","Battle","Creature","Sorcery","Instant","Artifact","Kindred","Enchantment","Land","Conspiracy","Dungeon","Emblem","Hero","Phenomenon","Plane","Scheme","Vanguard","Other"];window.__hoveredCardName=null;function pn(p,T=[]){var se,de,pe,fe,Q,ye,he,$e,Ke,Qe,K;const m={};if(!Array.isArray(p))return[];for(const M of p){let H,ne;if(M){if(M&&typeof M=="object"){if(M.card&&typeof M.card=="object")if(H=((se=M.card)==null?void 0:se.name)||M.name,M.isCommander||(de=M.card)!=null&&de.isCommander||H&&T.includes(H.toLowerCase()))ne="Commander";else try{const n=((pe=M.card)==null?void 0:pe.type_line)||M.type_line||((fe=M.scryfallCard)==null?void 0:fe.type_line)||((Q=M.scryfall_json)==null?void 0:Q.type_line)||((he=(ye=M.card)==null?void 0:ye.scryfallCard)==null?void 0:he.type_line)||((Ke=($e=M.card)==null?void 0:$e.scryfall_json)==null?void 0:Ke.type_line);ne=H&&po[H]||n&&Ao(n)||"Other"}catch(n){console.error("Error getting card type for:",M,n),ne="Other"}else if(M.name)if(H=M.name,M.isCommander||H&&T.includes(H.toLowerCase()))ne="Commander";else try{const n=M.type_line||((Qe=M.scryfallCard)==null?void 0:Qe.type_line)||((K=M.scryfall_json)==null?void 0:K.type_line);ne=H&&po[H]||n&&Ao(n)||"Other"}catch(n){console.error("Error getting card type for direct card object:",M,n),ne="Other"}}else typeof M=="string"&&(H=M,H&&T.includes(H.toLowerCase())?ne="Commander":ne=H&&po[H]||"Other");H&&(m[ne]||(m[ne]=[]),m[ne].push(M))}}yn(Object.keys(m),M=>{const H=m[M];if(!Array.isArray(H)){console.error("[FOREACH DEBUG] cardsInType is not an array in groupCardsByType:",typeof H,H,"Type:",M),m[M]=[];return}const ne={};try{yn(H,n=>{var Ne,F,Y,_e,be,Ve,oe,Le,lt;const Pe=((Ne=n.card)==null?void 0:Ne.name)||n.name,le=n.printing||((F=n.card)==null?void 0:F.printing)||((Y=n.scryfall_json)==null?void 0:Y.id)||((be=(_e=n.card)==null?void 0:_e.scryfall_json)==null?void 0:be.id)||((oe=(Ve=n.cardObj)==null?void 0:Ve.scryfall_json)==null?void 0:oe.id)||((Le=n.cardObj)==null?void 0:Le.printing)||null,it=n.foil||((lt=n.card)==null?void 0:lt.foil)||!1,V=`${Pe}-${le}-${it}`;ne[V]||(ne[V]={name:Pe,count:0,printing:le,cardObj:n,foil:it});const Re=n.count||n.quantity||1;ne[V].count+=Re})}catch(n){throw console.error("[DEBUG] Error in consolidation for type",M,":",n),console.error("[DEBUG] Cards in type:",H),n}m[M]=Object.values(ne).sort((n,Pe)=>{const le=(n.name||"").toLowerCase(),it=(Pe.name||"").toLowerCase();return le.localeCompare(it)})});const L=[],z=Object.keys(m);let q=[];if(no&&no.length>0){q=no.filter(H=>z.includes(H));const M=z.filter(H=>!no.includes(H)).sort();q=q.concat(M)}else q=z.sort();for(const M of q){const H=m[M];L.push({type:M,cards:H})}return L}function gn(p){var se,de,pe,fe,Q,ye,he,$e,Ke,Qe,K,M,H,ne,n,Pe,le,it,V,Re,Ne;if(!p)return[];let T=Array.isArray(p.cards)?[...p.cards]:[];T=wn(T),Math.random()<.05&&console.log(`[DEBUG] ensureCommanderInCards filtered to ${T.length} cards`);let m=[];if(p.commander&&Array.isArray(p.commander)&&p.commander.length>0?m=p.commander.filter(F=>F!=null):p.commander&&typeof p.commander=="object"&&p.commander!==null&&!Array.isArray(p.commander)?m=[p.commander]:typeof p.commander=="string"&&p.commander.trim()&&(m=[p.commander]),p.commanderNames&&Array.isArray(p.commanderNames)&&p.commanderNames.length>0){const F=p.commanderNames.filter(Y=>typeof Y=="string"&&Y.trim());m=m.concat(F)}if(m.length===0)return T;const L=m.map(F=>{var _e;const Y=((_e=F.card)==null?void 0:_e.name)||F.name||F;return typeof Y=="string"?Y.toLowerCase():""}).filter(F=>F),z=new Set,q=T.filter(F=>{var _e;if(!F)return!1;const Y=(((_e=F.card)==null?void 0:_e.name)||F.name||"").toLowerCase();return L.includes(Y)?z.has(Y)?!1:(z.add(Y),!0):!0});for(const F of m){if(!F)continue;const Y=(((se=F.card)==null?void 0:se.name)||F.name||F).toLowerCase();if(Y&&!q.some(_e=>{var be;return(((be=_e.card)==null?void 0:be.name)||_e.name||"").toLowerCase()===Y}))if(typeof F=="object"&&F!==null){const _e={card:F};let be=null;F.cmc!==void 0?be=F.cmc:((de=F.card)==null?void 0:de.cmc)!==void 0?be=(pe=F.card)==null?void 0:pe.cmc:((fe=F.scryfall_json)==null?void 0:fe.cmc)!==void 0?be=F.scryfall_json.cmc:((ye=(Q=F.card)==null?void 0:Q.scryfall_json)==null?void 0:ye.cmc)!==void 0&&(be=($e=(he=F.card)==null?void 0:he.scryfall_json)==null?void 0:$e.cmc),be!==null&&(_e.card&&(_e.card.cmc=be),_e.cmc=be);let Ve=null;((Ke=F.prices)==null?void 0:Ke.usd)!==void 0?Ve=F.prices.usd:((K=(Qe=F.card)==null?void 0:Qe.prices)==null?void 0:K.usd)!==void 0?Ve=(H=(M=F.card)==null?void 0:M.prices)==null?void 0:H.usd:((n=(ne=F.scryfall_json)==null?void 0:ne.prices)==null?void 0:n.usd)!==void 0?Ve=F.scryfall_json.prices.usd:((it=(le=(Pe=F.card)==null?void 0:Pe.scryfall_json)==null?void 0:le.prices)==null?void 0:it.usd)!==void 0?Ve=(Ne=(Re=(V=F.card)==null?void 0:V.scryfall_json)==null?void 0:Re.prices)==null?void 0:Ne.usd:F.price&&(Ve=F.price),Ve!==null&&(_e.card&&!_e.card.prices&&(_e.card.prices={}),_e.prices||(_e.prices={}),_e.card&&(_e.card.prices.usd=Ve),_e.prices.usd=Ve),F.printings&&F.printings.length>0&&!_e.printing&&(_e.printing=F.printings[0]),q.unshift(_e)}else typeof F=="string"&&q.unshift({name:F})}return q}const Nr=(p,T)=>{if(!Array.isArray(p)){console.error("[FOREACH DEBUG] preloadCardImages: cards is not an array:",typeof p,p);return}const m=new Map;yn(p,L=>{if(!L)return;const z=L.card||L,q=(z==null?void 0:z.name)||L.name;if(!q)return;const se=L.printing||q;m.has(se)||m.set(se,z)}),yn(Array.from(m),([L,z])=>{if(T.has(L))return;let q;z.set&&z.collector_number?q=`https://api.scryfall.com/cards/${z.set.toLowerCase()}/${z.collector_number}?format=image&version=png`:gt[z.name]?q=`https://api.scryfall.com/cards/${gt[z.name]}?format=image&version=png`:q=`https://api.scryfall.com/cards/named?format=image&version=png&exact=${encodeURIComponent(z.name)}`;const se=new Image;se.src=q,T.set(L,q)})},Vt=p=>{var m,L;const T=ho(p,{preferStoredPrice:!0,fallbackPrice:null,debugLogging:!1,forceNonFoil:!p.foil});return{price:T.price,source:T.source,cardType:T.cardType,isFoil:T.metadata.isFoil||!1,isEtched:T.cardType==="etched",isPromo:((m=T.metadata.finishes)==null?void 0:m.includes("promo"))||!1,isSpecialFinish:T.cardType==="special_foil",isDigital:((L=T.metadata.finishes)==null?void 0:L.includes("digital"))||!1}};function Ar({x:p,y:T,cardObj:m,onCopyScryfallLink:L,onClose:z,onUseForDeckImage:q,onAddToWishlist:se,onAddToCollection:de,onRemoveFromDeck:pe,onAddToSideboard:fe,onAddToTechIdeas:Q,onMoveToMainDeck:ye,onMoveFromSideboardToTechIdeas:he,onMoveFromTechIdeasToSideboard:$e,onRemoveFromSideboard:Ke,onRemoveFromTechIdeas:Qe}){const K=so.useRef(null);so.useEffect(()=>{K.current&&K.current.focus()},[]);const M={position:"fixed",top:Math.min(T,window.innerHeight-250),left:Math.min(p,window.innerWidth-200),background:"#fff",border:"1px solid #ccc",borderRadius:6,boxShadow:"0 2px 8px rgba(0,0,0,0.15)",zIndex:1e4,minWidth:180,padding:"4px 0",maxHeight:"200px",overflow:"auto"},H={display:"block",width:"100%",background:"none",border:"none",textAlign:"left",padding:"8px 16px",fontSize:15,fontWeight:500,color:"#222",cursor:"pointer",transition:"background 0.15s"},ne=n=>{n(),z()};return s.jsxs("div",{ref:K,tabIndex:-1,style:M,onContextMenu:n=>n.preventDefault(),onKeyDown:n=>{n.key==="Escape"&&z()},children:[s.jsx("button",{style:H,onClick:()=>ne(q),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Use for Deck Image"}),s.jsx("button",{style:H,onClick:()=>ne(se),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Wishlist"}),s.jsx("button",{style:H,onClick:()=>ne(de),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Collection"}),(m==null?void 0:m.section)==="sideboard"?s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(ye),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Main Deck"}),s.jsx("button",{style:H,onClick:()=>ne(he),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Tech Ideas"})]}):(m==null?void 0:m.section)==="techIdeas"?s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(ye),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Main Deck"}),s.jsx("button",{style:H,onClick:()=>ne($e),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Sideboard"})]}):s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(fe),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Sideboard"}),s.jsx("button",{style:H,onClick:()=>ne(Q),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Tech Ideas"})]}),s.jsx("button",{style:H,onClick:()=>ne(L),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Copy Scryfall Link"}),s.jsx("hr",{style:{margin:"4px 0",border:"0",borderTop:"1px solid #eee"}}),(m==null?void 0:m.section)==="sideboard"?s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(Ke),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Sideboard"}):(m==null?void 0:m.section)==="techIdeas"?s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(Qe),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Tech Ideas"}):s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(pe),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Deck"})]})}const Fo=({size:p=12,color:T="#1976d2"})=>s.jsx("svg",{version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:p,height:p*(32/23),viewBox:"0 0 23 32",style:{display:"inline-block",verticalAlign:"middle"},children:s.jsx("path",{fill:T,d:"M18.486 28.106c0 1.581-1.282 2.863-2.863 2.863h-12.762c-1.581 0-2.863-1.282-2.863-2.863v-20.157c0-1.581 1.282-2.863 2.863-2.863h2.028v-1.193c0-1.581 1.282-2.863 2.863-2.863h12.762c1.581 0 2.863 1.282 2.863 2.863v20.157c0 1.581-1.282 2.863-2.863 2.863h-2.028v1.193zM15.623 6.995h-12.762c-0.527 0-0.954 0.427-0.954 0.954v20.157c0 0.527 0.427 0.954 0.954 0.954h12.762c0.527 0 0.954-0.427 0.954-0.954v-20.157c0-0.527-0.427-0.954-0.954-0.954zM18.486 25.005h2.028c0.527 0 0.954-0.427 0.954-0.954v-20.157c0-0.527-0.427-0.954-0.954-0.954h-12.762c-0.527 0-0.954 0.427-0.954 0.954v1.193h8.826c1.581 0 2.863 1.282 2.863 2.863v17.056z"})}),ro=A.memo(({cardData:p,isFoil:T,price:m,index:L,onMouseEnter:z,onClick:q,onContextMenu:se,showMana:de,hidePrices:pe,isExplicitlyFoil:fe,bulkEditMode:Q,isSelected:ye,onToggleSelection:he,customButtons:$e,setFixedPreview:Ke,deckFlipStates:Qe,setDeckFlipStates:K})=>{var Ve,oe,Le,lt,Be,St,en,tn,Sn,hn,$t,_t,Fe,dn,xt,nn,Ht;const M=`${p.name}-${p.printing||((Ve=p.cardObj)==null?void 0:Ve.scryfall_id)||"default"}`,H=Qe.get(M)||!1,ne=A.useMemo(()=>pe?"not-owned":xo(p),[p,pe]),n=((lt=(Le=(oe=p.cardObj)==null?void 0:oe.card)==null?void 0:Le.scryfall_json)==null?void 0:lt.card_faces)||((St=(Be=p.cardObj)==null?void 0:Be.scryfall_json)==null?void 0:St.card_faces)||((tn=(en=p.cardObj)==null?void 0:en.card)==null?void 0:tn.card_faces)||((Sn=p.cardObj)==null?void 0:Sn.card_faces),Pe=((_t=($t=(hn=p.cardObj)==null?void 0:hn.card)==null?void 0:$t.scryfall_json)==null?void 0:_t.layout)||((dn=(Fe=p.cardObj)==null?void 0:Fe.scryfall_json)==null?void 0:dn.layout)||((nn=(xt=p.cardObj)==null?void 0:xt.card)==null?void 0:nn.layout)||((Ht=p.cardObj)==null?void 0:Ht.layout),le=Pe==="transform"||Pe==="modal_dfc"||Pe==="reversible_card",it=n&&Array.isArray(n)&&n.length>=2||le,V=()=>{var jt;return!it||!n?p.name:((jt=n[H?1:0])==null?void 0:jt.name)||p.name},Ne=(()=>{var ut,jt,qt,Ut,on,jn,rn,Xt,ze,Kt,_n,fn,Qt,un,bt,sn;if(it&&n&&Array.isArray(n)){const Se=n[0];return Se!=null&&Se.mana_cost?Se.mana_cost:((qt=(jt=(ut=p.cardObj)==null?void 0:ut.card)==null?void 0:jt.scryfall_json)==null?void 0:qt.mana_cost)||((on=(Ut=p.cardObj)==null?void 0:Ut.scryfall_json)==null?void 0:on.mana_cost)||((rn=(jn=p.cardObj)==null?void 0:jn.card)==null?void 0:rn.mana_cost)||((Xt=p.cardObj)==null?void 0:Xt.mana_cost)||""}return((_n=(Kt=(ze=p.cardObj)==null?void 0:ze.card)==null?void 0:Kt.scryfall_json)==null?void 0:_n.mana_cost)||((Qt=(fn=p.cardObj)==null?void 0:fn.scryfall_json)==null?void 0:Qt.mana_cost)||((bt=(un=p.cardObj)==null?void 0:un.card)==null?void 0:bt.mana_cost)||((sn=p.cardObj)==null?void 0:sn.mana_cost)||""})(),F=p.name.split("").reduce((ut,jt)=>(ut=(ut<<5)-ut+jt.charCodeAt(0),ut&ut),0),Y=`${-(Math.abs(F)%8)}s`,_e=ut=>{Q?(ut.preventDefault(),ut.stopPropagation(),he()):q()},be=ut=>{ut.preventDefault(),ut.stopPropagation();const jt=!H;K(qt=>{const Ut=new Map(qt);return Ut.set(M,jt),Ut}),Ke&&Ke(qt=>({...qt,flipState:jt}))};return s.jsxs("div",{className:`deck-card-row ${Q?"bulk-edit-mode":""} ${Q&&ye?"bulk-selected":""}`,onMouseEnter:z,onClick:_e,onContextMenu:se,children:[Q&&s.jsx("input",{type:"checkbox",checked:ye,onChange:he,onClick:ut=>ut.stopPropagation(),className:"bulk-edit-checkbox",style:{cursor:"pointer",marginRight:"3px"}}),s.jsx("span",{className:"card-count",style:{marginLeft:"4px"},children:`${p.count||p.quantity||1} -`}),s.jsxs("span",{className:`card-name ${fe?"foil-active-text":""}`,style:fe?{animationDelay:Y}:{},children:[V(),it&&s.jsx("span",{onClick:be,style:{marginLeft:"6px",cursor:"pointer",userSelect:"none",display:"inline-flex",alignItems:"center",verticalAlign:"middle"},title:`Flip to ${H?"front":"back"} face`,children:s.jsx(Fo,{size:10,color:"#1976d2"})})]}),s.jsxs("span",{className:"card-right-group",children:[de&&s.jsx(s.Fragment,{children:Ne?s.jsx("span",{className:"card-mana-column",children:s.jsx(To,{manaCost:Ne})}):s.jsx("span",{className:"card-mana-column"})}),!pe&&s.jsx("span",{className:`card-price ${fe?"foil-price":""} ${!m&&gt[p.name]?"basic-land-price":""}`,title:`${fe?"Foil":"Non-foil"} price`,children:Bn(m)}),!pe&&s.jsx("span",{style:{width:"16px",minWidth:"16px",display:"inline-flex",justifyContent:"center",alignItems:"center",flexShrink:0},children:ne==="exact-match"?s.jsx("span",{style:{color:"#22c55e",fontSize:"14px"},title:"In collection (exact match)",children:"‚óè"}):ne==="different-version"?s.jsx("span",{style:{color:"#eab308",fontSize:"14px"},title:"In collection (different printing)",children:"‚óè"}):s.jsx("span",{style:{color:"#ef4444",fontSize:"14px"},title:"Not in collection",children:"‚óè"})})]}),$e&&s.jsx("span",{className:"custom-buttons",style:{marginLeft:"0.5rem"},children:$e})]},`${p.name}-${p.printing||""}-${p.count}-${fe?"foil":"nonfoil"}-${m||"na"}-${L}`)});ro.displayName="DeckCardRow";let oo=null,Ro=0;const Rr=3e4,Tr=()=>{const p=Date.now();if(oo&&p-Ro<Rr)return oo;try{const T=In.getChunkedItem("cardCollection");let m=[];if(T&&typeof T=="object"){if(Array.isArray(T))m=T;else if(T.data)try{m=JSON.parse(T.data)}catch(q){console.warn("[COLLECTION] Failed to parse collection data:",q),m=[]}}Array.isArray(m)||(console.warn("[COLLECTION] Collection data is not an array:",typeof m),m=[]);const L=new Map,z=new Map;return yn(m,q=>{const se=`${q.printing_id}_${q.foil}`;L.set(se,(L.get(se)||0)+q.quantity);const de=q.name||q.card_name||q.cardName;de&&(z.has(de)||z.set(de,new Set),z.get(de).add(`${q.printing_id}_${q.foil}`))},"collection-cache-build"),oo={collectionMap:L,cardNameMap:z},Ro=p,oo}catch(T){return console.error("[COLLECTION] Error loading collection:",T),{collectionMap:new Map,cardNameMap:new Map}}},xo=p=>{var T,m,L,z,q,se,de,pe,fe,Q,ye,he,$e,Ke,Qe,K,M,H,ne,n,Pe,le,it,V;try{const{collectionMap:Re,cardNameMap:Ne}=Tr(),F=p.name||((T=p.cardObj)==null?void 0:T.name)||((L=(m=p.cardObj)==null?void 0:m.card)==null?void 0:L.name)||((z=p.card)==null?void 0:z.name)||((de=(se=(q=p.cardObj)==null?void 0:q.card)==null?void 0:se.scryfall_json)==null?void 0:de.name)||((pe=p.scryfall_json)==null?void 0:pe.name),Y=p.printing||((fe=p.cardObj)==null?void 0:fe.printing)||((ye=(Q=p.cardObj)==null?void 0:Q.card)==null?void 0:ye.printing)||((he=p.card)==null?void 0:he.printing)||p.scryfall_id||p.id||(($e=p.cardObj)==null?void 0:$e.scryfall_id)||((Ke=p.cardObj)==null?void 0:Ke.id)||((K=(Qe=p.cardObj)==null?void 0:Qe.card)==null?void 0:K.scryfall_id)||((H=(M=p.cardObj)==null?void 0:M.card)==null?void 0:H.id),_e=p.foil===!0||p.isFoil===!0||((ne=p.cardObj)==null?void 0:ne.foil)===!0||((n=p.cardObj)==null?void 0:n.isFoil)===!0||((le=(Pe=p.cardObj)==null?void 0:Pe.card)==null?void 0:le.foil)===!0||((V=(it=p.cardObj)==null?void 0:it.card)==null?void 0:V.isFoil)===!0;if(!Y||!F)return"not-owned";const be=`${Y}_${_e}`;if((Re.get(be)||0)>0)return"exact-match";{const oe=Ne.get(F);return oe&&oe.size>0?"different-version":"not-owned"}}catch(Re){return console.error("Error checking collection status:",Re),"not-owned"}},Uo=A.memo(({cardData:p,isExplicitlyFoil:T,price:m,onMouseEnter:L,onClick:z,onContextMenu:q,bulkEditMode:se,isSelected:de,onToggleSelection:pe,deckFlipStates:fe,setDeckFlipStates:Q})=>{var K;const ye=`${p.name}-${p.printing||((K=p.cardObj)==null?void 0:K.scryfall_id)||"default"}`;fe.get(ye);const he=xo(p),Ke=(()=>{var ne,n,Pe,le,it,V,Re,Ne,F,Y,_e,be,Ve,oe,Le,lt;const M=p.cardObj||p;let H=null;if((Pe=(n=(ne=M==null?void 0:M.card)==null?void 0:ne.scryfall_json)==null?void 0:n.image_uris)!=null&&Pe.normal)H=M.card.scryfall_json.image_uris.normal;else if((it=(le=M==null?void 0:M.scryfall_json)==null?void 0:le.image_uris)!=null&&it.normal)H=M.scryfall_json.image_uris.normal;else if((Re=(V=M==null?void 0:M.card)==null?void 0:V.image_uris)!=null&&Re.normal)H=M.card.image_uris.normal;else if((Ne=M==null?void 0:M.image_uris)!=null&&Ne.normal)H=M.image_uris.normal;else if((_e=(Y=(F=M==null?void 0:M.card)==null?void 0:F.scryfall_json)==null?void 0:Y.image_uris)!=null&&_e.small)H=M.card.scryfall_json.image_uris.small;else if((Ve=(be=M==null?void 0:M.scryfall_json)==null?void 0:be.image_uris)!=null&&Ve.small)H=M.scryfall_json.image_uris.small;else{const Be=((Le=(oe=M==null?void 0:M.card)==null?void 0:oe.scryfall_json)==null?void 0:Le.id)||((lt=M==null?void 0:M.scryfall_json)==null?void 0:lt.id)||(M==null?void 0:M.scryfall_id)||(M==null?void 0:M.id);Be&&(H=`https://cards.scryfall.io/normal/front/${Be.substr(0,1)}/${Be.substr(1,1)}/${Be}.jpg`)}return Mo(H)})(),Qe=p.count||p.quantity||1;return s.jsxs("div",{className:"grid-card",style:{position:"relative",aspectRatio:"5/7",width:"150px",borderRadius:"8px",overflow:"hidden",backgroundColor:"#f0f0f0",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:de?"0 0 0 3px #1976d2":"0 2px 4px rgba(0,0,0,0.1)",opacity:se&&!de?.7:1},onMouseEnter:M=>{se||(M.currentTarget.style.transform="scale(1.05)",M.currentTarget.style.boxShadow=de?"0 0 0 3px #1976d2":"0 4px 8px rgba(0,0,0,0.2)"),L&&L()},onMouseLeave:M=>{se||(M.currentTarget.style.transform="scale(1)",M.currentTarget.style.boxShadow=de?"0 0 0 3px #1976d2":"0 2px 4px rgba(0,0,0,0.1)")},onClick:M=>{se?(M.preventDefault(),M.stopPropagation(),pe&&pe()):z&&z(M)},onContextMenu:q,children:[Ke?s.jsx("img",{src:Ke,alt:p.name,style:{width:"100%",height:"100%",objectFit:"cover"},onError:M=>{M.target.style.display="none",M.target.nextSibling.style.display="flex"}}):null,s.jsxs("div",{style:{display:Ke?"none":"flex",width:"100%",height:"100%",alignItems:"center",justifyContent:"center",backgroundColor:"#e0e0e0",color:"#666",fontSize:"12px",textAlign:"center",padding:"8px",flexDirection:"column",gap:"4px"},children:[s.jsx("div",{style:{fontWeight:"bold",lineHeight:"1.2"},children:p.name}),s.jsx("div",{style:{fontSize:"10px",opacity:.7},children:"No Image"})]}),Qe>1&&s.jsx("div",{style:{position:"absolute",top:"6px",left:"6px",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"white",borderRadius:"12px",padding:"2px 8px",fontSize:"12px",fontWeight:"bold",minWidth:"20px",textAlign:"center"},children:Qe}),T&&s.jsx("div",{style:{position:"absolute",top:"6px",right:"6px",width:"18px",height:"18px",background:"linear-gradient(125deg, #ff0000, #ffa500, #ffff00, #00ff00, #0000ff, #ee82ee)",backgroundSize:"400% 400%",borderRadius:"50%",border:"1px solid rgba(255, 255, 255, 0.8)",opacity:1,pointerEvents:"none",zIndex:2,animation:"rainbow-shift 3s linear infinite",willChange:"transform, filter"}}),(()=>{const M=()=>he==="exact-match"?"#22c55e":he==="different-version"?"#eab308":"#ef4444",H=()=>he==="exact-match"?"In collection (exact match)":he==="different-version"?"In collection (different printing)":"Not in collection";return s.jsx("div",{style:{position:"absolute",top:"6px",right:T?"32px":"6px",color:M(),fontSize:"18px",lineHeight:"1",display:"flex",alignItems:"center",justifyContent:"center",width:"18px",height:"18px"},title:H(),children:"‚óè"})})(),m&&s.jsxs("div",{style:{position:"absolute",bottom:"6px",left:"6px",backgroundColor:"rgba(0, 0, 0, 0.85)",color:"white",borderRadius:"6px",padding:"2px 6px",fontSize:"11px",fontWeight:"bold",boxShadow:"0 1px 3px rgba(0,0,0,0.3)"},children:["$",m]}),se&&s.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"30px",height:"30px",borderRadius:"50%",backgroundColor:de?"#1976d2":"rgba(255, 255, 255, 0.9)",border:de?"none":"2px solid #1976d2",display:"flex",alignItems:"center",justifyContent:"center",color:de?"white":"#1976d2",fontSize:"16px",fontWeight:"bold",boxShadow:"0 2px 8px rgba(0,0,0,0.3)",zIndex:10},children:de?"‚úì":""})]})});Uo.displayName="GridCard";let an=0;function Lr({isPublic:p=!1}){if(an++,an%100===0&&console.warn(`[PERFORMANCE] DeckViewEdit has re-rendered ${an} times! Possible render loop.`),an>150)return console.error(`[EMERGENCY] DeckViewEdit has re-rendered ${an} times! Activating circuit breaker.`),an=0,s.jsxs("div",{style:{padding:"20px",border:"2px solid red",margin:"20px"},children:[s.jsx("h3",{children:"üö® Render Loop Detected"}),s.jsxs("p",{children:["The deck editor encountered a render loop ($",an," renders) and was stopped to prevent crashes."]}),s.jsx("p",{children:"This usually happens when adding cards triggers excessive re-renders."}),s.jsx("button",{onClick:()=>window.location.reload(),children:"Refresh Page"}),s.jsx("button",{onClick:()=>{an=0,window.location.reload()},children:"Reset & Refresh"})]});const{id:T}=gr(),[m,L]=A.useState({isOpen:!1,cardObj:null}),[z,q]=A.useState({isActive:!1,searchResults:[],currentIndex:-1}),[se,de]=A.useState(new Set),pe=A.useRef(!0),fe=A.useRef(!1),Q=A.useRef(null),ye=A.useRef(new Map),he=A.useRef(new Map),$e=A.useRef(0),Ke=A.useRef(new Map),Qe=yr(),[K,M]=A.useState(p),[H,ne]=A.useState({isOpen:!1,cardName:null,activeComponentId:null,cardObj:null}),[n,Pe]=A.useState(null),le=A.useCallback(e=>{var a,o;const t=new Error().stack;if(typeof e=="function")return Pe(r=>{var i,c;const l=e(r);return l&&r&&r.commander&&!l.commander?(console.log("[DEBUG] setDeck function update preserved commander data:",{originalCommander:r.commander,originalCommanderNames:r.commanderNames,stackTrace:((i=t==null?void 0:t.split(`
`)[2])==null?void 0:i.trim())||"Unknown"}),{...l,commander:r.commander,commanderNames:r.commanderNames}):($e.current%100===0&&console.log("[DEBUG] setDeck function update called from:",{hasCommander:(l==null?void 0:l.commander)!==void 0,stackTrace:((c=t==null?void 0:t.split(`
`)[2])==null?void 0:c.trim())||"Unknown"}),l)});{let r=e;return r&&n&&n.commander&&!r.commander&&(console.log("[DEBUG] setDeck direct value preserved commander data:",{originalCommander:n.commander,originalCommanderNames:n.commanderNames,newDeckId:r._id,stackTrace:((a=t==null?void 0:t.split(`
`)[2])==null?void 0:a.trim())||"Unknown"}),r={...r,commander:n.commander,commanderNames:n.commanderNames}),$e.current%100===0&&console.log("[DEBUG] setDeck direct value called from:",{hasCommander:(r==null?void 0:r.commander)!==void 0,stackTrace:((o=t==null?void 0:t.split(`
`)[2])==null?void 0:o.trim())||"Unknown"}),Pe(r)}},[Pe,n]),[it,V]=A.useState(!1),[Re,Ne]=A.useState(""),[F,Y]=A.useState([]),[_e,be]=A.useState(!0),[Ve,oe]=A.useState(!0),[Le,lt]=A.useState(0),[Be,St]=A.useState({card:null}),[en,tn]=A.useState([]),[Sn,hn]=A.useState(!1),[$t,_t]=A.useState(""),[Fe,dn]=A.useState("type"),[xt,nn]=A.useState("name-asc"),[Ht,ut]=A.useState(!1),[jt,qt]=A.useState(!0),[Ut,on]=A.useState("list"),[jn,rn]=A.useState(0),Xt=A.useRef(new Map),ze=e=>{var l,i,c,g,y,C;const t=((l=e.card)==null?void 0:l.name)||e.name,a=e.printing||((i=e.cardObj)==null?void 0:i.printing),o=e.foil===!0||((c=e.card)==null?void 0:c.foil)===!0||((g=e.cardObj)==null?void 0:g.foil)===!0||((C=(y=e.cardObj)==null?void 0:y.card)==null?void 0:C.foil)===!0;return`${t}_${a||"unknown"}_${o}`},Kt=e=>{const t=ze(e);Rt(a=>{const o=new Set(a);return o.has(t)?o.delete(t):o.add(t),o})};A.useEffect(()=>{he.current.clear(),console.log("[PRICE CACHE] Cleared cache due to deck change")},[n==null?void 0:n._id]);const[_n,fn]=A.useState(!1);A.useEffect(()=>{if(!n||!F||F.length===0)return;const e=setTimeout(async()=>{console.log("[PRICE CACHE] Starting async price loading...");const t=F.slice(0,20);for(const o of t)try{await getCardPrice(o)}catch{}fn(!0),console.log("[PRICE CACHE] Initial price loading complete");const a=F.slice(20);setTimeout(async()=>{for(const o of a)try{await getCardPrice(o)}catch{}console.log("[PRICE CACHE] Background price loading complete")},1e3)},500);return()=>clearTimeout(e)},[n==null?void 0:n._id,F==null?void 0:F.length]),A.useEffect(()=>{$e.current%20===0&&console.log("[DEBUG] Deck state changed:",{deckExists:!!n,deckId:n==null?void 0:n._id,hasCommander:!!(n!=null&&n.commander)})},[n]);const Qt=A.useCallback(e=>{const t=a=>{const o=Array.from(Xt.current.values());if(o.length>0){const r=new Set(o.map(c=>{var g;return c.name||((g=c.card)==null?void 0:g.name)})),i=[...a.filter(c=>{var y;const g=c.name||((y=c.card)==null?void 0:y.name);return!r.has(g)}),...o];return wn(i)}return wn(a)};Y(typeof e=="function"?a=>t(e(a)):t(e))},[]),un=A.useCallback(async()=>{var e,t;if(!(!n||!n._id))try{const a=localStorage.getItem("token"),o="";if(!a)return;const r=await fetch(`${o}/api/decks/${n._id}`,{method:"GET",headers:{Authorization:`Bearer ${a}`},credentials:"include"});if(r.ok){const l=await r.json(),i=((e=l.cards)==null?void 0:e.length)||0,c=(F==null?void 0:F.length)||0,g=Array.from(Xt.current.entries());for(const[f,u]of g)((t=l.cards)==null?void 0:t.some(x=>{var _;return(x.name||((_=x.card)==null?void 0:_.name))===f}))?Xt.current.delete(f):P.warning(`${f} may not be properly saved to database. Please try moving it again.`,{duration:8e3});const y=F||[],C=(l.cards||[]).map(f=>{var x,_,S;const u=f.name||((x=f.card)==null?void 0:x.name),I=y.find(k=>{var N;return(k.name||((N=k.card)==null?void 0:N.name))===u});if(I){let k={...f};return I.modalPrice&&!f.modalPrice&&(k.modalPrice=I.modalPrice),I.type_line&&!f.type_line&&(k.type_line=I.type_line),(_=I.card)!=null&&_.type_line&&k.card&&typeof k.card=="object"&&!k.card.type_line&&(k.card.type_line=I.card.type_line),I.scryfall_json&&!f.scryfall_json&&(k.scryfall_json=I.scryfall_json),(S=I.card)!=null&&S.scryfall_json&&k.card&&typeof k.card=="object"&&!k.card.scryfall_json&&(k.card.scryfall_json=I.card.scryfall_json),k}return f}),d=(l.sideboard||[]).map(f=>{var _,S,k,E,N,j,v,W,O,R;const u=f.name||((_=f.card)==null?void 0:_.name),I=(S=n==null?void 0:n.sideboard)==null?void 0:S.find(D=>{var h;return(D.name||((h=D.card)==null?void 0:h.name))===u});if(I){let D={...f};return I.modalPrice&&!f.modalPrice&&(D.modalPrice=I.modalPrice),I.cardObj&&!f.cardObj&&(D.cardObj=I.cardObj),I.type_line&&!f.type_line&&(D.type_line=I.type_line),(k=I.card)!=null&&k.type_line&&D.card&&typeof D.card=="object"&&!D.card.type_line&&(D.card.type_line=I.card.type_line),I.scryfall_json&&!f.scryfall_json&&(D.scryfall_json=I.scryfall_json),(E=I.card)!=null&&E.scryfall_json&&D.card&&typeof D.card=="object"&&!D.card.scryfall_json&&(D.card.scryfall_json=I.card.scryfall_json),D}let x={...f};if(x.cardObj||(x.scryfall_json?x.cardObj={scryfall_id:x.scryfall_json.scryfall_id||x.printing,name:x.scryfall_json.name||x.name,set:x.scryfall_json.set,collector_number:x.scryfall_json.collector_number,image_uris:x.scryfall_json.image_uris,scryfall_json:x.scryfall_json}:x.cardObj={scryfall_id:x.printing,name:x.name,set:x.set||"unknown",collector_number:x.collector_number||"0",image_uris:x.image_uris||null,scryfall_json:x.scryfall_json||{name:x.name,scryfall_id:x.printing,prices:{usd:"0.25"}}}),!x.modalPrice){const D=[{source:"cardObj.scryfall_json.prices.usd",value:(v=(j=(N=x.cardObj)==null?void 0:N.scryfall_json)==null?void 0:j.prices)==null?void 0:v.usd},{source:"scryfall_json.prices.usd",value:(O=(W=x.scryfall_json)==null?void 0:W.prices)==null?void 0:O.usd},{source:"prices.usd",value:(R=x.prices)==null?void 0:R.usd},{source:"price",value:x.price}];let B=null,h="fallback";for(const G of D)if(G.value&&typeof G.value=="string"&&parseFloat(G.value)>0&&parseFloat(G.value)<1e3){B=G.value,h=G.source;break}B?x.modalPrice=B:x.modalPrice="0.25"}return x}),$=(l.techIdeas||[]).map(f=>{var N,j,v,W,O,R,D,B,h,G,U,b,te,re,ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Xe,Ie,De,ge,ue;const u=f.name||((N=f.card)==null?void 0:N.name),I=Date.now(),x=window.techIdeasProcessing||{},_=`${u}_${f._id||f.card}`;if(x[_]&&I-x[_]<5e3){const ee=(j=window.fixedTechIdeasCache)==null?void 0:j.get(u);if(ee&&Date.now()-ee.fixedAt<3e5&&(f.card=ee.card,ee.modalPrice)){const xe=parseFloat(ee.modalPrice.toString().replace(/^\$/,""));xe>0&&xe<100?f.modalPrice=ee.modalPrice:window.fixedTechIdeasCache.delete(u)}return f}x[_]=I,window.techIdeasProcessing=x;const S=(v=window.fixedTechIdeasCache)==null?void 0:v.get(u);if(S&&Date.now()-S.fixedAt<3e5)if(f.card=S.card,S.modalPrice){const ee=parseFloat(S.modalPrice.toString().replace(/^\$/,""));if(ee>0&&ee<100)return f.modalPrice=S.modalPrice,f;window.fixedTechIdeasCache.delete(u)}else return f;if(typeof f.card!="string"&&!f.modalPrice){const ee=((R=(O=(W=f.card)==null?void 0:W.scryfall_json)==null?void 0:O.prices)==null?void 0:R.usd)||((B=(D=f.scryfall_json)==null?void 0:D.prices)==null?void 0:B.usd);ee&&(f.modalPrice=`$${ee}`,window.fixedTechIdeasCache||(window.fixedTechIdeasCache=new Map),window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:f.modalPrice,fixedAt:Date.now()}))}if(typeof f.card=="string"){const ee=f.card;let xe={};if((h=f.scryfall_json)!=null&&h.prices?xe=f.scryfall_json.prices:f.name==="In the Trenches"&&(xe={usd:"0.31"}),f.card={scryfall_id:ee,name:f.name,scryfall_json:{scryfall_id:ee,name:f.name,...Object.keys(xe).length>0&&{prices:xe}}},f.modalPrice||(f.name==="In the Trenches"?f.modalPrice="$0.31":(b=(U=(G=f.card)==null?void 0:G.scryfall_json)==null?void 0:U.prices)!=null&&b.usd&&(f.modalPrice=`$${f.card.scryfall_json.prices.usd}`)),window.fixedTechIdeasCache||(window.fixedTechIdeasCache=new Map),f.modalPrice){const Ee=parseFloat(f.modalPrice.toString().replace(/^\$/,""));Ee>0&&Ee<100?window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:f.modalPrice,fixedAt:Date.now()}):window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:null,fixedAt:Date.now()})}else window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:null,fixedAt:Date.now()})}const k=(te=n==null?void 0:n.techIdeas)==null?void 0:te.find(ee=>{var Ee;return(ee.name||((Ee=ee.card)==null?void 0:Ee.name))===u});if(k){let ee={...f};if(k.modalPrice&&!f.modalPrice&&(ee.modalPrice=k.modalPrice),k.cardObj&&!f.cardObj&&(ee.cardObj=k.cardObj),!ee.modalPrice&&!f.modalPrice){const xe=[(Ze=(ve=(re=ee.cardObj)==null?void 0:re.scryfall_json)==null?void 0:ve.prices)==null?void 0:Ze.usd,(je=(me=(ie=ee.card)==null?void 0:ie.scryfall_json)==null?void 0:me.prices)==null?void 0:je.usd,k.modalPrice];let Ee=null;for(const Ae of xe)if(Ae&&typeof Ae=="string"&&parseFloat(Ae)>0&&parseFloat(Ae)<1e3){Ee=Ae;break}Ee||(Ee="0.25"),ee.modalPrice=Ee.startsWith("$")?Ee:`$${Ee}`}return k.type_line&&!f.type_line&&(ee.type_line=k.type_line),(qe=k.card)!=null&&qe.type_line&&ee.card&&typeof ee.card=="object"&&!ee.card.type_line&&(ee.card.type_line=k.card.type_line),k.scryfall_json&&!f.scryfall_json&&(ee.scryfall_json=k.scryfall_json),(yt=k.card)!=null&&yt.scryfall_json&&ee.card&&typeof ee.card=="object"&&!ee.card.scryfall_json&&(ee.card.scryfall_json=k.card.scryfall_json),ee}let E={...f};if(E.cardObj||(E.scryfall_json?E.cardObj={scryfall_id:E.scryfall_json.scryfall_id||E.printing,name:E.scryfall_json.name||E.name,set:E.scryfall_json.set,collector_number:E.scryfall_json.collector_number,image_uris:E.scryfall_json.image_uris,scryfall_json:E.scryfall_json}:E.card&&typeof E.card=="object"?E.cardObj=E.card:E.cardObj={scryfall_id:E.printing||(typeof E.card=="string"?E.card:"unknown"),name:E.name,set:E.set||"unknown",collector_number:E.collector_number||"0",image_uris:E.image_uris||null,scryfall_json:{name:E.name,scryfall_id:E.printing,prices:{usd:"0.31"}}}),!E.modalPrice){const ee=[{source:"cardObj.scryfall_json.prices.usd",value:(ht=(ke=(Ge=E.cardObj)==null?void 0:Ge.scryfall_json)==null?void 0:ke.prices)==null?void 0:ht.usd},{source:"card.scryfall_json.prices.usd",value:(Ie=(Xe=(et=E.card)==null?void 0:et.scryfall_json)==null?void 0:Xe.prices)==null?void 0:Ie.usd},{source:"scryfall_json.prices.usd",value:(ge=(De=E.scryfall_json)==null?void 0:De.prices)==null?void 0:ge.usd},{source:"prices.usd",value:(ue=E.prices)==null?void 0:ue.usd},{source:"price",value:E.price}];let xe=null,Ee="fallback";for(const Ae of ee)if(Ae.value&&typeof Ae.value=="string"&&parseFloat(Ae.value)>0&&parseFloat(Ae.value)<1e3){xe=Ae.value,Ee=Ae.source;break}xe||(xe="0.25",Ee="conservative_fallback"),E.modalPrice=xe}return E});Qt(C),le({...l,commander:n.commander||l.commander,commanderNames:n.commanderNames||l.commanderNames,cards:C,sideboard:d,techIdeas:$,lastUpdated:Date.now(),_verificationTimestamp:Date.now()})}else console.error("Failed to fetch fresh deck data:",r.status)}catch(a){console.error("Error during consistency check:",a)}},[n,F,Qt]);A.useCallback(async e=>{var t;if(!(!n||!n._id))try{const a=localStorage.getItem("token"),o="";if(!a)return;const r=((t=n.techIdeas)==null?void 0:t.map(i=>i.name===e.name?e:i))||[e],l=await fetch(`${o}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},credentials:"include",body:JSON.stringify({...n,techIdeas:r})});l.ok||console.error("Failed to save database fix, status:",l.status)}catch(a){console.error("Error saving database fix:",a)}},[n]),A.useEffect(()=>{},[n==null?void 0:n._id,un]),A.useEffect(()=>{},[n==null?void 0:n._id,un]);const[bt,sn]=A.useState(!1),[Se,Rt]=A.useState(new Set),[nt,Dt]=A.useState([]),[Wn,Jt]=A.useState(!1),[Yt,Pt]=A.useState(!1),[w,X]=A.useState(!1),[J,Z]=A.useState(!1),[Ce,ce]=A.useState(!1),[We,we]=A.useState(!1),[ae,He]=A.useState(""),[ot,Ue]=A.useState(!1),[Oe,rt]=A.useState(-1),[Nt,Je]=A.useState(!1),[ct,Te]=A.useState([]),[Tt,It]=A.useState(!1),[Ye,mt]=A.useState(new Map),[Ct,tt]=A.useState(new Map),[Mt,pt]=A.useState(""),[Lt,dt]=A.useState("");A.useEffect(()=>{if(Nt){const e=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${e}px`,document.body.style.width="100%",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.overflow="",window.scrollTo(0,e)}}},[Nt]),A.useEffect(()=>{const e=t=>{w&&!t.target.closest(".export-dropdown-container")&&X(!1),J&&!t.target.closest(".import-dropdown-container")&&Z(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[w,J]),A.useEffect(()=>()=>{},[]);const st=A.useCallback(e=>{if(!e){St({card:null});return}St(t=>{var u,I,x,_,S,k,E,N,j,v,W,O,R,D;const a=t==null?void 0:t.card,o=(a==null?void 0:a.name)||((u=a==null?void 0:a.card)==null?void 0:u.name),r=e.name||((I=e.card)==null?void 0:I.name);if(o===r&&a&&(!e.printing&&!a.printing||e.printing===a.printing))return t;let i={...e};const c={foil:e.foil,isFoil:e.isFoil||e.foil},g=e.showBackFace||e._flipState,y=i.name||((x=i.card)==null?void 0:x.name),C=gt[y],$=!(i.forceEnglish===!0)&&!C&&(i.printing||((_=i.card)==null?void 0:_.printing)||i.scryfall_json||i.image_uris||((S=i.card)==null?void 0:S.scryfall_json)||((k=i.card)==null?void 0:k.image_uris));if(C){const B=gt[y];i={...i,...c,printing:B,forceEnglish:!0,forceHighRes:!0,name:y,image_uris:null,scryfall_json:null,card:i.card?{...i.card,...c,printing:B,name:y,image_uris:null,scryfall_json:null}:{name:y,...c,printing:B,image_uris:null,scryfall_json:null}}}return C||($?(i.card&&typeof i.card=="object"&&i.card!==null?(i.card.printing=i.printing||i.card.printing,i.card={...i.card,...c},i.scryfall_json&&!i.card.scryfall_json&&(i.card.scryfall_json=i.scryfall_json),i.image_uris&&!i.card.image_uris&&(i.card.image_uris=i.image_uris)):i.card&&typeof i.card=="string"&&(console.warn("[CARD HOVER] card.card is a string (ObjectId), creating minimal object for:",y),i.card={_id:i.card,name:y,printing:i.printing,...c}),i={...i,...c}):y&&(i={...i,...c,forceEnglish:!0,forceHighRes:!0,name:y,image_uris:null,card:i.card?{...i.card,...c,name:y,image_uris:null}:{name:y,...c,image_uris:null}})),{...c,id:i.id||i.scryfall_id||((E=i.card)==null?void 0:E.id)||((N=i.card)==null?void 0:N.scryfall_id),scryfall_id:i.scryfall_id||i.id||((j=i.card)==null?void 0:j.scryfall_id)||((v=i.card)==null?void 0:v.id),printing:i.printing,card:{...i,...c,id:i.id||i.scryfall_id||((W=i.card)==null?void 0:W.id)||((O=i.card)==null?void 0:O.scryfall_id),scryfall_id:i.scryfall_id||i.id||((R=i.card)==null?void 0:R.scryfall_id)||((D=i.card)==null?void 0:D.id),printing:i.printing},top:0,left:0,flipState:g}})},[]);A.useEffect(()=>{Rt(new Set)},[Fe,xt]);const ft=A.useMemo(()=>nt.map((e,t)=>{const a=`${e.name}-${e.set||"default"}-${t}`;return{originalCard:e,cardKey:a,cardForHover:{name:e.name,id:e.id||e.scryfall_id,scryfall_id:e.scryfall_id||e.id,card:{name:e.name,id:e.id||e.scryfall_id,scryfall_id:e.scryfall_id||e.id,...e.image_uris&&{image_uris:e.image_uris},...e.scryfall_json&&{scryfall_json:e.scryfall_json},...e.mana_cost&&{mana_cost:e.mana_cost},...e.type_line&&{type_line:e.type_line},...e.oracle_text&&{oracle_text:e.oracle_text},...e.power&&{power:e.power},...e.toughness&&{toughness:e.toughness},...e.loyalty&&{loyalty:e.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:e.set||e.set_name||null,set:e.set||e.set_name||null,collector_number:e.collector_number||null}}}),[nt]),Ot=A.useRef(null);A.useMemo(()=>()=>{rt(-1)},[]);const at=A.useCallback((e,t,a)=>{var g,y;const o=gt[e.name];let r=e.printing||((g=e.cardObj)==null?void 0:g.printing);o&&(r=gt[e.name]);const l=`${e.name}-${e.printing||((y=e.cardObj)==null?void 0:y.scryfall_id)||"default"}`,i=a.get(l)||!1,c={...e.cardObj,foil:t,isFoil:t,name:e.name,printing:r,showBackFace:i,_flipState:i};st(c)},[st]),Me=A.useCallback(e=>{Kt(e)},[Kt]),At=A.useCallback((e,t,a,o,r,l)=>{if(o){r(e);return}let i={};e.cardObj&&typeof e.cardObj=="object"?i=JSON.parse(JSON.stringify(e.cardObj)):typeof e.cardObj=="string"&&(i={scryfall_id:e.cardObj,name:e.name,printing:e.printing},console.log(`[MODAL CLICK] cardObj was string ID, created object for: ${e.name}`));const c={...i,name:e.name,foil:t,count:e.count||1,price:a||null,printing:e.printing||i.printing};c.card&&typeof c.card=="object"?c.card.foil=t:typeof c.card=="string"&&console.log(`[MODAL CLICK] enrichedCardObj.card was string ID: ${c.card}`),l({isOpen:!0,cardObj:c})},[]),En=A.useCallback((e,t,a,o)=>{const r=JSON.parse(JSON.stringify(e.cardObj||{})),l=gt[e.name],i=l?ln(e.name):null;let c=e.printing||r.printing;l&&i&&(c=i,console.log(`üèûÔ∏è [MODAL] Using user preferred printing for ${e.name}: ${i}`));const g={...r,name:e.name,foil:t,count:e.count||1,price:a||null,printing:c,...l&&i&&{id:i,scryfall_id:i,image_uris:null,card:{...r.card,printing:i,scryfall_id:i,id:i,scryfall_json:null}}};g.card&&(g.card.foil=t),o({isOpen:!0,cardObj:g})},[]);A.useEffect(()=>{const e=t=>{t.key==="Escape"&&Nt&&Bt()};if(Nt){document.addEventListener("keydown",e);const t=document.querySelector("[data-search-modal]");t&&t.focus()}return()=>{document.removeEventListener("keydown",e)}},[Nt]);const Bt=()=>{xn.current&&xn.current.abort(),Je(!1),mt(new Map),dt(""),pt("")};A.useEffect(()=>{rt(-1),Ot.current=null},[nt,Yt]);const zt=A.useCallback(async e=>{var i,c,g,y,C,d,$,f;if(!n||!e){console.error("Cannot add card: missing deck or card data"),P.error("Cannot add card: missing deck or card data");return}if(!e.name){console.error("Cannot add card: missing card name"),P.error("Cannot add card: missing card name");return}const t=`${e.name}-${e.set||"default"}`,a=Date.now(),o=Ke.current.get(t);if(o&&a-o<1e3){P.info(`Please wait a moment before adding ${e.name} again`);return}Ke.current.set(t,a);const r=F.findIndex(u=>{var x;return(((x=u.card)==null?void 0:x.name)||u.name)===e.name});if(Array.from(Xt.current.values()).some(u=>{var x;return(u.name||((x=u.card)==null?void 0:x.name))===e.name})){P.info(`${e.name} is already in your deck (emergency restore active)`);return}if(r!==-1){const u=F[r],x=(u.count||u.quantity||1)+1;Io(u,{quantity:x}),le(_=>{if(!_)return _;const S=_.cards.map(k=>{var N;return(((N=k.card)==null?void 0:N.name)||k.name)===e.name?{...k,count:x,quantity:x}:k});return{..._,cards:S}}),P.success(`Added ${e.name} to deck (now ${x})`);return}try{const u=localStorage.getItem("token"),I="",x=!1,_=e.scryfall_id||e.id;if(!_){console.error("No Scryfall ID found in card data"),P.error("Unable to add card: missing ID information");return}const S={name:e.name,cardId:_,quantity:1,card:{name:e.name,id:_}};e.set&&(S.set=e.set),e.collector_number&&(S.collector_number=e.collector_number),e.finishes&&e.finishes.length>0&&(S.finishes=e.finishes);const k=`/api/decks/${n._id}`;console.log("üîß API URL Debug:",{apiUrl:I,isDev:x,url:k,finalUrl:x?`http://localhost:3001${k}`:`${I}${k}`});const E=x?`http://localhost:3001${k}`:`${I}${k}`,N=gt[e.name],j=N?ln(e.name):null;let v=e;N&&(console.log(`üèûÔ∏è [ADD CARD] Using user preferred printing for ${e.name}: ${j}`),v={...e,id:j,scryfall_id:j,printing:j,image_uris:null});const W={name:v.name,quantity:1,count:1,isCommander:!1,set:v.set,collector_number:v.collector_number,finishes:v.finishes||["nonfoil"],prices:v.prices,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,printing:v.printing||v.scryfall_id||v.id,card:{name:v.name,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,set:v.set,collector_number:v.collector_number,prices:v.prices,printing:v.printing||v.scryfall_id||v.id,scryfall_json:v,...v},scryfallCard:v,scryfall_json:v,_optimistic:!0};console.log("üèûÔ∏è BASIC LAND PRINTING FIX:",{cardName:e.name,isBasicLand:N,originalPrinting:e.printing||e.scryfall_id||e.id,preferredPrinting:j,finalPrinting:v.printing||v.scryfall_id||v.id,usingPreferred:N&&j!==(e.printing||e.scryfall_id||e.id)}),le(U=>U&&{...U,cards:[...U.cards,W],cardCount:U.cards.length+1}),Qt(U=>[...U,W]),P.success(`Adding ${e.name} to deck...`);const O={name:v.name,quantity:1,count:1,isCommander:!1,set:v.set,collector_number:v.collector_number,finishes:v.finishes||["nonfoil"],prices:v.prices||{},mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,printing:v.printing||v.scryfall_id||v.id,scryfall_id:v.id||v.scryfall_id,card:{name:v.name,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,set:v.set,collector_number:v.collector_number,printing:v.printing||v.scryfall_id||v.id,scryfall_id:v.id||v.scryfall_id}},R=(n.cards||[]).map(U=>{var b,te,re,ve,Ze,ie,me,je,qe;return{name:U.name,quantity:U.quantity||1,count:U.count||1,isCommander:U.isCommander||!1,set:U.set,collector_number:U.collector_number,finishes:U.finishes||["nonfoil"],prices:U.prices||{},mana_cost:U.mana_cost,color_identity:U.color_identity,cmc:U.cmc,type_line:U.type_line,scryfall_id:U.scryfall_id||((b=U.card)==null?void 0:b.scryfall_id),card:{name:U.name||((te=U.card)==null?void 0:te.name),mana_cost:U.mana_cost||((re=U.card)==null?void 0:re.mana_cost),color_identity:U.color_identity||((ve=U.card)==null?void 0:ve.color_identity),cmc:U.cmc||((Ze=U.card)==null?void 0:Ze.cmc),type_line:U.type_line||((ie=U.card)==null?void 0:ie.type_line),set:U.set||((me=U.card)==null?void 0:me.set),collector_number:U.collector_number||((je=U.card)==null?void 0:je.collector_number),scryfall_id:U.scryfall_id||((qe=U.card)==null?void 0:qe.scryfall_id)}}}),B={_id:n._id,name:n.name,format:n.format,commander:n.commander,cards:[...R,O],...n.sideboard&&{sideboard:n.sideboard},...n.techIdeas&&{techIdeas:n.techIdeas},...n.description&&{description:n.description},...n.colors&&{colors:n.colors}},h=JSON.stringify(B);console.log("üöÄ Sending PUT request to:",E),console.log("üì¶ Request body deck structure:",{deckId:B._id,cardsCount:(i=B.cards)==null?void 0:i.length,newCardName:O.name,requestSize:h.length,hasNestedScryfall:O.scryfall_json?"YES":"NO",cardObjectKeys:Object.keys(O),sampleCardSize:JSON.stringify(O).length,serverEnvironment:x?"DEVELOPMENT":"PRODUCTION",timestamp:new Date().toISOString()}),h.length>5e4&&(console.warn("‚ö†Ô∏è Large request detected:",h.length,"bytes"),console.log("üìä Card data sample:",JSON.stringify(O).substring(0,500)+"..."));const G=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},credentials:"include",body:JSON.stringify(B)});if(G.ok){const U=await G.json();console.log("[DEBUG] Server response after card addition:",{commander:U.commander,commanderNames:U.commanderNames,cardsCount:(c=U.cards)==null?void 0:c.length,timestamp:new Date().toISOString(),deckId:U._id});const b=(g=U.cards)==null?void 0:g.find(ie=>{var me;return(((me=ie.card)==null?void 0:me.name)||ie.name)===e.name});console.log("[DEBUG] Added card verification:",{cardName:e.name,foundInResponse:!!b,cardDetails:b,totalCardsAfterAdd:(y=U.cards)==null?void 0:y.length}),console.log("[DEBUG] All card names in server response:",(C=U.cards)==null?void 0:C.map(ie=>{var me;return((me=ie.card)==null?void 0:me.name)||ie.name}).sort());const te=(U.cards||[]).map(ie=>{var je,qe,yt,Ge,ke;const me=B.cards.find(ht=>{var Ie,De;const et=ie.name||((Ie=ie.card)==null?void 0:Ie.name),Xe=ht.name||((De=ht.card)==null?void 0:De.name);return et===Xe});return me?{...me,...ie,card:{...me.card,...ie.card||{},type_line:((je=me.card)==null?void 0:je.type_line)||me.type_line||ie.type_line,scryfall_json:((qe=me.card)==null?void 0:qe.scryfall_json)||me.scryfall_json,mana_cost:((yt=me.card)==null?void 0:yt.mana_cost)||me.mana_cost,color_identity:((Ge=me.card)==null?void 0:Ge.color_identity)||me.color_identity,cmc:((ke=me.card)==null?void 0:ke.cmc)||me.cmc}}:ie}),re={...U,cards:gn({...U,cards:te})};le(ie=>({...re,sideboard:(ie==null?void 0:ie.sideboard)||[],techIdeas:(ie==null?void 0:ie.techIdeas)||[]})),Qt(re.cards||[]),P.success(`Successfully added ${e.name} to deck!`);try{if(re.cards.find(me=>{var qe;return(((qe=me.card)==null?void 0:qe.name)||me.name)===e.name})&&_){const me=e.name,je=`https://api.scryfall.com/cards/search?q=unique:prints+!"${encodeURIComponent(me)}"`,qe=await fetch(je);if(qe.ok){const yt=await qe.json(),Ge=((d=yt.data)==null?void 0:d.find(ke=>ke.id===_))||(($=yt.data)==null?void 0:$[0]);if(Ge){const ke=Ge.prices||{},ht=Ge.finishes||[],et=Ge.promo_types||[],Xe=Ge.foil===!0&&Ge.nonfoil===!1||ht.includes("foil")&&!ht.includes("nonfoil");let Ie=null;Xe?ht.includes("etched")||(f=Ge.frame_effects)!=null&&f.includes("etched")?Ie=ke.usd_etched||ke.usd_foil||ke.usd||null:(et.includes("surgefoil")||et.includes("rainbow")||et.includes("textured")||et.includes("boosterfun"),Ie=ke.usd_foil||ke.usd||null):Ie=ke.usd||null;const De=re.cards.map(ge=>{var ee;if((((ee=ge.card)==null?void 0:ee.name)||ge.name)===e.name){const xe=Ie!=null&&Ie!=="undefined"?Ie:null;return{...ge,card:{...ge.card,scryfall_json:Ge,prices:Ge.prices,modalPrice:xe},scryfall_json:Ge,prices:Ge.prices,modalPrice:xe,lastUpdated:Date.now()}}return ge});re.cards=De}}}}catch{}const ve=re.cards.map(ie=>{var qe,yt,Ge,ke;const me=((qe=ie.card)==null?void 0:qe.name)||ie.name,je=F.find(ht=>{var Xe;return(((Xe=ht.card)==null?void 0:Xe.name)||ht.name)===me});return je&&je!==ie?{...ie,card:{...ie.card,...((yt=je.card)==null?void 0:yt.scryfall_json)&&{scryfall_json:je.card.scryfall_json},...((Ge=je.card)==null?void 0:Ge.prices)&&{prices:je.card.prices},...((ke=je.card)==null?void 0:ke.modalPrice)!==void 0&&{modalPrice:je.card.modalPrice}},...je.scryfall_json&&{scryfall_json:je.scryfall_json},...je.prices&&{prices:je.prices},...je.modalPrice!==void 0&&{modalPrice:je.modalPrice}}:ie}),Ze={...re,_id:n._id,cards:ve};le(ie=>({...Ze,sideboard:(ie==null?void 0:ie.sideboard)||[],techIdeas:(ie==null?void 0:ie.techIdeas)||[]})),Y(ve),P.success(`Added ${e.name} to deck`)}else{le(b=>b&&{...b,cards:b.cards.filter(te=>!te._optimistic||te.name!==e.name),cardCount:b.cards.length-1});const U=await G.text();console.error("Failed to add card to deck:",G.status,G.statusText),console.error("Server error response:",U),P.error(`Failed to add card to deck: ${G.status} - ${U||G.statusText}`)}}catch(u){le(I=>I&&{...I,cards:I.cards.filter(x=>!x._optimistic||x.name!==e.name),cardCount:I.cards.length-1}),console.error("Error adding card to deck:",u.message),P.error(`Error adding card to deck: ${u.message}. Please try again.`)}},[n,le,gn]);so.useEffect(()=>{typeof window<"u"&&n&&zt&&(window.testCardPersistence=async(e="Island")=>{var a;console.log(`üß™ [PERSISTENCE TEST] Starting test with card: ${e}`),console.log("üß™ [PERSISTENCE TEST] Current deck cards before:",(a=n.cards)==null?void 0:a.length);const t={name:e,scryfall_id:"23635e40-d040-40b7-8b98-90ed362aa028",id:"23635e40-d040-40b7-8b98-90ed362aa028",set:"fdn",collector_number:"275"};try{await zt(t),console.log("üß™ [PERSISTENCE TEST] Add completed, waiting 2 seconds..."),setTimeout(async()=>{var i,c,g;console.log("üß™ [PERSISTENCE TEST] Testing persistence by refetching deck...");const o="",r=localStorage.getItem("token"),l=await fetch(`${o}/api/decks/${n._id}`,{headers:{Authorization:`Bearer ${r}`}});if(l.ok){const y=await l.json(),C=(i=y.cards)==null?void 0:i.some(d=>{var $;return((($=d.card)==null?void 0:$.name)||d.name)===e});console.log("üß™ [PERSISTENCE TEST] Card found in fresh fetch:",C),console.log("üß™ [PERSISTENCE TEST] Fresh deck cards count:",(c=y.cards)==null?void 0:c.length),console.log("üß™ [PERSISTENCE TEST] Fresh deck cards:",(g=y.cards)==null?void 0:g.map(d=>{var $;return(($=d.card)==null?void 0:$.name)||d.name}).sort())}else console.error("üß™ [PERSISTENCE TEST] Failed to refetch deck:",l.status)},2e3)}catch(o){console.error("üß™ [PERSISTENCE TEST] Error:",o)}},console.log("üß™ Persistence test available: window.testCardPersistence()"))},[n,zt]);const[Et,Oo]=A.useState(new Map),mn=A.useMemo(()=>{if(!n)return[];let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0?e=n.commander.filter(t=>t!=null):n.commander&&typeof n.commander=="object"&&n.commander!==null&&!Array.isArray(n.commander)?e=[n.commander]:typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]),n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const t=n.commanderNames.filter(a=>typeof a=="string"&&a.trim());e=e.concat(t)}return e.map(t=>{var o;const a=((o=t.card)==null?void 0:o.name)||t.name||t;return typeof a=="string"?a.toLowerCase():""}).filter(t=>t)},[n]),Do=async(e,t)=>{var o,r,l,i,c,g,y,C,d,$,f;if(!e||!t){console.error("Invalid card data provided for printing update"),P.error("Could not update card printing. Invalid data.");return}Ue(!0);const a=((o=e.card)==null?void 0:o.name)||e.name;if(t&&typeof t.cmc>"u"){const u=((r=e==null?void 0:e.scryfall_json)==null?void 0:r.cmc)||((i=(l=e==null?void 0:e.card)==null?void 0:l.scryfall_json)==null?void 0:i.cmc)||(e==null?void 0:e.cmc)||((c=e==null?void 0:e.card)==null?void 0:c.cmc);u!==void 0&&(t.cmc=u)}try{const u=Array.isArray(t.finishes)?t.finishes:[],I=u.includes("nonfoil"),x=u.includes("foil")||u.includes("etched");let _=I,S=x;if(u.length===0){const b=(g=t.set)==null?void 0:g.toLowerCase(),te=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(b),re=["ocm1","pcm1"].includes(b);te?(_=!0,S=!1):re?(_=!1,S=!0):(_=!0,S=!0)}const k=e.foil||((y=e.card)==null?void 0:y.foil)||!1;let E=k;t.modalFoilStatus!==void 0?t.modalFoilStatus===!0?S?E=!0:E=!1:_?E=!1:E=!0:!_&&S?E=!0:_&&!S?E=!1:_&&S&&(E=k);let N=null;if(t.modalPrice!==void 0&&t.modalPrice!==null)N=t.modalPrice;else{const b=t.prices||{},te=t.finishes||[];t.foil===!0&&t.nonfoil===!1||te.includes("foil")&&!te.includes("nonfoil")?te.includes("etched")||(C=t.frame_effects)!=null&&C.includes("etched")?N=b.usd_etched||b.usd_foil||b.usd||null:N=b.usd_foil||b.usd||null:E?N=b.usd_foil||b.usd||null:N=b.usd||null}const j={_id:e._id,id:e.id,name:((d=e.card)==null?void 0:d.name)||e.name,count:e.count||1,foil:E,printing:t.id,modalPrice:N!=null&&N!=="undefined"?N:null,cmc:t.cmc,mana_cost:t.mana_cost,type_line:t.type_line,color_identity:t.color_identity,card:{...($=e.card)!=null&&$._id?{_id:e.card._id}:{},name:t.name,set:t.set,collector_number:t.collector_number,cmc:t.cmc,mana_cost:t.mana_cost,type_line:t.type_line,color_identity:t.color_identity,foil:E,modalPrice:N,prices:t.prices||{},image_uris:t.image_uris||null,scryfall_json:t},scryfall_json:t,image_uris:t.image_uris||null},v=Be==null?void 0:Be.card,W=(v==null?void 0:v.name)||((f=v==null?void 0:v.card)==null?void 0:f.name);if(v&&W===a){const b={...v,printing:t.id,foil:E,scryfall_json:t,image_uris:t.image_uris,...v.card?{card:{...v.card,...j.card,foil:E}}:{}};St({card:b,top:0,left:0}),st({name:a,id:t.id,scryfall_id:t.id,printing:t.id,foil:E,scryfall_json:t,image_uris:t.image_uris})}if(m.isOpen&&m.cardObj){const b={...m.cardObj,printing:t.id,foil:E,scryfall_json:t,image_uris:t.image_uris,card:{...m.cardObj.card,...j.card,foil:E}};L({isOpen:!0,cardObj:b})}const O=F.map(b=>{var te;return b&&(((te=b.card)==null?void 0:te.name)||b.name)===a?{...b,printing:t.id,foil:E,scryfall_json:t,image_uris:t.image_uris,modalPrice:N,cmc:j.cmc,mana_cost:j.mana_cost,type_line:j.type_line,color_identity:j.color_identity,card:{...b.card,...j.card,foil:E,modalPrice:N}}:b});Y(O);const R=b=>b&&typeof b=="string"&&/^[0-9a-fA-F]{24}$/.test(b),D=O.map(b=>{var ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Xe,Ie,De,ge,ue,ee,xe,Ee,Ae,Ft,wt,Zt,kn,$n,Pn,Nn,An,Rn,Tn,Mn,Fn,Un,On,Dn,Po;const te=b.modalPrice!==void 0&&b.modalPrice!==null&&b.modalPrice!=="undefined"?b.modalPrice:null;let re={name:((ve=b.card)==null?void 0:ve.name)||b.name,count:b.count||1,quantity:b.count||1,printing:b.printing||null,isCommander:b.isCommander||!1,...b.foil!==void 0?{foil:b.foil}:{},set:b.set||((Ze=b.card)==null?void 0:Ze.set)||((ie=b.scryfall_json)==null?void 0:ie.set),collector_number:b.collector_number||((me=b.card)==null?void 0:me.collector_number)||((je=b.scryfall_json)==null?void 0:je.collector_number),finishes:b.finishes||((qe=b.scryfall_json)==null?void 0:qe.finishes)||["nonfoil"],prices:b.prices||((yt=b.card)==null?void 0:yt.prices)||((Ge=b.scryfall_json)==null?void 0:Ge.prices)||{},mana_cost:b.mana_cost||((ke=b.card)==null?void 0:ke.mana_cost)||((ht=b.scryfall_json)==null?void 0:ht.mana_cost),color_identity:b.color_identity||((et=b.card)==null?void 0:et.color_identity)||((Xe=b.scryfall_json)==null?void 0:Xe.color_identity),cmc:b.cmc||((Ie=b.card)==null?void 0:Ie.cmc)||((De=b.scryfall_json)==null?void 0:De.cmc),type_line:b.type_line||((ge=b.card)==null?void 0:ge.type_line)||((ue=b.scryfall_json)==null?void 0:ue.type_line),scryfall_id:b.scryfall_id||((ee=b.card)==null?void 0:ee.scryfall_id)||((xe=b.scryfall_json)==null?void 0:xe.id),...te!==null?{modalPrice:te}:{}};return b._id&&R(b._id)&&(re._id=b._id),b.card?typeof b.card=="object"&&b.card!==null?b.card._id&&R(b.card._id)?re.card=b.card._id:re.card={name:b.card.name||b.name,set:b.card.set||b.set||((Ee=b.scryfall_json)==null?void 0:Ee.set),collector_number:b.card.collector_number||b.collector_number||((Ae=b.scryfall_json)==null?void 0:Ae.collector_number),mana_cost:b.card.mana_cost||b.mana_cost||((Ft=b.scryfall_json)==null?void 0:Ft.mana_cost),color_identity:b.card.color_identity||b.color_identity||((wt=b.scryfall_json)==null?void 0:wt.color_identity),cmc:b.card.cmc||b.cmc||((Zt=b.scryfall_json)==null?void 0:Zt.cmc),type_line:b.card.type_line||b.type_line||((kn=b.scryfall_json)==null?void 0:kn.type_line),...b.card._id&&R(b.card._id)?{_id:b.card._id}:{}}:typeof b.card=="string"&&(R(b.card)?re.card=b.card:re.card={name:b.name,set:b.set||(($n=b.scryfall_json)==null?void 0:$n.set),collector_number:b.collector_number||((Pn=b.scryfall_json)==null?void 0:Pn.collector_number),mana_cost:b.mana_cost||((Nn=b.scryfall_json)==null?void 0:Nn.mana_cost),color_identity:b.color_identity||((An=b.scryfall_json)==null?void 0:An.color_identity),cmc:b.cmc||((Rn=b.scryfall_json)==null?void 0:Rn.cmc),type_line:b.type_line||((Tn=b.scryfall_json)==null?void 0:Tn.type_line)}):re.card={name:b.name,set:b.set||((Mn=b.scryfall_json)==null?void 0:Mn.set),collector_number:b.collector_number||((Fn=b.scryfall_json)==null?void 0:Fn.collector_number),mana_cost:b.mana_cost||((Un=b.scryfall_json)==null?void 0:Un.mana_cost),color_identity:b.color_identity||((On=b.scryfall_json)==null?void 0:On.color_identity),cmc:b.cmc||((Dn=b.scryfall_json)==null?void 0:Dn.cmc),type_line:b.type_line||((Po=b.scryfall_json)==null?void 0:Po.type_line)},re});console.log("[PRINTING UPDATE] Sending updated cards to server:",D),console.log("[PRINTING UPDATE] Full payload:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames});const B=localStorage.getItem("token");if(!B)throw new Error("No authentication token found. Please log in again.");const G=await fetch(`/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`},credentials:"include",body:JSON.stringify({cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})});if(!G.ok){let b,te;try{te=await G.json(),b=JSON.stringify(te),console.error("[PRINTING UPDATE] Server error:",G.status,te),console.error("[PRINTING UPDATE] Request payload that failed:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})}catch{b=await G.text(),console.error("[PRINTING UPDATE] Server error:",G.status,b),console.error("[PRINTING UPDATE] Request payload that failed:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})}throw new Error(`Printing update server error ${G.status}: ${b}`)}const U=await G.json();U!=null&&U.cards&&(U.cards=U.cards.map(b=>{var ve,Ze,ie,me;const te=b.modalPrice!==void 0&&b.modalPrice!==null&&b.modalPrice!=="undefined"?b.modalPrice:null,re=((ve=b.card)==null?void 0:ve.modalPrice)!==void 0&&((Ze=b.card)==null?void 0:Ze.modalPrice)!==null&&((ie=b.card)==null?void 0:ie.modalPrice)!=="undefined"?(me=b.card)==null?void 0:me.modalPrice:null;return{...b,modalPrice:te,...b.card?{card:{...b.card,modalPrice:re}}:{}}})),le(b=>({...b,...U,cards:O,sideboard:(b==null?void 0:b.sideboard)||[],techIdeas:(b==null?void 0:b.techIdeas)||[]})),P.success(`Updated ${a} to ${t.set_name}.`)}catch(u){console.error("Failed to save updated deck:",u),u.message.includes("mongoose")?P.error("Failed to save printing change due to a server connection issue. Please try again."):u.message.includes("not defined")?(P.error("Failed to save printing change due to a code issue. The developers have been notified."),console.error("Code Error in handlePrintingUpdate:",u.message,u.stack)):P.error(`Failed to save printing change: ${u.message}`)}finally{Ue(!1)}};A.useEffect(()=>{const e=t=>{t.key==="Escape"&&m.isOpen&&(t.preventDefault(),L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1}))};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[]),A.useEffect(()=>{function e(t){t.key==="Escape"&&m.isOpen&&(t.preventDefault(),t.stopPropagation(),L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1}))}return m.isOpen&&(document.addEventListener("keydown",e,!0),window.addEventListener("keydown",e,!0)),()=>{document.removeEventListener("keydown",e,!0),window.removeEventListener("keydown",e,!0)}},[m.isOpen]),A.useEffect(()=>{if(pe.current=!0,(()=>{if(window.fixedTechIdeasCache){const c=[],g=[];for(const[y,C]of window.fixedTechIdeasCache.entries())if(C.modalPrice){const d=parseFloat(C.modalPrice.toString().replace(/^\$/,""));(d>100||d<=0)&&(c.push({name:y,price:C.modalPrice,priceNum:d}),g.push(y))}g.length>0&&g.forEach(y=>window.fixedTechIdeasCache.delete(y))}})(),!T||!/^[0-9a-fA-F]{24}$/.test(T)){console.error("Invalid deck ID format:",T),P.error("Invalid deck ID. Redirecting to home page..."),setTimeout(()=>{Qe("/")},2e3),be(!1);return}if(fe.current||Q.current===T)return;fe.current=!0,Q.current=T;const t=new AbortController,a=setTimeout(()=>{console.error("Request timeout for deck ID:",T,"- Server may be cold starting, please try refreshing"),t.abort()},3e4),o=`?_cb=${Date.now()}`,r="",l=localStorage.getItem("token"),i=p?`/api/public/decks/${T}`:`/api/decks/${T}`;return fetch(`${r}${i}${o}`,{signal:t.signal,cache:"no-cache",headers:{"Cache-Control":"no-cache",Pragma:"no-cache",...!p&&l?{Authorization:`Bearer ${l}`}:{}}}).then(async c=>{if(clearTimeout(a),!c.ok)throw c.status===404?(console.error("404 Error for deck ID:",T),new Error("DECK_NOT_FOUND")):new Error(`HTTP ${c.status}: ${c.statusText}`);return c.json()}).then(c=>{var d,$,f,u,I;if(!pe.current)return;if(console.log("[DEBUG] Deck loaded from server - commander properties:",{commander:c.commander,commanderNames:c.commanderNames,hasCommander:"commander"in c,hasCommanderNames:"commanderNames"in c,allKeys:Object.keys(c),fullDeckData:c}),console.log("[DEBUG] Deck loaded from server - sideboard/techIdeas check:",{hasSideboard:"sideboard"in c,hasTechiIdeas:"techIdeas"in c,sideboardData:c.sideboard,techIdeasData:c.techIdeas,sideboardCount:((d=c.sideboard)==null?void 0:d.length)||0,techIdeasCount:(($=c.techIdeas)==null?void 0:$.length)||0}),!c.commander&&c.cards&&c.cards.length>0){const x=c.cards.filter(_=>{var E,N,j;const S=((E=_.card)==null?void 0:E.name)||_.name||"",k=((N=_.card)==null?void 0:N.type_line)||_.type_line||"";return console.log("[COMMANDER INFERENCE] Checking card:",{cardName:S,cardType:k,cardObj:_,hasCard:!!_.card,hasTypeLine:!!((j=_.card)!=null&&j.type_line||_.type_line),fullCard:_}),k.toLowerCase().includes("legendary")&&k.toLowerCase().includes("creature")});if(x.length>0){const _=x[0],S=((f=_.card)==null?void 0:f.name)||_.name;console.log("[COMMANDER FIX] Server missing commander data, inferring from cards:",{inferredCommander:S,fromCard:_,potentialCommanders:x.length}),c.commander=S,c.commanderNames=[S]}else if(c.format==="Commander / EDH"&&c.cards.length>0){const _=c.cards[0],S=((u=_.card)==null?void 0:u.name)||_.name;console.log("[COMMANDER FIX] No legendary creatures found, but Commander format - assuming first card is commander:",{assumedCommander:S,format:c.format,firstCard:_}),c.commander=S,c.commanderNames=[S]}}c!=null&&c.cards&&(c.cards=c.cards.map(x=>{var k,E,N,j;const _=x.modalPrice!==void 0&&x.modalPrice!==null&&x.modalPrice!=="undefined"?x.modalPrice:null,S=((k=x.card)==null?void 0:k.modalPrice)!==void 0&&((E=x.card)==null?void 0:E.modalPrice)!==null&&((N=x.card)==null?void 0:N.modalPrice)!=="undefined"?(j=x.card)==null?void 0:j.modalPrice:null;return{...x,modalPrice:_,...x.card?{card:{...x.card,modalPrice:S}}:{}}})),(I=c==null?void 0:c.cards)!=null&&I.filter(x=>{var _,S;return x.modalPrice!==null&&x.modalPrice!==void 0||((_=x.card)==null?void 0:_.modalPrice)!==null&&((S=x.card)==null?void 0:S.modalPrice)!==void 0});const C=gn(c).filter(x=>{var k;if(!x)return!1;const _=((k=x.card)==null?void 0:k.name)||x.name||"",S=/^(test|example|placeholder|unknown|null|undefined|sample)/i;return _.length>2&&!S.test(_)}).map((x,_)=>{var B,h,G;if(!x)return console.warn(`[Card Verifier] Card at index ${_} is null.`),Promise.resolve(null);const S=((B=x.card)==null?void 0:B.name)||x.name||`(unknown card at index ${_})`;if(!!x.scryfall_json)return Promise.resolve(x);const E=x.printing,N=(h=x.card)==null?void 0:h.set,j=(G=x.card)==null?void 0:G.collector_number,v=`${E||"no-id"}:${S||"no-name"}`;if(ao.has(v))return Promise.resolve(x);const W=U=>!U||typeof U!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(U),O=U=>{if(!U||typeof U!="string")return!1;const b=/^(test|example|placeholder|unknown|null|undefined|sample)/i;return U.length>2&&!b.test(U)};let R=null,D="";return N&&j?(R=`https://api.scryfall.com/cards/${N.toLowerCase()}/${j}`,D=`set/collector number ${N}/${j}`):E&&W(E)?(R=`https://api.scryfall.com/cards/${E}`,D=`printing ID ${E}`):S&&O(S)&&(R=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(S)}`,D=`card name "${S}"`),R?R?fetch(R.startsWith("http")?R:`${R}`).then(b=>{if(!b.ok){if(b.status===404)return console.debug(`[Scryfall] Card not found: "${S}" (${D}) - using original data`),Promise.resolve(x);throw console.warn(`[SCRYFALL ERROR] Failed to fetch card data for "${S}" using ${D}. Status: ${b.status}`),new Error(`Scryfall fetch failed for ${D} with status ${b.status}`)}return b.json()}).then(b=>{if(b===x)return b;const te={...x,scryfall_json:b,printing:b.id};return te.card&&(te.card.scryfall_json=b,te.card.prices=b.prices),te}).catch(b=>(console.error(`[Card Fetch] Failed for "${S}" using ${D}:`,b.message),{...x,scryfall_fetch_failed:!0})):(console.warn(`[Card Verifier] Cannot fetch "${S}" - no identifier available.`),Promise.resolve(x)):(ao.add(v),E&&!W(E)?console.warn(`[Card Validation] Skipping invalid printing ID "${E}" for card "${S}"`):S&&!O(S)?console.warn(`[Card Validation] Skipping invalid card name "${S}"`):console.warn(`[Card Validation] No valid fetch method available for card "${S}"`),Promise.resolve(x))});Promise.all(C).then(x=>{const _=x.filter(R=>R);if(!pe.current)return;const S=_.map(R=>{var te,re,ve,Ze,ie,me;(te=R.card)!=null&&te.name||R.name;const D=R.modalPrice!==void 0&&R.modalPrice!==null&&R.modalPrice!=="undefined"?R.modalPrice:null,B=((re=R.card)==null?void 0:re.modalPrice)!==void 0&&((ve=R.card)==null?void 0:ve.modalPrice)!==null&&((Ze=R.card)==null?void 0:Ze.modalPrice)!=="undefined"?(ie=R.card)==null?void 0:ie.modalPrice:null,h=R.foil===!0||((me=R.card)==null?void 0:me.foil)===!0,G={...R,foil:h,modalPrice:D,...R.card?{card:{...R.card,foil:h,modalPrice:B}}:{},...R.cardObj?{cardObj:{...R.cardObj,foil:h,...R.cardObj.card?{card:{...R.cardObj.card,foil:h}}:{}}}:{}},U=Vt(G),b=R.count!==void 0?R.count:R.quantity||1;return{...G,count:b,price:U.price,lastUpdated:Date.now(),...G.card?{card:{...G.card,count:b,price:U.price,lastUpdated:Date.now()}}:{}}}),k=wn(S);console.log(`[DEBUG] Processed cards: ${S.length}, Filtered cards: ${k.length}`);const E={...c,cards:k},N=gn(E),j={...E,cards:N};console.log(`[DEBUG] Final deck card count: ${j.cards.length}`),console.log("[DEBUG] Loaded deck card names:",j.cards.map(R=>{var D;return((D=R.card)==null?void 0:D.name)||R.name}).sort()),console.log("[DEBUG] Deck load timestamp:",new Date().toISOString(),"Total cards:",j.cards.length),console.log("[DEBUG] Final deck data commander properties:",{commander:j.commander,commanderNames:j.commanderNames,hasCommander:"commander"in j,hasCommanderNames:"commanderNames"in j,originalDataCommander:c.commander,originalDataCommanderNames:c.commanderNames}),console.log("[DEBUG] About to call setDeck with:",j);const v=Lo(c._id);let W=j.cards;if(v.sideboard.length>0||v.techIdeas.length>0){const R=new Set([...v.sideboard.map(B=>{var h;return B.name||((h=B.card)==null?void 0:h.name)}),...v.techIdeas.map(B=>{var h;return B.name||((h=B.card)==null?void 0:h.name)})].filter(Boolean)),D=W.length;W=W.filter(B=>{var G;const h=B.name||((G=B.card)==null?void 0:G.name);return!R.has(h)}),D!==W.length&&(console.log(`[PERSISTENCE] üîÑ Removed ${D-W.length} duplicate cards from main deck that exist in zones`),console.log("[PERSISTENCE] Zone card names:",Array.from(R))),console.log(`[PERSISTENCE] ‚úÖ Restored ${v.sideboard.length} sideboard + ${v.techIdeas.length} tech ideas from localStorage`)}const O={...j,cards:W,sideboard:v.sideboard,techIdeas:v.techIdeas};(c.isPublic||c.readOnly)&&M(!0),le(O),console.log("[DEBUG] setDeck called with commander data:",{passedCommander:O.commander,passedCommanderNames:O.commanderNames,sideboardCount:v.sideboard.length,techIdeasCount:v.techIdeas.length,isReadOnly:c.isPublic||c.readOnly||!1}),Ne(c.name),Y(W),oe(!1),be(!1),Nr(N,ye.current),setTimeout(()=>{var D,B,h,G;let R=null;if(c.commander)if(Array.isArray(c.commander)&&c.commander.length>0){const U=c.commander[0],b=U.name||U;R=N.find(te=>{var re;return(((re=te.card)==null?void 0:re.name)||te.name)===b}),(D=R==null?void 0:R.card)!=null&&D.name||(R==null||R.name)}else typeof c.commander=="object"&&c.commander!==null?(R=N.find(U=>{var b;return(((b=U.card)==null?void 0:b.name)||U.name)===c.commander.name}),(B=R==null?void 0:R.card)==null||B.name):typeof c.commander=="string"&&(R=N.find(U=>{var b;return(((b=U.card)==null?void 0:b.name)||U.name)===c.commander}),(h=R==null?void 0:R.card)!=null&&h.name||(R==null||R.name));if(!R){const b=pn(N,[]).find(te=>te.type==="Commander");b&&b.cards.length>0&&(R=b.cards[0],(G=R==null?void 0:R.card)!=null&&G.name||(R==null||R.name))}R?st(R):N.length>0&&st(N[0])},100)})}).catch(c=>{if(clearTimeout(a),c.name==="AbortError"){console.error("Deck loading timed out for deck ID:",T),P.error("Deck loading timed out. The server may be starting up - please try refreshing the page.",{duration:8e3}),pe.current&&be(!1);return}console.error("Error loading deck:",c),c.message==="DECK_NOT_FOUND"?(P.error("Deck not found. Redirecting to home page..."),setTimeout(()=>{Qe("/")},2e3)):c.message.includes("Failed to fetch")?P.error("Network error loading deck. Please check your connection and try again.",{duration:6e3}):P.error("Failed to load deck: "+c.message),pe.current&&be(!1)}).finally(()=>{clearTimeout(a),fe.current=!1}),()=>{pe.current=!1,t.abort(),fe.current=!1}},[T]);const Wt=(e,t,a)=>{try{const o=`deck_zones_${e}`,r={sideboard:t||[],techIdeas:a||[],lastUpdated:Date.now()};localStorage.setItem(o,JSON.stringify(r)),console.log(`[STORAGE] Saved sideboard/techIdeas to localStorage for deck ${e}:`,{sideboardCount:r.sideboard.length,techIdeasCount:r.techIdeas.length})}catch(o){console.error("[STORAGE] Failed to save sideboard/techIdeas to localStorage:",o)}},Lo=e=>{var t,a;try{const o=`deck_zones_${e}`,r=localStorage.getItem(o);if(r){const l=JSON.parse(r);return console.log(`[STORAGE] Loaded sideboard/techIdeas from localStorage for deck ${e}:`,{sideboardCount:((t=l.sideboard)==null?void 0:t.length)||0,techIdeasCount:((a=l.techIdeas)==null?void 0:a.length)||0,age:Math.round((Date.now()-l.lastUpdated)/1e3/60)+" minutes"}),{sideboard:l.sideboard||[],techIdeas:l.techIdeas||[]}}}catch(o){console.error("[STORAGE] Failed to load sideboard/techIdeas from localStorage:",o)}return{sideboard:[],techIdeas:[]}},Hn=async e=>{var t,a,o,r;try{const l="",i=localStorage.getItem("token");if(!i){console.error("[SAVE DECK] No authentication token found"),P.error("Cannot save: Not logged in");return}const c=(e.cards||[]).map(d=>{var $,f,u,I,x,_,S,k,E,N,j,v,W,O,R,D;return{name:d.name||(($=d.card)==null?void 0:$.name),quantity:d.quantity||1,count:d.count||1,isCommander:d.isCommander||!1,set:d.set||((f=d.card)==null?void 0:f.set),collector_number:d.collector_number||((u=d.card)==null?void 0:u.collector_number),finishes:d.finishes||["nonfoil"],prices:d.prices||{},mana_cost:d.mana_cost||((I=d.card)==null?void 0:I.mana_cost),color_identity:d.color_identity||((x=d.card)==null?void 0:x.color_identity),cmc:d.cmc||((_=d.card)==null?void 0:_.cmc),type_line:d.type_line||((S=d.card)==null?void 0:S.type_line),scryfall_id:d.scryfall_id||((k=d.card)==null?void 0:k.scryfall_id),card:{name:d.name||((E=d.card)==null?void 0:E.name),mana_cost:d.mana_cost||((N=d.card)==null?void 0:N.mana_cost),color_identity:d.color_identity||((j=d.card)==null?void 0:j.color_identity),cmc:d.cmc||((v=d.card)==null?void 0:v.cmc),type_line:d.type_line||((W=d.card)==null?void 0:W.type_line),set:d.set||((O=d.card)==null?void 0:O.set),collector_number:d.collector_number||((R=d.card)==null?void 0:R.collector_number),scryfall_id:d.scryfall_id||((D=d.card)==null?void 0:D.scryfall_id)}}}),g={_id:e._id,name:e.name,format:e.format,commander:e.commander,cards:c,...e.sideboard&&{sideboard:e.sideboard},...e.techIdeas&&{techIdeas:e.techIdeas},...e.description&&{description:e.description},...e.colors&&{colors:e.colors}},y=JSON.stringify(g);console.log("[SAVE DECK] Attempting save with sideboard/techIdeas:",{deckId:e._id,cardsCount:c.length,sideboardCount:(e.sideboard||[]).length,techIdeasCount:(e.techIdeas||[]).length,payloadSize:y.length});const C=await fetch(`${l}/api/decks/${e._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"Cache-Control":"no-cache"},credentials:"include",body:y});if(C.ok){const d=await C.json();console.log("[SAVE DECK] ‚úÖ Server supports sideboard/techIdeas - full persistence enabled!"),console.log("[SAVE DECK] Server response sideboard/techIdeas:",{serverReturnedSideboard:((t=d.sideboard)==null?void 0:t.length)||0,serverReturnedTechIdeas:((a=d.techIdeas)==null?void 0:a.length)||0,localSideboardCount:(e.sideboard||[]).length,localTechIdeasCount:(e.techIdeas||[]).length,willPreserveFromLocal:!d.sideboard||!d.techIdeas});const $=(d.cards||[]).map(u=>{var x,_,S,k,E;const I=(e.cards||[]).find(N=>{var W,O;const j=u.name||((W=u.card)==null?void 0:W.name),v=N.name||((O=N.card)==null?void 0:O.name);return j===v});return I?{...I,...u,card:{...I.card,...u.card||{},type_line:((x=I.card)==null?void 0:x.type_line)||I.type_line||u.type_line,scryfall_json:((_=I.card)==null?void 0:_.scryfall_json)||I.scryfall_json,mana_cost:((S=I.card)==null?void 0:S.mana_cost)||I.mana_cost,color_identity:((k=I.card)==null?void 0:k.color_identity)||I.color_identity,cmc:((E=I.card)==null?void 0:E.cmc)||I.cmc}}:u}),f={...d,cards:gn({...d,cards:$}),sideboard:d.sideboard||e.sideboard||[],techIdeas:d.techIdeas||e.techIdeas||[]};le(f),Y(f.cards||[]),(((o=f.sideboard)==null?void 0:o.length)>0||((r=f.techIdeas)==null?void 0:r.length)>0)&&Wt(e._id,f.sideboard,f.techIdeas)}else if(console.log("[SAVE DECK] Server doesn't support zones, using localStorage fallback"),C.status===500||C.status===400){const d={_id:e._id,name:e.name,format:e.format,commander:e.commander,cards:c,...e.description&&{description:e.description},...e.colors&&{colors:e.colors}},$=await fetch(`${l}/api/decks/${e._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"Cache-Control":"no-cache"},credentials:"include",body:JSON.stringify(d)});if($.ok){const f=await $.json();console.log("[SAVE DECK] ‚úÖ Main deck saved, zones persisted to localStorage");const u=(f.cards||[]).map(x=>{var S,k,E,N,j;const _=(e.cards||[]).find(v=>{var R,D;const W=x.name||((R=x.card)==null?void 0:R.name),O=v.name||((D=v.card)==null?void 0:D.name);return W===O});return _?{..._,...x,card:{..._.card,...x.card||{},type_line:((S=_.card)==null?void 0:S.type_line)||_.type_line||x.type_line,scryfall_json:((k=_.card)==null?void 0:k.scryfall_json)||_.scryfall_json,mana_cost:((E=_.card)==null?void 0:E.mana_cost)||_.mana_cost,color_identity:((N=_.card)==null?void 0:N.color_identity)||_.color_identity,cmc:((j=_.card)==null?void 0:j.cmc)||_.cmc}}:x}),I={...f,cards:gn({...f,cards:u}),sideboard:e.sideboard||[],techIdeas:e.techIdeas||[]};le(I),Y(I.cards||[]),Wt(e._id,e.sideboard,e.techIdeas)}else{const f=await $.json();console.error("[SAVE DECK] Fallback save failed:",f),P.error(`Failed to save deck: ${f.error||"Unknown error"}`)}}else{const d=await C.json();P.error(`Failed to save deck: ${d.error||"Unknown error"}`)}}catch(l){console.error("[SAVE DECK] Error saving deck to server:",l),P.error("Error saving deck to server")}},Bo=async e=>{try{const t=e.toLowerCase().trim(),a=encodeURIComponent(t),o=await fetch(`https://api.scryfall.com/cards/named?exact=${a}`);return o.ok?(await o.json()).color_identity||[]:(o.status===404||console.error("Scryfall API error:",o.status,o.statusText),null)}catch(t){return console.error("Error fetching commander color identity:",t),null}},vn=A.useMemo(()=>{var a,o,r,l,i,c,g;if(!n)return"";let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0)e=n.commander.map(y=>{var d;const C=((d=y.card)==null?void 0:d.name)||y.name||y;return typeof C=="string"?C:null}).filter(Boolean);else if(n.commander&&typeof n.commander=="object"&&n.commander!==null){const y=((a=n.commander.card)==null?void 0:a.name)||n.commander.name||n.commander;y&&typeof y=="string"&&(e=[y])}else typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]);if(n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const y=n.commanderNames.filter(C=>typeof C=="string"&&C.trim());e=e.concat(y)}if(n.cards&&Array.isArray(n.cards)){const y=n.cards.filter(C=>C.isCommander===!0);for(const C of y){const d=((o=C.card)==null?void 0:o.name)||C.name||"";d&&typeof d=="string"&&e.push(d)}}if(e.length===0)return"";let t=null;if(n.commander){const y=Array.isArray(n.commander)?n.commander[0]:n.commander;(r=y==null?void 0:y.card)!=null&&r.color_identity&&Array.isArray(y.card.color_identity)?t=y.card.color_identity:y!=null&&y.color_identity&&Array.isArray(y.color_identity)&&(t=y.color_identity)}if(!t&&n.cards&&Array.isArray(n.cards)){const y=n.cards.find(C=>C.isCommander===!0);if(y&&((l=y.scryfallCard)!=null&&l.color_identity&&Array.isArray(y.scryfallCard.color_identity)?t=y.scryfallCard.color_identity:(i=y.card)!=null&&i.color_identity&&Array.isArray(y.card.color_identity)?t=y.card.color_identity:y.color_identity&&Array.isArray(y.color_identity)&&(t=y.color_identity)),!t)for(const C of e){if(typeof C!="string")continue;const d=n.cards.find($=>{var u;return(((u=$.card)==null?void 0:u.name)||$.name||"").toLowerCase()===C.toLowerCase()});if((c=d==null?void 0:d.card)!=null&&c.color_identity&&Array.isArray(d.card.color_identity)){t=d.card.color_identity;break}else if((g=d==null?void 0:d.scryfallCard)!=null&&g.color_identity&&Array.isArray(d.scryfallCard.color_identity)){t=d.scryfallCard.color_identity;break}else if(d!=null&&d.color_identity&&Array.isArray(d.color_identity)){t=d.color_identity;break}}}if(!t&&e.length>0){const C=e[0].toLowerCase().trim();if(Et.has(C)){const d=Et.get(C);d!==null&&(t=d)}}if((!t||Array.isArray(t)&&t.length===0)&&e.length>0){const y={"jason bright, glowing prophet":["U"],"jason bright":["U"],"atraxa, praetors' voice":["W","U","B","G"],"edgar markov":["W","U","B","R"],"kumena, tyrant of orazca":["U","G"],"meren of clan nel toth":["B","G"],"prossh, skyraider of kher":["B","R","G"],"derevi, empyrial tactician":["W","U","G"],"oloro, ageless ascetic":["W","U","B"],"kaalia of the vast":["W","B","R"],"ghave, guru of spores":["W","B","G"],"riku of two reflections":["U","R","G"],"the ur-dragon":["W","U","B","R","G"],"sliver overlord":["W","U","B","R","G"]};for(const C of e){if(!C||typeof C!="string")continue;const d=C.toLowerCase().trim();if(y[d]){t=y[d];break}if(d.includes("jason bright")){t=["U"];break}}}return t?t.join("").toLowerCase():""},[n,Et]);A.useEffect(()=>{var t,a,o;if(!n)return;let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0)e=n.commander.map(r=>{var i;const l=((i=r.card)==null?void 0:i.name)||r.name||r;return typeof l=="string"?l:null}).filter(Boolean);else if(n.commander&&typeof n.commander=="object"&&n.commander!==null){const r=((t=n.commander.card)==null?void 0:t.name)||n.commander.name||n.commander;r&&typeof r=="string"&&(e=[r])}else typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]);if(n.commander_names&&Array.isArray(n.commander_names)&&n.commander_names.length>0){const r=n.commander_names.filter(l=>typeof l=="string"&&l.trim());e=e.concat(r)}if(n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const r=n.commanderNames.filter(l=>typeof l=="string"&&l.trim());e=e.concat(r)}if(e.length!==0)for(const r of e){if(typeof r!="string")continue;const l=r.toLowerCase().trim();if(Et.has(l)||se.has(l))continue;let i=!1;if(n.commander){const c=Array.isArray(n.commander)?n.commander[0]:n.commander;((a=c==null?void 0:c.card)!=null&&a.color_identity&&Array.isArray(c.card.color_identity)||c!=null&&c.color_identity&&Array.isArray(c.color_identity))&&(i=!0)}if(!i&&n.cards&&Array.isArray(n.cards)){const c=n.cards.find(g=>{var C;return(((C=g.card)==null?void 0:C.name)||g.name||"").toLowerCase()===r.toLowerCase()});(o=c==null?void 0:c.card)!=null&&o.color_identity&&Array.isArray(c.card.color_identity)&&(i=!0)}i||(de(c=>new Set(c).add(l)),Bo(r).then(c=>{Oo(g=>new Map(g).set(l,c)),de(g=>{const y=new Set(g);return y.delete(l),y})}))}},[n,Et,se]);const qn=A.useRef(null),bo=A.useRef(0),zo=150,xn=A.useRef(null),Co=No(async e=>{const t=Date.now();if(t-bo.current<zo)return;if(bo.current=t,!e.trim()){Dt([]),Pt(!1),He(""),Jt(!1);return}qn.current&&qn.current.abort(),qn.current=new AbortController;const a=qn.current.signal;Jt(!0);let o=e.trim();const r=vn;try{const l=`/api/cards/typesense-search?q=${encodeURIComponent(o)}&limit=1000${r?`&colorIdentity=${r}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,g=!1?l:`${l}`,y=await fetch(g,{signal:a});if(!y.ok)throw new Error(`HTTP error! status: ${y.status}`);const C=await y.json();let d=C.data||C||[];if((o.toLowerCase().includes("animating faerie")||o.toLowerCase().includes("adventure")||o.toLowerCase().includes("faerie")||o.toLowerCase().includes("underwater tunnel")||o.toLowerCase().includes("room")||o.toLowerCase().includes("dungeon")||o.toLowerCase().includes("plane")||o.toLowerCase().includes("phenomenon")||o.toLowerCase().includes("scheme")||o.toLowerCase().includes("vanguard"))&&d.length===0)try{let f;o.toLowerCase().includes("underwater tunnel")||o.toLowerCase().includes("room")?f=encodeURIComponent(`"${o.trim()}" OR type:room`):o.toLowerCase().includes("adventure")||o.toLowerCase().includes("faerie")?f=encodeURIComponent(`"${o.trim()}" OR keyword:adventure`):f=encodeURIComponent(`"${o.trim()}"`);const u=`https://api.scryfall.com/cards/search?q=${f}&unique=cards&order=name`,I=await fetch(u,{signal:a});if(I.ok){const _=(await I.json()).data||[];_.length>0&&(d=_.slice(0,10))}else{const _=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(o.trim())}`,S=await fetch(_,{signal:a});S.ok&&(d=[await S.json()])}}catch{}Array.isArray(d)?(Dt(d),He(d.length===0?"No cards found matching your search criteria.":""),Pt(d.length>0)):C&&C.message?(Dt([]),He(C.message),Pt(!0)):(Dt([]),He("No results found."),Pt(!0))}catch(l){if(l.name==="AbortError")return;console.error("Search error:",l),Dt([]),He("Error fetching cards."),Pt(!0)}Jt(!1)},200),io=async e=>{if(!e.trim())return;It(!0);const t=vn;try{const a=e.toLowerCase().includes("animating faerie")||e.toLowerCase().includes("adventure")||e.toLowerCase().includes("faerie")||e.toLowerCase().includes("underwater tunnel")||e.toLowerCase().includes("room")||e.toLowerCase().includes("dungeon")||e.toLowerCase().includes("plane")||e.toLowerCase().includes("phenomenon")||e.toLowerCase().includes("scheme")||e.toLowerCase().includes("vanguard"),o=`/api/cards/typesense-search?q=${encodeURIComponent(e.trim())}&limit=1000${t?`&colorIdentity=${t}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,i=!1?o:`${o}`,c=await fetch(i);if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const g=await c.json();let y=g.data||g||[];if(y.length>0&&[...new Set(y.map(f=>f.type_line).filter(Boolean))].filter(f=>f.includes("Adventure")||f.includes("Room")||f.includes("Dungeon")||f.includes("Plane")||f.includes("Phenomenon")||f.includes("Scheme")||f.includes("Vanguard")).length>0,a&&y.length===0)try{let d,$;e.toLowerCase().includes("underwater tunnel")||e.toLowerCase().includes("room")?(d=encodeURIComponent(`"${e.trim()}" OR type:room`),$="Room card search"):e.toLowerCase().includes("adventure")||e.toLowerCase().includes("faerie")?(d=encodeURIComponent(`"${e.trim()}" OR keyword:adventure`),$="Adventure card search"):(d=encodeURIComponent(`"${e.trim()}"`),$="Special card search");const f=`https://api.scryfall.com/cards/search?q=${d}&unique=cards&order=name`,u=await fetch(f);if(u.ok){const x=(await u.json()).data||[];x.length>0&&(y=x)}else{const x=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(e.trim())}`,_=await fetch(x);_.ok&&(y=[await _.json()])}}catch{}const C=Array.isArray(y)?y.map(d=>{if(gt[d.name]){const f=ln(d.name);if(d.id===f||d.scryfall_id===f)return{...d,_isPreferredPrinting:!0}}return d}).sort((d,$)=>d._isPreferredPrinting&&!$._isPreferredPrinting?-1:!d._isPreferredPrinting&&$._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [SEARCH MODAL] Processed ${C.length} results with basic land preferences`),Te(C),pt(e.trim()),dt(""),Je(!0),Pt(!1)}catch(a){console.error("Error fetching all search results:",a),Te([])}finally{It(!1)}},wo=async e=>{if(!e.trim()){Te([]);return}xn.current&&xn.current.abort(),xn.current=new AbortController;const t=xn.current.signal;It(!0);const a=vn;try{const o=`/api/cards/typesense-search?q=${encodeURIComponent(e.trim())}&limit=1000${a?`&colorIdentity=${a}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,i=!1?o:`${o}`;console.log("üîç Modal search debug:",{query:e.trim(),currentColorId:a,deckFormat:n==null?void 0:n.format,url:o,finalUrl:i});const c=await fetch(i,{signal:t});if(t.aborted)return;if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const g=await c.json();if(t.aborted)return;const y=g.data||g||[],C=Array.isArray(y)?y.map(d=>{if(gt[d.name]){const f=ln(d.name);if(d.id===f||d.scryfall_id===f)return{...d,_isPreferredPrinting:!0}}return d}).sort((d,$)=>d._isPreferredPrinting&&!$._isPreferredPrinting?-1:!d._isPreferredPrinting&&$._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [MODAL SEARCH] Processed ${C.length} results with basic land preferences`),Te(C),pt(e.trim()),mt(new Map)}catch(o){if(o.name==="AbortError")return;console.error("Error in modal search:",o),Te([])}finally{t.aborted||It(!1)}},Wo=No(wo,100);A.useCallback(e=>{const t=`oracletag:${e}`;try{_t(t),Pt(!0),rt(-1),Dt([]),He(""),Jt(!0)}catch(a){console.error("Error initiating oracle tag search:",a),He(`Error searching for oracle tag "${e}"`),Jt(!1)}},[_t,Pt,rt,Dt,He,Jt]);const Ho=A.useCallback(async e=>{var t,a,o,r,l;try{It(!0),Je(!0);const i=`oracletag:${e}`;dt(""),pt(i),_t(`Oracle Tag: ${e.replace(/-/g," ").replace(/\b\w/g,k=>k.toUpperCase())}`);let c=vn;const g=(t=n==null?void 0:n.commander)==null?void 0:t[0],y=((a=g==null?void 0:g.card)==null?void 0:a.name)||(g==null?void 0:g.name)||"";console.log("üéØ Commander Color Identity Detection:"),console.log("  - Commander Name:",y),console.log("  - Detected Color ID:",c),console.log("  - Is Empty?:",c===""),console.log("  - Length:",(c==null?void 0:c.length)||0);const C={oracleTag:e,currentColorId:c,deckFormat:n==null?void 0:n.format,commander:n==null?void 0:n.commander,commanderNames:n==null?void 0:n.commanderNames,commanderCard:g,commanderColorIdentity:((o=g==null?void 0:g.card)==null?void 0:o.color_identity)||(g==null?void 0:g.color_identity)||((r=g==null?void 0:g.scryfallCard)==null?void 0:r.color_identity),commanderName:((l=g==null?void 0:g.card)==null?void 0:l.name)||(g==null?void 0:g.name),allCommanderKeys:g?Object.keys(g):[],cardKeys:g!=null&&g.card?Object.keys(g.card):[]};console.log("üîç Oracle Tag Search Debug:",C);const d=`/api/cards/typesense-search?q=${encodeURIComponent(i)}${c?`&colorIdentity=${c}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,u=!1?d:`${d}`;console.log("üîó Oracle Tag Search URL Analysis:"),console.log("  - Oracle Tag:",e),console.log("  - Search Query:",i),console.log("  - Color ID:",c),console.log("  - Color ID Length:",(c==null?void 0:c.length)||0),console.log("  - Deck Format:",n==null?void 0:n.format),console.log("  - Final URL:",u),console.log("  - URL includes colorIdentity param:",u.includes("colorIdentity="));const I=await fetch(u);if(!I.ok)throw new Error(`Search failed: ${I.status} ${I.statusText}`);const x=await I.json(),_=x.data||x||[],S=Array.isArray(_)?_.map(k=>{if(gt[k.name]){const N=ln(k.name);if(k.id===N||k.scryfall_id===N)return{...k,_isPreferredPrinting:!0}}return k}).sort((k,E)=>k._isPreferredPrinting&&!E._isPreferredPrinting?-1:!k._isPreferredPrinting&&E._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [ORACLE TAG] Processed ${S.length} results with basic land preferences`),Te(S)}catch(i){console.error("Error in oracle tag search modal:",i),Te([]),_t(`Oracle Tag Error: ${e}`),P.error(`Failed to search for oracle tag "${e}": ${i.message}`)}finally{It(!1)}},[It,Je,Te,_t,vn,n]);A.useEffect(()=>(Co($t),()=>{Co.cancel()}),[$t]),A.useEffect(()=>{if(!Yt)return;const e=a=>{a.target.closest(".search-container")||Pt(!1)},t=a=>{a.key==="Escape"&&Pt(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[Yt]),A.useEffect(()=>{},[n]);const Gn=A.useMemo(()=>(e,t)=>e.sort((a,o)=>{var i,c;const r=((i=a.card)==null?void 0:i.name)||a.name||"",l=((c=o.card)==null?void 0:c.name)||o.name||"";if(t.includes("price")){const g=Vt(a),y=Vt(o);let C=parseFloat(g.price)||0,d=parseFloat(y.price)||0;switch(t){case"price-asc":return C===d?r.localeCompare(l):C-d;case"price-desc":return d===C?r.localeCompare(l):d-C;default:return r.localeCompare(l)}}switch(t){case"name-asc":return r.localeCompare(l);case"name-desc":return l.localeCompare(r);default:return r.localeCompare(l)}}),[]);A.useMemo(()=>{if(!n)return[];try{const e=gn(n),t=(()=>{var o;if(!n||!n.commander)return[];if(Array.isArray(n.commander))return n.commander.length===0?[]:n.commander.map(r=>{var i;if(!r)return"";const l=((i=r.card)==null?void 0:i.name)||r.name||r;return typeof l=="string"?l.toLowerCase():""}).filter(r=>r.length>0);{const r=n.commander,l=((o=r.card)==null?void 0:o.name)||r.name||r;return typeof l=="string"&&l.trim()?[l.toLowerCase()]:[]}})();let a;switch(Fe){case"manaValue":a=eo(e,t);break;case"colorIdentity":a=to(e,t);break;case"collectionStatus":a=yo(e,t);break;case"type":default:a=pn(e,t)}return Array.isArray(a)&&yn(a,o=>{o&&Array.isArray(o.cards)&&(o.cards=Gn(o.cards,xt))}),a}catch(e){return console.error("Error grouping cards:",e),[]}},[n,Fe,xt]);const qo=A.useMemo(()=>{const t=wn(F||[]).reduce((a,o)=>{var C,d,$,f,u;const r=((C=o.card)==null?void 0:C.name)||o.name||"Unknown",l=o.count||o.quantity||1,i=o.foil===!0||((d=o.card)==null?void 0:d.foil)===!0||(($=o.cardObj)==null?void 0:$.foil)===!0||((u=(f=o.cardObj)==null?void 0:f.card)==null?void 0:u.foil)===!0,c=`${r}-${o.printing||"default"}-${i?"foil":"nonfoil"}`;let g;if(he.current.has(c))g=he.current.get(c);else{const I={...o,foil:i,card:{...o.card,foil:i}};g=Vt(I),he.current.set(c,g)}const y=parseFloat(g.price)||0;return a+y*l},0);return Bn(t,{showCurrency:!1})},[F]),Go=A.useMemo(()=>{if(!(n!=null&&n.sideboard)||n.sideboard.length===0)return[];let e;const t=n.sideboard;return Fe==="type"?e=pn(t,mn):Fe==="manaValue"?e=eo(t):Fe==="colorIdentity"?e=to(t):Fe==="collectionStatus"&&(e=yo(t)),e&&xt&&e.forEach(o=>{o.cards&&(o.cards=Gn(o.cards,xt))}),e||[]},[n==null?void 0:n.sideboard,Fe,xt,mn]),Vo=A.useMemo(()=>{if(!(n!=null&&n.techIdeas)||n.techIdeas.length===0)return[];let e;const t=n.techIdeas;return Fe==="type"?e=pn(t,mn):Fe==="manaValue"?e=eo(t):Fe==="colorIdentity"?e=to(t):Fe==="collectionStatus"&&(e=yo(t)),e&&xt&&e.forEach(o=>{o.cards&&(o.cards=Gn(o.cards,xt))}),e||[]},[n==null?void 0:n.techIdeas,Fe,xt,mn]),vt=A.useMemo(()=>{try{let e;const t=F||(n==null?void 0:n.cards)||[];if(t.length===0)return[];const a=Array.isArray(mn)?mn:[];if(Fe==="type"?e=pn(t,a):Fe==="manaValue"?e=eo(t,a):Fe==="colorIdentity"?e=to(t,a):(Fe==="collectionStatus"&&console.warn("Collection status grouping not supported in deck view, falling back to type grouping"),e=pn(t,a)),Array.isArray(e))for(let o=0;o<e.length;o++){const r=e[o];try{Array.isArray(r.cards)||(r.cards=[]);try{Array.isArray(r.cards)||(r.cards=[]);const l=[...r.cards];r.cards=Gn(l,xt)}catch(l){throw console.error("[FOREACH DEBUG] Error in sortCards:",l,"group.cards:",r.cards),console.error("[FOREACH DEBUG] sortBy:",xt),l}}catch(l){console.error("[FOREACH DEBUG] Error processing group:",l)}}else console.error("[FOREACH DEBUG] cardGroups is not an array in groupedAndSortedCards:",typeof e,e),e=[];return e}catch(e){throw console.error("[FOREACH DEBUG] Error in groupedAndSortedCards useMemo:",e),console.error("[FOREACH DEBUG] Error stack:",e.stack),e}},[F,Fe,xt,mn]),Vn=A.useCallback(e=>{var c,g,y,C;if(!m.isOpen||!m.cardObj)return;if(z.isActive&&z.searchResults.length>0){const d=z.currentIndex;let $;if(e==="previous")$=d-1,$<0&&($=z.searchResults.length-1);else if(e==="next")$=d+1,$>=z.searchResults.length&&($=0);else return;const f=z.searchResults[$];if(!f)return;console.log(`[ORACLE TAG NAVIGATION] Moving to ${e} card: ${f.name} (${$+1}/${z.searchResults.length})`);const u={name:f.name,printing:f.scryfall_id||f.id,cardObj:{name:f.name,scryfall_id:f.scryfall_id||f.id,set:f.set,collector_number:f.collector_number,image_uris:f.image_uris,type_line:f.type_line,mana_cost:f.mana_cost,oracle_text:f.oracle_text,power:f.power,toughness:f.toughness,cmc:f.cmc||f.converted_mana_cost,rarity:f.rarity,prices:f.prices,card_faces:f.card_faces},card:{name:f.name,scryfall_json:f,type_line:f.type_line},scryfall_json:f,foil:!1,count:1,modalPrice:((c=f.prices)==null?void 0:c.usd)||((g=f.prices)==null?void 0:g.usd_foil)||"0.00"};L({isOpen:!0,cardObj:u}),q(I=>({...I,currentIndex:$}));return}const t=((y=m.cardObj.card)==null?void 0:y.name)||m.cardObj.name;if(!t)return;const a=[];try{if(Array.isArray(vt)){console.log("[NUCLEAR SAFETY] About to forEach on groupedAndSortedCards:",{isArray:Array.isArray(vt),type:typeof vt,length:vt==null?void 0:vt.length,value:vt});const d=Array.isArray(vt)?vt:[];for(let $=0;$<d.length;$++){const f=d[$];try{if(f&&Array.isArray(f.cards)){const u=Array.isArray(f.cards)?f.cards:[];for(let I=0;I<u.length;I++){const x=u[I];x&&a.push(x)}}}catch(u){console.error("[NUCLEAR SAFETY] Error processing group:",f,u)}}}else console.error("[NUCLEAR SAFETY] groupedAndSortedCards is not an array:",{type:typeof vt,value:vt,isNull:vt===null,isUndefined:vt===void 0})}catch(d){console.error("[NUCLEAR SAFETY] Critical error in card flattening:",d),console.trace()}const o=a.findIndex(d=>{var f;return(((f=d.card)==null?void 0:f.name)||d.name)===t});if(o===-1)return;let r;if(e==="previous")r=o-1,r<0&&(r=a.length-1);else if(e==="next")r=o+1,r>=a.length&&(r=0);else return;const l=a[r];if(!l)return;const i={...l,cardObj:l,name:((C=l.card)==null?void 0:C.name)||l.name};L({isOpen:!0,cardObj:i})},[m,vt,z]),Xo=A.useCallback(()=>{Vn("previous")},[Vn]),Ko=A.useCallback(()=>{Vn("next")},[Vn]),Qo=A.useCallback(e=>{St(t=>{var a,o;return{...t,card:{...e,image_uris:e.image_uris||((a=e.scryfall_json)==null?void 0:a.image_uris),flipped:((o=t.card)==null?void 0:o.flipped)||!1}}})},[St]),Jo=A.useCallback(e=>{if(!F||!e)return!1;const t=e.name;return t?F.some(a=>{var r;return(((r=a.card)==null?void 0:r.name)||a.name)===t}):!1},[F]);function Io(e,t={}){var a,o,r,l,i,c,g,y,C,d,$,f;if(!e){console.error("[DeckViewEdit] Cannot update card: missing card object"),P.error("Failed to update card: Missing card data");return}if(!Array.isArray(F)){console.error("[FOREACH DEBUG] handleUpdateCard: cards is not an array:",typeof F,F),P.error("Failed to update card: Invalid deck data");return}try{if(t.freshPriceDataOnly&&t.scryfall_json){const u=((a=e.card)==null?void 0:a.name)||e.name;if(!u){console.error("[DeckViewEdit] Cannot update fresh price data: missing card name");return}const I=Date.now(),x=F.map(_=>{var k;if((((k=_.card)==null?void 0:k.name)||_.name)===u){const E={..._,..._.scryfall_json?{scryfall_json:{..._.scryfall_json,...t.scryfall_json}}:{},..._.card?{card:{..._.card,..._.card.scryfall_json?{scryfall_json:{..._.card.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},..._.cardObj?{cardObj:{..._.cardObj,..._.cardObj.card?{card:{..._.cardObj.card,..._.cardObj.card.scryfall_json?{scryfall_json:{..._.cardObj.card.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},..._.cardObj.scryfall_json?{scryfall_json:{..._.cardObj.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},lastUpdated:I};return t.modalPrice!==void 0&&(E.modalPrice=t.modalPrice,E.card&&(E.card.modalPrice=t.modalPrice),E.cardObj&&(E.cardObj.modalPrice=t.modalPrice,E.cardObj.card&&(E.cardObj.card.modalPrice=t.modalPrice))),E}return _});le(_=>({..._,cards:x,lastUpdated:I}));return}if(t.printing&&t.scryfall_json){const u=t.scryfall_json||null;if(u){t.modalPrice!==void 0&&(u.modalPrice=t.modalPrice),t.foil!==void 0&&(u.modalFoilStatus=t.foil);const I=Be==null?void 0:Be.card,x=((o=e.card)==null?void 0:o.name)||e.name,_=(I==null?void 0:I.name)||((r=I==null?void 0:I.card)==null?void 0:r.name);I&&_===x&&St({card:{...I,printing:t.printing,scryfall_json:t.scryfall_json,modalPrice:t.modalPrice,image_uris:t.image_uris||((l=t.scryfall_json)==null?void 0:l.image_uris),card_faces:t.card_faces||((i=t.scryfall_json)==null?void 0:i.card_faces)},top:0,left:0}),Do(e,u)}else console.error("[DeckViewEdit] Cannot update printing: missing scryfall_json data"),P.error("Failed to update card printing: Missing card data");return}if(t.quantity!==void 0)try{if(t.quantity<1){Xn(e);return}const u=((c=e.card)==null?void 0:c.name)||e.name;if(!u){console.error("[DeckViewEdit] Cannot update quantity: missing card name"),P.error("Failed to update quantity: Missing card data");return}const I=Date.now();let x=[],_=!1;console.log(`[QUANTITY DEBUG] Looking for card to update: "${u}", quantity: ${t.quantity}`),console.log("[QUANTITY DEBUG] CardObj data:",{name:u,foil:e.foil||((g=e.card)==null?void 0:g.foil)||!1,printing:e.printing||((y=e.card)==null?void 0:y.printing)||((C=e.cardObj)==null?void 0:C.printing)}),F.forEach(j=>{var re,ve,Ze,ie,me,je,qe;const v=((re=j.card)==null?void 0:re.name)||j.name,W=e.foil||((ve=e.card)==null?void 0:ve.foil)||!1,O=j.foil||((Ze=j.card)==null?void 0:Ze.foil)||!1,R=e.printing||((ie=e.card)==null?void 0:ie.printing)||((me=e.cardObj)==null?void 0:me.printing),D=j.printing||((je=j.card)==null?void 0:je.printing)||((qe=j.cardObj)==null?void 0:qe.printing),B=v===u,h=W===O,G=R&&D&&R===D,U=u&&gt[u],b=!R||!D,te=G||U||b;if(v===u&&console.log(`[QUANTITY DEBUG] Found potential match: "${v}"`,{nameMatches:B,foilMatches:`${W} === ${O} = ${h}`,exactPrintingMatch:`${R} === ${D} = ${G}`,isBasicLand:U,noPrintingInfo:b,printingMatches:te,overallMatch:B&&h&&te,currentCount:j.count}),B&&h&&te){if(!_){_=!0,console.log(`[QUANTITY DEBUG] Updating card "${v}" from quantity ${j.count} to ${t.quantity}`);const yt={...j,count:t.quantity,quantity:t.quantity,...j.card?{card:{...j.card,count:t.quantity,quantity:t.quantity}}:{},...j.cardObj?{cardObj:{...j.cardObj,count:t.quantity,quantity:t.quantity,...j.cardObj.card?{card:{...j.cardObj.card,count:t.quantity,quantity:t.quantity}}:{}}}:{}};x.push(yt)}}else x.push(j)});const S=x.find(j=>{var v;return(((v=j.card)==null?void 0:v.name)||j.name)===u}),k=x.map(j=>({...j}));if(console.log(`[QUANTITY DEBUG] Final result - found match: ${_}, total cards: ${k.length}`),_){const j=k.find(v=>{var W;return(((W=v.card)==null?void 0:W.name)||v.name)===u});console.log("[QUANTITY DEBUG] Updated card final state:",{name:((d=j==null?void 0:j.card)==null?void 0:d.name)||(j==null?void 0:j.name),count:j==null?void 0:j.count,quantity:j==null?void 0:j.quantity})}Y(k),le(j=>{if(!j)return j;const v=j.cards.map(O=>{var D,B;return(O.name||((D=O.card)==null?void 0:D.name)||((B=O.cardObj)==null?void 0:B.name))===u?{...O,count:t.quantity,quantity:t.quantity,...O.card?{card:{...O.card,count:t.quantity,quantity:t.quantity,id:O.card.id||O.card.scryfall_id,scryfall_id:O.card.scryfall_id||O.card.id,set:O.card.set,set_name:O.card.set_name,collector_number:O.card.collector_number}}:{},...O.cardObj?{cardObj:{...O.cardObj,id:O.cardObj.id||O.cardObj.scryfall_id,scryfall_id:O.cardObj.scryfall_id||O.cardObj.id,set:O.cardObj.set,set_name:O.cardObj.set_name,collector_number:O.cardObj.collector_number,count:t.quantity,quantity:t.quantity,...O.cardObj.card?{card:{...O.cardObj.card,count:t.quantity,quantity:t.quantity}}:{}}}:{}}:O});return{...j,cards:[...v],lastUpdated:I}}),lt(j=>j+1),Fe&&rn(j=>j+1);const E=Be==null?void 0:Be.card,N=(E==null?void 0:E.name)||(($=E==null?void 0:E.card)==null?void 0:$.name);E&&N===u&&St({card:{...E,count:t.quantity,...E.card?{card:{...E.card,count:t.quantity}}:{}},top:0,left:0}),m.isOpen&&m.cardObj&&t.quantity!==void 0&&(((f=m.cardObj.card)==null?void 0:f.name)||m.cardObj.name)===u&&L(v=>({...v,cardObj:{...v.cardObj,count:t.quantity,card:v.cardObj.card?{...v.cardObj.card,count:t.quantity}:v.cardObj.card}}));try{const j=localStorage.getItem("token");if(!j){console.error("[DeckViewEdit] No authentication token found for server update"),P.error("Quantity updated locally but cannot save to server: Not logged in");return}(async function(){const W=h=>h&&typeof h=="string"&&/^[0-9a-fA-F]{24}$/.test(h),O=x.map(h=>{var b,te,re,ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Xe,Ie,De,ge,ue,ee,xe,Ee,Ae,Ft,wt,Zt,kn,$n,Pn,Nn,An,Rn,Tn,Mn,Fn,Un,On,Dn;const G=h.modalPrice!==void 0&&h.modalPrice!==null&&h.modalPrice!=="undefined"?h.modalPrice:null;(((b=h.card)==null?void 0:b.name)||h.name)==="Island"&&console.log("[CARD CLEANING DEBUG] Island before cleaning:",{name:((te=h.card)==null?void 0:te.name)||h.name,originalCount:h.count,countExists:"count"in h,cardStructure:Object.keys(h)});let U={name:((re=h.card)==null?void 0:re.name)||h.name,count:h.count||1,quantity:h.count||1,printing:h.printing||null,isCommander:h.isCommander||!1,...h.foil!==void 0?{foil:h.foil}:{},set:h.set||((ve=h.card)==null?void 0:ve.set)||((Ze=h.scryfall_json)==null?void 0:Ze.set),collector_number:h.collector_number||((ie=h.card)==null?void 0:ie.collector_number)||((me=h.scryfall_json)==null?void 0:me.collector_number),finishes:h.finishes||((je=h.scryfall_json)==null?void 0:je.finishes)||["nonfoil"],prices:h.prices||((qe=h.card)==null?void 0:qe.prices)||((yt=h.scryfall_json)==null?void 0:yt.prices)||{},mana_cost:h.mana_cost||((Ge=h.card)==null?void 0:Ge.mana_cost)||((ke=h.scryfall_json)==null?void 0:ke.mana_cost),color_identity:h.color_identity||((ht=h.card)==null?void 0:ht.color_identity)||((et=h.scryfall_json)==null?void 0:et.color_identity),cmc:h.cmc||((Xe=h.card)==null?void 0:Xe.cmc)||((Ie=h.scryfall_json)==null?void 0:Ie.cmc),type_line:h.type_line||((De=h.card)==null?void 0:De.type_line)||((ge=h.scryfall_json)==null?void 0:ge.type_line),scryfall_id:h.scryfall_id||((ue=h.card)==null?void 0:ue.scryfall_id)||((ee=h.scryfall_json)==null?void 0:ee.id),...G!==null?{modalPrice:G}:{}};return h._id&&W(h._id)&&(U._id=h._id),h.card?typeof h.card=="object"&&h.card!==null?h.card._id&&W(h.card._id)?U.card=h.card._id:U.card={name:h.card.name||h.name,set:h.card.set||h.set||((xe=h.scryfall_json)==null?void 0:xe.set),collector_number:h.card.collector_number||h.collector_number||((Ee=h.scryfall_json)==null?void 0:Ee.collector_number),mana_cost:h.card.mana_cost||h.mana_cost||((Ae=h.scryfall_json)==null?void 0:Ae.mana_cost),color_identity:h.card.color_identity||h.color_identity||((Ft=h.scryfall_json)==null?void 0:Ft.color_identity),cmc:h.card.cmc||h.cmc||((wt=h.scryfall_json)==null?void 0:wt.cmc),type_line:h.card.type_line||h.type_line||((Zt=h.scryfall_json)==null?void 0:Zt.type_line),...h.card._id&&W(h.card._id)?{_id:h.card._id}:{}}:typeof h.card=="string"&&(W(h.card)?U.card=h.card:U.card={name:h.name,set:h.set||((kn=h.scryfall_json)==null?void 0:kn.set),collector_number:h.collector_number||(($n=h.scryfall_json)==null?void 0:$n.collector_number),mana_cost:h.mana_cost||((Pn=h.scryfall_json)==null?void 0:Pn.mana_cost),color_identity:h.color_identity||((Nn=h.scryfall_json)==null?void 0:Nn.color_identity),cmc:h.cmc||((An=h.scryfall_json)==null?void 0:An.cmc),type_line:h.type_line||((Rn=h.scryfall_json)==null?void 0:Rn.type_line)}):U.card={name:h.name,set:h.set||((Tn=h.scryfall_json)==null?void 0:Tn.set),collector_number:h.collector_number||((Mn=h.scryfall_json)==null?void 0:Mn.collector_number),mana_cost:h.mana_cost||((Fn=h.scryfall_json)==null?void 0:Fn.mana_cost),color_identity:h.color_identity||((Un=h.scryfall_json)==null?void 0:Un.color_identity),cmc:h.cmc||((On=h.scryfall_json)==null?void 0:On.cmc),type_line:h.type_line||((Dn=h.scryfall_json)==null?void 0:Dn.type_line)},U}),R=O.find(h=>{var G;return(h.name||((G=h.card)==null?void 0:G.name))===u});(u==="Island"||R)&&console.log("[QUANTITY DEBUG] Island data being sent to server:",{found:!!R,cardName:u,islandData:R,updatesQuantity:t.quantity,cleanedCount:R==null?void 0:R.count,cleanedQuantity:R==null?void 0:R.quantity,hasCountField:R?"count"in R:!1,hasQuantityField:R?"quantity"in R:!1}),console.log("[QUANTITY UPDATE] Sending cleaned cards to server:",O);const B=await fetch(`/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`,"Cache-Control":"no-cache"},credentials:"include",body:JSON.stringify({cards:O,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})});if(!B.ok){console.error(`[DeckViewEdit] Server error updating quantity: ${B.status}`);let h="";try{const G=await B.json();h=G.message||G.error||""}catch{}P.error(`Quantity updated locally but failed to save to server. ${h}`);return}try{const h=await B.json();le(G=>({...G,...h,cards:x})),P.success(`Updated quantity to ${t.quantity}.`)}catch(h){console.error("[DeckViewEdit] Error parsing server response:",h),P.warning("Quantity updated but server response was invalid. Changes may not persist after refresh.")}})()}catch(j){console.error("[DeckViewEdit] Error in server update for quantity:",j),P.error(`Quantity updated locally but failed to save to server: ${j.message}`)}}catch(u){console.error("[DeckViewEdit] Error updating quantity:",u),P.error("Failed to update quantity.")}if(t.isFoil!==void 0||t.foil!==void 0||t.price!==void 0||t.foilToggleAction===!0)try{const u=t.isFoil!==void 0?t.isFoil:t.foil,I=t.price,x=Date.now(),_=F.map(S=>{var O,R,D,B;const k=((O=S.card)==null?void 0:O.name)||S.name,E=((R=e.card)==null?void 0:R.name)||e.name,N=S.printing||((D=S.card)==null?void 0:D.printing),j=e.printing||((B=e.card)==null?void 0:B.printing);if(k===E&&(!N||!j||N===j)){const h=JSON.parse(JSON.stringify(S));h.foil=!!u,h.card&&(h.card.foil=!!u),h.cardObj&&(h.cardObj.foil=!!u,h.cardObj.card&&(h.cardObj.card.foil=!!u));const G=Vt(h),U=I??G.price;return h.price=U,h.card&&(h.card.price=U),h.cardObj&&(h.cardObj.price=U,h.cardObj.card&&(h.cardObj.card.price=U)),t.modalPrice!==void 0&&(h.modalPrice=t.modalPrice,h.card&&(h.card.modalPrice=t.modalPrice),h.cardObj&&(h.cardObj.modalPrice=t.modalPrice,h.cardObj.card&&(h.cardObj.card.modalPrice=t.modalPrice))),h.lastUpdated=x,h}return S});Y(_),le(S=>S?{...S,cards:_,lastUpdated:x}:null),(async()=>{try{const S=localStorage.getItem("token");if(!S){P.error("Foil status updated locally but cannot save to server: Not logged in");return}const k="",E=_.map(O=>{var D;const{price:R}=Vt(O);return{name:((D=O.card)==null?void 0:D.name)||O.name,count:O.count||1,foil:!!O.foil,price:R,printing:O.printing||null,...O.modalPrice!==void 0?{modalPrice:O.modalPrice}:{},...O._id?{_id:O._id}:{},...O.card&&O.card._id?{card:{_id:O.card._id,name:O.card.name}}:{}}});E.filter(O=>O.modalPrice!==void 0).length>0;const j=await fetch(`${k}/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`,"Cache-Control":"no-cache"},body:JSON.stringify({cards:E,name:Re||n.name,lastUpdated:x,commander:n.commander,commanderNames:n.commanderNames})});if(!j.ok)throw new Error(`Server responded with ${j.status}`);const v=await j.json();le(O=>({...O,...v,cards:_,lastUpdated:Date.now()}));const W=u?" (foil price applied)":"";P.success(`Updated to ${u?"foil":"non-foil"}${W}.`)}catch(S){console.error("[DeckViewEdit] Error saving foil status to server:",S),P.error(`Foil status updated locally but failed to save to server: ${S.message}`)}})()}catch(u){console.error("[DeckViewEdit] Error updating foil status:",u),P.error("Failed to update foil status.")}}catch(u){console.error("[DeckViewEdit] Card update error:",u),P.error(`Failed to update card: ${u.message}`)}}function Xn(e){var a,o,r,l;const t=e.name||((a=e.card)==null?void 0:a.name)||((o=e.cardObj)==null?void 0:o.name)||((l=(r=e.cardObj)==null?void 0:r.card)==null?void 0:l.name);if(!t){console.error("[DeckViewEdit] Failed to remove card: Could not determine card name","Card object structure:",e),P.error("Failed to remove card: Could not determine card name");return}console.log("[DEBUG] Before card removal:",{cardBeingRemoved:t,commanderArray:n==null?void 0:n.commander,commanderNames:n==null?void 0:n.commanderNames,deckId:n==null?void 0:n._id}),console.log("[DEBUG] Full deck object before removal:",n);try{const i=Date.now(),c=F.filter(d=>{var u,I,x,_;return(d.name||((u=d.card)==null?void 0:u.name)||((I=d.cardObj)==null?void 0:I.name)||((_=(x=d.cardObj)==null?void 0:x.card)==null?void 0:_.name))!==t});Y([...c]),le(d=>{if(!d)return d;const $=d.cards.filter(f=>{var I,x,_,S;return(f.name||((I=f.card)==null?void 0:I.name)||((x=f.cardObj)==null?void 0:x.name)||((S=(_=f.cardObj)==null?void 0:_.card)==null?void 0:S.name))!==t});return{...d,cards:[...$],lastUpdated:i}});const g=localStorage.getItem("token");if(!g){console.error("[DeckViewEdit] No authentication token found for server update"),P.error("Card removed locally but cannot save to server: Not logged in");return}const y=c.map(d=>{var $,f,u,I,x,_,S,k,E,N,j,v,W,O,R,D;return{name:d.name||(($=d.card)==null?void 0:$.name),quantity:d.quantity||1,count:d.count||1,isCommander:d.isCommander||!1,set:d.set||((f=d.card)==null?void 0:f.set),collector_number:d.collector_number||((u=d.card)==null?void 0:u.collector_number),finishes:d.finishes||["nonfoil"],prices:d.prices||{},mana_cost:d.mana_cost||((I=d.card)==null?void 0:I.mana_cost),color_identity:d.color_identity||((x=d.card)==null?void 0:x.color_identity),cmc:d.cmc||((_=d.card)==null?void 0:_.cmc),type_line:d.type_line||((S=d.card)==null?void 0:S.type_line),scryfall_id:d.scryfall_id||((k=d.card)==null?void 0:k.scryfall_id),card:{name:d.name||((E=d.card)==null?void 0:E.name),mana_cost:d.mana_cost||((N=d.card)==null?void 0:N.mana_cost),color_identity:d.color_identity||((j=d.card)==null?void 0:j.color_identity),cmc:d.cmc||((v=d.card)==null?void 0:v.cmc),type_line:d.type_line||((W=d.card)==null?void 0:W.type_line),set:d.set||((O=d.card)==null?void 0:O.set),collector_number:d.collector_number||((R=d.card)==null?void 0:R.collector_number),scryfall_id:d.scryfall_id||((D=d.card)==null?void 0:D.scryfall_id)}}}),C="";(async()=>{var d;try{const $={_id:n._id,name:n.name,format:n.format,commander:n.commander,cards:y,...n.sideboard&&{sideboard:n.sideboard},...n.techIdeas&&{techIdeas:n.techIdeas},...n.description&&{description:n.description},...n.colors&&{colors:n.colors}},f=JSON.stringify($);console.log("[DEBUG] Card removal request body sent to server:",{deckId:$._id,cardsCount:y.length,removedCardName:t,requestSize:f.length,commander:n.commander,commanderNames:n.commanderNames});const u=await fetch(`${C}/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:f});if(!u.ok){console.error(`[DeckViewEdit] Server error removing card: ${u.status}`);let E="";try{const N=await u.json();E=N.message||N.error||""}catch{}P.error(`Card removed locally but failed to save to server. ${E}`);return}const I=await u.json();console.log("[DEBUG] Server response after card removal:",{commander:I==null?void 0:I.commander,commanderNames:I==null?void 0:I.commanderNames,cardsCount:(d=I==null?void 0:I.cards)==null?void 0:d.length}),console.log("[DEBUG] Full server response:",I);const x=(I.cards||[]).map(E=>{var j,v,W,O,R;const N=($.cards||[]).find(D=>{var G,U;const B=E.name||((G=E.card)==null?void 0:G.name),h=D.name||((U=D.card)==null?void 0:U.name);return B===h});return N?{...N,...E,card:{...N.card,...E.card||{},type_line:((j=N.card)==null?void 0:j.type_line)||N.type_line||E.type_line,scryfall_json:((v=N.card)==null?void 0:v.scryfall_json)||N.scryfall_json,mana_cost:((W=N.card)==null?void 0:W.mana_cost)||N.mana_cost,color_identity:((O=N.card)==null?void 0:O.color_identity)||N.color_identity,cmc:((R=N.card)==null?void 0:R.cmc)||N.cmc}}:E}),_=n.commander,S=n.commanderNames,k={...I,cards:x,commander:I.commander||_,commanderNames:I.commanderNames||S};(_&&!I.commander||S&&!I.commanderNames)&&console.log("[COMMANDER FIX] Server lost commander data, restoring from deck state:",{restoringCommander:_,restoringCommanderNames:S,serverReturnedCommander:I.commander,serverReturnedCommanderNames:I.commanderNames}),le(E=>({...E,...k,sideboard:(E==null?void 0:E.sideboard)||[],techIdeas:(E==null?void 0:E.techIdeas)||[]})),P.success("Card removed from deck.")}catch($){console.error("[DeckViewEdit] Network error removing card:",$),P.error("Card removed locally but failed to save to server.")}})()}catch(i){console.error("[DeckViewEdit] Error in card removal process:",i),P.error("Failed to remove card due to an error.")}}function So(e,t){var a,o,r,l,i,c,g,y,C,d,$;try{const f=(t==null?void 0:t.foil)||(e==null?void 0:e.foil)||!1,u=t||((a=e==null?void 0:e.cardObj)==null?void 0:a.scryfall_json)||(e==null?void 0:e.scryfall_json)||((r=(o=e==null?void 0:e.cardObj)==null?void 0:o.card)==null?void 0:r.scryfall_json)||((l=e==null?void 0:e.card)==null?void 0:l.scryfall_json)||(e==null?void 0:e.cardObj),I={id:`${(u==null?void 0:u.id)||(e==null?void 0:e.printing)||((i=e==null?void 0:e.cardObj)==null?void 0:i.printing)}_${f?"foil":"nonfoil"}_${Date.now()}`,name:(e==null?void 0:e.name)||((c=e==null?void 0:e.cardObj)==null?void 0:c.name)||(u==null?void 0:u.name),set:(u==null?void 0:u.set)||((g=e==null?void 0:e.cardObj)==null?void 0:g.set)||"unknown",set_name:(u==null?void 0:u.set_name)||((y=e==null?void 0:e.cardObj)==null?void 0:y.set_name)||(u==null?void 0:u.set)||"Unknown Set",collector_number:(u==null?void 0:u.collector_number)||((C=e==null?void 0:e.cardObj)==null?void 0:C.collector_number),printing_id:(u==null?void 0:u.id)||(e==null?void 0:e.printing)||((d=e==null?void 0:e.cardObj)==null?void 0:d.printing),rarity:(u==null?void 0:u.rarity)||(($=e==null?void 0:e.cardObj)==null?void 0:$.rarity),foil:f,scryfall_json:u,dateAdded:new Date().toISOString(),quantity:1},x=In.getChunkedItem("cardCollection")||[],_=x.findIndex(k=>k.printing_id===I.printing_id&&k.foil===I.foil);if(_>=0?(x[_].quantity+=1,P.success(`Added another copy to collection! Now have ${x[_].quantity} copies.`)):(x.push(I),P.success(`Added ${I.name} (${f?"Foil":"Non-foil"}) to collection!`)),!In.setItem("cardCollection",x,{clearOldData:!0})){P.error("Failed to save collection - storage may be full");return}Fe==="collectionStatus"&&rn(k=>k+1)}catch(f){console.error("[Collection] Error adding to collection:",f),P.error("Failed to add card to collection. Please try again.")}}const Yo=async()=>{if(Se.size!==0)try{let e=0,t=0;const a=Array.from(Se);if(!Array.isArray(a)){console.error("[FOREACH DEBUG] handleBulkAddToCollection: selectedCardIds is not an array:",typeof a,a),P.error("Failed to process selected cards: Invalid selection data");return}const o=In.getChunkedItem("cardCollection")||[];if(a.forEach(l=>{var i,c,g,y,C,d,$,f,u,I,x;try{const _=ar(l);if(!_){t++;return}const S=((i=_.cardObj)==null?void 0:i.scryfall_json)||_.scryfall_json||((g=(c=_.cardObj)==null?void 0:c.card)==null?void 0:g.scryfall_json)||((y=_.card)==null?void 0:y.scryfall_json)||_.cardObj,k={id:`${(S==null?void 0:S.id)||_.printing||((C=_.cardObj)==null?void 0:C.printing)||"unknown"}_${_.foil?"foil":"nonfoil"}_${Date.now()}_${Math.random()}`,name:((d=_.card)==null?void 0:d.name)||_.name||(S==null?void 0:S.name)||"Unknown Card",set:(S==null?void 0:S.set)||(($=_.cardObj)==null?void 0:$.set)||_.set||"unknown",set_name:(S==null?void 0:S.set_name)||((f=_.cardObj)==null?void 0:f.set_name)||_.set_name||(S==null?void 0:S.set)||"Unknown Set",collector_number:(S==null?void 0:S.collector_number)||((u=_.cardObj)==null?void 0:u.collector_number)||_.collector_number,printing_id:(S==null?void 0:S.id)||_.printing||((I=_.cardObj)==null?void 0:I.printing),rarity:(S==null?void 0:S.rarity)||((x=_.cardObj)==null?void 0:x.rarity)||_.rarity,foil:_.foil||!1,scryfall_json:S,dateAdded:new Date().toISOString(),quantity:_.count||1},E=o.findIndex(N=>N.printing_id===k.printing_id&&N.foil===k.foil);E>=0?o[E].quantity+=k.quantity:o.push(k),e++}catch(_){console.error(`[Bulk Collection] Failed to add card ${l}:`,_),t++}}),!In.setItem("cardCollection",o,{clearOldData:!0})){P.error("Failed to save bulk collection - storage may be full");return}if(Fe==="collectionStatus"&&rn(l=>l+1),e>0&&t===0)P.success(`Successfully added ${e} card${e!==1?"s":""} to collection!`);else if(e>0&&t>0)P.warning(`Added ${e} cards to collection, but ${t} failed.`);else{P.error("Failed to add cards to collection.");return}Rt(new Set),sn(!1)}catch(e){console.error("[Bulk Collection] Error adding cards to collection:",e),P.error("Failed to add cards to collection. Please try again.")}},Zo=async()=>{try{const e=Array.from(Se).map(r=>F.find(l=>{var i;return(((i=l.card)==null?void 0:i.name)||l.name)===r})).filter(Boolean);if(!Array.isArray(e)){console.error("[FOREACH DEBUG] handleBulkAddToWishlist: cardsToAdd is not an array:",typeof e,e),P.error("Failed to process selected cards: Invalid selection data");return}if(e.length===0){P.error("No valid cards selected for wishlist");return}const t=JSON.parse(localStorage.getItem("global-wishlist")||"[]");let a=0,o=0;e.forEach(r=>{var g;const l=r.scryfall_json||r.cardObj||r,i={name:r.name||((g=r.card)==null?void 0:g.name),printing:r.printing||l.scryfall_id||l.id,foil:!1,count:r.count||1,dateAdded:Date.now(),cardObj:{scryfall_id:l.scryfall_id||l.id,name:l.name,set:l.set,set_name:l.set_name,collector_number:l.collector_number,image_uris:l.image_uris,type_line:l.type_line,mana_cost:l.mana_cost,cmc:l.cmc,colors:l.colors,color_identity:l.color_identity,prices:l.prices},scryfall_json:l},c=t.findIndex(y=>y.name===i.name&&y.printing===i.printing);c!==-1?(t[c].count+=r.count||1,o++):(t.push(i),a++)}),localStorage.setItem("global-wishlist",JSON.stringify(t)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:t})),Rt(new Set),sn(!1),P.success(`Added ${a} new cards and updated ${o} existing cards in wishlist`)}catch(e){console.error("Error bulk adding cards to wishlist:",e),P.error("Error adding cards to wishlist")}},lo=(e,t,a="main")=>{if(!bt)return;const o=t.map(i=>{var c;if(a==="tech ideas"){const g=i.cardObj?i:{name:((c=i.card)==null?void 0:c.name)||i.name,count:i.count||i.quantity||1,printing:i.printing,cardObj:i};return ze(g)}else return ze(i.cardObj||i)}),r=o.every(i=>Se.has(i)),l=new Set(Se);r?(o.forEach(i=>l.delete(i)),P.info(`Deselected all ${e} cards from ${a}`)):(o.forEach(i=>l.add(i)),P.info(`Selected all ${e} cards from ${a}`)),Rt(l)},er=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected for removal");return}try{const a=localStorage.getItem("token"),o="",r=[],l=[],i=[];for(const c of Se){const g=(F||(n==null?void 0:n.cards)||[]).find(d=>ze(d)===c);if(g){r.push(g);continue}const y=(e=n.sideboard)==null?void 0:e.find(d=>ze(d)===c);if(y){const d=n.sideboard.findIndex($=>$===y);l.push({card:y,index:d});continue}const C=(t=n.techIdeas)==null?void 0:t.find(d=>ze(d)===c);if(C){const d=n.techIdeas.findIndex($=>$===C);i.push({card:C,index:d});continue}}for(const c of r)Xn(c);l.sort((c,g)=>g.index-c.index);for(const{card:c,index:g}of l)await Kn(g);i.sort((c,g)=>g.index-c.index);for(const{card:c,index:g}of i)await Qn(g);le(c=>({...c,cards:F||(n==null?void 0:n.cards)||[],lastUpdated:Date.now()})),Rt(new Set),P.success("Removed selected cards from deck")}catch(a){console.error("Error removing cards from deck:",a),P.error("Failed to remove cards from deck")}},tr=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected");return}try{const a=[],o=[];for(const r of Se){if((F||(n==null?void 0:n.cards)||[]).find(g=>ze(g)===r))continue;const i=(e=n.sideboard)==null?void 0:e.find(g=>ze(g)===r);if(i){const g=n.sideboard.findIndex(y=>y===i);o.push({card:i,index:g});continue}const c=(t=n.techIdeas)==null?void 0:t.find(g=>ze(g)===r);if(c){const g=n.techIdeas.findIndex(y=>y===c);a.push({card:c,index:g});continue}}for(const{card:r,index:l}of o)await co(r,l);a.sort((r,l)=>l.index-r.index);for(const{card:r,index:l}of a)await uo(r,l);Rt(new Set),P.success("Moved selected cards to main deck")}catch(a){console.error("Error moving cards to main deck:",a),P.error("Error moving cards to main deck")}},nr=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected");return}try{const a=[],o=[];for(const r of Se){if((e=n.sideboard)==null?void 0:e.find(g=>ze(g)===r))continue;const i=(F||(n==null?void 0:n.cards)||[]).find(g=>ze(g)===r);if(i){a.push(i);continue}const c=(t=n.techIdeas)==null?void 0:t.find(g=>ze(g)===r);if(c){const g=n.techIdeas.findIndex(y=>y===c);o.push({card:c,index:g});continue}}for(const r of a)await Jn(r);o.sort((r,l)=>l.index-r.index);for(const{card:r,index:l}of o)await mo(r,l);Rt(new Set),P.success("Moved selected cards to sideboard")}catch(a){console.error("Error moving cards to sideboard:",a),P.error("Error moving cards to sideboard")}},or=async()=>{var e,t,a,o,r,l,i,c,g,y,C,d;if(Se.size===0){P.warning("No cards selected");return}try{const $=new Map,f=[],u=[];for(const I of Se){if((e=n.techIdeas)==null?void 0:e.find(k=>ze(k)===I))continue;const _=(F||(n==null?void 0:n.cards)||[]).find(k=>ze(k)===I);if(_){const k=((t=_.card)==null?void 0:t.name)||_.name,E=_.printing||((a=_.scryfall_json)==null?void 0:a.id)||((r=(o=_.card)==null?void 0:o.scryfall_json)==null?void 0:r.id),N=_.foil||((l=_.card)==null?void 0:l.foil)||!1,j=`${k}|${E||"unknown"}|${N}`;if($.has(j)){const v=$.get(j);v.totalCount+=_.count||_.quantity||1,v.cards.push(_)}else $.set(j,{cardName:k,printing:E,foil:N,totalCount:_.count||_.quantity||1,cards:[_],representative:_,zone:"main"});continue}const S=(i=n.sideboard)==null?void 0:i.find(k=>ze(k)===I);if(S){const k=((c=S.card)==null?void 0:c.name)||S.name,E=S.printing||((g=S.scryfall_json)==null?void 0:g.id)||((C=(y=S.card)==null?void 0:y.scryfall_json)==null?void 0:C.id),N=S.foil||((d=S.card)==null?void 0:d.foil)||!1,j=`${k}|${E||"unknown"}|${N}`,v=n.sideboard.findIndex(W=>W===S);if($.has(j)){const W=$.get(j);W.totalCount+=S.count||S.quantity||1,W.cards.push(S),W.sideboardIndices=W.sideboardIndices||[],W.sideboardIndices.push(v)}else $.set(j,{cardName:k,printing:E,foil:N,totalCount:S.count||S.quantity||1,cards:[S],representative:S,zone:"sideboard",sideboardIndices:[v]});continue}}for(const[I,x]of $){const _={...x.representative,count:x.totalCount,quantity:x.totalCount};_.card&&(_.card.count=x.totalCount,_.card.quantity=x.totalCount),_.cardObj&&(_.cardObj.count=x.totalCount,_.cardObj.quantity=x.totalCount,_.cardObj.card&&(_.cardObj.card.count=x.totalCount,_.cardObj.card.quantity=x.totalCount)),await Yn(_)}u.sort((I,x)=>x.index-I.index);for(const{card:I,index:x}of u)await fo(I,x);Rt(new Set),P.success("Moved selected cards to tech ideas")}catch($){console.error("Error moving cards to tech ideas:",$),P.error("Error moving cards to tech ideas")}},rr=()=>{if(!F||!Array.isArray(F)){P.error("No cards to deduplicate");return}const e=new Map;let t=0;F.forEach((o,r)=>{var y,C,d,$,f;const l=((y=o.card)==null?void 0:y.name)||o.name,i=o.printing||((C=o.scryfall_json)==null?void 0:C.id)||(($=(d=o.card)==null?void 0:d.scryfall_json)==null?void 0:$.id),c=o.foil||((f=o.card)==null?void 0:f.foil)||!1;if(!l){console.warn(`[DEDUPE] Skipping card without name at index ${r}`);return}const g=`${l}|${i||"unknown"}|${c}`;if(e.has(g)){const u=e.get(g),I=o.count||o.quantity||1;u.count=(u.count||1)+I,u.quantity=u.count,u.card&&(u.card.count=u.count,u.card.quantity=u.count),u.cardObj&&(u.cardObj.count=u.count,u.cardObj.quantity=u.count,u.cardObj.card&&(u.cardObj.card.count=u.count,u.cardObj.card.quantity=u.count)),t++}else{const u={...o,count:o.count||o.quantity||1,quantity:o.count||o.quantity||1};u.card&&(u.card.count=u.count,u.card.quantity=u.count),u.cardObj&&(u.cardObj.count=u.count,u.cardObj.quantity=u.count,u.cardObj.card&&(u.cardObj.card.count=u.count,u.cardObj.card.quantity=u.count)),e.set(g,u)}});const a=Array.from(e.values());a.length<F.length?(Y(a),le(o=>({...o,cards:a})),Rt(new Set),P.success(`Deduplicated deck: removed ${t} duplicate card entries`)):P.info("No duplicate cards found")},sr=()=>{if(Se.size===0){P.warning("No cards selected for foil toggle");return}const e={foiled:0,unfoiled:0};try{const t=F.map(l=>{var c,g,y,C;const i=ze(l);if(Se.has(i)){const $=!(l.foil===!0||((c=l.card)==null?void 0:c.foil)===!0||((g=l.cardObj)==null?void 0:g.foil)===!0||((C=(y=l.cardObj)==null?void 0:y.card)==null?void 0:C.foil)===!0);return $?e.foiled++:e.unfoiled++,{...l,foil:$,...l.card?{card:{...l.card,foil:$}}:{},...l.cardObj?{cardObj:{...l.cardObj,foil:$,...l.cardObj.card?{card:{...l.cardObj.card,foil:$}}:{}}}:{}}}return l});Y([...t]),le(l=>{if(!l)return l;const i=l.cards.map(c=>{var y,C,d,$;const g=ze(c);if(Se.has(g)){const u=!(c.foil===!0||((y=c.card)==null?void 0:y.foil)===!0||((C=c.cardObj)==null?void 0:C.foil)===!0||(($=(d=c.cardObj)==null?void 0:d.card)==null?void 0:$.foil)===!0);return{...c,foil:u,...c.card?{card:{...c.card,foil:u}}:{},...c.cardObj?{cardObj:{...c.cardObj,foil:u,...c.cardObj.card?{card:{...c.cardObj.card,foil:u}}:{}}}:{}}}return c});return{...l,cards:[...i],lastUpdated:Date.now()}}),Rt(new Set);const a=e.foiled+e.unfoiled;let o=`Updated ${a} card${a!==1?"s":""}`;e.foiled>0&&e.unfoiled>0?o+=` (${e.foiled} to foil, ${e.unfoiled} to non-foil)`:e.foiled>0?o+=" to foil":o+=" to non-foil",P.success(o);const r=localStorage.getItem("token")}catch(t){console.error("[DeckViewEdit] Error toggling foil status:",t),P.error("Failed to toggle foil status")}},ar=e=>(F&&F.length>0?F:(n==null?void 0:n.cards)||[]).find(a=>{var c,g;const o=((c=a.card)==null?void 0:c.name)||a.name,r=a.printing||((g=a.cardObj)==null?void 0:g.printing),l=a.foil||!1;return`${o}_${r||"unknown"}_${l}`===e}),jo=e=>{var o,r,l,i;const a=xo(e)!=="exact-match";return a||e.name||(o=e.cardObj)!=null&&o.name||(l=(r=e.cardObj)==null?void 0:r.card)!=null&&l.name||(i=e.card)==null||i.name,a},bn=e=>{var l,i,c,g,y,C,d;const t=e.name||((l=e.card)==null?void 0:l.name)||"Unknown Card",a=e.count||e.quantity||1;let o="";(c=(i=e.card)==null?void 0:i.scryfall_json)!=null&&c.set?o=e.card.scryfall_json.set.toUpperCase():(g=e.card)!=null&&g.set?o=e.card.set.toUpperCase():e.set&&(o=e.set.toUpperCase());let r="";return(C=(y=e.card)==null?void 0:y.scryfall_json)!=null&&C.collector_number?r=e.card.scryfall_json.collector_number:(d=e.card)!=null&&d.collector_number?r=e.card.collector_number:e.collector_number&&(r=e.collector_number),o&&r?`${a} ${t} [${o}] ${r}`:o?`${a} ${t} [${o}]`:`${a} ${t}`},ir=()=>{try{if(!n||!F||F.length===0){P.warning("No cards to export");return}let e=`${n.name||"Untitled Deck"}
`;e+=`Generated on ${new Date().toLocaleDateString()}
`,e+=`Format: TCGPlayer Mass Entry Compatible

`,e+=`MAIN DECK:
`,e+=`=========
`;const t=(F||[]).sort((l,i)=>{var y,C;const c=(l.name||((y=l.card)==null?void 0:y.name)||"Unknown Card").toLowerCase(),g=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase();return c.localeCompare(g)});if(!Array.isArray(t)){console.error("[FOREACH DEBUG] handleExportToText: sortedCards is not an array:",typeof t,t),P.error("Failed to export: Invalid deck data");return}if(t.forEach(l=>{e+=bn(l)+`
`}),e+=`
Main Deck Total: ${F.length} cards
`,n.sideboard&&n.sideboard.length>0){e+=`
SIDEBOARD:
`,e+=`==========
`;const l=n.sideboard.sort((i,c)=>{var C,d;const g=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase(),y=(c.name||((d=c.card)==null?void 0:d.name)||"Unknown Card").toLowerCase();return g.localeCompare(y)});if(!Array.isArray(l)){console.error("[FOREACH DEBUG] handleExportToText: sortedSideboard is not an array:",typeof l,l),P.error("Failed to export sideboard: Invalid data");return}l.forEach(i=>{e+=bn(i)+`
`}),e+=`
Sideboard Total: ${n.sideboard.length} cards
`}if(n.techIdeas&&n.techIdeas.length>0){e+=`
TECH IDEAS:
`,e+=`===========
`;const l=n.techIdeas.sort((i,c)=>{var C,d;const g=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase(),y=(c.name||((d=c.card)==null?void 0:d.name)||"Unknown Card").toLowerCase();return g.localeCompare(y)});if(!Array.isArray(l)){console.error("[FOREACH DEBUG] handleExportToText: sortedTechIdeas is not an array:",typeof l,l),P.error("Failed to export tech ideas: Invalid data");return}l.forEach(i=>{e+=bn(i)+`
`}),e+=`
Tech Ideas Total: ${n.techIdeas.length} cards
`}const a=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=`${n.name||"deck"}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),P.success("Deck list exported to text file!")}catch(e){console.error("[EXPORT] Error exporting to text:",e),P.error("Failed to export deck list to text")}},lr=async()=>{try{if(!n||!F||F.length===0){P.error("No deck or cards available for PDF export");return}P.info("Generating optimized PDF with compressed images...");const e=async j=>{var W,O,R,D,B,h,G,U,b,te,re,ve,Ze,ie,me,je,qe,yt,Ge;console.log("[EXPORT] Full card structure for:",((W=j.card)==null?void 0:W.name)||j.name,{hasCardObj:!!j.cardObj,hasImageUris:!!j.image_uris,hasCardImageUris:!!((O=j.card)!=null&&O.image_uris),hasScryfallJson:!!j.scryfall_json,hasCardObjScryfallJson:!!((R=j.cardObj)!=null&&R.scryfall_json)});const v=((B=(D=j.cardObj)==null?void 0:D.image_uris)==null?void 0:B.normal)||((U=(G=(h=j.cardObj)==null?void 0:h.card)==null?void 0:G.image_uris)==null?void 0:U.normal)||((te=(b=j.scryfall_json)==null?void 0:b.image_uris)==null?void 0:te.normal)||((Ze=(ve=(re=j.cardObj)==null?void 0:re.scryfall_json)==null?void 0:ve.image_uris)==null?void 0:Ze.normal)||((me=(ie=j.card)==null?void 0:ie.image_uris)==null?void 0:me.normal)||((je=j.image_uris)==null?void 0:je.normal);if(console.log("[EXPORT] Found image URL for",((qe=j.card)==null?void 0:qe.name)||j.name,":",v?"YES":"NO"),!v)return console.log("[EXPORT] No image URL found for card:",((yt=j.card)==null?void 0:yt.name)||j.name),null;try{return await new Promise(ke=>{const ht=async et=>new Promise(Xe=>{const Ie=new Image;Ie.crossOrigin="anonymous",Ie.onload=()=>{var De;try{const ge=document.createElement("canvas"),ue=ge.getContext("2d"),ee=Ie.naturalWidth||Ie.width||200,xe=Ie.naturalHeight||Ie.height||280;ge.width=ee,ge.height=xe;const Ee=15;ue.beginPath(),ue.moveTo(Ee,0),ue.lineTo(ee-Ee,0),ue.quadraticCurveTo(ee,0,ee,Ee),ue.lineTo(ee,xe-Ee),ue.quadraticCurveTo(ee,xe,ee-Ee,xe),ue.lineTo(Ee,xe),ue.quadraticCurveTo(0,xe,0,xe-Ee),ue.lineTo(0,Ee),ue.quadraticCurveTo(0,0,Ee,0),ue.closePath(),ue.clip();const Ae=200,Ft=Math.round(Ae/Ie.naturalWidth*Ie.naturalHeight);ge.width=Ae,ge.height=Ft;const wt=Math.round(Ee*(Ae/Ie.naturalWidth));ue.beginPath(),ue.moveTo(wt,0),ue.lineTo(Ae-wt,0),ue.quadraticCurveTo(Ae,0,Ae,wt),ue.lineTo(Ae,Ft-wt),ue.quadraticCurveTo(Ae,Ft,Ae-wt,Ft),ue.lineTo(wt,Ft),ue.quadraticCurveTo(0,Ft,0,Ft-wt),ue.lineTo(0,wt),ue.quadraticCurveTo(0,0,wt,0),ue.closePath(),ue.clip(),ue.drawImage(Ie,0,0,Ae,Ft);const Zt=ge.toDataURL("image/png",.8);console.log("[EXPORT] Successfully loaded via proxy with size optimization for:",((De=j.card)==null?void 0:De.name)||j.name),Xe(Zt)}catch(ge){console.log("[EXPORT] Proxy canvas conversion failed:",ge),Xe(null)}},Ie.onerror=()=>{console.log("[EXPORT] Proxy image load failed"),Xe(null)},setTimeout(()=>{console.log("[EXPORT] Proxy method timed out after 8 seconds"),Xe(null)},8e3),Ie.src=et});(async()=>{console.log(`[EXPORT] Trying to load image: ${v}`),console.log("[EXPORT] Trying method 1: api.codetabs.com proxy");let et=await ht(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(v)}`);if(et){console.log("[EXPORT] Success with api.codetabs.com proxy"),ke(et);return}if(console.log("[EXPORT] Trying method 2: allorigins.win proxy"),et=await ht(`https://api.allorigins.win/raw?url=${encodeURIComponent(v)}`),et){console.log("[EXPORT] Success with allorigins.win proxy"),ke(et);return}if(console.log("[EXPORT] Trying method 3: cors-anywhere.herokuapp.com proxy"),et=await ht(`https://cors-anywhere.herokuapp.com/${v}`),et){console.log("[EXPORT] Success with cors-anywhere.herokuapp.com proxy"),ke(et);return}const Xe=new Image;Xe.onload=()=>{var Ie;try{const De=document.createElement("canvas"),ge=De.getContext("2d"),ue=200,ee=Math.round(ue/(Xe.naturalWidth||488)*(Xe.naturalHeight||680));De.width=ue,De.height=ee;const xe=Math.round(15*(ue/(Xe.naturalWidth||488)));ge.beginPath(),ge.moveTo(xe,0),ge.lineTo(ue-xe,0),ge.quadraticCurveTo(ue,0,ue,xe),ge.lineTo(ue,ee-xe),ge.quadraticCurveTo(ue,ee,ue-xe,ee),ge.lineTo(xe,ee),ge.quadraticCurveTo(0,ee,0,ee-xe),ge.lineTo(0,xe),ge.quadraticCurveTo(0,0,xe,0),ge.closePath(),ge.clip(),ge.drawImage(Xe,0,0,ue,ee);const Ee=De.toDataURL("image/png",.8);console.log("[EXPORT] Successfully loaded directly with size optimization for:",((Ie=j.card)==null?void 0:Ie.name)||j.name),ke(Ee)}catch(De){console.log("[EXPORT] Direct canvas conversion failed:",De),ke(null)}},Xe.onerror=()=>{console.log("[EXPORT] Direct image load failed"),ke(null)},setTimeout(()=>{var Ie;console.log("[EXPORT] All image loading methods failed, creating placeholder");try{const De=document.createElement("canvas"),ge=De.getContext("2d"),ue=200,ee=280;De.width=ue,De.height=ee,ge.fillStyle="#f0f0f0",ge.fillRect(0,0,ue,ee),ge.strokeStyle="#ccc",ge.lineWidth=2,ge.strokeRect(1,1,ue-2,ee-2),ge.fillStyle="#666",ge.font="14px Arial",ge.textAlign="center";const xe=((Ie=j.card)==null?void 0:Ie.name)||j.name||"Unknown Card",Ee=xe.split(" ");let Ae=ee/2-10;for(let wt=0;wt<Ee.length;wt+=2){const Zt=Ee.slice(wt,wt+2).join(" ");ge.fillText(Zt,ue/2,Ae),Ae+=20}const Ft=De.toDataURL("image/png",.8);console.log("[EXPORT] Created placeholder for:",xe),ke(Ft)}catch(De){console.log("[EXPORT] Failed to create placeholder:",De),ke(null)}},5e3),Xe.src=v})()})}catch(ke){return console.log("[EXPORT] Error loading image for",((Ge=j.card)==null?void 0:Ge.name)||j.name,":",ke),null}},t=j=>{var W,O;const v=j.type_line||((W=j.card)==null?void 0:W.type_line)||((O=j.scryfall_json)==null?void 0:O.type_line)||"";return v.includes("Land")?{type:"Lands",priority:7}:v.includes("Creature")?{type:"Creatures",priority:2}:v.includes("Instant")?{type:"Instants",priority:4}:v.includes("Sorcery")?{type:"Sorceries",priority:5}:v.includes("Artifact")?{type:"Artifacts",priority:3}:v.includes("Enchantment")?{type:"Enchantments",priority:6}:v.includes("Planeswalker")?{type:"Planeswalkers",priority:1}:{type:"Other",priority:8}},a=document.createElement("div");a.style.position="absolute",a.style.left="-9999px",a.style.top="0",a.style.width="794px",a.style.minHeight="1123px",a.style.backgroundColor="white",a.style.padding="38px",a.style.boxSizing="border-box",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="12px",a.style.lineHeight="1.4",document.body.appendChild(a);let o=`
        <div style="width: 100%; box-sizing: border-box; font-family: Arial, sans-serif; color: #333;">
          <div style="text-align: center; margin-bottom: 30px; page-break-inside: avoid;">
            <h1 style="color: #333; margin: 0 0 10px 0; font-size: 24px; font-weight: bold;">${n.name||"Untitled Deck"}</h1>
            <p style="color: #666; margin: 0; font-size: 14px;">Generated on ${new Date().toLocaleDateString()}</p>
          </div>
      `;const r=async(j,v)=>{if(!v||v.length===0){console.log(`[EXPORT] ${j}: No cards to process`);return}console.log(`[EXPORT] Processing ${j} with ${v.length} cards`);const W=v.reduce((B,h)=>{var b;const G=h.name||((b=h.card)==null?void 0:b.name)||"Unknown Card",U=h.count||h.quantity||1;return B[G]?B[G].quantity+=U:B[G]={card:h,quantity:U,typeInfo:t(h)},B},{}),O={};Object.entries(W).forEach(([B,h])=>{const G=h.typeInfo.type;O[G]||(O[G]={cards:[],priority:h.typeInfo.priority}),O[G].cards.push({cardName:B,...h})});const R=Object.entries(O).sort(([,B],[,h])=>B.priority-h.priority).map(([B,h])=>({typeName:B,cards:h.cards.sort((G,U)=>G.cardName.localeCompare(U.cardName))}));o+='<div style="page-break-before: auto; margin-bottom: 40px;">',o+=`<h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin: 30px 0 20px 0; font-size: 20px;">${j}</h2>`;for(const{typeName:B,cards:h}of R)if(h.length!==0){o+=`<h3 style="color: #555; margin: 25px 0 15px 0; font-size: 16px; font-weight: bold;">${B} (${h.reduce((G,U)=>G+U.quantity,0)})</h3>`,o+='<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; width: 100%;">';for(let G=0;G<h.length;G++){const{cardName:U,card:b,quantity:te}=h[G];console.log(`[EXPORT] Processing card ${G+1}/${h.length}: ${U}`);let re=null;try{re=await e(b),re?console.log(`[EXPORT] ‚úÖ Successfully loaded image for ${U}`,{dataUrlLength:re.length,isJpeg:re.startsWith("data:image/jpeg"),isPng:re.startsWith("data:image/png")}):console.log(`[EXPORT] ‚ùå Failed to load image for ${U}`)}catch(ve){console.log(`[EXPORT] ‚ùå Error loading image for ${U}:`,ve)}console.log(`[EXPORT] Adding HTML for ${U}, has dataUrl: ${!!re}`),o+=`
              <div style="
                text-align: center; 
                page-break-inside: avoid; 
                border: 1px solid #ddd; 
                padding: 8px; 
                border-radius: 5px; 
                background: white;
                min-height: 280px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
              ">
                ${re?`<img src="${re}" alt="${U}" style="width: 100%; max-width: 140px; height: auto; border-radius: 4px; margin: 0 auto 8px auto; object-fit: contain;">`:'<div style="width: 140px; height: 195px; background: #f0f0f0; border-radius: 4px; margin: 0 auto 8px auto; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; text-align: center; padding: 8px;">No Image<br/>Available</div>'}
                <div style="font-weight: bold; font-size: 11px; line-height: 1.2; color: #333;">
                  ${te>1?`${te}x `:""}${U}
                </div>
              </div>
            `}o+="</div>"}const D=Object.values(W).reduce((B,h)=>B+h.quantity,0);o+=`<p style="text-align: right; color: #666; font-style: italic; margin: 15px 0; font-size: 12px;">${j} Total: ${D} cards</p>`,o+="</div>"};console.log("[EXPORT] Processing main deck..."),await r("Main Deck",F),n.sideboard&&n.sideboard.length>0&&(console.log("[EXPORT] Processing sideboard..."),await r("Sideboard",n.sideboard)),n.techIdeas&&n.techIdeas.length>0&&(console.log("[EXPORT] Processing tech ideas..."),await r("Tech Ideas",n.techIdeas)),o+="</div>",a.innerHTML=o,console.log("[EXPORT] HTML content set, generating canvas...");const l=a.querySelectorAll("img[src]");console.log("[EXPORT] Found",l.length,"images to wait for");const i=a.querySelectorAll("img");if(console.log("[EXPORT] Total img elements found:",i.length),l.forEach((j,v)=>{console.log(`[EXPORT] Data image ${v+1}:`,{src:j.src.substring(0,50)+"...",complete:j.complete,naturalWidth:j.naturalWidth,naturalHeight:j.naturalHeight})}),i.forEach((j,v)=>{var W;console.log(`[EXPORT] All images ${v+1}:`,{src:j.src?j.src.substring(0,50)+"...":"NO SRC",hasDataSrc:(W=j.src)==null?void 0:W.startsWith("data:image"),complete:j.complete})}),l.length>0){const j=Array.from(l).map((v,W)=>new Promise(O=>{v.complete?(console.log(`[EXPORT] Image ${W+1} already complete`),O()):(v.onload=()=>{console.log(`[EXPORT] Image ${W+1} loaded successfully`),O()},v.onerror=()=>{console.log(`[EXPORT] Image ${W+1} failed to load`),O()},setTimeout(()=>{console.log(`[EXPORT] Image ${W+1} timeout`),O()},3e3))}));await Promise.all(j),console.log("[EXPORT] All images processed")}else console.log("[EXPORT] No images found - this might be the issue!");console.log("[EXPORT] Skipping html2canvas, creating PDF directly from images...");const c=Array.from(l);console.log("[EXPORT] Creating optimized PDF from",c.length,"compressed card images");const g=a.querySelectorAll("img");console.log("[EXPORT] Found",g.length,"compressed images in container");const y=new hr({orientation:"p",unit:"mm",format:"a4",compress:!0}),C=210,d=297,$=10,f=C-2*$,u=d-2*$,I=63/88,x=3,_=f/x,S=_/I,k=Math.floor(u/S)*x;console.log("[EXPORT] Card layout:",{cardsPerRow:x,cardWidth:_.toFixed(1)+"mm",cardHeight:S.toFixed(1)+"mm",cardsPerPage:k});let E=0,N=1;for(y.setFontSize(24),y.text(n.name||"Magic Deck",C/2,50,{align:"center"}),y.setFontSize(12),y.text(`Generated on ${new Date().toLocaleDateString()}`,C/2,70,{align:"center"}),y.text(`${c.length} cards`,C/2,85,{align:"center"});E<g.length;){const j=Math.min(k,g.length-E);N>1&&y.addPage(),console.log(`[EXPORT] Creating page ${N} with ${j} cards`);for(let v=0;v<j;v++){const W=g[E+v];if(!W||!W.src)continue;const O=Math.floor(v/x),R=v%x,D=$+R*_,B=$+O*S;try{y.addImage(W.src,"PNG",D,B,_,S),console.log(`[EXPORT] Added optimized card ${E+v+1} at position (${D.toFixed(1)}, ${B.toFixed(1)})`)}catch(h){console.error(`[EXPORT] Failed to add card ${E+v+1}:`,h)}}if(E+=j,N++,N>50){console.warn("[EXPORT] Safety break: Maximum pages reached");break}}console.log("[EXPORT] Total pages created:",N-1),document.body.removeChild(a),y.save(`${n.name||"deck"}.pdf`),P.success("Deck exported to optimized PDF! File size reduced by ~60%"),console.log("[EXPORT] Optimized PDF export completed successfully")}catch(e){console.error("[EXPORT] Error exporting to PDF:",e),P.error("Failed to export deck to PDF");const t=document.querySelector('div[style*="left: -9999px"]');t&&document.body.removeChild(t)}},cr=()=>{try{if(console.log("[EXPORT] Starting wishlist text export..."),!n||!F||F.length===0){P.warning("No cards to export");return}const e=F.filter(g=>jo(g));if(e.length===0){P.info("All cards are already in your collection!");return}let t=`${n.name||"Untitled Deck"} - Wishlist
`;t+=`Generated on ${new Date().toLocaleDateString()}
`,t+=`Format: TCGPlayer Mass Entry Compatible
`,t+=`Cards needed: ${e.length} of ${F.length} total

`;const a=e.filter(g=>!g.sideboard&&!g.techIdeas);a.length>0&&(t+=`Main Deck Wishlist:
`,t+=`====================
`,a.sort((y,C)=>{var f,u;const d=(((f=y.card)==null?void 0:f.name)||y.name||"Unknown Card").toLowerCase(),$=(((u=C.card)==null?void 0:u.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare($)}).forEach(y=>{t+=bn(y)+`
`}),t+=`
`);const o=e.filter(g=>g.sideboard);o.length>0&&(t+=`Sideboard Wishlist:
`,t+=`===================
`,o.sort((y,C)=>{var f,u;const d=(((f=y.card)==null?void 0:f.name)||y.name||"Unknown Card").toLowerCase(),$=(((u=C.card)==null?void 0:u.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare($)}).forEach(y=>{t+=bn(y)+`
`}),t+=`
`);const r=e.filter(g=>g.techIdeas);r.length>0&&(t+=`Tech Ideas Wishlist:
`,t+=`====================
`,r.sort((y,C)=>{var f,u;const d=(((f=y.card)==null?void 0:f.name)||y.name||"Unknown Card").toLowerCase(),$=(((u=C.card)==null?void 0:u.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare($)}).forEach(y=>{t+=bn(y)+`
`}));const l=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(l),c=document.createElement("a");c.href=i,c.download=`${n.name||"deck"}_wishlist.txt`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(i),P.success(`Wishlist exported! ${e.length} cards needed.`),console.log("[EXPORT] Wishlist text export completed successfully")}catch(e){console.error("[EXPORT] Error exporting wishlist to text:",e),P.error("Failed to export wishlist to text")}},dr=async()=>{try{if(console.log("[EXPORT] Starting wishlist PDF export..."),!n||!F||F.length===0){P.error("No deck or cards available for wishlist PDF export");return}const e=F.filter(S=>jo(S));if(e.length===0){P.info("All cards are already in your collection!");return}P.info("Generating wishlist PDF with card images...");const t=async S=>{var E,N,j,v,W,O,R,D,B,h,G,U,b;const k=((N=(E=S.cardObj)==null?void 0:E.image_uris)==null?void 0:N.normal)||((W=(v=(j=S.cardObj)==null?void 0:j.card)==null?void 0:v.image_uris)==null?void 0:W.normal)||((R=(O=S.scryfall_json)==null?void 0:O.image_uris)==null?void 0:R.normal)||((h=(B=(D=S.cardObj)==null?void 0:D.scryfall_json)==null?void 0:B.image_uris)==null?void 0:h.normal)||((U=(G=S.card)==null?void 0:G.image_uris)==null?void 0:U.normal)||((b=S.image_uris)==null?void 0:b.normal);return k?new Promise(te=>{const re=new Image;re.crossOrigin="anonymous",re.onload=()=>{const ve=document.createElement("canvas"),Ze=ve.getContext("2d");ve.width=re.width,ve.height=re.height,Ze.drawImage(re,0,0),te(ve.toDataURL("image/jpeg",.6))},re.onerror=()=>te(null),re.src=k}):null},a=document.createElement("div");a.style.position="absolute",a.style.left="-9999px",a.style.top="-9999px",a.style.width="200px",a.style.height="280px",document.body.appendChild(a);const o=[];for(const S of e){const k=await t(S);if(k){const E=document.createElement("img");E.src=k,E.style.width="200px",E.style.height="auto",a.appendChild(E),o.push({src:k,card:S})}}const{jsPDF:r}=window.jspdf||await mr(()=>import("./jspdf.es.min-DtPQpl4u.js").then(S=>S.j),__vite__mapDeps([0,1,2,3,4])),l=new r({orientation:"p",unit:"mm",format:"a4",compress:!0}),i=210,c=297,g=10,y=i-2*g,C=c-2*g,d=63/88,$=3,f=y/$,u=f/d,I=Math.floor(C/u)*$;console.log("[EXPORT] Wishlist card layout:",{cardsPerRow:$,cardWidth:f.toFixed(1)+"mm",cardHeight:u.toFixed(1)+"mm",cardsPerPage:I});let x=0,_=1;for(l.setFontSize(24),l.text(`${n.name||"Untitled Deck"} - Wishlist`,i/2,50,{align:"center"}),l.setFontSize(12),l.text(`Generated on ${new Date().toLocaleDateString()}`,i/2,70,{align:"center"}),l.text(`Cards needed: ${e.length} of ${F.length} total`,i/2,85,{align:"center"});x<o.length;){const S=Math.min(I,o.length-x);_>1&&l.addPage(),console.log(`[EXPORT] Creating wishlist page ${_} with ${S} cards`);for(let k=0;k<S;k++){const E=o[x+k];if(!E||!E.src)continue;const N=Math.floor(k/$),j=k%$,v=g+j*f,W=g+N*u;try{l.addImage(E.src,"PNG",v,W,f,u),console.log(`[EXPORT] Added wishlist card ${x+k+1} at position (${v.toFixed(1)}, ${W.toFixed(1)})`)}catch(O){console.error(`[EXPORT] Failed to add wishlist card ${x+k+1}:`,O)}}if(x+=S,_++,_>50){console.warn("[EXPORT] Safety break: Maximum pages reached");break}}console.log("[EXPORT] Total wishlist pages created:",_-1),document.body.removeChild(a),l.save(`${n.name||"deck"}_wishlist.pdf`),P.success(`Wishlist PDF exported! ${e.length} cards needed.`),console.log("[EXPORT] Wishlist PDF export completed successfully")}catch(e){console.error("[EXPORT] Error exporting wishlist to PDF:",e),P.error("Failed to export wishlist to PDF")}},Eo=async(e,t={})=>{try{if(!e||e.trim()===""){P.warning("No text content provided");return}const a=e.trim().split(`
`),o={mainDeck:[],sideboard:[],techIdeas:[],errors:[]};let r="mainDeck";for(let C=0;C<a.length;C++){const d=a[C].trim();if(!d||d.startsWith("===")||d.includes("Generated on")||d.includes("Format:")||d.includes("Total:"))continue;if(d.toUpperCase().includes("MAIN DECK")){r="mainDeck";continue}if(d.toUpperCase().includes("SIDEBOARD")){r="sideboard";continue}if(d.toUpperCase().includes("TECH IDEAS")){r="techIdeas";continue}const $=d.match(/^(\d+)\s+(.+?)(?:\s+\[([A-Z0-9]+)\](?:\s+(\w+))?)?$/);if($){const[,f,u,I,x]=$,_={name:u.trim(),quantity:parseInt(f),set:I==null?void 0:I.toLowerCase(),collector_number:x};o[r].push(_),console.log(`[IMPORT] Parsed: ${f}x ${u} (${I||"no set"})`)}else{const f=d.match(/^(\d+)\s+(.+)$/);if(f){const[,u,I]=f;o[r].push({name:I.trim(),quantity:parseInt(u)}),console.log(`[IMPORT] Parsed (simple): ${u}x ${I}`)}else o.errors.push(`Line ${C+1}: Could not parse "${d}"`)}}const i=(await Promise.all(o.mainDeck.map(async C=>{var d;try{let $=C.name;C.set&&($+=` set:${C.set}`);const u=await(await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent($)}`)).json();if(u.data&&u.data.length>0){const I=u.data[0];return{name:I.name,card:{name:I.name,scryfall_json:{...I,image_uris:I.image_uris||I.card_faces&&((d=I.card_faces[0])==null?void 0:d.image_uris)},printing:I.id,set:I.set,collector_number:I.collector_number},count:C.quantity,quantity:C.quantity,printing:I.id,scryfall_id:I.id,added_at:new Date().toISOString()}}else return o.errors.push(`Card not found: ${C.name}`),null}catch($){return console.error(`[IMPORT] Error searching for ${C.name}:`,$),o.errors.push(`Error searching for: ${C.name}`),null}}))).filter(C=>C!==null);if(i.length===0){P.error("No valid cards found to import");return}const c=localStorage.getItem("token"),g="";try{const C=i.map(f=>({name:f.name,quantity:f.count,isCommander:!1,set:f.card.set,collector_number:f.card.collector_number,scryfall_id:f.scryfall_id,card:f.card,scryfallCard:f.card})),d={...n,cards:[...n.cards||[],...C]},$=await fetch(`${g}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(d),credentials:"include"});if($.ok)o.successful=i.length;else{const f=await $.text();console.error("[IMPORT] Server error:",f),o.errors.push(`Failed to add cards: ${$.status}`)}}catch(C){console.error("[IMPORT] Error adding cards:",C),o.errors.push(`Error adding cards: ${C.message}`)}try{const C=await fetch(`${g}/api/decks/${n._id}`,{method:"GET",headers:{Authorization:`Bearer ${c}`},credentials:"include"});if(C.ok){const d=await C.json();le(d),Y(d.cards||[])}}catch(C){console.error("[IMPORT] Error refreshing deck:",C)}const y=`Successfully imported ${i.length} cards${o.errors.length>0?` (${o.errors.length} errors)`:""}`;P.success(y),o.errors.length>0&&console.warn("[IMPORT] Import completed with errors:",o.errors)}catch(a){console.error("[IMPORT] Error importing text:",a),P.error("Failed to import deck list from text")}},Kn=async e=>{try{console.log(`[REMOVE FROM SIDEBOARD] Removing card at index ${e} from sideboard`);const t=[...n.sideboard],a=t.splice(e,1)[0],o={...n,sideboard:t,lastUpdated:Date.now()};le(o),Wt(o._id,o.sideboard,o.techIdeas),P.success(`Removed ${(a==null?void 0:a.name)||"card"} from sideboard`),console.log("[REMOVE FROM SIDEBOARD] Successfully removed from sideboard")}catch(t){console.error("Error removing card from sideboard:",t),P.error("Error removing card from sideboard")}},Qn=async e=>{try{console.log(`[REMOVE FROM TECH IDEAS] Removing card at index ${e} from tech ideas`);const t=[...n.techIdeas],a=t.splice(e,1)[0],o={...n,techIdeas:t,lastUpdated:Date.now()};le(o),Wt(o._id,o.sideboard,o.techIdeas),P.success(`Removed ${(a==null?void 0:a.name)||"card"} from tech ideas`),console.log("[REMOVE FROM TECH IDEAS] Successfully removed from tech ideas")}catch(t){console.error("Error removing card from tech ideas:",t),P.error("Error removing card from tech ideas")}},co=async(e,t)=>{var a,o,r,l,i,c,g,y,C,d,$,f,u,I,x,_,S,k,E,N,j,v,W,O;try{const R=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE FROM SIDEBOARD] Moving ${R} from sideboard to main deck`);const D=[...n.sideboard];D.splice(t,1);const B={name:R,printing:e.printing||((o=e.scryfall_json)==null?void 0:o.id)||((l=(r=e.card)==null?void 0:r.scryfall_json)==null?void 0:l.id),quantity:1,modalPrice:e.modalPrice,type_line:((i=e.cardObj)==null?void 0:i.type_line)||e.type_line||((c=e.card)==null?void 0:c.type_line)||((g=e.scryfall_json)==null?void 0:g.type_line)||((C=(y=e.card)==null?void 0:y.scryfall_json)==null?void 0:C.type_line),scryfall_json:e.scryfall_json||((d=e.card)==null?void 0:d.scryfall_json)||(($=e.cardObj)==null?void 0:$.scryfall_json),cardObj:e.cardObj||e,card:e.card||{name:R,type_line:((f=e.cardObj)==null?void 0:f.type_line)||e.type_line||((u=e.card)==null?void 0:u.type_line)||((I=e.scryfall_json)==null?void 0:I.type_line)||((_=(x=e.card)==null?void 0:x.scryfall_json)==null?void 0:_.type_line),scryfall_json:e.scryfall_json||((S=e.card)==null?void 0:S.scryfall_json)||((k=e.cardObj)==null?void 0:k.scryfall_json)}},h={...n,cards:[...n.cards||[],B],sideboard:D,cardCount:(((E=n.cards)==null?void 0:E.length)||0)+1,lastUpdated:Date.now()};console.log(`[MOVE FROM SIDEBOARD] New deck prepared with ${h.cards.length} main cards, ${h.sideboard.length} sideboard cards`),console.log("[MOVE FROM SIDEBOARD] Card type info preserved:",JSON.stringify({name:B.name,type_line:B.type_line,scryfall_type:(N=B.scryfall_json)==null?void 0:N.type_line,card_type:(j=B.card)==null?void 0:j.type_line,originalCard_cardObj_type:(v=e.cardObj)==null?void 0:v.type_line,originalCard_type_line:e.type_line,originalCard_scryfall_type:(W=e.scryfall_json)==null?void 0:W.type_line,originalCard_card_type:(O=e.card)==null?void 0:O.type_line},null,2)),le(h),Y(h.cards||[]),Wt(h._id,h.sideboard,h.techIdeas),console.log("[MOVE FROM SIDEBOARD] Attempting to save deck to server...");try{await Hn(h),console.log("[MOVE FROM SIDEBOARD] Server save completed successfully")}catch(G){console.error("[MOVE FROM SIDEBOARD] Failed to save deck to server:",G),console.log("[MOVE FROM SIDEBOARD] Move successful in UI, zones saved to localStorage")}P.success(`Moved ${R} to Main Deck`),console.log("[MOVE FROM SIDEBOARD] === FUNCTION COMPLETED SUCCESSFULLY ===")}catch(R){console.error("Error moving card from sideboard to main deck:",R),P.error("Error moving card from sideboard to main deck")}},fo=async(e,t)=>{var a;try{const o=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE BETWEEN ZONES] Moving ${o} from sideboard to tech ideas`);let r;le(l=>{var y,C,d,$,f,u;if(!l||!l.sideboard)return l;const i=[...l.sideboard],c=i.splice(t,1)[0],g={name:o,printing:c.printing||((y=c.scryfall_json)==null?void 0:y.id)||((d=(C=c.card)==null?void 0:C.scryfall_json)==null?void 0:d.id),foil:c.foil||(($=c.card)==null?void 0:$.foil)||!1,count:1,modalPrice:c.modalPrice,type_line:c.type_line||((f=c.card)==null?void 0:f.type_line),scryfall_json:c.scryfall_json||((u=c.card)==null?void 0:u.scryfall_json),cardObj:c.cardObj||c};return r={...l,sideboard:i,techIdeas:[...l.techIdeas||[],g],lastUpdated:Date.now()},r}),r&&Wt(r._id,r.sideboard,r.techIdeas),P.success(`Moved ${o} to Tech Ideas`)}catch(o){console.error("Error moving card from sideboard to tech ideas:",o),P.error("Error moving card from sideboard to tech ideas")}},uo=async(e,t)=>{var a,o,r,l,i,c,g,y,C,d,$,f,u,I,x,_,S,k,E;try{const N=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE FROM TECH IDEAS] Moving ${N} from tech ideas to main deck`);const j=[...n.techIdeas];j.splice(t,1);const v={name:N,printing:e.printing||((o=e.scryfall_json)==null?void 0:o.id)||((l=(r=e.card)==null?void 0:r.scryfall_json)==null?void 0:l.id),quantity:1,modalPrice:e.modalPrice,type_line:((i=e.cardObj)==null?void 0:i.type_line)||e.type_line||((c=e.card)==null?void 0:c.type_line)||((g=e.scryfall_json)==null?void 0:g.type_line)||((C=(y=e.card)==null?void 0:y.scryfall_json)==null?void 0:C.type_line),scryfall_json:e.scryfall_json||((d=e.card)==null?void 0:d.scryfall_json)||(($=e.cardObj)==null?void 0:$.scryfall_json),cardObj:e.cardObj||e,card:e.card||{name:N,type_line:((f=e.cardObj)==null?void 0:f.type_line)||e.type_line||((u=e.card)==null?void 0:u.type_line)||((I=e.scryfall_json)==null?void 0:I.type_line)||((_=(x=e.card)==null?void 0:x.scryfall_json)==null?void 0:_.type_line),scryfall_json:e.scryfall_json||((S=e.card)==null?void 0:S.scryfall_json)||((k=e.cardObj)==null?void 0:k.scryfall_json)}},W={...n,cards:[...n.cards||[],v],techIdeas:j,cardCount:(((E=n.cards)==null?void 0:E.length)||0)+1,lastUpdated:Date.now()};le(W),Y(W.cards||[]),Wt(W._id,W.sideboard,W.techIdeas);try{await Hn(W)}catch(O){console.error("[MOVE FROM TECH IDEAS] Failed to save deck to server:",O),console.log("[MOVE FROM TECH IDEAS] Move successful in UI, zones saved to localStorage")}P.success(`Moved ${N} to Main Deck`),console.log("[MOVE FROM TECH IDEAS] === FUNCTION COMPLETED SUCCESSFULLY ===")}catch(N){console.error("Error moving card from tech ideas to main deck:",N),P.error("Error moving card from tech ideas to main deck")}},mo=async(e,t)=>{var a,o,r;try{let l=e.modalPrice||((a=e.cardObj)==null?void 0:a.modalPrice)||((r=(o=e.cardObj)==null?void 0:o.card)==null?void 0:r.modalPrice);if(!pr(l)&&(l=Vt(e).price,!l)){const c=(g,y=0)=>{var C;if(y>10||!g||typeof g!="object")return null;if((C=g.prices)!=null&&C.usd)return g.prices.usd;if(g.usd)return g.usd;if(g.price)return g.price;for(const d of Object.values(g))if(d&&typeof d=="object"){const $=c(d,y+1);if($)return $}return null};l=c(e)||"0.24",console.log(`[ZONE MOVE] Deep search price for ${e.name}: $${l}`)}le(i=>{const c=[...i.techIdeas||[]],g=[...i.sideboard||[]],C={...c.splice(t,1)[0],modalPrice:l};return g.push(C),{...i,techIdeas:c,sideboard:g}}),Wt(n._id,[...n.sideboard||[],{...e,modalPrice:l}],[...n.techIdeas||[]].filter((i,c)=>c!==t)),P.success(`Moved ${e.name} to sideboard`)}catch(l){console.error("Error moving card from tech ideas to sideboard:",l),P.error("Error moving card to sideboard")}},vo=async e=>{try{console.log(`[ADD TO TECH IDEAS] Adding ${e.name} to tech ideas`);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line},scryfall_json:e},a={...n,techIdeas:[...n.techIdeas||[],t],lastUpdated:Date.now()};le(a),Wt(a._id,a.sideboard,a.techIdeas),P.success(`Added ${e.name} to Tech Ideas`),console.log("[ADD TO TECH IDEAS] Successfully added to tech ideas")}catch(t){console.error("Error adding card to tech ideas:",t),P.error("Error adding card to tech ideas")}},ko=async e=>{try{console.log(`[ADD TO SIDEBOARD] Adding ${e.name} to sideboard`);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line},scryfall_json:e},a={...n,sideboard:[...n.sideboard||[],t],lastUpdated:Date.now()};le(a),Wt(a._id,a.sideboard,a.techIdeas),P.success(`Added ${e.name} to Sideboard`),console.log("[ADD TO SIDEBOARD] Successfully added to sideboard")}catch(t){console.error("Error adding card to sideboard:",t),P.error("Error adding card to sideboard")}},$o=async e=>{try{console.log("Add to Wishlist:",e.name);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,dateAdded:Date.now(),cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,set_name:e.set_name,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,cmc:e.cmc,colors:e.colors,color_identity:e.color_identity,prices:e.prices},scryfall_json:e},a=JSON.parse(localStorage.getItem("global-wishlist")||"[]"),o=a.findIndex(r=>r.name===e.name&&r.printing===(e.scryfall_id||e.id));o!==-1?(a[o].count+=1,P.success(`Updated ${e.name} quantity in wishlist (now ${a[o].count})`)):(a.push(t),P.success(`Added ${e.name} to wishlist`)),localStorage.setItem("global-wishlist",JSON.stringify(a)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:a}))}catch(t){console.error("Error adding card to wishlist:",t),P.error("Error adding card to wishlist")}},Jn=async e=>{var t;try{const a=((t=e.card)==null?void 0:t.name)||e.name;console.log(`[MOVE TO SIDEBOARD] Moving ${a} from main deck to sideboard`);let o;if(le(r=>{var c,g,y,C,d,$,f;if(!r)return r;const l=(r.cards||[]).filter(u=>{var x,_,S,k;return(u.name||((x=u.card)==null?void 0:x.name)||((_=u.cardObj)==null?void 0:_.name)||((k=(S=u.cardObj)==null?void 0:S.card)==null?void 0:k.name))!==a}),i={name:a,printing:e.printing||((c=e.scryfall_json)==null?void 0:c.id)||((y=(g=e.card)==null?void 0:g.scryfall_json)==null?void 0:y.id),foil:e.foil||((C=e.card)==null?void 0:C.foil)||!1,count:1,modalPrice:e.modalPrice||((d=e.card)==null?void 0:d.modalPrice),type_line:e.type_line||(($=e.card)==null?void 0:$.type_line),scryfall_json:e.scryfall_json||((f=e.card)==null?void 0:f.scryfall_json),cardObj:e};return o={...r,cards:l,sideboard:[...r.sideboard||[],i],cardCount:l.length,lastUpdated:Date.now()},o}),o&&(Y(o.cards||[]),Wt(o._id,o.sideboard,o.techIdeas)),o)try{await Hn(o)}catch(r){console.error("[MOVE TO SIDEBOARD] Failed to save deck to server:",r),console.log("[MOVE TO SIDEBOARD] Sideboard move successful in UI (client-side only)")}P.success(`Moved ${a} to Sideboard`)}catch(a){console.error("Error moving card to sideboard:",a),P.error("Error moving card to sideboard")}},Yn=async e=>{var t;try{const a=((t=e.card)==null?void 0:t.name)||e.name;console.log(`[MOVE TO TECH IDEAS] Moving ${a} from main deck to tech ideas`);let o;if(le(r=>{var c,g,y,C,d,$,f;if(!r)return r;const l=(r.cards||[]).filter(u=>{var x,_,S,k;return(u.name||((x=u.card)==null?void 0:x.name)||((_=u.cardObj)==null?void 0:_.name)||((k=(S=u.cardObj)==null?void 0:S.card)==null?void 0:k.name))!==a}),i={name:a,printing:e.printing||((c=e.scryfall_json)==null?void 0:c.id)||((y=(g=e.card)==null?void 0:g.scryfall_json)==null?void 0:y.id),foil:e.foil||((C=e.card)==null?void 0:C.foil)||!1,count:1,modalPrice:e.modalPrice||((d=e.card)==null?void 0:d.modalPrice),type_line:e.type_line||(($=e.card)==null?void 0:$.type_line),scryfall_json:e.scryfall_json||((f=e.card)==null?void 0:f.scryfall_json),cardObj:e};return o={...r,cards:l,techIdeas:[...r.techIdeas||[],i],cardCount:l.length,lastUpdated:Date.now()},o}),o&&(Y(o.cards||[]),Wt(o._id,o.sideboard,o.techIdeas)),o)try{await Hn(o)}catch(r){console.error("[MOVE TO TECH IDEAS] Failed to save deck to server:",r),console.log("[MOVE TO TECH IDEAS] Tech ideas move successful in UI (client-side only)")}P.success(`Moved ${a} to Tech Ideas`)}catch(a){console.error("Error moving card to tech ideas:",a),P.error("Error moving card to tech ideas")}},[kt,Cn]=A.useState({open:!1,x:0,y:0,cardObj:null});return A.useEffect(()=>{if(!kt.open)return;const e=()=>Cn({open:!1,x:0,y:0,cardObj:null});return window.addEventListener("click",e),window.addEventListener("contextmenu",e),()=>{window.removeEventListener("click",e),window.removeEventListener("contextmenu",e)}},[kt.open]),A.useEffect(()=>(typeof window<"u"&&(window.deckEditApp={handleAddToSideboard:ko,handleAddToTechIdeas:vo,handleMoveToSideboard:Jn,handleMoveToTechIdeas:Yn,handleRemoveFromSideboard:Kn,handleRemoveFromTechIdeas:Qn,setModalState:L,openCardModal:e=>{var a,o;console.log("[ORACLE TAG MODAL] Opening CardActionsModal for:",e.name);const t={name:e.name,printing:e.scryfall_id||e.id,cardObj:{name:e.name,scryfall_id:e.scryfall_id||e.id,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,oracle_text:e.oracle_text,power:e.power,toughness:e.toughness,cmc:e.cmc||e.converted_mana_cost,rarity:e.rarity,prices:e.prices},card:{name:e.name,scryfall_json:e,type_line:e.type_line},scryfall_json:e,foil:!1,count:1,modalPrice:((a=e.prices)==null?void 0:a.usd)||((o=e.prices)==null?void 0:o.usd_foil)||"0.00"};L({isOpen:!0,cardObj:t})}},$e.current%50===0&&console.log("[GLOBAL FUNCTIONS] Exposed deck editing functions to window.deckEditApp")),()=>{typeof window<"u"&&window.deckEditApp&&delete window.deckEditApp}),[n==null?void 0:n._id]),_e?s.jsxs("div",{className:"container",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",textAlign:"center"},children:[s.jsx("div",{style:{fontSize:"18px",marginBottom:"12px",color:"#333"},children:"Loading deck..."}),s.jsx("div",{style:{fontSize:"14px",color:"#666",maxWidth:"400px",lineHeight:"1.4"},children:"If this is taking longer than expected, the server may be starting up. This can take up to 30 seconds on the first load."}),s.jsx("div",{style:{marginTop:"20px",width:"40px",height:"40px",border:"4px solid #f3f3f3",borderTop:"4px solid #3498db",borderRadius:"50%",animation:"spin 1s linear infinite"}}),s.jsx("style",{dangerouslySetInnerHTML:{__html:`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}})]}):n?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"deck-title-bar",style:{width:"100%",textAlign:"center",background:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",paddingTop:8,paddingBottom:8},children:s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"16px",flexWrap:"wrap"},children:[s.jsx("h2",{style:{margin:0,fontSize:"2rem",fontWeight:700,letterSpacing:"-0.5px",cursor:"pointer",display:"inline-block",transition:"color 0.15s"},title:"Click to copy deck link",onClick:async()=>{try{const e=window.location.origin+`/decks/${T}`;await navigator.clipboard.writeText(e),P.success("Deck link copied!")}catch{P.error("Failed to copy link")}},onMouseOver:e=>e.currentTarget.style.color="#1976d2",onMouseOut:e=>e.currentTarget.style.color="",children:n.name||"Untitled Deck"}),!K&&s.jsx("button",{onClick:()=>{const e=`${window.location.origin}/public/decks/${T}`;navigator.clipboard.writeText(e),P.success("Public share link copied to clipboard!")},style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"6px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",marginTop:"4px",marginBottom:"8px",display:"flex",alignItems:"center",gap:"4px",width:"fit-content"},onMouseOver:e=>e.currentTarget.style.backgroundColor="#1976d2",onMouseOut:e=>e.currentTarget.style.backgroundColor="#2196f3",children:"üîó Copy Public Share Link"}),K&&s.jsxs("div",{style:{backgroundColor:"#e3f2fd",border:"1px solid #2196f3",borderRadius:"6px",padding:"8px 12px",marginTop:"8px",marginBottom:"8px",display:"flex",alignItems:"center",gap:"8px",color:"#1976d2",fontSize:"14px",fontWeight:"500"},children:[s.jsx("span",{children:"üëÅÔ∏è"}),s.jsx("span",{children:"Public View (Read-Only) - This deck is shared publicly and cannot be edited"})]}),!K&&s.jsxs("div",{style:{display:"flex",gap:"12px",alignItems:"center"},children:[s.jsxs("div",{className:"import-dropdown-container",style:{position:"relative",display:"inline-block"},children:[s.jsxs("button",{onClick:()=>Z(!J),style:{backgroundColor:"#4caf50",color:"white",border:"none",padding:"10px 16px",borderRadius:"6px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},onMouseEnter:e=>{e.target.style.backgroundColor="#388e3c",e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 8px rgba(0,0,0,0.15)"},onMouseLeave:e=>{e.target.style.backgroundColor="#4caf50",e.target.style.transform="translateY(0)",e.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"},title:"Import Options",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M12,12L16,16H13V19H11V16H8L12,12Z"})}),"Import",s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",style:{transform:J?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s ease"},children:s.jsx("path",{d:"M7,10L12,15L17,10H7Z"})})]}),J&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:"0",marginTop:"4px",backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",boxShadow:"0 4px 16px rgba(0,0,0,0.15)",zIndex:1e3,minWidth:"240px",overflow:"hidden"},children:[s.jsxs("div",{onClick:()=>{ce(!0),Z(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#4caf50",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M12,12L16,16H13V19H11V16H8L12,12Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Import from Text"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Paste or upload card list"})]})]}),s.jsxs("div",{onClick:()=>{we(!0),Z(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#ff9800",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M9,15A1,1 0 0,1 8,14A1,1 0 0,1 9,13A1,1 0 0,1 10,14A1,1 0 0,1 9,15M16,15H11L13,12L14.25,13.25L15.75,11.75L17,13V15H16Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Import from Photo/PDF"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Upload card images or PDFs"})]})]})]})]}),s.jsxs("div",{className:"export-dropdown-container",style:{position:"relative",display:"inline-block"},children:[s.jsxs("button",{onClick:()=>X(!w),style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"10px 16px",borderRadius:"6px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},onMouseEnter:e=>{e.target.style.backgroundColor="#1976d2",e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 8px rgba(0,0,0,0.15)"},onMouseLeave:e=>{e.target.style.backgroundColor="#2196f3",e.target.style.transform="translateY(0)",e.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"},title:"Export Options",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),"Export",s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",style:{transform:w?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s ease"},children:s.jsx("path",{d:"M7,10L12,15L17,10H7Z"})})]}),w&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:"0",marginTop:"4px",backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",boxShadow:"0 4px 16px rgba(0,0,0,0.15)",zIndex:1e3,minWidth:"220px",overflow:"hidden"},children:[s.jsxs("div",{onClick:()=>{ir(),X(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#4caf50",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Entire Text"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"All cards as plain text file"})]})]}),s.jsxs("div",{onClick:()=>{lr(),X(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#ff5722",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M9,13V19A1,1 0 0,0 10,20H14A1,1 0 0,0 15,19V13A1,1 0 0,0 14,12H10A1,1 0 0,0 9,13Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Entire PDF"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"All cards with images as PDF"})]})]}),s.jsxs("div",{onClick:()=>{cr(),X(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#2196f3",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M10,11H14V12H10V11Z M10,14H17V15H10V14Z M10,17H17V18H10V17Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Text Wishlist"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Cards not in collection as text"})]})]}),s.jsxs("div",{onClick:()=>{dr(),X(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#9c27b0",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M10,11H14V12H10V11Z M16,11H17V12H16V11Z M10,14H17V15H10V14Z M10,17H14V18H10V17Z M16,17H17V18H16V17Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export PDF Wishlist"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Cards not in collection as PDF"})]})]})]})]})]})]})}),s.jsx("div",{className:"deck-container",style:{paddingBottom:"50px"},children:s.jsxs("div",{className:"deck-layout",style:{alignItems:"flex-start"},children:[s.jsxs("div",{className:"deck-sidebar",children:[Be&&Be.card&&s.jsx(ur,{preview:Be,showPreview:!0,isFixed:!0,externalFlipState:Be==null?void 0:Be.flipState,style:{height:"auto",maxHeight:"400px",maxWidth:"100%",borderRadius:"4.75%",background:"white",marginBottom:"12px",padding:0,boxShadow:"0 2px 8px rgba(0,0,0,0.04)",objectFit:"contain"}}),s.jsxs("div",{className:"search-container",style:{position:"relative",display:"flex",justifyContent:"center",marginBottom:"8pt"},children:[s.jsx("input",{type:"text",placeholder:"Search for cards to add (Scryfall syntax supported)...",value:$t,"data-deck-view-search":"true",onChange:e=>{_t(e.target.value)},onBlur:e=>{const t=e.currentTarget,a=t.closest(".search-container");setTimeout(()=>{const o=document.activeElement,r=a==null?void 0:a.querySelector('[style*="position: absolute"]'),l=r&&r.contains(o);!(o===t)&&!l&&(_t(""),Dt([]),He(""),Pt(!1),rt(-1))},200)},onKeyDown:e=>{if(Yt&&(nt.length>0||ae)){const t=nt.length+(nt.length>0?1:0);if(e.key==="ArrowDown"){e.preventDefault(),rt(a=>{const o=a<t-1?a+1:0;if(o<nt.length&&nt[o]){const r=nt[o],l={name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,card:{name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,...r.image_uris&&{image_uris:r.image_uris},...r.scryfall_json&&{scryfall_json:r.scryfall_json},...r.mana_cost&&{mana_cost:r.mana_cost},...r.type_line&&{type_line:r.type_line},...r.oracle_text&&{oracle_text:r.oracle_text},...r.power&&{power:r.power},...r.toughness&&{toughness:r.toughness},...r.loyalty&&{loyalty:r.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:r.set||r.set_name||null,set:r.set||r.set_name||null,collector_number:r.collector_number||null};st(l)}return o});return}if(e.key==="ArrowUp"){e.preventDefault(),rt(a=>{const o=a>0?a-1:t-1;if(o<nt.length&&nt[o]){const r=nt[o],l={name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,card:{name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,...r.image_uris&&{image_uris:r.image_uris},...r.scryfall_json&&{scryfall_json:r.scryfall_json},...r.mana_cost&&{mana_cost:r.mana_cost},...r.type_line&&{type_line:r.type_line},...r.oracle_text&&{oracle_text:r.oracle_text},...r.power&&{power:r.power},...r.toughness&&{toughness:r.toughness},...r.loyalty&&{loyalty:r.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:r.set||r.set_name||null,set:r.set||r.set_name||null,collector_number:r.collector_number||null};st(l)}return o});return}if(e.key==="Enter"){if(e.preventDefault(),Oe>=0&&Oe<nt.length){const a=nt[Oe];zt(a),_t(""),Pt(!1),rt(-1);return}else if(Oe===nt.length&&nt.length>0){io($t.trim()),rt(-1);return}}}e.key==="Enter"&&$t.trim()&&(io($t.trim()),e.preventDefault()),e.key==="Escape"&&(Yt&&(Pt(!1),rt(-1)),_t(""),Dt([]),He(""),e.preventDefault())},style:{backgroundColor:"#f9f9f9",boxShadow:"0 2px 8px rgba(0,0,0,0.02)",borderRadius:4,marginBottom:0,padding:"6px 8px",border:"1px solid #ccc",width:"242px",fontSize:"12px",color:"#333",outline:"none",transition:"border-color 0.15s"}}),Yt&&$t.trim()&&s.jsxs("div",{style:{position:"absolute",top:"100%",left:"50%",transform:"translateX(-50%)",width:"242px",backgroundColor:"#f9f9f9",border:"1px solid #ccc",borderRadius:"4px",marginTop:"2px",maxHeight:"300px",overflowY:"auto",zIndex:1e3,boxShadow:"0 2px 8px rgba(0,0,0,0.15)"},onMouseLeave:()=>{},children:[Wn?s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:"#666",fontSize:"12px"},children:"Searching..."}):nt.length>0?ft.map((e,t)=>{const a=t===Oe,o=e.originalCard;e.cardForHover;const r=e.cardKey;return s.jsx("div",{style:{padding:"6px 8px",cursor:"pointer",transition:"background-color 0.15s ease",borderBottom:t<nt.length-1?"1px solid #eee":"none",backgroundColor:a?"#e3f2fd":"transparent"},onMouseEnter:()=>{if(Ot.current===r)return;Ot.current=r,rt(t);const l=gt[o.name];console.log(`üîç [PREVIEW DEBUG] Card: ${o.name}, isBasicLand: ${!!l}, cardId: ${o.id}`);let i=o;if(l){const c=ln(o.name);console.log(`üèûÔ∏è [SEARCH PREVIEW] Using preferred printing for ${o.name}: ${c} (was ${o.id})`);const g=`https://cards.scryfall.io/normal/front/${c.charAt(0)}/${c.charAt(1)}/${c}.jpg`;i={...o,id:c,scryfall_id:c,image_uris:{small:g.replace("/normal/","/small/"),normal:g,large:g.replace("/normal/","/large/")},scryfall_json:{...o.scryfall_json,id:c,image_uris:{small:g.replace("/normal/","/small/"),normal:g,large:g.replace("/normal/","/large/")}}},console.log(`üèûÔ∏è [SEARCH PREVIEW] Set image URL: ${g}`)}St({card:{name:i.name,id:i.id||i.scryfall_id,scryfall_id:i.scryfall_id||i.id,card:{name:i.name,id:i.id||i.scryfall_id,scryfall_id:i.scryfall_id||i.id,image_uris:i.image_uris,scryfall_json:i.scryfall_json,mana_cost:i.mana_cost,type_line:i.type_line,oracle_text:i.oracle_text,power:i.power,toughness:i.toughness,loyalty:i.loyalty},forceEnglish:!0,forceHighRes:!0,printing:i.set||i.set_name||null,set:i.set||i.set_name||null,collector_number:i.collector_number||null},top:0,left:0})},onMouseLeave:()=>{},onClick:l=>{l.preventDefault(),l.stopPropagation(),zt(o),_t(""),Pt(!1),rt(-1)},children:s.jsx("div",{style:{fontWeight:a?"600":"500",fontSize:"12px",color:a?"#1976d2":"#333"},children:o.name})},`${o.scryfall_id||o.id}-${t}`)}):ae?s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:"#666",fontSize:"12px"},children:ae}):null,$t.trim()&&nt.length>0&&s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:Oe===nt.length?"#ffffff":"#1976d2",fontSize:"12px",fontWeight:"bold",backgroundColor:Oe===nt.length?"#007acc":"#f0f7ff",borderTop:"1px solid #ddd",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:()=>{rt(nt.length)},onMouseLeave:()=>{},onClick:()=>{io($t.trim()),rt(-1)},children:"Show all results..."})]})]}),s.jsx("div",{style:{background:"white",padding:"8px 0",display:"flex",justifyContent:"center",marginBottom:"8px"},children:s.jsx("button",{onClick:()=>{sn(!bt),Rt(new Set)},className:`bulk-edit-button ${bt?"active":""}`,children:bt?"Exit Bulk Edit":"Bulk Edit"})}),bt&&s.jsxs("div",{className:"bulk-actions-container",children:[s.jsxs("div",{className:"bulk-actions-counter",children:[Se.size," card",Se.size!==1?"s":""," selected"]}),s.jsx("div",{className:"bulk-select-all-container",children:s.jsx("button",{onClick:()=>{if(Se.size===0){const e=new Set,t=F&&F.length>0?F:(n==null?void 0:n.cards)||[];Array.isArray(t)&&t.forEach(r=>{e.add(ze(r))});const a=(n==null?void 0:n.sideboard)||[];Array.isArray(a)&&a.forEach(r=>{e.add(ze(r))});const o=(n==null?void 0:n.techIdeas)||[];Array.isArray(o)&&o.forEach(r=>{e.add(ze(r))}),Rt(e)}else Rt(new Set)},className:"bulk-select-all-text",style:{padding:"2px 6px",fontSize:"10px",backgroundColor:"#1976d2",color:"#fff",border:"1px solid #1565c0",borderRadius:"3px",cursor:"pointer"},children:Se.size===0?"Select All":"Clear All"})}),s.jsxs("div",{className:"bulk-actions-grid",children:[s.jsx("button",{onClick:()=>Yo(),disabled:Se.size===0,className:"bulk-action-button collection",children:"+ Collection"}),s.jsx("button",{onClick:()=>Zo(),disabled:Se.size===0,className:"bulk-action-button wishlist",children:"+ Wishlist"}),s.jsx("button",{onClick:()=>tr(),disabled:Se.size===0,className:"bulk-action-button main-deck",children:"‚Üí Main Deck"}),s.jsx("button",{onClick:()=>nr(),disabled:Se.size===0,className:"bulk-action-button sideboard",children:"‚Üí Sideboard"}),s.jsx("button",{onClick:()=>or(),disabled:Se.size===0,className:"bulk-action-button tech-ideas",children:"‚Üí Tech Ideas"}),s.jsx("button",{onClick:()=>er(),disabled:Se.size===0,className:"bulk-action-button remove",children:"Remove from Deck"}),s.jsx("button",{onClick:()=>sr(),disabled:Se.size===0,className:"bulk-action-button foil",children:"Toggle Foil"}),s.jsx("button",{onClick:()=>rr(),className:"bulk-action-button utility",title:"Remove duplicate card entries and consolidate quantities",children:"üîß Fix Duplicates"})]})]}),s.jsx("div",{style:{background:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.02)",borderRadius:8,marginBottom:8},children:s.jsx(Ir,{groupBy:Fe,setGroupBy:dn,sortBy:xt,setSortBy:nn,hidePrices:Ht,setHidePrices:ut,showMana:jt,setShowMana:qt,viewMode:Ut,setViewMode:on})})]}),s.jsxs("div",{className:"deck-main-content",children:[s.jsx("div",{className:"mobile-view-controls",style:{display:"none",marginBottom:"1rem",padding:"12px",backgroundColor:"white",borderRadius:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",flexWrap:"wrap"},children:[s.jsx("span",{style:{fontSize:"14px",fontWeight:"500",color:"#666"},children:"View:"}),s.jsxs("div",{style:{display:"flex",gap:"4px"},children:[s.jsx("button",{onClick:()=>on("list"),style:{padding:"6px 12px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:Ut==="list"?"#1976d2":"white",color:Ut==="list"?"white":"#333",fontSize:"12px",cursor:"pointer",transition:"all 0.2s ease"},children:"üìã List"}),s.jsx("button",{onClick:()=>on("grid"),style:{padding:"6px 12px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:Ut==="grid"?"#1976d2":"white",color:Ut==="grid"?"white":"#333",fontSize:"12px",cursor:"pointer",transition:"all 0.2s ease"},children:"üî≥ Grid"})]})]})}),s.jsxs("h3",{style:{margin:"1rem 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #1976d2",paddingBottom:"0.5rem"},children:["Main Deck (",Array.isArray(vt)?vt.reduce((e,t)=>e+(Array.isArray(t.cards)?t.cards.reduce((a,o)=>{const r=o.count||o.quantity||1;return a+r},0):0),0):0," cards)"]}),s.jsxs("div",{className:"card-sections-container",children:[Array.isArray(vt)?vt.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"main deck"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var f,u,I,x,_,S,k,E,N,j,v,W,O,R;const o=D=>{var B,h,G,U,b,te,re,ve;return D.count||D.quantity||((B=D.card)==null?void 0:B.count)||((h=D.card)==null?void 0:h.quantity)||((G=D.cardObj)==null?void 0:G.count)||((U=D.cardObj)==null?void 0:U.quantity)||((te=(b=D.cardObj)==null?void 0:b.card)==null?void 0:te.count)||((ve=(re=D.cardObj)==null?void 0:re.card)==null?void 0:ve.quantity)||1},r=t.cardObj?{...t,count:o(t)}:{name:((f=t.card)==null?void 0:f.name)||t.name,count:o(t),printing:t.printing,cardObj:t};r.foil===!0||t.foil===!0||((u=r.cardObj)==null?void 0:u.foil)===!0||((x=(I=r.cardObj)==null?void 0:I.card)==null?void 0:x.foil)===!0||((_=t.card)==null||_.foil);const l=r.cardObj||t,i=JSON.parse(JSON.stringify(l)),c=r.foil===!0||t.foil===!0||((S=r.cardObj)==null?void 0:S.foil)===!0||((E=(k=r.cardObj)==null?void 0:k.card)==null?void 0:E.foil)===!0||((N=t.card)==null?void 0:N.foil)===!0||((v=(j=r.cardObj)==null?void 0:j.cardObj)==null?void 0:v.foil)===!0||((R=(O=(W=r.cardObj)==null?void 0:W.cardObj)==null?void 0:O.card)==null?void 0:R.foil)===!0;if(i.foil=c,i.card&&(i.card.foil=c),i.cardObj&&(i.cardObj.foil=c,i.cardObj.card&&(i.cardObj.card.foil=c)),gt[r.name]){const D=gt[r.name];i.printing=D,i.card&&(i.card.printing=D)}else r.printing&&!i.printing&&(i.printing=r.printing),r.printing&&i.card&&!i.card.printing&&(i.card.printing=r.printing);const y=`${r.name}-${r.printing||"default"}-${c?"foil":"nonfoil"}`;if(!he.current.has(y)){const D={...i,foil:c,card:{...i.card,foil:c}},B=Vt(D);console.log(`[PRICE CACHE] New price for ${r.name}: $${B.price} (${B.isFoil?"foil":"non-foil"}, source: ${B.source})`),he.current.set(y,B)}const{price:C,isFoil:d,source:$}=he.current.get(y);return Ut==="grid"?s.jsx(Uo,{cardData:r,isExplicitlyFoil:c,price:C,deckFlipStates:Ct,setDeckFlipStates:tt,onMouseEnter:()=>{var b,te;const D=gt[r.name];let B=r.printing||((b=r.cardObj)==null?void 0:b.printing);D&&(B=gt[r.name]);const h=`${r.name}-${r.printing||((te=r.cardObj)==null?void 0:te.scryfall_id)||"default"}`,G=Ct.get(h)||!1,U={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:B,showBackFace:G,_flipState:G};st(U)},onClick:()=>{var U,b,te;const D=JSON.parse(JSON.stringify(r.cardObj||{})),B=gt[r.name];let h=r.printing||D.printing;B&&(h=gt[r.name]);const G={...D,name:r.name,foil:c,count:r.count||1,price:C||null,printing:h,_debug_cardData:{printing:r.printing,name:r.name,baseObjPrinting:D.printing,preferredPrinting:h,isBasicLand:!!B,cardObjCard:D.card,cardObjCardPrinting:(U=D.card)==null?void 0:U.printing,cardObjCardScryfallId:(te=(b=D.card)==null?void 0:b.scryfall_json)==null?void 0:te.id}};G.card&&(G.card.foil=c,B&&(G.card.printing=h)),L({isOpen:!0,cardObj:G})},onContextMenu:D=>{var h;D.preventDefault(),D.stopPropagation();const B={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:r.printing||((h=r.cardObj)==null?void 0:h.printing),count:r.count||1,price:C||null};Cn({open:!0,x:D.clientX,y:D.clientY,cardObj:B})},bulkEditMode:bt,isSelected:Se.has(ze(r)),onToggleSelection:()=>Me(r)},`${r.name}-${r.printing||""}-${r.count}-${c?"foil":"nonfoil"}-${C||"na"}-${a}-${Le}`):s.jsx(ro,{cardData:r,isFoil:d,price:C,index:a,deckFlipStates:Ct,setDeckFlipStates:tt,onMouseEnter:()=>at(r,c,Ct),onClick:()=>En(r,c,C,L),showMana:jt,hidePrices:Ht,isExplicitlyFoil:c,bulkEditMode:bt,isSelected:Se.has(ze(r)),onToggleSelection:()=>Me(r),onContextMenu:D=>{var h;D.preventDefault(),D.stopPropagation();const B={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:r.printing||((h=r.cardObj)==null?void 0:h.printing),count:r.count||1,price:C||null};Cn({open:!0,x:D.clientX,y:D.clientY,cardObj:B})},setFixedPreview:St},`${r.name}-${r.printing||""}-${r.count}-${c?"foil":"nonfoil"}-${C||"na"}-${a}-${Le}`)}):null})]},e.type)):null,kt.open&&s.jsx(Ar,{x:kt.x,y:kt.y,cardObj:kt.cardObj,onClose:()=>Cn({open:!1,x:0,y:0,cardObj:null}),onUseForDeckImage:async()=>{var t,a,o,r,l,i,c,g;const e=kt.cardObj;if(!e||!n){P.error("Unable to set deck image");return}try{let y=null;if((o=(a=(t=e.card)==null?void 0:t.scryfall_json)==null?void 0:a.image_uris)!=null&&o.art_crop?y=e.card.scryfall_json.image_uris.art_crop:(l=(r=e.scryfall_json)==null?void 0:r.image_uris)!=null&&l.art_crop?y=e.scryfall_json.image_uris.art_crop:(c=(i=e.card)==null?void 0:i.image_uris)!=null&&c.art_crop?y=e.card.image_uris.art_crop:(g=e.image_uris)!=null&&g.art_crop&&(y=e.image_uris.art_crop),y){const C=localStorage.getItem("token"),d="",$={name:n.name,format:n.format,cards:n.cards,customPreviewImage:y,commander:n.commander,commanderNames:n.commanderNames},f=await fetch(`${d}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${C}`},body:JSON.stringify($),credentials:"include"});if(f.ok){const u=await f.json();console.log("‚úÖ Server response for deck update:",u),le(u),P.success(`Set "${e.name}" as deck image!`),localStorage.setItem("deck-updated-timestamp",Date.now().toString()),window.dispatchEvent(new CustomEvent("deck-updated",{detail:{deckId:n._id,action:"custom-image-set"}}))}else{const u=await f.text();console.error("‚ùå Failed to update deck:",f.status,u),P.error("Failed to update deck image")}}else P.error("No suitable image found for this card")}catch(y){console.error("Error setting deck image:",y),P.error("Failed to set deck image")}},onAddToWishlist:async()=>{const e=kt.cardObj;if(!e){P.error("Unable to add card to wishlist");return}await $o(e)},onAddToCollection:async()=>{const e=kt.cardObj;if(!e){P.error("Unable to add card to collection");return}await So(e)},onCopyScryfallLink:async()=>{var a,o,r,l,i;const e=kt.cardObj;let t=null;if((o=(a=e==null?void 0:e.card)==null?void 0:a.scryfall_json)!=null&&o.scryfall_uri?t=e.card.scryfall_json.scryfall_uri:(r=e==null?void 0:e.scryfall_json)!=null&&r.scryfall_uri?t=e.scryfall_json.scryfall_uri:(l=e==null?void 0:e.card)!=null&&l.scryfall_uri?t=e.card.scryfall_uri:e!=null&&e.scryfall_uri?t=e.scryfall_uri:(i=e==null?void 0:e.card)!=null&&i.name?t=`https://scryfall.com/search?q=${encodeURIComponent(e.card.name)}`:e!=null&&e.name&&(t=`https://scryfall.com/search?q=${encodeURIComponent(e.name)}`),t)try{await navigator.clipboard.writeText(t),P.success("Scryfall link copied to clipboard!")}catch{P.error("Failed to copy Scryfall link.")}else P.error("Could not determine Scryfall link for this card.")},onRemoveFromDeck:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card");return}Xn(e)},onAddToSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to sideboard");return}Jn(e)},onAddToTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to tech ideas");return}Yn(e)},onMoveToMainDeck:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to main deck");return}e.section==="sideboard"?co(e,e.sideboardIndex):e.section==="techIdeas"&&uo(e,e.techIdeasIndex)},onMoveFromSideboardToTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to tech ideas");return}fo(e,e.sideboardIndex)},onMoveFromTechIdeasToSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to sideboard");return}mo(e,e.techIdeasIndex)},onRemoveFromSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card from sideboard");return}Kn(e.sideboardIndex)},onRemoveFromTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card from tech ideas");return}Qn(e.techIdeasIndex)}})]}),n.sideboard&&n.sideboard.length>0&&s.jsxs(s.Fragment,{children:[s.jsxs("h3",{style:{margin:"2rem 0 1rem 0",fontSize:"1.5rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #0ea5e9",paddingBottom:"0.5rem"},children:["Sideboard (",n.sideboard.length," cards)"]}),s.jsx("div",{className:"card-sections-container",children:Go.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"sideboard"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var y,C,d,$;const o=t.cardObj?t:{name:((y=t.card)==null?void 0:y.name)||t.name,count:t.count||t.quantity||1,printing:t.printing,cardObj:t},r=o.foil===!0||t.foil===!0||((C=o.cardObj)==null?void 0:C.foil)===!0||(($=(d=o.cardObj)==null?void 0:d.card)==null?void 0:$.foil)===!0,l=JSON.parse(JSON.stringify(o.cardObj||{}));l.foil=r;const{price:i,isFoil:c}=Vt(l);o.name;const g=n.sideboard.findIndex((f,u)=>f.name===o.name&&u>=a);return s.jsx(ro,{cardData:o,isFoil:c,price:i,index:a,bulkEditMode:bt,isSelected:Se.has(ze(o)),onToggleSelection:()=>Me(o),deckFlipStates:Ct,setDeckFlipStates:tt,onContextMenu:f=>{f.preventDefault(),f.stopPropagation();const u={...l,name:o.name,printing:o.printing,foil:r,count:o.count||1,price:i,section:"sideboard",sideboardIndex:g};Cn({open:!0,x:f.clientX,y:f.clientY,cardObj:u})},onMouseEnter:()=>at(o,r,Ct),onClick:()=>At(o,r,i,bt,Kt,L),customButtons:bt?null:s.jsxs("div",{style:{display:"flex",gap:"0.1rem",alignItems:"center"},children:[s.jsx("button",{onClick:f=>{f.stopPropagation(),console.log("[SIDEBOARD MAIN BUTTON] Button clicked for card:",t),console.log("[SIDEBOARD MAIN BUTTON] Sideboard index:",g),co(t,g)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to main deck",children:"Main"}),s.jsx("button",{onClick:f=>{f.stopPropagation(),fo(t,g)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#7c3aed",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to tech ideas",children:"Tech"}),s.jsx("button",{onClick:f=>{f.stopPropagation(),Kn(g)},style:{padding:"0.2rem 0.4rem",fontSize:"0.7rem",backgroundColor:"#ef4444",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Remove from sideboard",children:"‚úï"})]}),showMana:!1,hidePrices:Ht,setFixedPreview:St},`sideboard-row-${o.name}-${o.printing||""}-${a}-${Le}`)}):null})]},`sideboard-${e.type}`))})]}),n.techIdeas&&n.techIdeas.length>0&&s.jsxs(s.Fragment,{children:[s.jsxs("h3",{style:{margin:"2rem 0 1rem 0",fontSize:"1.5rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #7c3aed",paddingBottom:"0.5rem"},children:["Tech Ideas (",n.techIdeas.length," cards)"]}),s.jsx("div",{className:"card-sections-container",children:Vo.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"tech ideas"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var y,C,d,$,f,u;!t.modalPrice&&t.modalPrice!==0&&(t.modalPrice=((y=t.cardObj)==null?void 0:y.modalPrice)||((C=t.card)==null?void 0:C.modalPrice)||t.modalPrice);const o=t.cardObj?t:{name:((d=t.card)==null?void 0:d.name)||t.name,count:t.count||t.quantity||1,printing:t.printing,cardObj:t},r=o.foil===!0||t.foil===!0||(($=o.cardObj)==null?void 0:$.foil)===!0||((u=(f=o.cardObj)==null?void 0:f.card)==null?void 0:u.foil)===!0,l=JSON.parse(JSON.stringify(o.cardObj||{}));l.foil=r;let i,c;if(o.name==="In the Trenches")i="0.31",c=r;else if(t.modalPrice&&t.modalPrice!=="N/A"&&t.modalPrice!==null&&t.modalPrice!==void 0)i=t.modalPrice.toString().replace(/^\$/,""),parseFloat(i)>100&&(console.warn(`[TECH DISPLAY] üö® SUSPICIOUS HIGH PRICE for ${o.name}: $${i} from modalPrice: ${t.modalPrice}`),console.warn("[TECH DISPLAY] üö® Card object:",t)),c=r;else{const I=Vt(l);i=I.price,parseFloat(i)>100&&(console.warn(`[TECH DISPLAY] üö® SUSPICIOUS HIGH PRICE from extractPrice for ${o.name}: $${i} (source: ${I.source})`),console.warn("[TECH DISPLAY] üö® Card object:",l)),c=I.isFoil}const g=n.techIdeas.findIndex((I,x)=>I.name===o.name&&x>=a);return s.jsx(ro,{cardData:o,isFoil:c,price:i,index:a,bulkEditMode:bt,isSelected:Se.has(ze(o)),onToggleSelection:()=>Me(o),deckFlipStates:Ct,setDeckFlipStates:tt,onContextMenu:I=>{I.preventDefault(),I.stopPropagation();const x={...l,name:o.name,printing:o.printing,foil:r,count:o.count||1,price:i,section:"techIdeas",techIdeasIndex:g};Cn({open:!0,x:I.clientX,y:I.clientY,cardObj:x})},onMouseEnter:()=>at(o,r,Ct),onClick:()=>At(o,r,i,bt,Kt,L),customButtons:bt?null:s.jsxs("div",{style:{display:"flex",gap:"0.1rem",alignItems:"center"},children:[s.jsx("button",{onClick:I=>{I.stopPropagation(),console.log("[TECH IDEAS MAIN BUTTON] Button clicked for card:",t),console.log("[TECH IDEAS MAIN BUTTON] Tech ideas index:",g),uo(t,g)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to main deck",children:"Main"}),s.jsx("button",{onClick:I=>{I.stopPropagation(),mo(t,g)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#0ea5e9",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to sideboard",children:"Side"}),s.jsx("button",{onClick:I=>{I.stopPropagation(),Qn(g)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#ef4444",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Remove from tech ideas",children:"‚úï"})]}),showMana:!1,hidePrices:Ht,setFixedPreview:St},`tech-ideas-row-${o.name}-${o.printing||""}-${a}-${Le}`)}):null})]},`tech-ideas-${e.type}`))})]}),Nt&&s.jsx("div",{"data-search-modal":"true",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1e4,display:"flex",justifyContent:"center",alignItems:"center",padding:"20px"},onClick:e=>{e.target===e.currentTarget&&Bt()},onKeyDown:e=>{e.key==="Escape"&&Bt()},tabIndex:-1,children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"8px",width:"90%",maxWidth:"1200px",height:"80%",maxHeight:"800px",display:"flex",flexDirection:"column",boxShadow:"0 10px 25px rgba(0, 0, 0, 0.2)"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{style:{padding:"20px",borderBottom:"1px solid #eee",position:"relative"},children:[s.jsx("button",{onClick:Bt,className:"close-button",style:{position:"absolute",top:"10px",right:"10px",width:"30px",height:"30px",borderRadius:"50%",border:"none",backgroundColor:"#f5f5f5",color:"#666",fontSize:"18px",fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease",zIndex:10},onMouseEnter:e=>{e.target.style.backgroundColor="#e0e0e0",e.target.style.color="#333"},onMouseLeave:e=>{e.target.style.backgroundColor="#f5f5f5",e.target.style.color="#666"},children:"√ó"}),s.jsx("input",{type:"text",placeholder:"Search for cards (Scryfall syntax supported)...",value:Lt,"data-deck-view-search":"true",onChange:e=>{dt(e.target.value),Wo(e.target.value)},onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),wo(Lt))},style:{width:"50%",padding:"8px 16px",border:"1px solid #ccc",borderRadius:"6px",fontSize:"16px",backgroundColor:"#ffffff",color:"#333",outline:"none",transition:"border-color 0.15s",marginRight:"50px"},onFocus:e=>{e.target.style.borderColor="#1976d2",e.target.style.boxShadow="0 0 0 2px rgba(25, 118, 210, 0.1)"},onBlur:e=>{e.target.style.borderColor="#ccc",e.target.style.boxShadow="none"},autoFocus:!0})]}),s.jsx("div",{style:{flex:1,padding:"20px",overflowY:"auto"},children:Tt?s.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"200px",fontSize:"16px",color:"#666"},children:"Loading search results..."}):ct.length>0?s.jsxs(s.Fragment,{children:[Math.random()<.1&&console.log("üé≠ Modal rendering with",ct.length,"results"),s.jsxs("div",{style:{marginBottom:"16px",fontSize:"14px",color:"#666"},children:["Found ",ct.length," result",ct.length!==1?"s":""]}),s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(220px, 220px))",gap:"16px",justifyContent:"center"},children:ct.map((e,t)=>s.jsxs("div",{style:{border:"1px solid #ddd",borderRadius:"8px",padding:"12px",backgroundColor:"#fafafa",transition:"all 0.2s ease",display:"flex",flexDirection:"column",alignItems:"center"},onMouseEnter:a=>{a.currentTarget.style.borderColor="#1976d2",a.currentTarget.style.boxShadow="0 2px 8px rgba(25, 118, 210, 0.15)",a.currentTarget.style.backgroundColor="#f8fbff"},onMouseLeave:a=>{a.currentTarget.style.borderColor="#ddd",a.currentTarget.style.boxShadow="none",a.currentTarget.style.backgroundColor="#fafafa"},children:[(()=>{var g,y,C,d,$,f,u,I,x,_,S;const a=e.card_faces&&e.card_faces.length>=2,o=`${e.scryfall_id||e.id}-${t}`,r=Ye.get(o)||!1;let l=null,i=e.name;if(a){const k=r?1:0;l=((y=(g=e.card_faces[k])==null?void 0:g.image_uris)==null?void 0:y.normal)||((d=(C=e.card_faces[k])==null?void 0:C.image_uris)==null?void 0:d.small),i=(($=e.card_faces[k])==null?void 0:$.name)||e.name,l||(l=((f=e.image_uris)==null?void 0:f.normal)||((u=e.image_uris)==null?void 0:u.small))}else if(gt[i]){const k=ln(i);k&&k!==(e.scryfall_id||e.id)?(console.log(`üèûÔ∏è [SEARCH MODAL] Using preferred printing for ${i}: ${k} (was ${e.scryfall_id||e.id})`),l=`https://cards.scryfall.io/normal/front/${k.substring(0,1)}/${k.substring(1,2)}/${k}.jpg`,console.log(`üèûÔ∏è [SEARCH MODAL] Set image URL: ${l}`)):l=((I=e.image_uris)==null?void 0:I.normal)||((x=e.image_uris)==null?void 0:x.small)}else l=((_=e.image_uris)==null?void 0:_.normal)||((S=e.image_uris)==null?void 0:S.small);l=Mo(l);const c=k=>{k.stopPropagation(),mt(E=>{const N=new Map(E);return N.set(o,!r),N})};return s.jsxs(s.Fragment,{children:[l&&s.jsxs("div",{style:{position:"relative",width:"100%",maxWidth:"200px",margin:"0 auto"},children:[s.jsx("div",{style:{width:"100%",maxWidth:"200px",aspectRatio:"5/7",backgroundColor:"#f0f0f0",borderRadius:"6px",marginBottom:"12px",backgroundImage:`url(${l})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",cursor:"zoom-in"},onClick:()=>{var N,j;console.log("üé¥ Opening CardActionsModal for:",i);const k=ct.findIndex(v=>v.name===i||v.scryfall_id===e.scryfall_id||v.id===e.id),E={name:i,printing:e.scryfall_id||e.id,cardObj:{name:i,scryfall_id:e.scryfall_id||e.id,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,oracle_text:e.oracle_text,power:e.power,toughness:e.toughness,cmc:e.cmc||e.converted_mana_cost,rarity:e.rarity,prices:e.prices,card_faces:e.card_faces},card:{name:i,scryfall_json:e,type_line:e.type_line},scryfall_json:e,foil:!1,count:1,modalPrice:((N=e.prices)==null?void 0:N.usd)||((j=e.prices)==null?void 0:j.usd_foil)||"0.00"};console.log("[ORACLE TAG MODAL] Opening CardActionsModal with data:",E),console.log(`[ORACLE TAG NAVIGATION] Setting up navigation context - current card: ${i} (${k+1}/${ct.length})`),q({isActive:!0,searchResults:[...ct],currentIndex:k>=0?k:0}),Te([]),Je(!1),L({isOpen:!0,cardObj:E})},title:`${i} - Click to view larger`}),Jo(e)&&s.jsx("div",{style:{position:"absolute",top:"8px",left:"8px",background:"rgba(76, 175, 80, 0.95)",color:"white",borderRadius:"12px",padding:"4px 8px",fontSize:"10px",fontWeight:"bold",boxShadow:"0 2px 4px rgba(0,0,0,0.3)",zIndex:10,display:"flex",alignItems:"center",gap:"3px"},title:"This card is already in your deck",children:"‚úì In Deck"}),a&&s.jsx("span",{onClick:c,style:{position:"absolute",top:"8px",right:"8px",background:"rgba(255, 255, 255, 0.9)",borderRadius:"50%",padding:"6px",cursor:"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:"background 0.2s ease"},title:`Flip to ${r?"front":"back"} face`,onMouseEnter:k=>{k.target.style.background="rgba(255, 255, 255, 1)"},onMouseLeave:k=>{k.target.style.background="rgba(255, 255, 255, 0.9)"},children:s.jsx(Fo,{size:10,color:"#1976d2"})})]}),s.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",textAlign:"center",marginBottom:"8px",color:"#333"},children:i})]})})(),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px",width:"100%"},children:[s.jsx("button",{onClick:a=>{a.stopPropagation(),console.log("üéØ Add to Deck button clicked for card:",e),zt(e)},style:{backgroundColor:"#1976d2",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#1565c0"},onMouseLeave:a=>{a.target.style.backgroundColor="#1976d2"},children:"Add to Deck"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),vo(e)},style:{backgroundColor:"#9c27b0",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#7b1fa2"},onMouseLeave:a=>{a.target.style.backgroundColor="#9c27b0"},children:"Add to Tech Ideas"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),ko(e)},style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#1976d2"},onMouseLeave:a=>{a.target.style.backgroundColor="#2196f3"},children:"Add to Sideboard"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),$o(e)},style:{backgroundColor:"#ff9800",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#f57c00"},onMouseLeave:a=>{a.target.style.backgroundColor="#ff9800"},children:"Add to Wishlist"})]})]},`${e.scryfall_id||e.id}-${t}`))})]}):s.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#666",fontSize:"16px"},children:"No cards found matching your search criteria."})})]})}),Ce&&s.jsx(br,{isOpen:Ce,onClose:()=>ce(!1),onImport:Eo}),We&&s.jsx(Cr,{isOpen:We,onClose:()=>we(!1),onImport:Eo}),s.jsx("div",{className:"deck-stats-sticky-bar",style:{position:"fixed",bottom:0,left:0,right:0,width:"100%",background:"white",boxShadow:"0 -2px 8px rgba(0,0,0,0.1)",borderTop:"1px solid #e0e0e0",zIndex:1e3},children:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",maxWidth:"1200px",margin:"0 auto",gap:"24px",flexWrap:"wrap",padding:"8px 24px"},children:[s.jsxs("div",{style:{display:"flex",gap:"24px",alignItems:"center",flex:"0 0 auto"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Total Value:"}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"bold",color:"#2c5530"},children:["$",qo]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"In Collection:"}),s.jsx("span",{style:{fontSize:"12px",fontWeight:"bold",color:"#1976d2"},children:(()=>{const e=JSON.parse(localStorage.getItem("cardCollection")||"[]"),t=new Map;yn(e,l=>{const i=`${l.printing_id}_${l.foil}`;t.set(i,(t.get(i)||0)+l.quantity)});let a=0,o=0;return(F||(n==null?void 0:n.cards)||[]).forEach(l=>{var y,C,d,$,f,u,I,x,_,S,k,E,N,j,v,W;const i=l.count||l.quantity||1;a+=i;const c=l.printing||((y=l.cardObj)==null?void 0:y.printing)||((d=(C=l.cardObj)==null?void 0:C.card)==null?void 0:d.printing)||(($=l.card)==null?void 0:$.printing)||l.scryfall_id||l.id||((f=l.cardObj)==null?void 0:f.scryfall_id)||((u=l.cardObj)==null?void 0:u.id)||((x=(I=l.cardObj)==null?void 0:I.card)==null?void 0:x.scryfall_id)||((S=(_=l.cardObj)==null?void 0:_.card)==null?void 0:S.id),g=l.foil===!0||l.isFoil===!0||((k=l.cardObj)==null?void 0:k.foil)===!0||((E=l.cardObj)==null?void 0:E.isFoil)===!0||((j=(N=l.cardObj)==null?void 0:N.card)==null?void 0:j.foil)===!0||((W=(v=l.cardObj)==null?void 0:v.card)==null?void 0:W.isFoil)===!0;if(c){const O=`${c}_true`,R=`${c}_false`,D=t.get(O)||0,B=t.get(R)||0,h=g?D>0:B>0,G=D+B>0;(h||G)&&(o+=i)}}),`${a>0?Math.round(o/a*100):0}%`})()})]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flex:"0 0 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Mana:"}),s.jsx("div",{style:{display:"flex",gap:"4px",alignItems:"center"},children:(()=>{const e={W:0,U:0,B:0,R:0,G:0};return(F||(n==null?void 0:n.cards)||[]).forEach(a=>{var i,c,g,y;const o=a.count||a.quantity||1;((((i=a==null?void 0:a.scryfall_json)==null?void 0:i.mana_cost)||((g=(c=a==null?void 0:a.card)==null?void 0:c.scryfall_json)==null?void 0:g.mana_cost)||(a==null?void 0:a.mana_cost)||((y=a==null?void 0:a.card)==null?void 0:y.mana_cost)||"").match(/\{([^}]+)\}/g)||[]).forEach(C=>{const d=C.replace(/[{}]/g,"");d==="W"?e.W+=o:d==="U"?e.U+=o:d==="B"?e.B+=o:d==="R"?e.R+=o:d==="G"?e.G+=o:d.includes("/")&&d.split("/").forEach(f=>{f==="W"?e.W+=o:f==="U"?e.U+=o:f==="B"?e.B+=o:f==="R"?e.R+=o:f==="G"&&(e.G+=o)})})}),[{symbol:"W",count:e.W},{symbol:"U",count:e.U},{symbol:"B",count:e.B},{symbol:"R",count:e.R},{symbol:"G",count:e.G}].filter(a=>a.count>0).map(a=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"2px"},children:[s.jsx("img",{src:`/svgs/${a.symbol.toLowerCase()}.svg`,alt:`{${a.symbol}}`,style:{width:"14px",height:"14px",filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.3))"},title:`${a.symbol} mana`,onError:o=>{o.target.outerHTML=`{${a.symbol}}`},"data-no-qr-scan":"true",loading:"lazy"}),s.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#333"},children:a.count})]},a.symbol))})()})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",flex:"0 0 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Curve:"}),s.jsx("div",{style:{display:"flex",gap:"1px",alignItems:"end"},children:(()=>{const e={};let t=0;return(F||(n==null?void 0:n.cards)||[]).forEach(o=>{var c,g,y,C;const r=o.count||o.quantity||1,l=((c=o==null?void 0:o.scryfall_json)==null?void 0:c.cmc)||((y=(g=o==null?void 0:o.card)==null?void 0:g.scryfall_json)==null?void 0:y.cmc)||(o==null?void 0:o.cmc)||((C=o==null?void 0:o.card)==null?void 0:C.cmc)||0,i=l>=7?"7+":l.toString();e[i]=(e[i]||0)+r,t=Math.max(t,e[i])}),["0","1","2","3","4","5","6","7+"].map(o=>{const r=e[o]||0,l=t>0?Math.max(2,r/t*20):2;return s.jsx("div",{style:{width:"8px",height:`${l}px`,backgroundColor:r>0?"#4caf50":"#e8e8e8",borderRadius:"1px",transition:"height 0.2s ease"},title:`${r} cards with CMC ${o}`},`mini-bar-${o}`)})})()})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flex:"1 1 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Types:"}),s.jsx("div",{style:{display:"flex",gap:"8px",alignItems:"center",flexWrap:"wrap"},children:(()=>{const e={},a=(()=>{const l=new Set;return n!=null&&n.commander&&(Array.isArray(n.commander)?n.commander.forEach(i=>{var c;i!=null&&i.name&&l.add(i.name.toLowerCase()),(c=i==null?void 0:i.card)!=null&&c.name&&l.add(i.card.name.toLowerCase())}):typeof n.commander=="object"&&n.commander.name?l.add(n.commander.name.toLowerCase()):typeof n.commander=="string"&&l.add(n.commander.toLowerCase())),n!=null&&n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.forEach(i=>{i&&typeof i=="string"&&l.add(i.toLowerCase())}),l})();wn(F||[]).forEach(l=>{var d,$,f,u,I,x,_,S,k;const i=l.count||l.quantity||1,c=((d=l==null?void 0:l.card)==null?void 0:d.name)||(l==null?void 0:l.name)||"Unknown",g=a.has(c.toLowerCase())||l.isCommander===!0||(($=l.card)==null?void 0:$.isCommander)===!0,y=((f=l==null?void 0:l.scryfall_json)==null?void 0:f.type_line)||((I=(u=l==null?void 0:l.card)==null?void 0:u.scryfall_json)==null?void 0:I.type_line)||(l==null?void 0:l.type_line)||((x=l==null?void 0:l.card)==null?void 0:x.type_line)||"",C=y.toLowerCase();if(g&&(!y||y.trim()==="")){const N={"jason bright, glowing prophet":"Legendary Creature ‚Äî Human Mutant"}[c.toLowerCase()];if(N){window.commanderTypeLogged||(console.log(`[DEBUG] Commander "${c}" using known type: ${N}`),window.commanderTypeLogged=!0),N.toLowerCase().includes("creature")?e.Creature=(e.Creature||0)+i:N.toLowerCase().includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:N.toLowerCase().includes("artifact")?e.Artifact=(e.Artifact||0)+i:e.Other=(e.Other||0)+i;return}Math.random()<.1&&console.log(`[DEBUG] Commander "${c}" missing type info, defaulting to Creature`),e.Creature=(e.Creature||0)+i;return}if(!y||y.trim()===""){const E=((_=l==null?void 0:l.scryfall_json)==null?void 0:_.type_line)||((k=(S=l==null?void 0:l.card)==null?void 0:S.scryfall_json)==null?void 0:k.type_line)||"";if(E){const N=E.toLowerCase();N.includes("creature")?e.Creature=(e.Creature||0)+i:N.includes("instant")?e.Instant=(e.Instant||0)+i:N.includes("sorcery")?e.Sorcery=(e.Sorcery||0)+i:N.includes("enchantment")?e.Enchantment=(e.Enchantment||0)+i:N.includes("artifact")?e.Artifact=(e.Artifact||0)+i:N.includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:N.includes("land")?e.Land=(e.Land||0)+i:N.includes("battle")?e.Battle=(e.Battle||0)+i:(console.log(`[DEBUG] Card with empty type_line counted as Other: "${c}" (Scryfall: "${E}")`),e.Other=(e.Other||0)+i)}else e.Other=(e.Other||0)+i}else C.includes("creature")?e.Creature=(e.Creature||0)+i:C.includes("instant")?e.Instant=(e.Instant||0)+i:C.includes("sorcery")?e.Sorcery=(e.Sorcery||0)+i:C.includes("enchantment")?e.Enchantment=(e.Enchantment||0)+i:C.includes("artifact")?e.Artifact=(e.Artifact||0)+i:C.includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:C.includes("land")?e.Land=(e.Land||0)+i:C.includes("battle")?e.Battle=(e.Battle||0)+i:(console.log(`[DEBUG] Card counted as Other: "${c}" with type_line: "${y}"`),e.Other=(e.Other||0)+i)});const r=l=>{const c={Creature:"creature.svg",Instant:"instant.svg",Sorcery:"sorcery.svg",Enchantment:"enchantment.svg",Artifact:"artifact.svg",Planeswalker:"planeswalker.svg",Land:"land.svg",Battle:"artifact.svg",Other:"artifact.svg"}[l]||"artifact.svg";return s.jsx("img",{src:`/svgs/${c}`,alt:l,style:{width:"14px",height:"14px",filter:"brightness(0)",opacity:.8},title:`${l} symbol`})};return Object.entries(e).filter(([l,i])=>i>0).sort(([,l],[,i])=>i-l).map(([l,i])=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"2px"},children:[r(l),s.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#333"},children:i})]},l))})()})]})]})}),m.isOpen&&m.cardObj&&s.jsx(xr,{isOpen:m.isOpen,onClose:()=>{L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1})},card:m.cardObj,onAddCard:zt,onUpdateCard:Io,onRemoveCard:Xn,onMoveToSideboard:Jn,onMoveToTechIdeas:Yn,onAddToCollection:So,updatingPrinting:ot,onOracleTagSearch:Ho,onNavigateToPrevious:Xo,onNavigateToNext:Ko,onPreviewUpdate:Qo})]})]})})]}):s.jsx("div",{className:"container",children:"Deck not found."})}typeof window<"u"&&(window.clearTechIdeasCache=()=>{if(window.fixedTechIdeasCache){const p=window.fixedTechIdeasCache.size;return window.fixedTechIdeasCache.clear(),console.log(`[CACHE] Cleared ${p} cached tech ideas entries`),p}return 0},window.validateTechIdeasCache=()=>{if(window.fixedTechIdeasCache){const p=[];for(const[T,m]of window.fixedTechIdeasCache.entries())if(m.modalPrice){const L=parseFloat(m.modalPrice.toString().replace(/^\$/,""));(L>100||L<=0)&&p.push({name:T,price:m.modalPrice,priceNum:L})}return console.log(`[CACHE] Found ${p.length} suspicious cached prices:`,p),p}return[]},window.testQuantityUpdate=(p="Island",T=null)=>{var de,pe,fe,Q;console.log(`[QUANTITY TEST] Testing quantity update for "${p}"`);let m=[],L="unknown";if(typeof deck<"u"&&(deck!=null&&deck.cards))m=deck.cards,L="deck variable";else if((de=window.deck)!=null&&de.cards)m=window.deck.cards,L="window.deck";else{const ye=document.querySelector('[data-testid="deck-view-edit"]')||document.querySelector("main");if(ye&&ye._reactInternalFiber)try{const he=ye._reactInternalFiber;console.log("[QUANTITY TEST] Found React component, trying to access state...")}catch{console.log("[QUANTITY TEST] Could not access React state")}}if(console.log(`[QUANTITY TEST] Found ${m.length} cards in deck (source: ${L})`),m.length===0)return console.log("[QUANTITY TEST] No cards found. Available globals:",Object.keys(window).filter(ye=>ye.toLowerCase().includes("deck")||ye.toLowerCase().includes("card"))),null;const z=m.find(ye=>{var $e;return((($e=ye.card)==null?void 0:$e.name)||ye.name)===p});if(!z)return console.log(`[QUANTITY TEST] Card "${p}" not found in deck`),console.log("[QUANTITY TEST] Available card names:",m.slice(0,10).map(ye=>{var he;return((he=ye.card)==null?void 0:he.name)||ye.name})),null;const q=z.count||1,se=T!==null?T:q+1;console.log(`[QUANTITY TEST] Found "${p}" with quantity ${q}, updating to ${se}`),console.log("[QUANTITY TEST] Target card data:",{name:((pe=z.card)==null?void 0:pe.name)||z.name,count:z.count,foil:z.foil||((fe=z.card)==null?void 0:fe.foil),printing:z.printing||((Q=z.card)==null?void 0:Q.printing)});try{if(typeof handleUpdateCard<"u")handleUpdateCard(z,{quantity:se}),console.log(`[QUANTITY TEST] Called handleUpdateCard for "${p}" with quantity ${se}`);else return console.log("[QUANTITY TEST] handleUpdateCard function not accessible"),null;return{cardName:p,oldQuantity:q,newQuantity:se}}catch(ye){return console.error("[QUANTITY TEST] Error calling handleUpdateCard:",ye),null}});export{Lr as default};
