const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jspdf.es.min-CGvl7WZV.js","assets/index-DzPcw_tb.js","assets/router-CYt2ycax.js","assets/vendor-Csw2ODfV.js","assets/index-6Wl1lZyG.css"])))=>i.map(i=>d[i]);
import{g as ho,P as Gt,a as Zn,s as In,j as s,y as P,f as Bn,O as fr,d as No,C as ur,_ as mr,i as pr}from"./index-DzPcw_tb.js";import{r as R,R as so,c as gr,a as yr}from"./router-CYt2ycax.js";import{E as hr}from"./jspdf.es.min-CGvl7WZV.js";import"./html2canvas.esm-CBrSDip1.js";import"./vendor-Csw2ODfV.js";const cn={Forest:"d232fcc2-12f6-401a-b1aa-ddff11cb9378",Island:"23635e40-d040-40b7-8b98-90ed362aa028",Mountain:"1edc5050-69bd-416d-b04c-7f82de2a1901",Plains:"4ef17ed4-a9b5-4b8e-b4cb-2ecb7e5898c3",Swamp:"13505c15-14e0-4200-82bd-fb9bce949e68",Wastes:"60682c00-c661-4a9d-8326-f3f014a04e3e","Snow-Covered Forest":"838c915d-8153-43c2-b513-dfbe4e9388a5","Snow-Covered Island":"6abf0692-07d1-4b72-af06-93d0e338589d","Snow-Covered Mountain":"0dc9a6d1-a1ca-4b8f-894d-71c2a9933f79","Snow-Covered Plains":"b1e3a010-dae3-41b6-8dd8-e31d14c3ac4a","Snow-Covered Swamp":"c4dacaf1-09b8-42bb-8064-990190fdaf81","Snow-Covered Wastes":"ad21a874-525e-4d11-bd8e-bc44918bec40","Basic Forest":"d232fcc2-12f6-401a-b1aa-ddff11cb9378","Basic Island":"ff0ba1cf-1b05-403e-8b5e-4bbe3cfa8a89","Basic Mountain":"b34bb2dc-c1af-4d77-b0b3-a0fb342a5fc6","Basic Plains":"8e592a1e-b5e1-497a-863d-9772d25d3b3f","Basic Swamp":"6b28e7a6-e0ed-4c45-85dd-7c1bbfe6b3e5"},_o="basic-land-printing-preferences",Ln=g=>{try{return JSON.parse(localStorage.getItem(_o)||"{}")[g]||cn[g]}catch(T){return console.warn("[BASIC LAND PREFS] Error reading preferences:",T),cn[g]}},_r=(g,T)=>{try{const p=JSON.parse(localStorage.getItem(_o)||"{}");p[g]=T,localStorage.setItem(_o,JSON.stringify(p)),console.log(`üèûÔ∏è [USER PREFS] Updated ${g} preferred printing to: ${T}`)}catch(p){console.error("[BASIC LAND PREFS] Error saving preferences:",p)}},xr=({isOpen:g,onClose:T,card:p,onUpdateCard:L,onRemoveCard:z,onMoveToSideboard:q,onMoveToTechIdeas:se,onAddToCollection:de,updatingPrinting:pe,cardPrice:fe,onPreviewUpdate:Q,onOracleTagSearch:ye,onNavigateToPrevious:he,onNavigateToNext:$e})=>{var nt,Dt,Wn,Jt,Yt,Pt;const Xe=R.useRef(null),Qe=R.useRef(null),[X,M]=R.useState([]),[H,ne]=R.useState([]),[n,Pe]=R.useState(20),[le,it]=R.useState(!1),[V,Re]=R.useState(null),[Ne,F]=R.useState(1),[Y,_e]=R.useState(!1),[be,Ve]=R.useState(!1),[oe,Le]=R.useState(!1),[lt,Be]=R.useState(!1),[St,en]=R.useState(0),[tn,Sn]=R.useState(0),[hn,$t]=R.useState(""),[_t,Fe]=R.useState(!1),dn="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==",[xt,nn]=R.useState(null),Ht=R.useCallback(()=>{if(!V)return null;const w={...V,scryfall_json:V,foil:Y};return ho(w,{preferStoredPrice:!1,fallbackPrice:null,debugLogging:!1}).price},[V,Y]),ut=R.useCallback(()=>{const w=Ht();return p&&w!==null?w:p&&p.modalPrice?p.modalPrice:w},[Ht,p]);R.useEffect(()=>{if(g){const w=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${w}px`,document.body.style.width="100%",()=>{document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,w)}}},[g]),R.useEffect(()=>{if(!g)return;const w=K=>{if(!(!he||!$e))switch(K.key){case"ArrowLeft":K.preventDefault(),K.stopPropagation(),he();break;case"ArrowRight":K.preventDefault(),K.stopPropagation(),$e();break}};return document.addEventListener("keydown",w,!0),()=>{document.removeEventListener("keydown",w,!0)}},[g,he,$e]);const jt=R.useCallback((w,K,J)=>w?ho({scryfall_json:w,foil:K,name:J},{preferStoredPrice:!1,fallbackPrice:null,debugLogging:!1}).price:null,[]),qt=R.useCallback(async w=>{var Ce,ce,We,we,ae,He,ot,Oe,Ue,rt,Nt,Je,ct,Te,Tt,It,Ye,mt,Ct,tt,Mt;if(!w)return;const K=((ce=(Ce=w.cardObj)==null?void 0:Ce.card)==null?void 0:ce.scryfall_json)||((We=w.cardObj)==null?void 0:We.scryfall_json)||w.scryfall_json||{};let J=null;if((ae=(we=w.cardObj)==null?void 0:we.card)!=null&&ae.name?J=w.cardObj.card.name:(He=w.cardObj)!=null&&He.name?J=w.cardObj.name:w.name?J=w.name:K.name&&(J=K.name),!J){console.error("[CardActionsModal] Failed to extract card name for printing search"),alert("Could not find card name information. Please try a different card or refresh the page.");return}const Z=Gt.get(J);if(console.log(`üèûÔ∏è [FETCH PRINTINGS] Cache check for ${J}: ${Z?`found ${((ot=Z.printings)==null?void 0:ot.length)||0} printings`:"no cache found"}`),Z){let pt=!1;(!Z.printings||Z.printings.length<=1)&&(pt=!0,`${((Oe=Z.printings)==null?void 0:Oe.length)||0}`);const Lt=Z.timestamp?Date.now()-Z.timestamp:1/0,dt=60*60*1e3;if(Lt>dt&&(pt=!0),Z.printings&&(!Array.isArray(Z.printings)||Z.printings.some(st=>!st||!st.id))&&(pt=!0),Z.printings&&Z.printings.length>0&&(Z.printings.every(ft=>ft&&ft.id&&ft.set&&ft.collector_number&&(ft.image_uris||ft.card_faces))||(pt=!0)),pt)Gt.remove(J);else{const st=Zn.get(J);let ft=Z.selectedPrinting,Ut=!0;if(cn[J]){const at=Ln(J);if(console.log(`üèûÔ∏è [MODAL CACHE] Checking basic land preference for ${J}: ${at}`),console.log(`üèûÔ∏è [MODAL CACHE] Available cached printings: ${Z.printings.length} cards`),console.log("üèûÔ∏è [MODAL CACHE] First 3 cached IDs:",Z.printings.slice(0,3).map(Me=>Me.id)),at){const Me=Z.printings.find(At=>At.id===at);Me?(ft=Me,console.log(`üèûÔ∏è [MODAL CACHE] ‚úÖ Found basic land preference in cache for ${J}: ${at}`)):(console.log(`üèûÔ∏è [MODAL CACHE] ‚ùå Basic land preference ${at} not in cache, forcing fresh fetch`),Gt.remove(J),Ut=!1)}}else if(st&&st.id&&Z.selectedPrinting.id!==st.id){const at=Z.printings.find(Me=>Me.id===st.id);at?ft=at:(console.log(`[CardActionsModal] ‚ùå User preference ${st.id} not found in cached printings, forcing fresh fetch`),Gt.remove(J),Ut=!1)}if(Ut){const at=Math.min(Z.printings.length,20);if(M(Z.printings.slice(0,at)),ne(Z.printings),Pe(at),Re(ft),nn(J),Q&&p&&ft){const Me={...p,printing:ft.id,scryfall_json:ft,image_uris:ft.image_uris,foil:Y};Q(Me)}if(L&&ft){const Me=jt(ft,Y,J);L(w,{scryfall_json:ft,printing:ft.id,modalPrice:Me,freshPriceDataOnly:!0})}Z.printings&&Z.printings.length<=20&&(console.log(`[CardActionsModal] üîÑ Background fetching full printing list for ${J} (cached: ${Z.printings.length})`),setTimeout(()=>{Ot(J,w)},100));return}}}it(!0);try{cn[J]&&console.log(`[CardActionsModal] ‚ö° Basic land detected: ${J}, but will fetch all printings for selection`);const Lt=`https://constant-lists-api.onrender.com/api/cards/printings?name=${encodeURIComponent(J)}`,dt=await fetch(Lt);if(!dt.ok)throw dt.status===404?new Error(`Card "${J}" not found on Scryfall`):new Error(`Scryfall API error: ${dt.status} ${dt.statusText}`);const st=await dt.json();if(!Array.isArray(st.data)||st.data.length===0)throw new Error("No printings found for this card.");const ft=st.data,Ut=st.data.slice(0,20);ne(ft),M(Ut),Pe(Ut.length);const at=Zn.get(J);let Me=null,At="";if(cn[J]){const Et=Ln(J);Et&&(Me=Et,At=`basic land preference: FDN #275 (${Et})`,console.log(`üèûÔ∏è [MODAL] Using basic land preference for ${J}: ${Et}`))}else at&&at.id?(Me=at.id,At=`user preference: ${(Ue=at.set)==null?void 0:Ue.toUpperCase()} #${at.collector_number}`,console.log(`[CardActionsModal] üéØ Using user preference: ${(rt=at.set)==null?void 0:rt.toUpperCase()} #${at.collector_number} (${at.id})`)):((ct=(Je=(Nt=w.cardObj)==null?void 0:Nt.card)==null?void 0:Je.scryfall_json)!=null&&ct.id?(Me=w.cardObj.card.scryfall_json.id,At="inherited from deck list (cardObj.cardObj.card.scryfall_json)"):w.printing?(Me=w.printing,At="inherited from deck list (cardObj.printing)"):(Te=w.cardObj)!=null&&Te.printing?(Me=w.cardObj.printing,At="inherited from deck list (cardObj.cardObj.printing)"):(It=(Tt=w.cardObj)==null?void 0:Tt.card)!=null&&It.printing?(Me=w.cardObj.card.printing,At="inherited from deck list (cardObj.cardObj.card.printing)"):(mt=(Ye=w.card)==null?void 0:Ye.scryfall_json)!=null&&mt.id?(Me=w.card.scryfall_json.id,At="inherited from deck list (cardObj.card.scryfall_json)"):(tt=(Ct=w.cardObj)==null?void 0:Ct.scryfall_json)!=null&&tt.id?(Me=w.cardObj.scryfall_json.id,At="inherited from deck list (cardObj.cardObj.scryfall_json)"):(Mt=w.scryfall_json)!=null&&Mt.id?(Me=w.scryfall_json.id,At="inherited from deck list (cardObj.scryfall_json)"):w.scryfall_id?(Me=w.scryfall_id,At="inherited from deck list (cardObj.scryfall_id)"):w.id&&(Me=w.id,At="inherited from deck list (cardObj.id)"),Me||(At="fallback to first available printing (no deck list printing found)",console.log("[CardActionsModal] ‚ö†Ô∏è No deck list printing found - will use first available printing")));const En=Me?Ut.find(Et=>Et.id===Me)||ft.find(Et=>Et.id===Me):null,Bt=En||Ut[0];if(Re(Bt),nn(J),!at&&En&&Zn.set(J,Bt),Gt.set(J,ft,Bt),Q&&p&&Bt){const Et={...p,printing:Bt.id,scryfall_json:Bt,image_uris:Bt.image_uris,foil:Y};Q(Et)}const zt=En||Ut[0];if(zt&&L){const Et=jt(zt,p.foil===!0,J);L(w,{scryfall_json:zt,printing:zt.id,modalPrice:Et,freshPriceDataOnly:!0})}}catch(pt){M([]),ne([]),Re(null),console.error("Failed to fetch card printings:",pt),pt.name==="AbortError"?alert("Request timed out. The Scryfall API may be slow. Please try again."):pt.message.includes("not found on Scryfall")?alert("Card not found on Scryfall. The card name might be incorrect or it might be a custom card."):pt.message.includes("Scryfall API error")?alert(`Scryfall API error: ${pt.message}. Please try again later.`):alert("Failed to fetch printings for this card. Please check your connection or try a different card.")}finally{it(!1)}},[L,Q,p,Y]),Ot=R.useCallback(async(w,K)=>{try{console.log(`[CardActionsModal] üîÑ Background fetch starting for ${w}`);const Z=`https://constant-lists-api.onrender.com/api/cards/printings?name=${encodeURIComponent(w)}`,Ce=await fetch(Z);if(!Ce.ok)throw new Error(`API error: ${Ce.status}`);const ce=await Ce.json();if(!Array.isArray(ce.data)||ce.data.length===0)throw new Error("No printings found");const We=ce.data,we=V;if(Gt.set(w,We,we),xt===w){ne(We);const ae=Math.min(X.length,20);M(We.slice(0,ae)),console.log(`[CardActionsModal] ‚úÖ Background update: ${w} now has ${We.length} total printings available (showing ${ae})`)}}catch(J){console.warn(`[CardActionsModal] Background fetch failed for ${w}:`,J.message)}},[V,xt]);R.useEffect(()=>{var w,K,J,Z,Ce,ce,We,we,ae,He,ot,Oe,Ue,rt,Nt,Je,ct,Te,Tt,It;if(g&&p){const Ye=p.name||((w=p.cardObj)==null?void 0:w.name)||((J=(K=p.cardObj)==null?void 0:K.card)==null?void 0:J.name);if(cn[Ye]){const tt=Ln(Ye),Mt=Gt.get(Ye);Mt&&Mt.printings?Mt.printings.some(Lt=>Lt.id===tt)?console.log(`üèûÔ∏è [MODAL INIT] Cache has preferred printing ${tt} for ${Ye}`):(console.log(`üèûÔ∏è [MODAL INIT] Cache missing preferred printing ${tt} for ${Ye}, clearing cache`),Gt.remove(Ye)):console.log(`üèûÔ∏è [MODAL INIT] No cache found for basic land: ${Ye}`)}const mt=Gt.get(Ye);if(mt&&(Ye!==xt||X.length===0||!V)){let tt=null,Mt=mt.selectedPrinting;if((ce=(Ce=(Z=p.cardObj)==null?void 0:Z.card)==null?void 0:Ce.scryfall_json)!=null&&ce.id?tt=p.cardObj.card.scryfall_json.id:p.printing?tt=p.printing:(We=p.cardObj)!=null&&We.printing&&(tt=p.cardObj.printing),cn[Ye]){const dt=Ln(Ye);dt&&(console.log(`üèûÔ∏è [MODAL SYNC] Overriding deck list printing for ${Ye}: ${tt} ‚Üí ${dt}`),tt=dt)}else(we=p.scryfall_json)!=null&&we.id?tt=p.scryfall_json.id:p.scryfall_id?tt=p.scryfall_id:p.id&&(tt=p.id);if(tt){const dt=mt.printings.find(st=>st.id===tt);dt?(Mt=dt,mt.selectedPrinting.id!==tt&&(console.log("[CardActionsModal] üìã Deck list shows different printing than cache - updating cache for consistency"),Gt.set(Ye,mt.printings,dt))):console.log(`[CardActionsModal] ‚ö†Ô∏è Deck list printing ${tt} not found in cache - using cached selection`)}else console.log("[CardActionsModal] ‚ÑπÔ∏è No deck list printing found - using cached selection");const pt=Math.min(mt.printings.length,20);if(M(mt.printings.slice(0,pt)),ne(mt.printings),Pe(pt),Re(Mt),nn(Ye),Q&&Mt){const dt={...p,printing:Mt.id,scryfall_json:Mt,image_uris:Mt.image_uris,foil:Y};Q(dt)}if(L&&mt.selectedPrinting){const dt=jt(mt.selectedPrinting,Y,Ye);L(p,{scryfall_json:mt.selectedPrinting,printing:mt.selectedPrinting.id,modalPrice:dt,freshPriceDataOnly:!0})}const Lt=p.count||p.quantity||((ae=p.cardObj)==null?void 0:ae.count)||((He=p.cardObj)==null?void 0:He.quantity)||((Oe=(ot=p.cardObj)==null?void 0:ot.card)==null?void 0:Oe.count)||((rt=(Ue=p.cardObj)==null?void 0:Ue.card)==null?void 0:rt.quantity)||1;F(typeof Lt=="number"&&!isNaN(Lt)?Lt:1);return}(Ye!==xt||X.length===0||!V)&&(Pe(20),qt(p));const Ct=p.count||p.quantity||((Nt=p.cardObj)==null?void 0:Nt.count)||((Je=p.cardObj)==null?void 0:Je.quantity)||((Te=(ct=p.cardObj)==null?void 0:ct.card)==null?void 0:Te.count)||((It=(Tt=p.cardObj)==null?void 0:Tt.card)==null?void 0:It.quantity)||1;F(typeof Ct=="number"&&!isNaN(Ct)?Ct:1)}},[g,p==null?void 0:p.name,p==null?void 0:p._id]),R.useEffect(()=>{var w,K,J,Z,Ce,ce,We,we,ae;if(!lt&&p){const He=((K=(w=p.cardObj)==null?void 0:w.card)==null?void 0:K.scryfall_json)||((J=p.cardObj)==null?void 0:J.scryfall_json)||p.scryfall_json||{};if(!He.name&&!He.finishes)return;const ot=Array.isArray(He.finishes)?He.finishes:[];let Oe=ot.includes("nonfoil"),Ue=ot.includes("foil")||ot.includes("etched");if(ot.length===0&&He.set){const Te=He.set.toLowerCase(),Tt=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(Te),It=["msc","cmb1","cmb2","plist"].includes(Te),Ye=["ocm1","pcm1","p30h","p30a","p30m"].includes(Te);Tt||It?(Oe=!0,Ue=!1):Ye?(Oe=!1,Ue=!0):(Oe=!0,Ue=!0)}const rt=Ue&&!Oe,Nt=Oe&&!Ue;let Je=!1;Je=[p.foil,p.isFoil,(Z=p.cardObj)==null?void 0:Z.foil,(Ce=p.cardObj)==null?void 0:Ce.isFoil,(We=(ce=p.cardObj)==null?void 0:ce.card)==null?void 0:We.foil,(ae=(we=p.cardObj)==null?void 0:we.card)==null?void 0:ae.isFoil].some(Te=>Te===!0),Je||(rt?Je=!0:Nt?Je=!1:Ue&&!Oe&&(Je=!0)),Ve(rt),Le(Nt),_e(Je),He.set}},[p==null?void 0:p.foil,p==null?void 0:p.isFoil,(nt=p==null?void 0:p.cardObj)==null?void 0:nt.foil,(Wn=(Dt=p==null?void 0:p.cardObj)==null?void 0:Dt.card)==null?void 0:Wn.foil,(Jt=p==null?void 0:p.cardObj)==null?void 0:Jt.isFoil,(Pt=(Yt=p==null?void 0:p.cardObj)==null?void 0:Yt.card)==null?void 0:Pt.isFoil,p==null?void 0:p._id,g]),R.useEffect(()=>{if(!lt&&V&&V.finishes&&Array.isArray(V.finishes)){const w=V.finishes,K=w.includes("nonfoil"),J=w.includes("foil")||w.includes("etched"),Z=J&&!K,Ce=K&&!J;(Z!==be||Ce!==oe)&&(Ve(Z),Le(Ce),Z&&!Y?_e(!0):Ce&&Y&&_e(!1))}},[V==null?void 0:V.id,lt,be,oe]),R.useEffect(()=>{if(V&&L&&p){const w=ut();w!=null&&L(p,{modalPrice:w,printing:V.id,foil:Y,freshPriceDataOnly:!0,scryfall_json:V})}},[V,Y,p==null?void 0:p.name]);const on=R.useCallback(w=>{try{const K=In.getChunkedItem("cardCollection")||[],J=K.filter(we=>we.printing_id===w.id&&we.foil===!0).reduce((we,ae)=>we+ae.quantity,0),Z=K.filter(we=>we.printing_id===w.id&&we.foil===!1).reduce((we,ae)=>we+ae.quantity,0);if(J+Z>0){const we=[];return Z>0&&we.push(`${Z} Regular`),J>0&&we.push(`${J} Foil`),{status:"exact-match",text:we.join(", ")}}const ce=w.name,We=w.oracle_id;if(ce&&We){const we=K.filter(ae=>(ae.oracle_id===We||ae.card_name===ce)&&ae.printing_id!==w.id);if(we.length>0){const ae=we.filter(Oe=>Oe.foil===!0).reduce((Oe,Ue)=>Oe+Ue.quantity,0),He=we.filter(Oe=>Oe.foil===!1).reduce((Oe,Ue)=>Oe+Ue.quantity,0),ot=[];return He>0&&ot.push(`${He} Regular`),ae>0&&ot.push(`${ae} Foil`),{status:"different-version",text:`${ot.join(", ")} (Other Printing)`}}}return{status:"not-owned",text:"Not Owned"}}catch(K){return console.error("Error checking collection status:",K),{status:"unknown",text:"Unknown"}}},[St]),jn=()=>{const w=Math.min(n+20,H.length);Pe(w),M(H.slice(0,w))},rn=(w,K)=>{var J;try{de(w,K),setTimeout(()=>{en(Z=>Z+1),console.log(`[CardActionsModal] Collection status refreshed after adding: ${K.name}`)},100),P.success("Added to collection!",{position:"top-center",autoClose:2e3,hideProgressBar:!0,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),console.log(`[CardActionsModal] Added to collection: ${K.name} (${(J=K.set)==null?void 0:J.toUpperCase()} #${K.collector_number})`)}catch(Z){console.error("[CardActionsModal] Error adding to collection:",Z),P.error("Failed to add to collection. Please try again.")}};if(!g||!p)return null;const Kt=w=>{var Z,Ce,ce,We,we;if(V&&V.id===w.id)return;const K=(p==null?void 0:p.name)||((Z=p==null?void 0:p.card)==null?void 0:Z.name);if(K&&cn[K]){const ae=Ln(K);ae!==w.id&&(_r(K,w.id),console.log(`üèûÔ∏è [MODAL] User changed preferred printing for ${K}: ${ae} -> ${w.id}`))}if(Re(w),Qe.current&&(Qe.current.scrollTop=0),L&&p){const ae=ut(w,Y);console.log(`[PRINTING SELECTION] Immediate sync: ${p.name} -> $${ae} (${w.set}/${w.collector_number}, foil: ${Y})`),L(p,{modalPrice:ae,printing:w.id,foil:Y,freshPriceDataOnly:!0,scryfall_json:w})}if(Q&&p){const ae={...p,printing:w.id,scryfall_json:w,image_uris:w.image_uris,foil:Y};console.log("[CardActionsModal] Calling onPreviewUpdate with:",{printingId:w.id,cardName:p.name||w.name,previewUpdateData:ae}),Q(ae)}else console.log("[CardActionsModal] NOT calling onPreviewUpdate:",{hasCallback:!!Q,hasCard:!!p,printingId:w.id});const J={id:w.id,name:w.name,set:w.set,set_name:w.set_name,collector_number:w.collector_number,rarity:w.rarity,released_at:w.released_at,image_uris:w.image_uris,mana_cost:w.mana_cost,type_line:w.type_line,oracle_text:w.oracle_text,power:w.power,toughness:w.toughness,colors:w.colors,color_identity:w.color_identity,prices:w.prices,games:w.games,legalities:w.legalities,finishes:w.finishes||[],foil:w.foil,nonfoil:w.nonfoil,frame_effects:w.frame_effects||[],promo_types:w.promo_types||[],oracle_id:w.oracle_id,card_faces:w.card_faces};try{const ae=w.prices||{},He=w.finishes||[],ot=w.promo_types||[];let Oe;Y?(He.includes("etched")||(Ce=w.frame_effects)!=null&&Ce.includes("etched")?Oe=ae.usd_etched||ae.usd_foil||ae.usd||null:(ot.includes("surgefoil")||ot.includes("rainbow")||ot.includes("textured")||ot.includes("boosterfun"),Oe=ae.usd_foil||ae.usd||null),!Oe&&be&&(Oe=ae.usd_foil||ae.usd_etched||null)):Oe=ae.usd||null;const Ue=w.finishes||[],rt=Ue.includes("nonfoil"),Nt=Ue.includes("foil")||Ue.includes("etched");let Je=rt,ct=Nt;if(Ue.length===0){const Ct=(ce=w.set)==null?void 0:ce.toLowerCase(),tt=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(Ct),Mt=["msc","cmb1","cmb2","plist"].includes(Ct),pt=["ocm1","pcm1","p30h","p30a","p30m"].includes(Ct);tt||Mt?(Je=!0,ct=!1):pt?(Je=!1,ct=!0):(Je=!0,ct=!0)}let Te;!Je&&ct?(Te=!0,console.log(`[CardActionsModal] New printing "${w.set_name}" is foil-only, forcing foil to true`)):Je&&!ct?(Te=!1,console.log(`[CardActionsModal] New printing "${w.set_name}" is non-foil-only, forcing foil to false`)):Je&&ct&&(Te=!1,console.log(`[CardActionsModal] New printing "${w.set_name}" supports both finishes, resetting to non-foil`));let Tt;Te?Ue.includes("etched")||(We=w.frame_effects)!=null&&We.includes("etched")?Tt=ae.usd_etched||ae.usd_foil||ae.usd||null:(ot.includes("surgefoil")||ot.includes("rainbow")||ot.includes("textured")||ot.includes("boosterfun"),Tt=ae.usd_foil||ae.usd||null):Tt=ae.usd||null,L(p,{printing:w.id,scryfall_json:J,price:Tt,modalPrice:Tt,foil:Te,modalFoilStatus:Te,image_uris:w.image_uris||null,card_faces:w.card_faces||null}),Te!==Y&&(console.log(`[CardActionsModal] Updating modal foil state from ${Y} to ${Te} due to printing change`),_e(Te));const It=!Je&&ct,Ye=Je&&!ct;It!==be&&(Ve(It),console.log(`[CardActionsModal] Updated foil-only status to: ${It} for set: ${w.set}`)),Ye!==oe&&(Le(Ye),console.log(`[CardActionsModal] Updated non-foil-only status to: ${Ye} for set: ${w.set}`));const mt=p.name||w.name;if(mt){const Ct={id:w.id,set:w.set,collector_number:w.collector_number,set_name:w.set_name,rarity:w.rarity};Zn.set(mt,Ct),console.log(`[CardActionsModal] üß† Learned preference for "${mt}": ${(we=w.set)==null?void 0:we.toUpperCase()} #${w.collector_number} (${w.set_name})`)}}catch(ae){console.error("[CardActionsModal] Error updating printing:",ae),alert("Error updating card printing. Please try again."),Re(V)}},ze=w=>{if(be||oe)return;const K=!!w.target.checked;_e(K),Be(!0),Sn(Z=>Z+1);const J=K?"Updated to foil":"Updated to non-foil";P.success(J,{position:"top-center",autoClose:1500,hideProgressBar:!0,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),setTimeout(()=>{var Z,Ce,ce;try{const We=V?jt(V,K,p.name):null,we=p.printing||((Z=p.cardObj)==null?void 0:Z.printing)||((ce=(Ce=p.cardObj)==null?void 0:Ce.card)==null?void 0:ce.printing)||(V==null?void 0:V.id),ae={foil:K,isFoil:K,modalPrice:We,printing:we,lastUpdated:Date.now()};L(p,ae)}catch(We){console.error("[CardActionsModal] Error updating foil status:",We),_e(!K),P.error("Failed to update foil status. Please try again.")}finally{setTimeout(()=>Be(!1),100)}},50)},Xt=w=>{const K=w.target.value;$t(K),Fe(!0)},_n=()=>{let w=parseInt(hn,10);if((isNaN(w)||w===0)&&(w=Ne),w>999&&(w=999),w<1){z(p);return}w!==Ne&&(F(w),L(p,{quantity:w}),P.success(`Updated quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0})),Fe(!1),$t("")},fn=()=>{$t(""),Fe(!1)},Qt=w=>{w.key==="Enter"?(w.preventDefault(),w.target.blur()):w.key==="Escape"&&(w.preventDefault(),fn(),w.target.blur())},un=w=>{$t(Ne.toString()),Fe(!0),setTimeout(()=>{w.target.select()},0)},bt=()=>{_t&&_n()},sn=()=>{const w=Math.min(Ne+1,999);w!==Ne&&(F(w),L(p,{quantity:w}),P.success(`Increased quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0}))},Se=()=>{const w=Ne-1;if(w<1){z(p),P.success("Removed card from deck",{position:"top-center",autoClose:1e3,hideProgressBar:!0});return}F(w),L(p,{quantity:w}),P.success(`Decreased quantity to ${w}`,{position:"top-center",autoClose:1e3,hideProgressBar:!0})};R.useEffect(()=>{const w=K=>{K.key==="cardCollection"&&en(J=>J+1)};return window.addEventListener("storage",w),()=>window.removeEventListener("storage",w)},[]),R.useEffect(()=>{g&&en(w=>w+1)},[g]),R.useEffect(()=>{const w=()=>{const Ce=document.querySelector(".toggle-switch"),ce=document.querySelector(".toggle-slider");Ce&&(Ce.style.display="inline-block",Ce.style.visibility="visible",Ce.style.opacity=be||oe?"0.6":"1",Ce.style.position="relative",Ce.style.width="50px",Ce.style.height="24px",Ce.style.zIndex="9999"),ce&&(ce.style.display="block",ce.style.visibility="visible",ce.style.opacity="1",ce.style.position="absolute",ce.style.top="0",ce.style.left="0",ce.style.right="0",ce.style.bottom="0")};w();const K=setTimeout(w,100),J=new MutationObserver(()=>{w()}),Z=document.querySelector(".toggle-switch");return Z&&J.observe(Z,{attributes:!0,attributeFilter:["style","class"]}),()=>{clearTimeout(K),J.disconnect()}},[be,oe,Y,V,g]);const Rt=R.useCallback(w=>{console.log(`[CardActionsModal] üîç Oracle tag search requested: ${w}`),ye?(T(),setTimeout(()=>{ye(w)},100)):(console.warn("[CardActionsModal] No onOracleTagSearch function provided"),alert(`Would search for oracle tag: "${w}"

Please implement the onOracleTagSearch prop in your parent component.`))},[ye,T]);return s.jsx("div",{className:"modal-backdrop card-actions-modal",onClick:T,children:s.jsxs("div",{className:"modal-content",onClick:w=>w.stopPropagation(),ref:Xe,children:[s.jsxs("div",{className:"modal-header",children:[he&&s.jsx("button",{onClick:he,className:"nav-arrow nav-arrow-left",title:"Previous card (Left arrow key)",children:"‚Äπ"}),s.jsx("button",{onClick:T,className:"close-button",children:"√ó"}),$e&&s.jsx("button",{onClick:$e,className:"nav-arrow nav-arrow-right",title:"Next card (Right arrow key)",children:"‚Ä∫"})]}),s.jsxs("div",{className:"modal-body",children:[s.jsxs("div",{className:"card-actions",ref:Qe,children:[s.jsxs("div",{className:"action-row foil-selector",children:[s.jsxs("label",{className:"control-label",children:["Foil:",be&&s.jsx("span",{className:"foil-only-indicator",children:" (Foil Only)"}),oe&&s.jsx("span",{className:"non-foil-only-indicator",children:" (Non-Foil Only)"})]}),s.jsxs("label",{className:`toggle-switch ${be||oe?"disabled":""}`,style:{display:"flex",alignItems:"center"},children:[s.jsx("input",{type:"checkbox",checked:Y,onChange:ze,disabled:be||oe,style:{opacity:1,visibility:"visible"}}),s.jsx("span",{className:`toggle-slider ${Y?"foil-active":""} ${be||oe?"disabled":""}`,style:{opacity:1,visibility:"visible"}})]})]}),s.jsxs("div",{className:"action-row quantity-row",children:[s.jsxs("label",{className:"control-label",style:{display:"flex",alignItems:"center"},children:["Quantity:",_t&&s.jsx("span",{style:{fontSize:"10px",color:"#666",marginLeft:"8px",fontStyle:"italic"},children:"Press Enter to save, Esc to cancel"})]}),s.jsxs("div",{className:"quantity-controls",children:[s.jsx("button",{className:"quantity-btn",onClick:Se,disabled:Ne<=1||_t,title:Ne<=1?"Cannot go below 1":"Decrease quantity",children:"‚àí"}),s.jsx("input",{type:"number",value:_t?hn:Ne,onChange:Xt,onFocus:un,onBlur:bt,onKeyDown:Qt,className:`quantity-input ${_t?"editing":""}`,min:"1",max:"999",step:"1",placeholder:"Enter quantity",title:"Click to edit, Enter to save, Esc to cancel"}),s.jsx("button",{className:"quantity-btn",onClick:sn,disabled:Ne>=999||_t,title:Ne>=999?"Maximum quantity reached":"Increase quantity",children:"+"})]}),_t&&s.jsxs("div",{style:{display:"flex",gap:"4px",marginLeft:"8px"},children:[s.jsx("button",{onClick:_n,style:{background:"#22c55e",color:"white",border:"none",borderRadius:"3px",padding:"2px 6px",fontSize:"12px",cursor:"pointer"},title:"Save changes",children:"‚úì"}),s.jsx("button",{onClick:fn,style:{background:"#ef4444",color:"white",border:"none",borderRadius:"3px",padding:"2px 6px",fontSize:"12px",cursor:"pointer"},title:"Cancel changes",children:"‚úï"})]})]}),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button",onClick:()=>{if(onAddCard&&V){const w={name:p.name,printing:V.id,foil:Y,quantity:Ne||1,cardObj:{scryfall_id:V.id,name:V.name,set:V.set,set_name:V.set_name,collector_number:V.collector_number,image_uris:V.image_uris,type_line:V.type_line,mana_cost:V.mana_cost,cmc:V.cmc,colors:V.colors,color_identity:V.color_identity,prices:V.prices},scryfall_json:V};onAddCard(w),P.success(`Added ${w.name} to deck`),T()}else P.error("Unable to add card to deck")},children:"Add to Main Board"}),s.jsx("button",{className:"action-button",onClick:()=>z(p),children:"Remove from Deck"}),s.jsx("button",{className:"action-button",onClick:()=>q(p),children:"Move to Sideboard"}),s.jsx("button",{className:"action-button",onClick:()=>{se?(se(p),T()):console.error("onMoveToTechIdeas function not provided")},children:"Move to Tech Ideas"}),s.jsx("button",{className:"action-button",onClick:()=>rn(p,{...V,foil:Y}),children:"Add to My Collection"}),s.jsx("button",{className:"action-button",onClick:()=>{if(V&&p){const w={name:p.name,printing:V.id,foil:Y,count:1,dateAdded:Date.now(),cardObj:{scryfall_id:V.id,name:V.name,set:V.set,set_name:V.set_name,collector_number:V.collector_number,image_uris:V.image_uris,type_line:V.type_line,mana_cost:V.mana_cost,cmc:V.cmc,colors:V.colors,color_identity:V.color_identity,prices:V.prices},scryfall_json:V},K=JSON.parse(localStorage.getItem("global-wishlist")||"[]"),J=K.findIndex(Z=>Z.name===p.name&&Z.printing===V.id);J!==-1?(K[J].count+=1,P.success(`Updated ${p.name} quantity in wishlist (now ${K[J].count})`)):(K.push(w),P.success(`Added ${p.name} to wishlist`)),localStorage.setItem("global-wishlist",JSON.stringify(K)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:K}))}else P.error("Unable to add card to wishlist")},children:"Add to Wishlist"})]}),s.jsxs("div",{className:"printings-section",children:[s.jsx("h3",{children:"Select Printing"}),s.jsxs("div",{className:"printings-list",children:[le?s.jsxs("div",{className:"loading-printings",children:[s.jsx("p",{children:"Loading printings..."}),s.jsx("div",{className:"spinner"})]}):X.length===0?s.jsx("p",{children:"No printings found for this card."}):(()=>{const w=[];return V&&w.push(V),X.forEach(K=>{(!V||K.id!==V.id)&&w.push(K)}),w.map((K,J)=>{let Z="";K.id&&(Z=`https://api.scryfall.com/cards/${K.id}?format=image&version=normal`),Z||(Z=dn);const Ce=(V==null?void 0:V.id)===K.id;return s.jsxs("div",{className:`printing-item ${Ce?"selected":""}`,title:`${K.name} - ${K.set.toUpperCase()} ${K.collector_number?`(#${K.collector_number})`:""}`,children:[s.jsx("img",{src:Z,alt:`${K.name} - ${K.set.toUpperCase()}`,onClick:()=>Kt(K),loading:"lazy",style:{maxWidth:"100%",maxHeight:"280px",objectFit:"contain",background:"#f8f8f8",transition:"opacity 0.2s"},onLoad:ce=>{ce.target.style.opacity="1"},onError:ce=>{ce.target.src=dn}}),Ce&&s.jsx("div",{className:"current-label",children:"CURRENT"}),s.jsxs("div",{className:"set-info",children:[s.jsxs("div",{className:"set-details-row",style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",marginBottom:"4px",width:"auto"},children:[s.jsx("img",{src:`/svgs/${K.set.toLowerCase()}.svg`,alt:K.set.toUpperCase(),className:"set-symbol",style:{width:"16px",height:"16px",flexShrink:0},onError:ce=>{ce.target.style.display="none"}}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"500"},children:[K.set.toUpperCase()," ",K.collector_number&&`#${K.collector_number}`]})]}),s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",marginTop:"4px",fontSize:"12px",minHeight:"16px",width:"auto",gap:"14px"},children:[s.jsx("span",{style:{color:"#666",fontWeight:"500",fontSize:"12px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"none"},children:(()=>{var We,we;if(V&&K.id===V.id){const ae=Ht();return Bn(ae)}const ce=((We=K.prices)==null?void 0:We.usd)||K.usd||((we=K.prices)==null?void 0:we.usd_foil)||K.usd_foil;return Bn(ce)})()}),s.jsx("span",{style:{fontSize:"18px",whiteSpace:"nowrap"},children:(()=>{const ce=on(K);return(ce==null?void 0:ce.status)==="exact-match"?s.jsx("span",{style:{color:"#22c55e",fontSize:"18px"},title:`Owned: ${ce.text}`,children:"‚óè"}):(ce==null?void 0:ce.status)==="different-version"?s.jsx("span",{style:{color:"#eab308",fontSize:"18px"},title:ce.text,children:"‚óè"}):(ce==null?void 0:ce.status)==="not-owned"?s.jsx("span",{style:{color:"#ef4444",fontSize:"18px"},title:"Not owned",children:"‚óè"}):s.jsx("span",{style:{color:"#6b7280",fontSize:"18px"},title:"Unknown status",children:"‚óè"})})()})]})]}),pe&&(V==null?void 0:V.id)===K.id&&s.jsxs("span",{className:"updating-indicator",children:[s.jsx("span",{className:"spinner-small"})," Updating..."]})]},K.id)})})(),H.length>X.length&&s.jsx("div",{style:{textAlign:"center",padding:"20px"},children:s.jsxs("button",{onClick:jn,style:{background:"#007bff",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",cursor:"pointer",fontSize:"14px"},onMouseEnter:w=>{w.target.style.background="#0056b3"},onMouseLeave:w=>{w.target.style.background="#007bff"},children:["Load More Printings (",H.length-X.length," remaining)"]})})]})]})]}),s.jsx("div",{className:"printings-container",children:V&&s.jsx("div",{className:"current-printing-container",children:s.jsxs("div",{className:"current-printing-info",children:[s.jsx("div",{className:"current-printing-name",children:s.jsx("strong",{children:V.name})}),s.jsxs("div",{className:"printing-price",children:["Price: ",(()=>{const w=ut();return Bn(w)})()]}),V.oracle_text&&s.jsx("div",{className:"oracle-text",children:V.oracle_text.split(`
`).map((w,K)=>s.jsx("p",{children:w},K))}),s.jsx(fr,{card:p,onOracleTagSearch:Rt})]})})})]})]})})},br=({isOpen:g,onClose:T,onImport:p})=>{const[L,z]=R.useState(""),[q,se]=R.useState(!1),de=async()=>{if(!L.trim()){P.warning("Please paste some text to import");return}se(!0);try{await p(L),z(""),T()}catch(Q){console.error("Import error:",Q)}finally{se(!1)}},pe=Q=>{const ye=Q.target.files[0];if(ye&&ye.type==="text/plain"){const he=new FileReader;he.onload=$e=>{z($e.target.result)},he.readAsText(ye)}else P.error("Please select a valid text file (.txt)")},fe=()=>`Sample Deck
Generated on ${new Date().toLocaleDateString()}
Format: TCGPlayer Mass Entry Compatible

MAIN DECK:
=========
4 Lightning Bolt [M11] 123
3 Counterspell [7ED] 54
2 Serra Angel
1 Black Lotus [LEA] 232

SIDEBOARD:
==========
2 Red Elemental Blast [4ED] 215
3 Disenchant [ICE] 110

TECH IDEAS:
===========
1 Ancestral Recall [LEA] 48
1 Time Walk [LEA] 371`;return g?s.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,padding:"20px"},onClick:Q=>{Q.target===Q.currentTarget&&T()},children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"24px",maxWidth:"800px",width:"100%",maxHeight:"90vh",overflow:"auto",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)"},onClick:Q=>Q.stopPropagation(),children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[s.jsx("h2",{style:{margin:0,color:"#333",fontSize:"24px",fontWeight:"600"},children:"Import Deck from Text"}),s.jsx("button",{onClick:T,style:{background:"none",border:"none",fontSize:"24px",cursor:"pointer",color:"#666",padding:"0",width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"6px"},onMouseEnter:Q=>Q.target.style.backgroundColor="#f5f5f5",onMouseLeave:Q=>Q.target.style.backgroundColor="transparent",children:"√ó"})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("p",{style:{color:"#666",margin:"0 0 16px 0",lineHeight:"1.5"},children:"Paste your deck list or upload a text file. Supports the export format from this application and other standard formats. Cards will be automatically searched and added to your deck."}),s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"inline-block",marginBottom:"8px",fontWeight:"500",color:"#333"},children:"Upload Text File:"}),s.jsx("input",{type:"file",accept:".txt",onChange:pe,style:{marginLeft:"12px",padding:"6px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:"#f9f9f9"}})]})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"500",color:"#333"},children:"Deck List Text:"}),s.jsx("textarea",{value:L,onChange:Q=>z(Q.target.value),placeholder:fe(),style:{width:"100%",height:"300px",border:"2px solid #ddd",borderRadius:"8px",padding:"12px",fontSize:"14px",fontFamily:'Monaco, Consolas, "Courier New", monospace',resize:"vertical",outline:"none"},onFocus:Q=>Q.target.style.borderColor="#4caf50",onBlur:Q=>Q.target.style.borderColor="#ddd"})]}),s.jsxs("div",{style:{backgroundColor:"#f8f9fa",padding:"16px",borderRadius:"8px",marginBottom:"24px",border:"1px solid #e9ecef"},children:[s.jsx("h4",{style:{margin:"0 0 12px 0",color:"#495057",fontSize:"16px"},children:"Supported Formats:"}),s.jsxs("ul",{style:{margin:0,paddingLeft:"20px",color:"#6c757d",lineHeight:"1.6"},children:[s.jsxs("li",{children:[s.jsx("strong",{children:"Full Format:"})," ",s.jsx("code",{children:"4 Lightning Bolt [M11] 123"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"With Set:"})," ",s.jsx("code",{children:"4 Lightning Bolt [M11]"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Simple:"})," ",s.jsx("code",{children:"4 Lightning Bolt"})]}),s.jsxs("li",{children:[s.jsx("strong",{children:"Sections:"})," MAIN DECK, SIDEBOARD, TECH IDEAS"]})]})]}),s.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:T,style:{padding:"12px 24px",border:"2px solid #ddd",borderRadius:"8px",backgroundColor:"white",color:"#666",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:Q=>{Q.target.style.borderColor="#999",Q.target.style.color="#333"},onMouseLeave:Q=>{Q.target.style.borderColor="#ddd",Q.target.style.color="#666"},children:"Cancel"}),s.jsx("button",{onClick:de,disabled:q||!L.trim(),style:{padding:"12px 24px",border:"none",borderRadius:"8px",backgroundColor:q||!L.trim()?"#ccc":"#4caf50",color:"white",fontSize:"14px",fontWeight:"500",cursor:q||!L.trim()?"not-allowed":"pointer",transition:"all 0.2s ease"},onMouseEnter:Q=>{!q&&L.trim()&&(Q.target.style.backgroundColor="#45a049")},onMouseLeave:Q=>{!q&&L.trim()&&(Q.target.style.backgroundColor="#4caf50")},children:q?"Importing...":"Import Cards"})]})]})}):null},Cr=({isOpen:g,onClose:T,onImport:p})=>{const[L,z]=R.useState([]),[q,se]=R.useState(!1),[de,pe]=R.useState(0),[fe,Q]=R.useState([]),ye=X=>{const M=Array.from(X.target.files),H=M.filter(ne=>ne.type.startsWith("image/")||ne.type==="application/pdf");H.length!==M.length&&P.warning("Some files were skipped. Only image and PDF files are supported."),z(H),Q([])},he=async()=>{if(L.length===0){P.warning("Please select some files to process");return}se(!0),pe(0);const X=[];try{for(let M=0;M<L.length;M++){const H=L[M];if(pe((M+1)/L.length*100),H.type==="application/pdf"){P.info(`PDF processing not yet implemented: ${H.name}`);continue}const ne=H.name.toLowerCase();let n=null;ne.includes("lightning")&&ne.includes("bolt")?n="Lightning Bolt":ne.includes("counterspell")?n="Counterspell":ne.includes("serra")&&ne.includes("angel")?n="Serra Angel":ne.includes("black")&&ne.includes("lotus")&&(n="Black Lotus"),n?X.push({fileName:H.name,cardName:n,confidence:.7,quantity:1}):X.push({fileName:H.name,cardName:`Unknown Card (${H.name})`,confidence:0,quantity:1,needsManualEntry:!0}),await new Promise(Pe=>setTimeout(Pe,500))}Q(X),P.success(`Processed ${L.length} files. Found ${X.filter(M=>M.confidence>.5).length} cards.`)}catch(M){console.error("Error processing images:",M),P.error("Error processing images")}finally{se(!1),pe(0)}},$e=async()=>{const X=fe.filter(H=>H.confidence>.5&&!H.needsManualEntry);if(X.length===0){P.warning("No valid cards detected to import");return}const M=["MAIN DECK:","=========",...X.map(H=>`${H.quantity} ${H.cardName}`),`
Main Deck Total: ${X.length} cards`].join(`
`);try{await p(M),z([]),Q([]),T()}catch(H){console.error("Import error:",H)}},Xe=(X,M)=>{const H=[...fe];H[X].cardName=M,H[X].needsManualEntry=!1,H[X].confidence=.9,Q(H)},Qe=(X,M)=>{const H=[...fe];H[X].quantity=parseInt(M)||1,Q(H)};return g?s.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,padding:"20px"},onClick:X=>{X.target===X.currentTarget&&T()},children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"24px",maxWidth:"900px",width:"100%",maxHeight:"90vh",overflow:"auto",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.3)"},onClick:X=>X.stopPropagation(),children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:[s.jsx("h2",{style:{margin:0,color:"#333",fontSize:"24px",fontWeight:"600"},children:"Import from Photos/PDF"}),s.jsx("button",{onClick:T,style:{background:"none",border:"none",fontSize:"24px",cursor:"pointer",color:"#666",padding:"0",width:"32px",height:"32px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"6px"},onMouseEnter:X=>X.target.style.backgroundColor="#f5f5f5",onMouseLeave:X=>X.target.style.backgroundColor="transparent",children:"√ó"})]}),s.jsxs("div",{style:{marginBottom:"24px"},children:[s.jsxs("div",{style:{backgroundColor:"#fff3cd",border:"1px solid #ffeaa7",borderRadius:"8px",padding:"16px",marginBottom:"20px"},children:[s.jsx("h4",{style:{margin:"0 0 8px 0",color:"#856404"},children:"üöß Beta Feature"}),s.jsx("p",{style:{margin:0,color:"#856404",fontSize:"14px",lineHeight:"1.4"},children:"Photo recognition is currently in beta. For best results, use clear, well-lit photos of individual cards. You can manually edit any misidentified cards before importing."})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"12px",fontWeight:"500",color:"#333",fontSize:"16px"},children:"Select Card Photos or PDFs:"}),s.jsx("input",{type:"file",multiple:!0,accept:"image/*,.pdf",onChange:ye,style:{width:"100%",padding:"12px",border:"2px dashed #ddd",borderRadius:"8px",backgroundColor:"#f9f9f9",cursor:"pointer"}}),L.length>0&&s.jsxs("p",{style:{margin:"8px 0 0 0",color:"#666",fontSize:"14px"},children:["Selected ",L.length," file",L.length!==1?"s":""]})]}),L.length>0&&!q&&fe.length===0&&s.jsx("button",{onClick:he,style:{padding:"12px 24px",backgroundColor:"#ff9800",color:"white",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:"500",cursor:"pointer",marginBottom:"20px"},onMouseEnter:X=>X.target.style.backgroundColor="#f57c00",onMouseLeave:X=>X.target.style.backgroundColor="#ff9800",children:"Process Images"}),q&&s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsxs("div",{style:{marginBottom:"8px",color:"#666"},children:["Processing images... ",Math.round(de),"%"]}),s.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},children:s.jsx("div",{style:{width:`${de}%`,height:"100%",backgroundColor:"#ff9800",transition:"width 0.3s ease"}})})]}),fe.length>0&&s.jsxs("div",{children:[s.jsxs("h3",{style:{marginBottom:"16px",color:"#333"},children:["Detected Cards (",fe.length,"):"]}),s.jsx("div",{style:{maxHeight:"300px",overflow:"auto",border:"1px solid #ddd",borderRadius:"8px"},children:fe.map((X,M)=>s.jsxs("div",{style:{padding:"12px",borderBottom:M<fe.length-1?"1px solid #eee":"none",display:"flex",alignItems:"center",gap:"12px",backgroundColor:X.needsManualEntry?"#fff3cd":"white"},children:[s.jsx("div",{style:{flex:"0 0 120px",fontSize:"12px",color:"#666"},children:X.fileName}),s.jsx("div",{style:{flex:"0 0 60px"},children:s.jsx("input",{type:"number",min:"1",max:"20",value:X.quantity,onChange:H=>Qe(M,H.target.value),style:{width:"50px",padding:"4px",border:"1px solid #ddd",borderRadius:"4px",textAlign:"center"}})}),s.jsx("div",{style:{flex:"1"},children:s.jsx("input",{type:"text",value:X.cardName,onChange:H=>Xe(M,H.target.value),placeholder:"Enter card name",style:{width:"100%",padding:"8px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:X.needsManualEntry?"#fff9e6":"white"}})}),s.jsx("div",{style:{flex:"0 0 80px",fontSize:"12px",textAlign:"center"},children:X.confidence>.5?s.jsx("span",{style:{color:"#4caf50"},children:"‚úì Ready"}):s.jsx("span",{style:{color:"#ff9800"},children:"‚ö† Edit"})})]},M))})]})]}),s.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:T,style:{padding:"12px 24px",border:"2px solid #ddd",borderRadius:"8px",backgroundColor:"white",color:"#666",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:X=>{X.target.style.borderColor="#999",X.target.style.color="#333"},onMouseLeave:X=>{X.target.style.borderColor="#ddd",X.target.style.color="#666"},children:"Cancel"}),fe.length>0&&s.jsxs("button",{onClick:$e,disabled:fe.filter(X=>X.confidence>.5).length===0,style:{padding:"12px 24px",border:"none",borderRadius:"8px",backgroundColor:fe.filter(X=>X.confidence>.5).length===0?"#ccc":"#4caf50",color:"white",fontSize:"14px",fontWeight:"500",cursor:fe.filter(X=>X.confidence>.5).length===0?"not-allowed":"pointer",transition:"all 0.2s ease"},onMouseEnter:X=>{fe.filter(M=>M.confidence>.5).length>0&&(X.target.style.backgroundColor="#45a049")},onMouseLeave:X=>{fe.filter(M=>M.confidence>.5).length>0&&(X.target.style.backgroundColor="#4caf50")},children:["Import ",fe.filter(X=>X.confidence>.5).length," Cards"]})]})]})}):null},po={Island:"Land",Mountain:"Land",Plains:"Land",Swamp:"Land",Forest:"Land",Wastes:"Land","Halimar Depths":"Land","Izzet Boilerworks":"Land","Lonely Sandbar":"Land","Remote Isle":"Land","Temple of Epiphany":"Land","Accumulated Knowledge":"Instant",Brainstorm:"Instant",Dand√¢n:"Creature","Diminishing Returns":"Sorcery",Foil:"Instant","Magical Hack":"Instant","Memory Lapse":"Instant","Mental Note":"Instant","Mind Bend":"Instant",Miscalculation:"Instant","Mystic Retrieval":"Sorcery",Portent:"Sorcery","Ray of Command":"Instant","Supplant Form":"Instant","Telling Time":"Instant","Vision Charm":"Instant"};function Ao(g){if(!g||typeof g!="string")return"Other";const T=["Commander","Creature","Planeswalker","Battle","Sorcery","Instant","Artifact","Kindred","Enchantment","Land","Conspiracy","Dungeon","Emblem","Hero","Phenomenon","Plane","Scheme","Vanguard"];for(const p of T)if(g.includes(p))return p;return g.split("‚Äî")[0].trim().split(" ")[0]||"Other"}const wr=g=>{const T=g.toLowerCase();return T.includes("commander")?"/svgs/cmd.svg":T.includes("creature")?"/svgs/creature.svg":T.includes("planeswalker")?"/svgs/planeswalker.svg":T.includes("instant")?"/svgs/instant.svg":T.includes("sorcery")?"/svgs/sorcery.svg":T.includes("artifact")?"/svgs/artifact.svg":T.includes("enchantment")?"/svgs/enchantment.svg":T.includes("land")?"/svgs/land.svg":null};function go({type:g,count:T,onClick:p,isClickable:L=!1}){const z=wr(g);return s.jsxs("div",{className:`card-type-header ${L?"clickable-header":""}`,"data-type":g,onClick:p,style:{cursor:L?"pointer":"default",transition:"background-color 0.2s",display:"flex",alignItems:"center",gap:"8px"},onMouseEnter:q=>{L&&(q.target.style.backgroundColor="#f0f8ff")},onMouseLeave:q=>{L&&(q.target.style.backgroundColor="transparent")},title:L?`Click to select/deselect all ${g} cards`:void 0,children:[z&&s.jsx("img",{src:z,alt:g,style:{width:"16px",height:"16px",opacity:.8},onError:q=>{q.target.style.display="none"}}),s.jsx("span",{className:"card-type-name",children:g}),s.jsxs("span",{className:"card-type-count",children:["(",T,")"]}),L&&s.jsx("span",{style:{marginLeft:"auto",marginRight:"4px",marginTop:"2px",fontSize:"11px",color:"#666",fontWeight:"normal"},children:"click to select all"})]})}function Ir({groupBy:g,setGroupBy:T,sortBy:p,setSortBy:L,viewMode:z,setViewMode:q,hidePrices:se,setHidePrices:de,showMana:pe,setShowMana:fe}){return s.jsxs("div",{style:{background:"#fff",borderRadius:"8px",padding:"0 12px",marginBottom:"0",display:"flex",flexDirection:"column",gap:"10px"},children:[s.jsx("h3",{style:{fontSize:"14px",margin:"0 0 4px 0",padding:"0 0 4px 0",borderBottom:"1px solid #eee",fontWeight:"600",color:"#333"},children:"Display Options"}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{htmlFor:"groupBy",style:{fontSize:"12px",color:"#666"},children:"Group by:"}),s.jsxs("select",{id:"groupBy",value:g,onChange:Q=>T(Q.target.value),style:{padding:"6px 8px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:"#f9f9f9"},children:[s.jsx("option",{value:"type",children:"Card Type"}),s.jsx("option",{value:"manaValue",children:"Mana Value"}),s.jsx("option",{value:"colorIdentity",children:"Color Identity"})]})]}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{htmlFor:"sortBy",style:{fontSize:"12px",color:"#666"},children:"Sort by:"}),s.jsxs("select",{id:"sortBy",value:p,onChange:Q=>L(Q.target.value),style:{padding:"6px 8px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:"#f9f9f9",marginBottom:"12px"},children:[s.jsx("option",{value:"name-asc",children:"Name (A-Z)"}),s.jsx("option",{value:"name-desc",children:"Name (Z-A)"}),s.jsx("option",{value:"price-asc",children:"Price ($-$$$)"}),s.jsx("option",{value:"price-desc",children:"Price ($$$-$)"})]})]}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[s.jsx("label",{style:{fontSize:"12px",color:"#666"},children:"View:"}),s.jsxs("div",{style:{display:"flex",gap:"4px"},children:[s.jsx("button",{onClick:()=>q("list"),style:{padding:"6px 12px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:z==="list"?"#1976d2":"#f9f9f9",color:z==="list"?"white":"#333",cursor:"pointer",transition:"all 0.2s ease"},children:"üìã List"}),s.jsx("button",{onClick:()=>q("grid"),style:{padding:"6px 12px",fontSize:"12px",borderRadius:"4px",border:"1px solid #ccc",backgroundColor:z==="grid"?"#1976d2":"#f9f9f9",color:z==="grid"?"white":"#333",cursor:"pointer",transition:"all 0.2s ease"},children:"üñºÔ∏è Grid"})]})]}),se!==void 0&&de&&pe!==void 0&&fe&&s.jsxs("div",{style:{display:"flex",gap:"8px"},children:[s.jsx("button",{onClick:()=>de(!se),className:`toggle-button ${se?"inactive":"active"}`,children:se?"Show Prices":"Hide Prices"}),s.jsx("button",{onClick:()=>fe(!pe),className:`toggle-button ${pe?"active":"inactive"}`,children:pe?"Hide Mana":"Show Mana"})]})]})}const To=so.memo(({manaCost:g})=>{if(!g)return null;const T=g.match(/\{([^}]+)\}/g)||[];return s.jsx("span",{className:"mana-cost",children:T.map((p,L)=>{const z=p.substring(1,p.length-1).replace("/","");return s.jsx("img",{src:`/svgs/${z.toLowerCase()}.svg`,alt:p,className:"mana-symbol",onError:q=>{q.target.outerHTML=p},"data-no-qr-scan":"true",loading:"lazy"},L)})})});To.displayName="ManaCost";const Sr=g=>{var p,L;const T=(g==null?void 0:g.scryfall_json)||((p=g==null?void 0:g.card)==null?void 0:p.scryfall_json);return T!=null&&T.cmc?T.cmc:(L=g==null?void 0:g.card)!=null&&L.cmc?g.card.cmc:g!=null&&g.cmc?g.cmc:0},jr=g=>{var z,q;const T=(g==null?void 0:g.scryfall_json)||((z=g==null?void 0:g.card)==null?void 0:z.scryfall_json),p=(T==null?void 0:T.color_identity)||((q=g==null?void 0:g.card)==null?void 0:q.color_identity)||[];if(p.length===0)return"C";const L=["W","U","B","R","G"];return p.sort((se,de)=>L.indexOf(se)-L.indexOf(de)).join("")};function eo(g){if(!Array.isArray(g))return console.error("[FOREACH DEBUG] groupCardsByManaValue: cards is not an array:",typeof g,g),[];const T={};for(const p of g){if(!p)continue;const z=`${Sr(p)}`;T[z]||(T[z]=[]),T[z].push(p)}return Object.entries(T).map(([p,L])=>({type:`${p} CMC`,cards:L})).sort((p,L)=>parseInt(p.type)-parseInt(L.type))}function to(g){if(!Array.isArray(g))return console.error("[FOREACH DEBUG] groupCardsByColorIdentity: cards is not an array:",typeof g,g),[];const T={},p={C:"Colorless",W:"White",U:"Blue",B:"Black",R:"Red",G:"Green",WU:"Azorius",WB:"Orzhov",WR:"Boros",WG:"Selesnya",UB:"Dimir",UR:"Izzet",UG:"Simic",BR:"Rakdos",BG:"Golgari",RG:"Gruul",WUB:"Esper",UBR:"Grixis",BRG:"Jund",WRG:"Naya",WUG:"Bant",WBG:"Abzan",WUR:"Jeskai",UBG:"Sultai",WBR:"Mardu",URG:"Temur",WUBR:"Non-Green",UBRG:"Non-White",WBRG:"Non-Blue",WURG:"Non-Black",WUBG:"Non-Red",WUBRG:"Five-Color"},L=["C","W","U","B","R","G","WU","UB","BR","RG","WG","WB","UR","BG","WR","UG","WUG","WUB","UBR","BRG","WRG","WBG","WUR","UBG","WBR","URG","WUBR","UBRG","WBRG","WURG","WUBG","WUBRG"];for(const q of g){if(!q)continue;const se=jr(q);T[se]||(T[se]=[]),T[se].push(q)}return Object.keys(T).map(q=>({type:p[q]||q,cards:T[q],originalKey:q})).sort((q,se)=>{const de=L.indexOf(q.originalKey),pe=L.indexOf(se.originalKey);return de===-1&&pe===-1?q.originalKey.length!==se.originalKey.length?q.originalKey.length-se.originalKey.length:q.originalKey.localeCompare(se.originalKey):de===-1?1:pe===-1?-1:de-pe})}function yo(g){var T,p,L,z,q,se,de,pe,fe,Q,ye,he,$e,Xe,Qe,X,M,H,ne,n,Pe,le,it,V;if(!Array.isArray(g))return console.error("[FOREACH DEBUG] groupCardsByCollectionStatus: cards is not an array:",typeof g,g),[];console.log("[CollectionGrouping] Regrouping cards by collection status, total cards:",g.length);try{const Re=JSON.parse(localStorage.getItem("cardCollection")||"[]");console.log("[CollectionGrouping] Current collection size:",Re.length);const Ne=new Map,F=new Map;Re.forEach(oe=>{const Le=`${oe.printing_id}_${oe.foil}`;Ne.set(Le,(Ne.get(Le)||0)+oe.quantity);const lt=oe.name||oe.card_name||oe.cardName;lt&&(F.has(lt)||F.set(lt,new Set),F.get(lt).add(`${oe.printing_id}_${oe.foil}`))}),console.log("[CollectionGrouping] Card name map:",Array.from(F.keys()).slice(0,10));const Y=[],_e=[],be=[];for(const oe of g){if(!oe){be.push(oe);continue}const Le=oe.name||((T=oe.cardObj)==null?void 0:T.name)||((L=(p=oe.cardObj)==null?void 0:p.card)==null?void 0:L.name)||((z=oe.card)==null?void 0:z.name)||((de=(se=(q=oe.cardObj)==null?void 0:q.card)==null?void 0:se.scryfall_json)==null?void 0:de.name)||((pe=oe.scryfall_json)==null?void 0:pe.name),lt=oe.printing||((fe=oe.cardObj)==null?void 0:fe.printing)||((ye=(Q=oe.cardObj)==null?void 0:Q.card)==null?void 0:ye.printing)||((he=oe.card)==null?void 0:he.printing)||oe.scryfall_id||oe.id||(($e=oe.cardObj)==null?void 0:$e.scryfall_id)||((Xe=oe.cardObj)==null?void 0:Xe.id)||((X=(Qe=oe.cardObj)==null?void 0:Qe.card)==null?void 0:X.scryfall_id)||((H=(M=oe.cardObj)==null?void 0:M.card)==null?void 0:H.id),Be=oe.foil===!0||oe.isFoil===!0||((ne=oe.cardObj)==null?void 0:ne.foil)===!0||((n=oe.cardObj)==null?void 0:n.isFoil)===!0||((le=(Pe=oe.cardObj)==null?void 0:Pe.card)==null?void 0:le.foil)===!0||((V=(it=oe.cardObj)==null?void 0:it.card)==null?void 0:V.isFoil)===!0;if(!lt||!Le){console.log("[CollectionGrouping] Missing data for card:",{cardName:Le,printingId:lt,cardStructure:Object.keys(oe)}),be.push(oe);continue}console.log("[CollectionGrouping] Processing card:",{cardName:Le,printingId:lt,isFoil:Be,ownedVersions:F.get(Le)});const St=`${lt}_${Be}`;if((Ne.get(St)||0)>0)console.log("[CollectionGrouping] Exact match found for:",Le),Y.push(oe);else{const tn=F.get(Le);tn&&tn.size>0?(console.log("[CollectionGrouping] Different version owned for:",Le,"versions:",Array.from(tn)),_e.push(oe)):(console.log("[CollectionGrouping] Not owned:",Le),be.push(oe))}}const Ve=[];return Y.length>0&&Ve.push({type:"Exact Match",cards:Y}),_e.length>0&&Ve.push({type:"Different Version Owned",cards:_e}),be.length>0&&Ve.push({type:"Not Owned",cards:be}),Ve}catch(Re){return console.error("Error checking collection status:",Re),[{type:"Not Owned",cards:g}]}}const yn=(g,T,p="unknown")=>{var L;try{if(!g){console.warn(`[ULTRA SAFE] ${p}: null/undefined array`);return}if(!Array.isArray(g)){const z={type:typeof g,constructor:(L=g==null?void 0:g.constructor)==null?void 0:L.name,hasLength:"length"in g,length:g==null?void 0:g.length,keys:g&&typeof g=="object"?Object.keys(g).slice(0,3):[],isIterable:g&&typeof g[Symbol.iterator]=="function"};if(p!=="unknown"&&(z.hasLength||z.isIterable)&&console.warn(`[ULTRA SAFE] ${p}: converting non-array:`,z),g&&typeof g.length=="number"&&g.length>=0)g=Array.from(g);else if(g&&typeof g[Symbol.iterator]=="function")g=Array.from(g);else{p!=="unknown"&&console.error(`[ULTRA SAFE] ${p}: cannot convert to array:`,z);return}}for(let z=0;z<g.length;z++)try{T(g[z],z,g)}catch(q){console.error(`[ULTRA SAFE] ${p}: callback error at index ${z}:`,q)}}catch(z){console.error(`[ULTRA SAFE] ${p}: critical error:`,z)}},Er=()=>{console.log("[DEBUG] forEach debugging disabled to prevent interference")},vr=()=>{};typeof window<"u"&&(window.enableForEachDebugging=Er,window.disableForEachDebugging=vr);const Mo=g=>g?g.startsWith("https://cards.scryfall.io/")||g.startsWith("https://c1.scryfall.com/")?`http://localhost:3001/api/cards/image-proxy?url=${encodeURIComponent(g)}`:g:null,gt={Forest:"d232fcc2-12f6-401a-b1aa-ddff11cb9378",Island:"23635e40-d040-40b7-8b98-90ed362aa028",Mountain:"1edc5050-69bd-416d-b04c-7f82de2a1901",Plains:"4ef17ed4-a9b5-4b8e-b4cb-2ecb7e5898c3",Swamp:"13505c15-14e0-4200-82bd-fb9bce949e68",Wastes:"60682c00-c661-4a9d-8326-f3f014a04e3e","Snow-Covered Forest":"838c915d-8153-43c2-b513-dfbe4e9388a5","Snow-Covered Island":"6abf0692-07d1-4b72-af06-93d0e338589d","Snow-Covered Mountain":"0dc9a6d1-a1ca-4b8f-894d-71c2a9933f79","Snow-Covered Plains":"b1e3a010-dae3-41b6-8dd8-e31d14c3ac4a","Snow-Covered Swamp":"c4dacaf1-09b8-42bb-8064-990190fdaf81","Snow-Covered Wastes":"ad21a874-525e-4d11-bd8e-bc44918bec40","Basic Forest":"d232fcc2-12f6-401a-b1aa-ddff11cb9378","Basic Island":"ff0ba1cf-1b05-403e-8b5e-4bbe3cfa8a89","Basic Mountain":"b34bb2dc-c1af-4d77-b0b3-a0fb342a5fc6","Basic Plains":"8e592a1e-b5e1-497a-863d-9772d25d3b3f","Basic Swamp":"6b28e7a6-e0ed-4c45-85dd-7c1bbfe6b3e5"},ao=new Set,wn=g=>Array.isArray(g)?g.filter(T=>{var q;if(!T)return!1;const p=((q=T.card)==null?void 0:q.name)||T.name||"";return!(/^(test|example|placeholder|unknown|null|undefined|sample)/i.test(p)||p.length<=2)}):[];typeof window<"u"&&(window.getInvalidCardCacheStats=()=>(console.log(`[Invalid Card Cache] Currently tracking ${ao.size} invalid cards/combinations`),Array.from(ao)));const zn="basic-land-printing-preferences",ln=g=>{try{const p=JSON.parse(localStorage.getItem(zn)||"{}")[g],L=gt[g],z=p||L;return console.log(`üèûÔ∏è [GET PREF] ${g}: user=${p}, default=${L}, result=${z}`),z}catch(T){return console.warn("[BASIC LAND PREFS] Error reading preferences:",T),gt[g]}},kr=(g,T)=>{try{const p=JSON.parse(localStorage.getItem(zn)||"{}");p[g]=T,localStorage.setItem(zn,JSON.stringify(p)),console.log(`üèûÔ∏è [USER PREFS] Updated ${g} preferred printing to: ${T}`)}catch(p){console.error("[BASIC LAND PREFS] Error saving preferences:",p)}},$r=()=>{try{return JSON.parse(localStorage.getItem(zn)||"{}")}catch(g){return console.warn("[BASIC LAND PREFS] Error reading all preferences:",g),{}}},Pr=()=>{localStorage.removeItem(zn),console.log("üèûÔ∏è [USER PREFS] Reset all basic land preferences to defaults")};typeof window<"u"&&(window.basicLandPrefs={get:ln,set:kr,getAll:$r,reset:Pr});const no=["Commander","Planeswalker","Battle","Creature","Sorcery","Instant","Artifact","Kindred","Enchantment","Land","Conspiracy","Dungeon","Emblem","Hero","Phenomenon","Plane","Scheme","Vanguard","Other"];window.__hoveredCardName=null;function pn(g,T=[]){var se,de,pe,fe,Q,ye,he,$e,Xe,Qe,X;const p={};if(!Array.isArray(g))return[];for(const M of g){let H,ne;if(M){if(M&&typeof M=="object"){if(M.card&&typeof M.card=="object")if(H=((se=M.card)==null?void 0:se.name)||M.name,M.isCommander||(de=M.card)!=null&&de.isCommander||H&&T.includes(H.toLowerCase()))ne="Commander";else try{const n=((pe=M.card)==null?void 0:pe.type_line)||M.type_line||((fe=M.scryfallCard)==null?void 0:fe.type_line)||((Q=M.scryfall_json)==null?void 0:Q.type_line)||((he=(ye=M.card)==null?void 0:ye.scryfallCard)==null?void 0:he.type_line)||((Xe=($e=M.card)==null?void 0:$e.scryfall_json)==null?void 0:Xe.type_line);ne=H&&po[H]||n&&Ao(n)||"Other"}catch(n){console.error("Error getting card type for:",M,n),ne="Other"}else if(M.name)if(H=M.name,M.isCommander||H&&T.includes(H.toLowerCase()))ne="Commander";else try{const n=M.type_line||((Qe=M.scryfallCard)==null?void 0:Qe.type_line)||((X=M.scryfall_json)==null?void 0:X.type_line);ne=H&&po[H]||n&&Ao(n)||"Other"}catch(n){console.error("Error getting card type for direct card object:",M,n),ne="Other"}}else typeof M=="string"&&(H=M,H&&T.includes(H.toLowerCase())?ne="Commander":ne=H&&po[H]||"Other");H&&(p[ne]||(p[ne]=[]),p[ne].push(M))}}yn(Object.keys(p),M=>{const H=p[M];if(!Array.isArray(H)){console.error("[FOREACH DEBUG] cardsInType is not an array in groupCardsByType:",typeof H,H,"Type:",M),p[M]=[];return}const ne={};try{yn(H,n=>{var Ne,F,Y,_e,be,Ve,oe,Le,lt;const Pe=((Ne=n.card)==null?void 0:Ne.name)||n.name,le=n.printing||((F=n.card)==null?void 0:F.printing)||((Y=n.scryfall_json)==null?void 0:Y.id)||((be=(_e=n.card)==null?void 0:_e.scryfall_json)==null?void 0:be.id)||((oe=(Ve=n.cardObj)==null?void 0:Ve.scryfall_json)==null?void 0:oe.id)||((Le=n.cardObj)==null?void 0:Le.printing)||null,it=n.foil||((lt=n.card)==null?void 0:lt.foil)||!1,V=`${Pe}-${le}-${it}`;ne[V]||(ne[V]={name:Pe,count:0,printing:le,cardObj:n,foil:it});const Re=n.count||n.quantity||1;ne[V].count+=Re})}catch(n){throw console.error("[DEBUG] Error in consolidation for type",M,":",n),console.error("[DEBUG] Cards in type:",H),n}p[M]=Object.values(ne).sort((n,Pe)=>{const le=(n.name||"").toLowerCase(),it=(Pe.name||"").toLowerCase();return le.localeCompare(it)})});const L=[],z=Object.keys(p);let q=[];if(no&&no.length>0){q=no.filter(H=>z.includes(H));const M=z.filter(H=>!no.includes(H)).sort();q=q.concat(M)}else q=z.sort();for(const M of q){const H=p[M];L.push({type:M,cards:H})}return L}function gn(g){var se,de,pe,fe,Q,ye,he,$e,Xe,Qe,X,M,H,ne,n,Pe,le,it,V,Re,Ne;if(!g)return[];let T=Array.isArray(g.cards)?[...g.cards]:[];T=wn(T),Math.random()<.05&&console.log(`[DEBUG] ensureCommanderInCards filtered to ${T.length} cards`);let p=[];if(g.commander&&Array.isArray(g.commander)&&g.commander.length>0?p=g.commander.filter(F=>F!=null):g.commander&&typeof g.commander=="object"&&g.commander!==null&&!Array.isArray(g.commander)?p=[g.commander]:typeof g.commander=="string"&&g.commander.trim()&&(p=[g.commander]),g.commanderNames&&Array.isArray(g.commanderNames)&&g.commanderNames.length>0){const F=g.commanderNames.filter(Y=>typeof Y=="string"&&Y.trim());p=p.concat(F)}if(p.length===0)return T;const L=p.map(F=>{var _e;const Y=((_e=F.card)==null?void 0:_e.name)||F.name||F;return typeof Y=="string"?Y.toLowerCase():""}).filter(F=>F),z=new Set,q=T.filter(F=>{var _e;if(!F)return!1;const Y=(((_e=F.card)==null?void 0:_e.name)||F.name||"").toLowerCase();return L.includes(Y)?z.has(Y)?!1:(z.add(Y),!0):!0});for(const F of p){if(!F)continue;const Y=(((se=F.card)==null?void 0:se.name)||F.name||F).toLowerCase();if(Y&&!q.some(_e=>{var be;return(((be=_e.card)==null?void 0:be.name)||_e.name||"").toLowerCase()===Y}))if(typeof F=="object"&&F!==null){const _e={card:F};let be=null;F.cmc!==void 0?be=F.cmc:((de=F.card)==null?void 0:de.cmc)!==void 0?be=(pe=F.card)==null?void 0:pe.cmc:((fe=F.scryfall_json)==null?void 0:fe.cmc)!==void 0?be=F.scryfall_json.cmc:((ye=(Q=F.card)==null?void 0:Q.scryfall_json)==null?void 0:ye.cmc)!==void 0&&(be=($e=(he=F.card)==null?void 0:he.scryfall_json)==null?void 0:$e.cmc),be!==null&&(_e.card&&(_e.card.cmc=be),_e.cmc=be);let Ve=null;((Xe=F.prices)==null?void 0:Xe.usd)!==void 0?Ve=F.prices.usd:((X=(Qe=F.card)==null?void 0:Qe.prices)==null?void 0:X.usd)!==void 0?Ve=(H=(M=F.card)==null?void 0:M.prices)==null?void 0:H.usd:((n=(ne=F.scryfall_json)==null?void 0:ne.prices)==null?void 0:n.usd)!==void 0?Ve=F.scryfall_json.prices.usd:((it=(le=(Pe=F.card)==null?void 0:Pe.scryfall_json)==null?void 0:le.prices)==null?void 0:it.usd)!==void 0?Ve=(Ne=(Re=(V=F.card)==null?void 0:V.scryfall_json)==null?void 0:Re.prices)==null?void 0:Ne.usd:F.price&&(Ve=F.price),Ve!==null&&(_e.card&&!_e.card.prices&&(_e.card.prices={}),_e.prices||(_e.prices={}),_e.card&&(_e.card.prices.usd=Ve),_e.prices.usd=Ve),F.printings&&F.printings.length>0&&!_e.printing&&(_e.printing=F.printings[0]),q.unshift(_e)}else typeof F=="string"&&q.unshift({name:F})}return q}const Nr=(g,T)=>{if(!Array.isArray(g)){console.error("[FOREACH DEBUG] preloadCardImages: cards is not an array:",typeof g,g);return}const p=new Map;yn(g,L=>{if(!L)return;const z=L.card||L,q=(z==null?void 0:z.name)||L.name;if(!q)return;const se=L.printing||q;p.has(se)||p.set(se,z)}),yn(Array.from(p),([L,z])=>{if(T.has(L))return;let q;z.set&&z.collector_number?q=`https://api.scryfall.com/cards/${z.set.toLowerCase()}/${z.collector_number}?format=image&version=png`:gt[z.name]?q=`https://api.scryfall.com/cards/${gt[z.name]}?format=image&version=png`:q=`https://api.scryfall.com/cards/named?format=image&version=png&exact=${encodeURIComponent(z.name)}`;const se=new Image;se.src=q,T.set(L,q)})},Vt=g=>{var p,L;const T=ho(g,{preferStoredPrice:!0,fallbackPrice:null,debugLogging:!1,forceNonFoil:!g.foil});return{price:T.price,source:T.source,cardType:T.cardType,isFoil:T.metadata.isFoil||!1,isEtched:T.cardType==="etched",isPromo:((p=T.metadata.finishes)==null?void 0:p.includes("promo"))||!1,isSpecialFinish:T.cardType==="special_foil",isDigital:((L=T.metadata.finishes)==null?void 0:L.includes("digital"))||!1}};function Ar({x:g,y:T,cardObj:p,onCopyScryfallLink:L,onClose:z,onUseForDeckImage:q,onAddToWishlist:se,onAddToCollection:de,onRemoveFromDeck:pe,onAddToSideboard:fe,onAddToTechIdeas:Q,onMoveToMainDeck:ye,onMoveFromSideboardToTechIdeas:he,onMoveFromTechIdeasToSideboard:$e,onRemoveFromSideboard:Xe,onRemoveFromTechIdeas:Qe}){const X=so.useRef(null);so.useEffect(()=>{X.current&&X.current.focus()},[]);const M={position:"fixed",top:Math.min(T,window.innerHeight-250),left:Math.min(g,window.innerWidth-200),background:"#fff",border:"1px solid #ccc",borderRadius:6,boxShadow:"0 2px 8px rgba(0,0,0,0.15)",zIndex:1e4,minWidth:180,padding:"4px 0",maxHeight:"200px",overflow:"auto"},H={display:"block",width:"100%",background:"none",border:"none",textAlign:"left",padding:"8px 16px",fontSize:15,fontWeight:500,color:"#222",cursor:"pointer",transition:"background 0.15s"},ne=n=>{n(),z()};return s.jsxs("div",{ref:X,tabIndex:-1,style:M,onContextMenu:n=>n.preventDefault(),onKeyDown:n=>{n.key==="Escape"&&z()},children:[s.jsx("button",{style:H,onClick:()=>ne(q),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Use for Deck Image"}),s.jsx("button",{style:H,onClick:()=>ne(se),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Wishlist"}),s.jsx("button",{style:H,onClick:()=>ne(de),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Collection"}),(p==null?void 0:p.section)==="sideboard"?s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(ye),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Main Deck"}),s.jsx("button",{style:H,onClick:()=>ne(he),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Tech Ideas"})]}):(p==null?void 0:p.section)==="techIdeas"?s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(ye),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Main Deck"}),s.jsx("button",{style:H,onClick:()=>ne($e),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Move to Sideboard"})]}):s.jsxs(s.Fragment,{children:[s.jsx("button",{style:H,onClick:()=>ne(fe),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Sideboard"}),s.jsx("button",{style:H,onClick:()=>ne(Q),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Add to Tech Ideas"})]}),s.jsx("button",{style:H,onClick:()=>ne(L),onMouseOver:n=>n.currentTarget.style.background="#e0e0e0",onMouseOut:n=>n.currentTarget.style.background="none",children:"Copy Scryfall Link"}),s.jsx("hr",{style:{margin:"4px 0",border:"0",borderTop:"1px solid #eee"}}),(p==null?void 0:p.section)==="sideboard"?s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(Xe),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Sideboard"}):(p==null?void 0:p.section)==="techIdeas"?s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(Qe),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Tech Ideas"}):s.jsx("button",{style:{...H,color:"#dc3545"},onClick:()=>ne(pe),onMouseOver:n=>n.currentTarget.style.background="#fff5f5",onMouseOut:n=>n.currentTarget.style.background="none",children:"Remove from Deck"})]})}const Fo=({size:g=12,color:T="#1976d2"})=>s.jsx("svg",{version:"1.1",xmlns:"http://www.w3.org/2000/svg",width:g,height:g*(32/23),viewBox:"0 0 23 32",style:{display:"inline-block",verticalAlign:"middle"},children:s.jsx("path",{fill:T,d:"M18.486 28.106c0 1.581-1.282 2.863-2.863 2.863h-12.762c-1.581 0-2.863-1.282-2.863-2.863v-20.157c0-1.581 1.282-2.863 2.863-2.863h2.028v-1.193c0-1.581 1.282-2.863 2.863-2.863h12.762c1.581 0 2.863 1.282 2.863 2.863v20.157c0 1.581-1.282 2.863-2.863 2.863h-2.028v1.193zM15.623 6.995h-12.762c-0.527 0-0.954 0.427-0.954 0.954v20.157c0 0.527 0.427 0.954 0.954 0.954h12.762c0.527 0 0.954-0.427 0.954-0.954v-20.157c0-0.527-0.427-0.954-0.954-0.954zM18.486 25.005h2.028c0.527 0 0.954-0.427 0.954-0.954v-20.157c0-0.527-0.427-0.954-0.954-0.954h-12.762c-0.527 0-0.954 0.427-0.954 0.954v1.193h8.826c1.581 0 2.863 1.282 2.863 2.863v17.056z"})}),ro=R.memo(({cardData:g,isFoil:T,price:p,index:L,onMouseEnter:z,onClick:q,onContextMenu:se,showMana:de,hidePrices:pe,isExplicitlyFoil:fe,bulkEditMode:Q,isSelected:ye,onToggleSelection:he,customButtons:$e,setFixedPreview:Xe,deckFlipStates:Qe,setDeckFlipStates:X})=>{var Ve,oe,Le,lt,Be,St,en,tn,Sn,hn,$t,_t,Fe,dn,xt,nn,Ht;const M=`${g.name}-${g.printing||((Ve=g.cardObj)==null?void 0:Ve.scryfall_id)||"default"}`,H=Qe.get(M)||!1,ne=R.useMemo(()=>pe?"not-owned":xo(g),[g,pe]),n=((lt=(Le=(oe=g.cardObj)==null?void 0:oe.card)==null?void 0:Le.scryfall_json)==null?void 0:lt.card_faces)||((St=(Be=g.cardObj)==null?void 0:Be.scryfall_json)==null?void 0:St.card_faces)||((tn=(en=g.cardObj)==null?void 0:en.card)==null?void 0:tn.card_faces)||((Sn=g.cardObj)==null?void 0:Sn.card_faces),Pe=((_t=($t=(hn=g.cardObj)==null?void 0:hn.card)==null?void 0:$t.scryfall_json)==null?void 0:_t.layout)||((dn=(Fe=g.cardObj)==null?void 0:Fe.scryfall_json)==null?void 0:dn.layout)||((nn=(xt=g.cardObj)==null?void 0:xt.card)==null?void 0:nn.layout)||((Ht=g.cardObj)==null?void 0:Ht.layout),le=Pe==="transform"||Pe==="modal_dfc"||Pe==="reversible_card",it=n&&Array.isArray(n)&&n.length>=2||le,V=()=>{var jt;return!it||!n?g.name:((jt=n[H?1:0])==null?void 0:jt.name)||g.name},Ne=(()=>{var ut,jt,qt,Ot,on,jn,rn,Kt,ze,Xt,_n,fn,Qt,un,bt,sn;if(it&&n&&Array.isArray(n)){const Se=n[0];return Se!=null&&Se.mana_cost?Se.mana_cost:((qt=(jt=(ut=g.cardObj)==null?void 0:ut.card)==null?void 0:jt.scryfall_json)==null?void 0:qt.mana_cost)||((on=(Ot=g.cardObj)==null?void 0:Ot.scryfall_json)==null?void 0:on.mana_cost)||((rn=(jn=g.cardObj)==null?void 0:jn.card)==null?void 0:rn.mana_cost)||((Kt=g.cardObj)==null?void 0:Kt.mana_cost)||""}return((_n=(Xt=(ze=g.cardObj)==null?void 0:ze.card)==null?void 0:Xt.scryfall_json)==null?void 0:_n.mana_cost)||((Qt=(fn=g.cardObj)==null?void 0:fn.scryfall_json)==null?void 0:Qt.mana_cost)||((bt=(un=g.cardObj)==null?void 0:un.card)==null?void 0:bt.mana_cost)||((sn=g.cardObj)==null?void 0:sn.mana_cost)||""})(),F=g.name.split("").reduce((ut,jt)=>(ut=(ut<<5)-ut+jt.charCodeAt(0),ut&ut),0),Y=`${-(Math.abs(F)%8)}s`,_e=ut=>{Q?(ut.preventDefault(),ut.stopPropagation(),he()):q()},be=ut=>{ut.preventDefault(),ut.stopPropagation();const jt=!H;X(qt=>{const Ot=new Map(qt);return Ot.set(M,jt),Ot}),Xe&&Xe(qt=>({...qt,flipState:jt}))};return s.jsxs("div",{className:`deck-card-row ${Q?"bulk-edit-mode":""} ${Q&&ye?"bulk-selected":""}`,onMouseEnter:z,onClick:_e,onContextMenu:se,children:[Q&&s.jsx("input",{type:"checkbox",checked:ye,onChange:he,onClick:ut=>ut.stopPropagation(),className:"bulk-edit-checkbox",style:{cursor:"pointer",marginRight:"3px"}}),s.jsx("span",{className:"card-count",style:{marginLeft:"4px"},children:`${g.count||g.quantity||1} -`}),s.jsxs("span",{className:`card-name ${fe?"foil-active-text":""}`,style:fe?{animationDelay:Y}:{},children:[V(),it&&s.jsx("span",{onClick:be,style:{marginLeft:"6px",cursor:"pointer",userSelect:"none",display:"inline-flex",alignItems:"center",verticalAlign:"middle"},title:`Flip to ${H?"front":"back"} face`,children:s.jsx(Fo,{size:10,color:"#1976d2"})})]}),s.jsxs("span",{className:"card-right-group",children:[de&&s.jsx(s.Fragment,{children:Ne?s.jsx("span",{className:"card-mana-column",children:s.jsx(To,{manaCost:Ne})}):s.jsx("span",{className:"card-mana-column"})}),!pe&&s.jsx("span",{className:`card-price ${fe?"foil-price":""} ${!p&&gt[g.name]?"basic-land-price":""}`,title:`${fe?"Foil":"Non-foil"} price`,children:Bn(p)}),!pe&&s.jsx("span",{style:{width:"16px",minWidth:"16px",display:"inline-flex",justifyContent:"center",alignItems:"center",flexShrink:0},children:ne==="exact-match"?s.jsx("span",{style:{color:"#22c55e",fontSize:"14px"},title:"In collection (exact match)",children:"‚óè"}):ne==="different-version"?s.jsx("span",{style:{color:"#eab308",fontSize:"14px"},title:"In collection (different printing)",children:"‚óè"}):s.jsx("span",{style:{color:"#ef4444",fontSize:"14px"},title:"Not in collection",children:"‚óè"})})]}),$e&&s.jsx("span",{className:"custom-buttons",style:{marginLeft:"0.5rem"},children:$e})]},`${g.name}-${g.printing||""}-${g.count}-${fe?"foil":"nonfoil"}-${p||"na"}-${L}`)});ro.displayName="DeckCardRow";let oo=null,Ro=0;const Rr=3e4,Tr=()=>{const g=Date.now();if(oo&&g-Ro<Rr)return oo;try{const T=In.getChunkedItem("cardCollection");let p=[];if(T&&typeof T=="object"){if(Array.isArray(T))p=T;else if(T.data)try{p=JSON.parse(T.data)}catch(q){console.warn("[COLLECTION] Failed to parse collection data:",q),p=[]}}Array.isArray(p)||(console.warn("[COLLECTION] Collection data is not an array:",typeof p),p=[]);const L=new Map,z=new Map;return yn(p,q=>{const se=`${q.printing_id}_${q.foil}`;L.set(se,(L.get(se)||0)+q.quantity);const de=q.name||q.card_name||q.cardName;de&&(z.has(de)||z.set(de,new Set),z.get(de).add(`${q.printing_id}_${q.foil}`))},"collection-cache-build"),oo={collectionMap:L,cardNameMap:z},Ro=g,oo}catch(T){return console.error("[COLLECTION] Error loading collection:",T),{collectionMap:new Map,cardNameMap:new Map}}},xo=g=>{var T,p,L,z,q,se,de,pe,fe,Q,ye,he,$e,Xe,Qe,X,M,H,ne,n,Pe,le,it,V;try{const{collectionMap:Re,cardNameMap:Ne}=Tr(),F=g.name||((T=g.cardObj)==null?void 0:T.name)||((L=(p=g.cardObj)==null?void 0:p.card)==null?void 0:L.name)||((z=g.card)==null?void 0:z.name)||((de=(se=(q=g.cardObj)==null?void 0:q.card)==null?void 0:se.scryfall_json)==null?void 0:de.name)||((pe=g.scryfall_json)==null?void 0:pe.name),Y=g.printing||((fe=g.cardObj)==null?void 0:fe.printing)||((ye=(Q=g.cardObj)==null?void 0:Q.card)==null?void 0:ye.printing)||((he=g.card)==null?void 0:he.printing)||g.scryfall_id||g.id||(($e=g.cardObj)==null?void 0:$e.scryfall_id)||((Xe=g.cardObj)==null?void 0:Xe.id)||((X=(Qe=g.cardObj)==null?void 0:Qe.card)==null?void 0:X.scryfall_id)||((H=(M=g.cardObj)==null?void 0:M.card)==null?void 0:H.id),_e=g.foil===!0||g.isFoil===!0||((ne=g.cardObj)==null?void 0:ne.foil)===!0||((n=g.cardObj)==null?void 0:n.isFoil)===!0||((le=(Pe=g.cardObj)==null?void 0:Pe.card)==null?void 0:le.foil)===!0||((V=(it=g.cardObj)==null?void 0:it.card)==null?void 0:V.isFoil)===!0;if(!Y||!F)return"not-owned";const be=`${Y}_${_e}`;if((Re.get(be)||0)>0)return"exact-match";{const oe=Ne.get(F);return oe&&oe.size>0?"different-version":"not-owned"}}catch(Re){return console.error("Error checking collection status:",Re),"not-owned"}},Oo=R.memo(({cardData:g,isExplicitlyFoil:T,price:p,onMouseEnter:L,onClick:z,onContextMenu:q,bulkEditMode:se,isSelected:de,onToggleSelection:pe,deckFlipStates:fe,setDeckFlipStates:Q})=>{var X;const ye=`${g.name}-${g.printing||((X=g.cardObj)==null?void 0:X.scryfall_id)||"default"}`;fe.get(ye);const he=xo(g),Xe=(()=>{var ne,n,Pe,le,it,V,Re,Ne,F,Y,_e,be,Ve,oe,Le,lt;const M=g.cardObj||g;let H=null;if((Pe=(n=(ne=M==null?void 0:M.card)==null?void 0:ne.scryfall_json)==null?void 0:n.image_uris)!=null&&Pe.normal)H=M.card.scryfall_json.image_uris.normal;else if((it=(le=M==null?void 0:M.scryfall_json)==null?void 0:le.image_uris)!=null&&it.normal)H=M.scryfall_json.image_uris.normal;else if((Re=(V=M==null?void 0:M.card)==null?void 0:V.image_uris)!=null&&Re.normal)H=M.card.image_uris.normal;else if((Ne=M==null?void 0:M.image_uris)!=null&&Ne.normal)H=M.image_uris.normal;else if((_e=(Y=(F=M==null?void 0:M.card)==null?void 0:F.scryfall_json)==null?void 0:Y.image_uris)!=null&&_e.small)H=M.card.scryfall_json.image_uris.small;else if((Ve=(be=M==null?void 0:M.scryfall_json)==null?void 0:be.image_uris)!=null&&Ve.small)H=M.scryfall_json.image_uris.small;else{const Be=((Le=(oe=M==null?void 0:M.card)==null?void 0:oe.scryfall_json)==null?void 0:Le.id)||((lt=M==null?void 0:M.scryfall_json)==null?void 0:lt.id)||(M==null?void 0:M.scryfall_id)||(M==null?void 0:M.id);Be&&(H=`https://cards.scryfall.io/normal/front/${Be.substr(0,1)}/${Be.substr(1,1)}/${Be}.jpg`)}return Mo(H)})(),Qe=g.count||g.quantity||1;return s.jsxs("div",{className:"grid-card",style:{position:"relative",aspectRatio:"5/7",width:"150px",borderRadius:"8px",overflow:"hidden",backgroundColor:"#f0f0f0",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:de?"0 0 0 3px #1976d2":"0 2px 4px rgba(0,0,0,0.1)",opacity:se&&!de?.7:1},onMouseEnter:M=>{se||(M.currentTarget.style.transform="scale(1.05)",M.currentTarget.style.boxShadow=de?"0 0 0 3px #1976d2":"0 4px 8px rgba(0,0,0,0.2)"),L&&L()},onMouseLeave:M=>{se||(M.currentTarget.style.transform="scale(1)",M.currentTarget.style.boxShadow=de?"0 0 0 3px #1976d2":"0 2px 4px rgba(0,0,0,0.1)")},onClick:M=>{se?(M.preventDefault(),M.stopPropagation(),pe&&pe()):z&&z(M)},onContextMenu:q,children:[Xe?s.jsx("img",{src:Xe,alt:g.name,style:{width:"100%",height:"100%",objectFit:"cover"},onError:M=>{M.target.style.display="none",M.target.nextSibling.style.display="flex"}}):null,s.jsxs("div",{style:{display:Xe?"none":"flex",width:"100%",height:"100%",alignItems:"center",justifyContent:"center",backgroundColor:"#e0e0e0",color:"#666",fontSize:"12px",textAlign:"center",padding:"8px",flexDirection:"column",gap:"4px"},children:[s.jsx("div",{style:{fontWeight:"bold",lineHeight:"1.2"},children:g.name}),s.jsx("div",{style:{fontSize:"10px",opacity:.7},children:"No Image"})]}),Qe>1&&s.jsx("div",{style:{position:"absolute",top:"6px",left:"6px",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"white",borderRadius:"12px",padding:"2px 8px",fontSize:"12px",fontWeight:"bold",minWidth:"20px",textAlign:"center"},children:Qe}),T&&s.jsx("div",{style:{position:"absolute",top:"6px",right:"6px",width:"18px",height:"18px",background:"linear-gradient(125deg, #ff0000, #ffa500, #ffff00, #00ff00, #0000ff, #ee82ee)",backgroundSize:"400% 400%",borderRadius:"50%",border:"1px solid rgba(255, 255, 255, 0.8)",opacity:1,pointerEvents:"none",zIndex:2,animation:"rainbow-shift 3s linear infinite",willChange:"transform, filter"}}),(()=>{const M=()=>he==="exact-match"?"#22c55e":he==="different-version"?"#eab308":"#ef4444",H=()=>he==="exact-match"?"In collection (exact match)":he==="different-version"?"In collection (different printing)":"Not in collection";return s.jsx("div",{style:{position:"absolute",top:"6px",right:T?"32px":"6px",color:M(),fontSize:"18px",lineHeight:"1",display:"flex",alignItems:"center",justifyContent:"center",width:"18px",height:"18px"},title:H(),children:"‚óè"})})(),p&&s.jsxs("div",{style:{position:"absolute",bottom:"6px",left:"6px",backgroundColor:"rgba(0, 0, 0, 0.85)",color:"white",borderRadius:"6px",padding:"2px 6px",fontSize:"11px",fontWeight:"bold",boxShadow:"0 1px 3px rgba(0,0,0,0.3)"},children:["$",p]}),se&&s.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"30px",height:"30px",borderRadius:"50%",backgroundColor:de?"#1976d2":"rgba(255, 255, 255, 0.9)",border:de?"none":"2px solid #1976d2",display:"flex",alignItems:"center",justifyContent:"center",color:de?"white":"#1976d2",fontSize:"16px",fontWeight:"bold",boxShadow:"0 2px 8px rgba(0,0,0,0.3)",zIndex:10},children:de?"‚úì":""})]})});Oo.displayName="GridCard";let an=0;function Lr({isPublic:g=!1}){if(an++,an%100===0&&console.warn(`[PERFORMANCE] DeckViewEdit has re-rendered ${an} times! Possible render loop.`),an>150)return console.error(`[EMERGENCY] DeckViewEdit has re-rendered ${an} times! Activating circuit breaker.`),an=0,s.jsxs("div",{style:{padding:"20px",border:"2px solid red",margin:"20px"},children:[s.jsx("h3",{children:"üö® Render Loop Detected"}),s.jsxs("p",{children:["The deck editor encountered a render loop ($",an," renders) and was stopped to prevent crashes."]}),s.jsx("p",{children:"This usually happens when adding cards triggers excessive re-renders."}),s.jsx("button",{onClick:()=>window.location.reload(),children:"Refresh Page"}),s.jsx("button",{onClick:()=>{an=0,window.location.reload()},children:"Reset & Refresh"})]});const{id:T}=gr(),[p,L]=R.useState({isOpen:!1,cardObj:null}),[z,q]=R.useState({isActive:!1,searchResults:[],currentIndex:-1}),[se,de]=R.useState(new Set),pe=R.useRef(!0),fe=R.useRef(!1),Q=R.useRef(null),ye=R.useRef(new Map),he=R.useRef(new Map),$e=R.useRef(0),Xe=R.useRef(new Map),Qe=yr(),[X,M]=R.useState(g),[H,ne]=R.useState({isOpen:!1,cardName:null,activeComponentId:null,cardObj:null}),[n,Pe]=R.useState(null),le=R.useCallback(e=>{var a,o;const t=new Error().stack;if(typeof e=="function")return Pe(r=>{var i,c;const l=e(r);return l&&r&&r.commander&&!l.commander?(console.log("[DEBUG] setDeck function update preserved commander data:",{originalCommander:r.commander,originalCommanderNames:r.commanderNames,stackTrace:((i=t==null?void 0:t.split(`
`)[2])==null?void 0:i.trim())||"Unknown"}),{...l,commander:r.commander,commanderNames:r.commanderNames}):($e.current%100===0&&console.log("[DEBUG] setDeck function update called from:",{hasCommander:(l==null?void 0:l.commander)!==void 0,stackTrace:((c=t==null?void 0:t.split(`
`)[2])==null?void 0:c.trim())||"Unknown"}),l)});{let r=e;return r&&n&&n.commander&&!r.commander&&(console.log("[DEBUG] setDeck direct value preserved commander data:",{originalCommander:n.commander,originalCommanderNames:n.commanderNames,newDeckId:r._id,stackTrace:((a=t==null?void 0:t.split(`
`)[2])==null?void 0:a.trim())||"Unknown"}),r={...r,commander:n.commander,commanderNames:n.commanderNames}),$e.current%100===0&&console.log("[DEBUG] setDeck direct value called from:",{hasCommander:(r==null?void 0:r.commander)!==void 0,stackTrace:((o=t==null?void 0:t.split(`
`)[2])==null?void 0:o.trim())||"Unknown"}),Pe(r)}},[Pe,n]),[it,V]=R.useState(!1),[Re,Ne]=R.useState(""),[F,Y]=R.useState([]),[_e,be]=R.useState(!0),[Ve,oe]=R.useState(!0),[Le,lt]=R.useState(0),[Be,St]=R.useState({card:null}),[en,tn]=R.useState([]),[Sn,hn]=R.useState(!1),[$t,_t]=R.useState(""),[Fe,dn]=R.useState("type"),[xt,nn]=R.useState("name-asc"),[Ht,ut]=R.useState(!1),[jt,qt]=R.useState(!0),[Ot,on]=R.useState("list"),[jn,rn]=R.useState(0),Kt=R.useRef(new Map),ze=e=>{var l,i,c,_,u,C;const t=((l=e.card)==null?void 0:l.name)||e.name,a=e.printing||((i=e.cardObj)==null?void 0:i.printing),o=e.foil===!0||((c=e.card)==null?void 0:c.foil)===!0||((_=e.cardObj)==null?void 0:_.foil)===!0||((C=(u=e.cardObj)==null?void 0:u.card)==null?void 0:C.foil)===!0;return`${t}_${a||"unknown"}_${o}`},Xt=e=>{const t=ze(e);Rt(a=>{const o=new Set(a);return o.has(t)?o.delete(t):o.add(t),o})};R.useEffect(()=>{he.current.clear(),console.log("[PRICE CACHE] Cleared cache due to deck change")},[n==null?void 0:n._id]);const[_n,fn]=R.useState(!1);R.useEffect(()=>{if(!n||!F||F.length===0)return;const e=setTimeout(async()=>{console.log("[PRICE CACHE] Starting async price loading...");const t=F.slice(0,20);for(const o of t)try{await getCardPrice(o)}catch{}fn(!0),console.log("[PRICE CACHE] Initial price loading complete");const a=F.slice(20);setTimeout(async()=>{for(const o of a)try{await getCardPrice(o)}catch{}console.log("[PRICE CACHE] Background price loading complete")},1e3)},500);return()=>clearTimeout(e)},[n==null?void 0:n._id,F==null?void 0:F.length]),R.useEffect(()=>{$e.current%20===0&&console.log("[DEBUG] Deck state changed:",{deckExists:!!n,deckId:n==null?void 0:n._id,hasCommander:!!(n!=null&&n.commander)})},[n]);const Qt=R.useCallback(e=>{const t=a=>{const o=Array.from(Kt.current.values());if(o.length>0){const r=new Set(o.map(c=>{var _;return c.name||((_=c.card)==null?void 0:_.name)})),i=[...a.filter(c=>{var u;const _=c.name||((u=c.card)==null?void 0:u.name);return!r.has(_)}),...o];return wn(i)}return wn(a)};Y(typeof e=="function"?a=>t(e(a)):t(e))},[]),un=R.useCallback(async()=>{var e,t;if(!(!n||!n._id))try{const a=localStorage.getItem("token"),o="";if(!a)return;const r=await fetch(`${o}/api/decks/${n._id}`,{method:"GET",headers:{Authorization:`Bearer ${a}`},credentials:"include"});if(r.ok){const l=await r.json(),i=((e=l.cards)==null?void 0:e.length)||0,c=(F==null?void 0:F.length)||0,_=Array.from(Kt.current.entries());for(const[f,m]of _)((t=l.cards)==null?void 0:t.some(x=>{var h;return(x.name||((h=x.card)==null?void 0:h.name))===f}))?Kt.current.delete(f):P.warning(`${f} may not be properly saved to database. Please try moving it again.`,{duration:8e3});const u=F||[],C=(l.cards||[]).map(f=>{var x,h,j;const m=f.name||((x=f.card)==null?void 0:x.name),I=u.find($=>{var N;return($.name||((N=$.card)==null?void 0:N.name))===m});if(I){let $={...f};return I.modalPrice&&!f.modalPrice&&($.modalPrice=I.modalPrice),I.type_line&&!f.type_line&&($.type_line=I.type_line),(h=I.card)!=null&&h.type_line&&$.card&&typeof $.card=="object"&&!$.card.type_line&&($.card.type_line=I.card.type_line),I.scryfall_json&&!f.scryfall_json&&($.scryfall_json=I.scryfall_json),(j=I.card)!=null&&j.scryfall_json&&$.card&&typeof $.card=="object"&&!$.card.scryfall_json&&($.card.scryfall_json=I.card.scryfall_json),$}return f}),d=(l.sideboard||[]).map(f=>{var h,j,$,S,N,E,v,W,U,A;const m=f.name||((h=f.card)==null?void 0:h.name),I=(j=n==null?void 0:n.sideboard)==null?void 0:j.find(D=>{var y;return(D.name||((y=D.card)==null?void 0:y.name))===m});if(I){let D={...f};return I.modalPrice&&!f.modalPrice&&(D.modalPrice=I.modalPrice),I.cardObj&&!f.cardObj&&(D.cardObj=I.cardObj),I.type_line&&!f.type_line&&(D.type_line=I.type_line),($=I.card)!=null&&$.type_line&&D.card&&typeof D.card=="object"&&!D.card.type_line&&(D.card.type_line=I.card.type_line),I.scryfall_json&&!f.scryfall_json&&(D.scryfall_json=I.scryfall_json),(S=I.card)!=null&&S.scryfall_json&&D.card&&typeof D.card=="object"&&!D.card.scryfall_json&&(D.card.scryfall_json=I.card.scryfall_json),D}let x={...f};if(x.cardObj||(x.scryfall_json?x.cardObj={scryfall_id:x.scryfall_json.scryfall_id||x.printing,name:x.scryfall_json.name||x.name,set:x.scryfall_json.set,collector_number:x.scryfall_json.collector_number,image_uris:x.scryfall_json.image_uris,scryfall_json:x.scryfall_json}:x.cardObj={scryfall_id:x.printing,name:x.name,set:x.set||"unknown",collector_number:x.collector_number||"0",image_uris:x.image_uris||null,scryfall_json:x.scryfall_json||{name:x.name,scryfall_id:x.printing,prices:{usd:"0.25"}}}),!x.modalPrice){const D=[{source:"cardObj.scryfall_json.prices.usd",value:(v=(E=(N=x.cardObj)==null?void 0:N.scryfall_json)==null?void 0:E.prices)==null?void 0:v.usd},{source:"scryfall_json.prices.usd",value:(U=(W=x.scryfall_json)==null?void 0:W.prices)==null?void 0:U.usd},{source:"prices.usd",value:(A=x.prices)==null?void 0:A.usd},{source:"price",value:x.price}];let B=null,y="fallback";for(const G of D)if(G.value&&typeof G.value=="string"&&parseFloat(G.value)>0&&parseFloat(G.value)<1e3){B=G.value,y=G.source;break}B?x.modalPrice=B:x.modalPrice="0.25"}return x}),k=(l.techIdeas||[]).map(f=>{var N,E,v,W,U,A,D,B,y,G,O,b,te,re,ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Ke,Ie,De,ge,ue;const m=f.name||((N=f.card)==null?void 0:N.name),I=Date.now(),x=window.techIdeasProcessing||{},h=`${m}_${f._id||f.card}`;if(x[h]&&I-x[h]<5e3){const ee=(E=window.fixedTechIdeasCache)==null?void 0:E.get(m);if(ee&&Date.now()-ee.fixedAt<3e5&&(f.card=ee.card,ee.modalPrice)){const xe=parseFloat(ee.modalPrice.toString().replace(/^\$/,""));xe>0&&xe<100?f.modalPrice=ee.modalPrice:window.fixedTechIdeasCache.delete(m)}return f}x[h]=I,window.techIdeasProcessing=x;const j=(v=window.fixedTechIdeasCache)==null?void 0:v.get(m);if(j&&Date.now()-j.fixedAt<3e5)if(f.card=j.card,j.modalPrice){const ee=parseFloat(j.modalPrice.toString().replace(/^\$/,""));if(ee>0&&ee<100)return f.modalPrice=j.modalPrice,f;window.fixedTechIdeasCache.delete(m)}else return f;if(typeof f.card!="string"&&!f.modalPrice){const ee=((A=(U=(W=f.card)==null?void 0:W.scryfall_json)==null?void 0:U.prices)==null?void 0:A.usd)||((B=(D=f.scryfall_json)==null?void 0:D.prices)==null?void 0:B.usd);ee&&(f.modalPrice=`$${ee}`,window.fixedTechIdeasCache||(window.fixedTechIdeasCache=new Map),window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:f.modalPrice,fixedAt:Date.now()}))}if(typeof f.card=="string"){const ee=f.card;let xe={};if((y=f.scryfall_json)!=null&&y.prices?xe=f.scryfall_json.prices:f.name==="In the Trenches"&&(xe={usd:"0.31"}),f.card={scryfall_id:ee,name:f.name,scryfall_json:{scryfall_id:ee,name:f.name,...Object.keys(xe).length>0&&{prices:xe}}},f.modalPrice||(f.name==="In the Trenches"?f.modalPrice="$0.31":(b=(O=(G=f.card)==null?void 0:G.scryfall_json)==null?void 0:O.prices)!=null&&b.usd&&(f.modalPrice=`$${f.card.scryfall_json.prices.usd}`)),window.fixedTechIdeasCache||(window.fixedTechIdeasCache=new Map),f.modalPrice){const Ee=parseFloat(f.modalPrice.toString().replace(/^\$/,""));Ee>0&&Ee<100?window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:f.modalPrice,fixedAt:Date.now()}):window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:null,fixedAt:Date.now()})}else window.fixedTechIdeasCache.set(f.name,{card:f.card,modalPrice:null,fixedAt:Date.now()})}const $=(te=n==null?void 0:n.techIdeas)==null?void 0:te.find(ee=>{var Ee;return(ee.name||((Ee=ee.card)==null?void 0:Ee.name))===m});if($){let ee={...f};if($.modalPrice&&!f.modalPrice&&(ee.modalPrice=$.modalPrice),$.cardObj&&!f.cardObj&&(ee.cardObj=$.cardObj),!ee.modalPrice&&!f.modalPrice){const xe=[(Ze=(ve=(re=ee.cardObj)==null?void 0:re.scryfall_json)==null?void 0:ve.prices)==null?void 0:Ze.usd,(je=(me=(ie=ee.card)==null?void 0:ie.scryfall_json)==null?void 0:me.prices)==null?void 0:je.usd,$.modalPrice];let Ee=null;for(const Ae of xe)if(Ae&&typeof Ae=="string"&&parseFloat(Ae)>0&&parseFloat(Ae)<1e3){Ee=Ae;break}Ee||(Ee="0.25"),ee.modalPrice=Ee.startsWith("$")?Ee:`$${Ee}`}return $.type_line&&!f.type_line&&(ee.type_line=$.type_line),(qe=$.card)!=null&&qe.type_line&&ee.card&&typeof ee.card=="object"&&!ee.card.type_line&&(ee.card.type_line=$.card.type_line),$.scryfall_json&&!f.scryfall_json&&(ee.scryfall_json=$.scryfall_json),(yt=$.card)!=null&&yt.scryfall_json&&ee.card&&typeof ee.card=="object"&&!ee.card.scryfall_json&&(ee.card.scryfall_json=$.card.scryfall_json),ee}let S={...f};if(S.cardObj||(S.scryfall_json?S.cardObj={scryfall_id:S.scryfall_json.scryfall_id||S.printing,name:S.scryfall_json.name||S.name,set:S.scryfall_json.set,collector_number:S.scryfall_json.collector_number,image_uris:S.scryfall_json.image_uris,scryfall_json:S.scryfall_json}:S.card&&typeof S.card=="object"?S.cardObj=S.card:S.cardObj={scryfall_id:S.printing||(typeof S.card=="string"?S.card:"unknown"),name:S.name,set:S.set||"unknown",collector_number:S.collector_number||"0",image_uris:S.image_uris||null,scryfall_json:{name:S.name,scryfall_id:S.printing,prices:{usd:"0.31"}}}),!S.modalPrice){const ee=[{source:"cardObj.scryfall_json.prices.usd",value:(ht=(ke=(Ge=S.cardObj)==null?void 0:Ge.scryfall_json)==null?void 0:ke.prices)==null?void 0:ht.usd},{source:"card.scryfall_json.prices.usd",value:(Ie=(Ke=(et=S.card)==null?void 0:et.scryfall_json)==null?void 0:Ke.prices)==null?void 0:Ie.usd},{source:"scryfall_json.prices.usd",value:(ge=(De=S.scryfall_json)==null?void 0:De.prices)==null?void 0:ge.usd},{source:"prices.usd",value:(ue=S.prices)==null?void 0:ue.usd},{source:"price",value:S.price}];let xe=null,Ee="fallback";for(const Ae of ee)if(Ae.value&&typeof Ae.value=="string"&&parseFloat(Ae.value)>0&&parseFloat(Ae.value)<1e3){xe=Ae.value,Ee=Ae.source;break}xe||(xe="0.25",Ee="conservative_fallback"),S.modalPrice=xe}return S});Qt(C),le({...l,commander:n.commander||l.commander,commanderNames:n.commanderNames||l.commanderNames,cards:C,sideboard:d,techIdeas:k,lastUpdated:Date.now(),_verificationTimestamp:Date.now()})}else console.error("Failed to fetch fresh deck data:",r.status)}catch(a){console.error("Error during consistency check:",a)}},[n,F,Qt]);R.useCallback(async e=>{var t;if(!(!n||!n._id))try{const a=localStorage.getItem("token"),o="";if(!a)return;const r=((t=n.techIdeas)==null?void 0:t.map(i=>i.name===e.name?e:i))||[e],l=await fetch(`${o}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},credentials:"include",body:JSON.stringify({...n,techIdeas:r})});l.ok||console.error("Failed to save database fix, status:",l.status)}catch(a){console.error("Error saving database fix:",a)}},[n]),R.useEffect(()=>{},[n==null?void 0:n._id,un]),R.useEffect(()=>{},[n==null?void 0:n._id,un]);const[bt,sn]=R.useState(!1),[Se,Rt]=R.useState(new Set),[nt,Dt]=R.useState([]),[Wn,Jt]=R.useState(!1),[Yt,Pt]=R.useState(!1),[w,K]=R.useState(!1),[J,Z]=R.useState(!1),[Ce,ce]=R.useState(!1),[We,we]=R.useState(!1),[ae,He]=R.useState(""),[ot,Oe]=R.useState(!1),[Ue,rt]=R.useState(-1),[Nt,Je]=R.useState(!1),[ct,Te]=R.useState([]),[Tt,It]=R.useState(!1),[Ye,mt]=R.useState(new Map),[Ct,tt]=R.useState(new Map),[Mt,pt]=R.useState(""),[Lt,dt]=R.useState("");R.useEffect(()=>{if(Nt){const e=window.scrollY;return document.body.style.position="fixed",document.body.style.top=`-${e}px`,document.body.style.width="100%",document.body.style.overflow="hidden",()=>{document.body.style.position="",document.body.style.top="",document.body.style.width="",document.body.style.overflow="",window.scrollTo(0,e)}}},[Nt]),R.useEffect(()=>{const e=t=>{w&&!t.target.closest(".export-dropdown-container")&&K(!1),J&&!t.target.closest(".import-dropdown-container")&&Z(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[w,J]),R.useEffect(()=>()=>{},[]);const st=R.useCallback(e=>{if(!e){St({card:null});return}St(t=>{var m,I,x,h,j,$,S,N,E,v,W,U,A,D;const a=t==null?void 0:t.card,o=(a==null?void 0:a.name)||((m=a==null?void 0:a.card)==null?void 0:m.name),r=e.name||((I=e.card)==null?void 0:I.name);if(o===r&&a&&(!e.printing&&!a.printing||e.printing===a.printing))return t;let i={...e};const c={foil:e.foil,isFoil:e.isFoil||e.foil},_=e.showBackFace||e._flipState,u=i.name||((x=i.card)==null?void 0:x.name),C=gt[u],k=!(i.forceEnglish===!0)&&!C&&(i.printing||((h=i.card)==null?void 0:h.printing)||i.scryfall_json||i.image_uris||((j=i.card)==null?void 0:j.scryfall_json)||(($=i.card)==null?void 0:$.image_uris));if(C){const B=gt[u];i={...i,...c,printing:B,forceEnglish:!0,forceHighRes:!0,name:u,image_uris:null,scryfall_json:null,card:i.card?{...i.card,...c,printing:B,name:u,image_uris:null,scryfall_json:null}:{name:u,...c,printing:B,image_uris:null,scryfall_json:null}}}return C||(k?(i.card&&typeof i.card=="object"&&i.card!==null?(i.card.printing=i.printing||i.card.printing,i.card={...i.card,...c},i.scryfall_json&&!i.card.scryfall_json&&(i.card.scryfall_json=i.scryfall_json),i.image_uris&&!i.card.image_uris&&(i.card.image_uris=i.image_uris)):i.card&&typeof i.card=="string"&&(console.warn("[CARD HOVER] card.card is a string (ObjectId), creating minimal object for:",u),i.card={_id:i.card,name:u,printing:i.printing,...c}),i={...i,...c}):u&&(i={...i,...c,forceEnglish:!0,forceHighRes:!0,name:u,image_uris:null,card:i.card?{...i.card,...c,name:u,image_uris:null}:{name:u,...c,image_uris:null}})),{...c,id:i.id||i.scryfall_id||((S=i.card)==null?void 0:S.id)||((N=i.card)==null?void 0:N.scryfall_id),scryfall_id:i.scryfall_id||i.id||((E=i.card)==null?void 0:E.scryfall_id)||((v=i.card)==null?void 0:v.id),printing:i.printing,card:{...i,...c,id:i.id||i.scryfall_id||((W=i.card)==null?void 0:W.id)||((U=i.card)==null?void 0:U.scryfall_id),scryfall_id:i.scryfall_id||i.id||((A=i.card)==null?void 0:A.scryfall_id)||((D=i.card)==null?void 0:D.id),printing:i.printing},top:0,left:0,flipState:_}})},[]);R.useEffect(()=>{Rt(new Set)},[Fe,xt]);const ft=R.useMemo(()=>nt.map((e,t)=>{const a=`${e.name}-${e.set||"default"}-${t}`;return{originalCard:e,cardKey:a,cardForHover:{name:e.name,id:e.id||e.scryfall_id,scryfall_id:e.scryfall_id||e.id,card:{name:e.name,id:e.id||e.scryfall_id,scryfall_id:e.scryfall_id||e.id,...e.image_uris&&{image_uris:e.image_uris},...e.scryfall_json&&{scryfall_json:e.scryfall_json},...e.mana_cost&&{mana_cost:e.mana_cost},...e.type_line&&{type_line:e.type_line},...e.oracle_text&&{oracle_text:e.oracle_text},...e.power&&{power:e.power},...e.toughness&&{toughness:e.toughness},...e.loyalty&&{loyalty:e.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:e.set||e.set_name||null,set:e.set||e.set_name||null,collector_number:e.collector_number||null}}}),[nt]),Ut=R.useRef(null);R.useMemo(()=>()=>{rt(-1)},[]);const at=R.useCallback((e,t,a)=>{var _,u;const o=gt[e.name];let r=e.printing||((_=e.cardObj)==null?void 0:_.printing);o&&(r=gt[e.name]);const l=`${e.name}-${e.printing||((u=e.cardObj)==null?void 0:u.scryfall_id)||"default"}`,i=a.get(l)||!1,c={...e.cardObj,foil:t,isFoil:t,name:e.name,printing:r,showBackFace:i,_flipState:i};st(c)},[st]),Me=R.useCallback(e=>{Xt(e)},[Xt]),At=R.useCallback((e,t,a,o,r,l)=>{if(o){r(e);return}let i={};e.cardObj&&typeof e.cardObj=="object"?i=JSON.parse(JSON.stringify(e.cardObj)):typeof e.cardObj=="string"&&(i={scryfall_id:e.cardObj,name:e.name,printing:e.printing},console.log(`[MODAL CLICK] cardObj was string ID, created object for: ${e.name}`));const c={...i,name:e.name,foil:t,count:e.count||1,price:a||null,printing:e.printing||i.printing};c.card&&typeof c.card=="object"?c.card.foil=t:typeof c.card=="string"&&console.log(`[MODAL CLICK] enrichedCardObj.card was string ID: ${c.card}`),l({isOpen:!0,cardObj:c})},[]),En=R.useCallback((e,t,a,o)=>{const r=JSON.parse(JSON.stringify(e.cardObj||{})),l=gt[e.name],i=l?ln(e.name):null;let c=e.printing||r.printing;l&&i&&(c=i,console.log(`üèûÔ∏è [MODAL] Using user preferred printing for ${e.name}: ${i}`));const _={...r,name:e.name,foil:t,count:e.count||1,price:a||null,printing:c,...l&&i&&{id:i,scryfall_id:i,image_uris:null,card:{...r.card,printing:i,scryfall_id:i,id:i,scryfall_json:null}}};_.card&&(_.card.foil=t),o({isOpen:!0,cardObj:_})},[]);R.useEffect(()=>{const e=t=>{t.key==="Escape"&&Nt&&Bt()};if(Nt){document.addEventListener("keydown",e);const t=document.querySelector("[data-search-modal]");t&&t.focus()}return()=>{document.removeEventListener("keydown",e)}},[Nt]);const Bt=()=>{xn.current&&xn.current.abort(),Je(!1),mt(new Map),dt(""),pt("")};R.useEffect(()=>{rt(-1),Ut.current=null},[nt,Yt]);const zt=R.useCallback(async e=>{var i,c,_,u,C,d,k,f;if(!n||!e){console.error("Cannot add card: missing deck or card data"),P.error("Cannot add card: missing deck or card data");return}if(!e.name){console.error("Cannot add card: missing card name"),P.error("Cannot add card: missing card name");return}const t=`${e.name}-${e.set||"default"}`,a=Date.now(),o=Xe.current.get(t);if(o&&a-o<1e3){P.info(`Please wait a moment before adding ${e.name} again`);return}Xe.current.set(t,a);const r=F.findIndex(m=>{var x;return(((x=m.card)==null?void 0:x.name)||m.name)===e.name});if(Array.from(Kt.current.values()).some(m=>{var x;return(m.name||((x=m.card)==null?void 0:x.name))===e.name})){P.info(`${e.name} is already in your deck (emergency restore active)`);return}if(r!==-1){const m=F[r],x=(m.count||m.quantity||1)+1;Io(m,{quantity:x}),le(h=>{if(!h)return h;const j=h.cards.map($=>{var N;return(((N=$.card)==null?void 0:N.name)||$.name)===e.name?{...$,count:x,quantity:x}:$});return{...h,cards:j}}),P.success(`Added ${e.name} to deck (now ${x})`);return}try{const m=localStorage.getItem("token"),I="",x=!1,h=e.scryfall_id||e.id;if(!h){console.error("No Scryfall ID found in card data"),P.error("Unable to add card: missing ID information");return}const j={name:e.name,cardId:h,quantity:1,card:{name:e.name,id:h}};e.set&&(j.set=e.set),e.collector_number&&(j.collector_number=e.collector_number),e.finishes&&e.finishes.length>0&&(j.finishes=e.finishes);const $=`/api/decks/${n._id}`;console.log("üîß API URL Debug:",{apiUrl:I,isDev:x,url:$,finalUrl:x?`http://localhost:3001${$}`:`${I}${$}`});const S=x?`http://localhost:3001${$}`:`${I}${$}`,N=gt[e.name],E=N?ln(e.name):null;let v=e;N&&(console.log(`üèûÔ∏è [ADD CARD] Using user preferred printing for ${e.name}: ${E}`),v={...e,id:E,scryfall_id:E,printing:E,image_uris:null});const W={name:v.name,quantity:1,count:1,isCommander:!1,set:v.set,collector_number:v.collector_number,finishes:v.finishes||["nonfoil"],prices:v.prices,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,printing:v.printing||v.scryfall_id||v.id,card:{name:v.name,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,set:v.set,collector_number:v.collector_number,prices:v.prices,printing:v.printing||v.scryfall_id||v.id,scryfall_json:v,...v},scryfallCard:v,scryfall_json:v,_optimistic:!0};console.log("üèûÔ∏è BASIC LAND PRINTING FIX:",{cardName:e.name,isBasicLand:N,originalPrinting:e.printing||e.scryfall_id||e.id,preferredPrinting:E,finalPrinting:v.printing||v.scryfall_id||v.id,usingPreferred:N&&E!==(e.printing||e.scryfall_id||e.id)}),le(O=>O&&{...O,cards:[...O.cards,W],cardCount:O.cards.length+1}),Qt(O=>[...O,W]),P.success(`Adding ${e.name} to deck...`);const U={name:v.name,quantity:1,count:1,isCommander:!1,set:v.set,collector_number:v.collector_number,finishes:v.finishes||["nonfoil"],prices:v.prices||{},mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,printing:v.printing||v.scryfall_id||v.id,scryfall_id:v.id||v.scryfall_id,card:{name:v.name,mana_cost:v.mana_cost,color_identity:v.color_identity,cmc:v.cmc,type_line:v.type_line,set:v.set,collector_number:v.collector_number,printing:v.printing||v.scryfall_id||v.id,scryfall_id:v.id||v.scryfall_id}},A=(n.cards||[]).map(O=>{var b,te,re,ve,Ze,ie,me,je,qe;return{name:O.name,quantity:O.quantity||1,count:O.count||1,isCommander:O.isCommander||!1,set:O.set,collector_number:O.collector_number,finishes:O.finishes||["nonfoil"],prices:O.prices||{},mana_cost:O.mana_cost,color_identity:O.color_identity,cmc:O.cmc,type_line:O.type_line,scryfall_id:O.scryfall_id||((b=O.card)==null?void 0:b.scryfall_id),card:{name:O.name||((te=O.card)==null?void 0:te.name),mana_cost:O.mana_cost||((re=O.card)==null?void 0:re.mana_cost),color_identity:O.color_identity||((ve=O.card)==null?void 0:ve.color_identity),cmc:O.cmc||((Ze=O.card)==null?void 0:Ze.cmc),type_line:O.type_line||((ie=O.card)==null?void 0:ie.type_line),set:O.set||((me=O.card)==null?void 0:me.set),collector_number:O.collector_number||((je=O.card)==null?void 0:je.collector_number),scryfall_id:O.scryfall_id||((qe=O.card)==null?void 0:qe.scryfall_id)}}}),B={_id:n._id,name:n.name,format:n.format,commander:n.commander,cards:[...A,U],...n.sideboard&&{sideboard:n.sideboard},...n.techIdeas&&{techIdeas:n.techIdeas},...n.description&&{description:n.description},...n.colors&&{colors:n.colors}},y=JSON.stringify(B);console.log("üöÄ Sending PUT request to:",S),console.log("üì¶ Request body deck structure:",{deckId:B._id,cardsCount:(i=B.cards)==null?void 0:i.length,newCardName:U.name,requestSize:y.length,hasNestedScryfall:U.scryfall_json?"YES":"NO",cardObjectKeys:Object.keys(U),sampleCardSize:JSON.stringify(U).length,serverEnvironment:x?"DEVELOPMENT":"PRODUCTION",timestamp:new Date().toISOString()}),y.length>5e4&&(console.warn("‚ö†Ô∏è Large request detected:",y.length,"bytes"),console.log("üìä Card data sample:",JSON.stringify(U).substring(0,500)+"..."));const G=await fetch(S,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},credentials:"include",body:JSON.stringify(B)});if(G.ok){const O=await G.json();console.log("[DEBUG] Server response after card addition:",{commander:O.commander,commanderNames:O.commanderNames,cardsCount:(c=O.cards)==null?void 0:c.length,timestamp:new Date().toISOString(),deckId:O._id});const b=(_=O.cards)==null?void 0:_.find(ie=>{var me;return(((me=ie.card)==null?void 0:me.name)||ie.name)===e.name});console.log("[DEBUG] Added card verification:",{cardName:e.name,foundInResponse:!!b,cardDetails:b,totalCardsAfterAdd:(u=O.cards)==null?void 0:u.length}),console.log("[DEBUG] All card names in server response:",(C=O.cards)==null?void 0:C.map(ie=>{var me;return((me=ie.card)==null?void 0:me.name)||ie.name}).sort());const te=(O.cards||[]).map(ie=>{var je,qe,yt,Ge,ke;const me=B.cards.find(ht=>{var Ie,De;const et=ie.name||((Ie=ie.card)==null?void 0:Ie.name),Ke=ht.name||((De=ht.card)==null?void 0:De.name);return et===Ke});return me?{...me,...ie,card:{...me.card,...ie.card||{},type_line:((je=me.card)==null?void 0:je.type_line)||me.type_line||ie.type_line,scryfall_json:((qe=me.card)==null?void 0:qe.scryfall_json)||me.scryfall_json,mana_cost:((yt=me.card)==null?void 0:yt.mana_cost)||me.mana_cost,color_identity:((Ge=me.card)==null?void 0:Ge.color_identity)||me.color_identity,cmc:((ke=me.card)==null?void 0:ke.cmc)||me.cmc}}:ie}),re={...O,cards:gn({...O,cards:te})};le(ie=>({...re,sideboard:(ie==null?void 0:ie.sideboard)||[],techIdeas:(ie==null?void 0:ie.techIdeas)||[]})),Qt(re.cards||[]),P.success(`Successfully added ${e.name} to deck!`);try{if(re.cards.find(me=>{var qe;return(((qe=me.card)==null?void 0:qe.name)||me.name)===e.name})&&h){const me=e.name,je=`https://api.scryfall.com/cards/search?q=unique:prints+!"${encodeURIComponent(me)}"`,qe=await fetch(je);if(qe.ok){const yt=await qe.json(),Ge=((d=yt.data)==null?void 0:d.find(ke=>ke.id===h))||((k=yt.data)==null?void 0:k[0]);if(Ge){const ke=Ge.prices||{},ht=Ge.finishes||[],et=Ge.promo_types||[],Ke=Ge.foil===!0&&Ge.nonfoil===!1||ht.includes("foil")&&!ht.includes("nonfoil");let Ie=null;Ke?ht.includes("etched")||(f=Ge.frame_effects)!=null&&f.includes("etched")?Ie=ke.usd_etched||ke.usd_foil||ke.usd||null:(et.includes("surgefoil")||et.includes("rainbow")||et.includes("textured")||et.includes("boosterfun"),Ie=ke.usd_foil||ke.usd||null):Ie=ke.usd||null;const De=re.cards.map(ge=>{var ee;if((((ee=ge.card)==null?void 0:ee.name)||ge.name)===e.name){const xe=Ie!=null&&Ie!=="undefined"?Ie:null;return{...ge,card:{...ge.card,scryfall_json:Ge,prices:Ge.prices,modalPrice:xe},scryfall_json:Ge,prices:Ge.prices,modalPrice:xe,lastUpdated:Date.now()}}return ge});re.cards=De}}}}catch{}const ve=re.cards.map(ie=>{var qe,yt,Ge,ke;const me=((qe=ie.card)==null?void 0:qe.name)||ie.name,je=F.find(ht=>{var Ke;return(((Ke=ht.card)==null?void 0:Ke.name)||ht.name)===me});return je&&je!==ie?{...ie,card:{...ie.card,...((yt=je.card)==null?void 0:yt.scryfall_json)&&{scryfall_json:je.card.scryfall_json},...((Ge=je.card)==null?void 0:Ge.prices)&&{prices:je.card.prices},...((ke=je.card)==null?void 0:ke.modalPrice)!==void 0&&{modalPrice:je.card.modalPrice}},...je.scryfall_json&&{scryfall_json:je.scryfall_json},...je.prices&&{prices:je.prices},...je.modalPrice!==void 0&&{modalPrice:je.modalPrice}}:ie}),Ze={...re,_id:n._id,cards:ve};le(ie=>({...Ze,sideboard:(ie==null?void 0:ie.sideboard)||[],techIdeas:(ie==null?void 0:ie.techIdeas)||[]})),Y(ve),P.success(`Added ${e.name} to deck`)}else{le(b=>b&&{...b,cards:b.cards.filter(te=>!te._optimistic||te.name!==e.name),cardCount:b.cards.length-1});const O=await G.text();console.error("Failed to add card to deck:",G.status,G.statusText),console.error("Server error response:",O),P.error(`Failed to add card to deck: ${G.status} - ${O||G.statusText}`)}}catch(m){le(I=>I&&{...I,cards:I.cards.filter(x=>!x._optimistic||x.name!==e.name),cardCount:I.cards.length-1}),console.error("Error adding card to deck:",m.message),P.error(`Error adding card to deck: ${m.message}. Please try again.`)}},[n,le,gn]);so.useEffect(()=>{typeof window<"u"&&n&&zt&&(window.testCardPersistence=async(e="Island")=>{var a;console.log(`üß™ [PERSISTENCE TEST] Starting test with card: ${e}`),console.log("üß™ [PERSISTENCE TEST] Current deck cards before:",(a=n.cards)==null?void 0:a.length);const t={name:e,scryfall_id:"23635e40-d040-40b7-8b98-90ed362aa028",id:"23635e40-d040-40b7-8b98-90ed362aa028",set:"fdn",collector_number:"275"};try{await zt(t),console.log("üß™ [PERSISTENCE TEST] Add completed, waiting 2 seconds..."),setTimeout(async()=>{var i,c,_;console.log("üß™ [PERSISTENCE TEST] Testing persistence by refetching deck...");const o="",r=localStorage.getItem("token"),l=await fetch(`${o}/api/decks/${n._id}`,{headers:{Authorization:`Bearer ${r}`}});if(l.ok){const u=await l.json(),C=(i=u.cards)==null?void 0:i.some(d=>{var k;return(((k=d.card)==null?void 0:k.name)||d.name)===e});console.log("üß™ [PERSISTENCE TEST] Card found in fresh fetch:",C),console.log("üß™ [PERSISTENCE TEST] Fresh deck cards count:",(c=u.cards)==null?void 0:c.length),console.log("üß™ [PERSISTENCE TEST] Fresh deck cards:",(_=u.cards)==null?void 0:_.map(d=>{var k;return((k=d.card)==null?void 0:k.name)||d.name}).sort())}else console.error("üß™ [PERSISTENCE TEST] Failed to refetch deck:",l.status)},2e3)}catch(o){console.error("üß™ [PERSISTENCE TEST] Error:",o)}},console.log("üß™ Persistence test available: window.testCardPersistence()"))},[n,zt]);const[Et,Uo]=R.useState(new Map),mn=R.useMemo(()=>{if(!n)return[];let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0?e=n.commander.filter(t=>t!=null):n.commander&&typeof n.commander=="object"&&n.commander!==null&&!Array.isArray(n.commander)?e=[n.commander]:typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]),n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const t=n.commanderNames.filter(a=>typeof a=="string"&&a.trim());e=e.concat(t)}return e.map(t=>{var o;const a=((o=t.card)==null?void 0:o.name)||t.name||t;return typeof a=="string"?a.toLowerCase():""}).filter(t=>t)},[n]),Do=async(e,t)=>{var o,r,l,i,c,_,u,C,d,k,f;if(!e||!t){console.error("Invalid card data provided for printing update"),P.error("Could not update card printing. Invalid data.");return}Oe(!0);const a=((o=e.card)==null?void 0:o.name)||e.name;if(t&&typeof t.cmc>"u"){const m=((r=e==null?void 0:e.scryfall_json)==null?void 0:r.cmc)||((i=(l=e==null?void 0:e.card)==null?void 0:l.scryfall_json)==null?void 0:i.cmc)||(e==null?void 0:e.cmc)||((c=e==null?void 0:e.card)==null?void 0:c.cmc);m!==void 0&&(t.cmc=m)}try{const m=Array.isArray(t.finishes)?t.finishes:[],I=m.includes("nonfoil"),x=m.includes("foil")||m.includes("etched");let h=I,j=x;if(m.length===0){const b=(_=t.set)==null?void 0:_.toLowerCase(),te=["lea","leb","2ed","arn","atq","leg","drk","fem","ice","hml","all","mir","vis","wth","tmp","sth","exo"].includes(b),re=["ocm1","pcm1"].includes(b);te?(h=!0,j=!1):re?(h=!1,j=!0):(h=!0,j=!0)}const $=e.foil||((u=e.card)==null?void 0:u.foil)||!1;let S=$;t.modalFoilStatus!==void 0?t.modalFoilStatus===!0?j?S=!0:S=!1:h?S=!1:S=!0:!h&&j?S=!0:h&&!j?S=!1:h&&j&&(S=$);let N=null;if(t.modalPrice!==void 0&&t.modalPrice!==null)N=t.modalPrice;else{const b=t.prices||{},te=t.finishes||[];t.foil===!0&&t.nonfoil===!1||te.includes("foil")&&!te.includes("nonfoil")?te.includes("etched")||(C=t.frame_effects)!=null&&C.includes("etched")?N=b.usd_etched||b.usd_foil||b.usd||null:N=b.usd_foil||b.usd||null:S?N=b.usd_foil||b.usd||null:N=b.usd||null}const E={_id:e._id,id:e.id,name:((d=e.card)==null?void 0:d.name)||e.name,count:e.count||1,foil:S,printing:t.id,modalPrice:N!=null&&N!=="undefined"?N:null,cmc:t.cmc,mana_cost:t.mana_cost,type_line:t.type_line,color_identity:t.color_identity,card:{...(k=e.card)!=null&&k._id?{_id:e.card._id}:{},name:t.name,set:t.set,collector_number:t.collector_number,cmc:t.cmc,mana_cost:t.mana_cost,type_line:t.type_line,color_identity:t.color_identity,foil:S,modalPrice:N,prices:t.prices||{},image_uris:t.image_uris||null,scryfall_json:t},scryfall_json:t,image_uris:t.image_uris||null},v=Be==null?void 0:Be.card,W=(v==null?void 0:v.name)||((f=v==null?void 0:v.card)==null?void 0:f.name);if(v&&W===a){const b={...v,printing:t.id,foil:S,scryfall_json:t,image_uris:t.image_uris,...v.card?{card:{...v.card,...E.card,foil:S}}:{}};St({card:b,top:0,left:0}),st({name:a,id:t.id,scryfall_id:t.id,printing:t.id,foil:S,scryfall_json:t,image_uris:t.image_uris})}if(p.isOpen&&p.cardObj){const b={...p.cardObj,printing:t.id,foil:S,scryfall_json:t,image_uris:t.image_uris,card:{...p.cardObj.card,...E.card,foil:S}};L({isOpen:!0,cardObj:b})}const U=F.map(b=>{var te;return b&&(((te=b.card)==null?void 0:te.name)||b.name)===a?{...b,printing:t.id,foil:S,scryfall_json:t,image_uris:t.image_uris,modalPrice:N,cmc:E.cmc,mana_cost:E.mana_cost,type_line:E.type_line,color_identity:E.color_identity,card:{...b.card,...E.card,foil:S,modalPrice:N}}:b});Y(U);const A=b=>b&&typeof b=="string"&&/^[0-9a-fA-F]{24}$/.test(b),D=U.map(b=>{var ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Ke,Ie,De,ge,ue,ee,xe,Ee,Ae,Ft,wt,Zt,kn,$n,Pn,Nn,An,Rn,Tn,Mn,Fn,On,Un,Dn,Po;const te=b.modalPrice!==void 0&&b.modalPrice!==null&&b.modalPrice!=="undefined"?b.modalPrice:null;let re={name:((ve=b.card)==null?void 0:ve.name)||b.name,count:b.count||1,quantity:b.count||1,printing:b.printing||null,isCommander:b.isCommander||!1,...b.foil!==void 0?{foil:b.foil}:{},set:b.set||((Ze=b.card)==null?void 0:Ze.set)||((ie=b.scryfall_json)==null?void 0:ie.set),collector_number:b.collector_number||((me=b.card)==null?void 0:me.collector_number)||((je=b.scryfall_json)==null?void 0:je.collector_number),finishes:b.finishes||((qe=b.scryfall_json)==null?void 0:qe.finishes)||["nonfoil"],prices:b.prices||((yt=b.card)==null?void 0:yt.prices)||((Ge=b.scryfall_json)==null?void 0:Ge.prices)||{},mana_cost:b.mana_cost||((ke=b.card)==null?void 0:ke.mana_cost)||((ht=b.scryfall_json)==null?void 0:ht.mana_cost),color_identity:b.color_identity||((et=b.card)==null?void 0:et.color_identity)||((Ke=b.scryfall_json)==null?void 0:Ke.color_identity),cmc:b.cmc||((Ie=b.card)==null?void 0:Ie.cmc)||((De=b.scryfall_json)==null?void 0:De.cmc),type_line:b.type_line||((ge=b.card)==null?void 0:ge.type_line)||((ue=b.scryfall_json)==null?void 0:ue.type_line),scryfall_id:b.scryfall_id||((ee=b.card)==null?void 0:ee.scryfall_id)||((xe=b.scryfall_json)==null?void 0:xe.id),...te!==null?{modalPrice:te}:{}};return b._id&&A(b._id)&&(re._id=b._id),b.card?typeof b.card=="object"&&b.card!==null?b.card._id&&A(b.card._id)?re.card=b.card._id:re.card={name:b.card.name||b.name,set:b.card.set||b.set||((Ee=b.scryfall_json)==null?void 0:Ee.set),collector_number:b.card.collector_number||b.collector_number||((Ae=b.scryfall_json)==null?void 0:Ae.collector_number),mana_cost:b.card.mana_cost||b.mana_cost||((Ft=b.scryfall_json)==null?void 0:Ft.mana_cost),color_identity:b.card.color_identity||b.color_identity||((wt=b.scryfall_json)==null?void 0:wt.color_identity),cmc:b.card.cmc||b.cmc||((Zt=b.scryfall_json)==null?void 0:Zt.cmc),type_line:b.card.type_line||b.type_line||((kn=b.scryfall_json)==null?void 0:kn.type_line),...b.card._id&&A(b.card._id)?{_id:b.card._id}:{}}:typeof b.card=="string"&&(A(b.card)?re.card=b.card:re.card={name:b.name,set:b.set||(($n=b.scryfall_json)==null?void 0:$n.set),collector_number:b.collector_number||((Pn=b.scryfall_json)==null?void 0:Pn.collector_number),mana_cost:b.mana_cost||((Nn=b.scryfall_json)==null?void 0:Nn.mana_cost),color_identity:b.color_identity||((An=b.scryfall_json)==null?void 0:An.color_identity),cmc:b.cmc||((Rn=b.scryfall_json)==null?void 0:Rn.cmc),type_line:b.type_line||((Tn=b.scryfall_json)==null?void 0:Tn.type_line)}):re.card={name:b.name,set:b.set||((Mn=b.scryfall_json)==null?void 0:Mn.set),collector_number:b.collector_number||((Fn=b.scryfall_json)==null?void 0:Fn.collector_number),mana_cost:b.mana_cost||((On=b.scryfall_json)==null?void 0:On.mana_cost),color_identity:b.color_identity||((Un=b.scryfall_json)==null?void 0:Un.color_identity),cmc:b.cmc||((Dn=b.scryfall_json)==null?void 0:Dn.cmc),type_line:b.type_line||((Po=b.scryfall_json)==null?void 0:Po.type_line)},re});console.log("[PRINTING UPDATE] Sending updated cards to server:",D),console.log("[PRINTING UPDATE] Full payload:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames});const B=localStorage.getItem("token");if(!B)throw new Error("No authentication token found. Please log in again.");const G=await fetch(`/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`},credentials:"include",body:JSON.stringify({cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})});if(!G.ok){let b,te;try{te=await G.json(),b=JSON.stringify(te),console.error("[PRINTING UPDATE] Server error:",G.status,te),console.error("[PRINTING UPDATE] Request payload that failed:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})}catch{b=await G.text(),console.error("[PRINTING UPDATE] Server error:",G.status,b),console.error("[PRINTING UPDATE] Request payload that failed:",{cards:D,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})}throw new Error(`Printing update server error ${G.status}: ${b}`)}const O=await G.json();O!=null&&O.cards&&(O.cards=O.cards.map(b=>{var ve,Ze,ie,me;const te=b.modalPrice!==void 0&&b.modalPrice!==null&&b.modalPrice!=="undefined"?b.modalPrice:null,re=((ve=b.card)==null?void 0:ve.modalPrice)!==void 0&&((Ze=b.card)==null?void 0:Ze.modalPrice)!==null&&((ie=b.card)==null?void 0:ie.modalPrice)!=="undefined"?(me=b.card)==null?void 0:me.modalPrice:null;return{...b,modalPrice:te,...b.card?{card:{...b.card,modalPrice:re}}:{}}})),le(b=>({...b,...O,cards:U,sideboard:(b==null?void 0:b.sideboard)||[],techIdeas:(b==null?void 0:b.techIdeas)||[]})),P.success(`Updated ${a} to ${t.set_name}.`)}catch(m){console.error("Failed to save updated deck:",m),m.message.includes("mongoose")?P.error("Failed to save printing change due to a server connection issue. Please try again."):m.message.includes("not defined")?(P.error("Failed to save printing change due to a code issue. The developers have been notified."),console.error("Code Error in handlePrintingUpdate:",m.message,m.stack)):P.error(`Failed to save printing change: ${m.message}`)}finally{Oe(!1)}};R.useEffect(()=>{const e=t=>{t.key==="Escape"&&p.isOpen&&(t.preventDefault(),L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1}))};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[]),R.useEffect(()=>{function e(t){t.key==="Escape"&&p.isOpen&&(t.preventDefault(),t.stopPropagation(),L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1}))}return p.isOpen&&(document.addEventListener("keydown",e,!0),window.addEventListener("keydown",e,!0)),()=>{document.removeEventListener("keydown",e,!0),window.removeEventListener("keydown",e,!0)}},[p.isOpen]),R.useEffect(()=>{if(pe.current=!0,(()=>{if(window.fixedTechIdeasCache){const c=[],_=[];for(const[u,C]of window.fixedTechIdeasCache.entries())if(C.modalPrice){const d=parseFloat(C.modalPrice.toString().replace(/^\$/,""));(d>100||d<=0)&&(c.push({name:u,price:C.modalPrice,priceNum:d}),_.push(u))}_.length>0&&_.forEach(u=>window.fixedTechIdeasCache.delete(u))}})(),!T||!/^[0-9a-fA-F]{24}$/.test(T)){console.error("Invalid deck ID format:",T),P.error("Invalid deck ID. Redirecting to home page..."),setTimeout(()=>{Qe("/")},2e3),be(!1);return}if(fe.current||Q.current===T)return;fe.current=!0,Q.current=T;const t=new AbortController,a=setTimeout(()=>{console.error("Request timeout for deck ID:",T,"- Server may be cold starting, please try refreshing"),t.abort()},3e4),o=`?_cb=${Date.now()}`,r="",l=localStorage.getItem("token"),i=g?`/api/public/decks/${T}`:`/api/decks/${T}`;return fetch(`${r}${i}${o}`,{signal:t.signal,cache:"no-cache",headers:{"Cache-Control":"no-cache",Pragma:"no-cache",...!g&&l?{Authorization:`Bearer ${l}`}:{}}}).then(async c=>{if(clearTimeout(a),!c.ok)throw c.status===404?(console.error("404 Error for deck ID:",T),new Error("DECK_NOT_FOUND")):new Error(`HTTP ${c.status}: ${c.statusText}`);return c.json()}).then(c=>{var d,k,f,m,I;if(!pe.current)return;if(console.log("[DEBUG] Deck loaded from server - commander properties:",{commander:c.commander,commanderNames:c.commanderNames,hasCommander:"commander"in c,hasCommanderNames:"commanderNames"in c,allKeys:Object.keys(c),fullDeckData:c}),console.log("[DEBUG] Deck loaded from server - sideboard/techIdeas check:",{hasSideboard:"sideboard"in c,hasTechiIdeas:"techIdeas"in c,sideboardData:c.sideboard,techIdeasData:c.techIdeas,sideboardCount:((d=c.sideboard)==null?void 0:d.length)||0,techIdeasCount:((k=c.techIdeas)==null?void 0:k.length)||0}),!c.commander&&c.cards&&c.cards.length>0){const x=c.cards.filter(h=>{var S,N,E;const j=((S=h.card)==null?void 0:S.name)||h.name||"",$=((N=h.card)==null?void 0:N.type_line)||h.type_line||"";return console.log("[COMMANDER INFERENCE] Checking card:",{cardName:j,cardType:$,cardObj:h,hasCard:!!h.card,hasTypeLine:!!((E=h.card)!=null&&E.type_line||h.type_line),fullCard:h}),$.toLowerCase().includes("legendary")&&$.toLowerCase().includes("creature")});if(x.length>0){const h=x[0],j=((f=h.card)==null?void 0:f.name)||h.name;console.log("[COMMANDER FIX] Server missing commander data, inferring from cards:",{inferredCommander:j,fromCard:h,potentialCommanders:x.length}),c.commander=j,c.commanderNames=[j]}else if(c.format==="Commander / EDH"&&c.cards.length>0){const h=c.cards[0],j=((m=h.card)==null?void 0:m.name)||h.name;console.log("[COMMANDER FIX] No legendary creatures found, but Commander format - assuming first card is commander:",{assumedCommander:j,format:c.format,firstCard:h}),c.commander=j,c.commanderNames=[j]}}c!=null&&c.cards&&(c.cards=c.cards.map(x=>{var $,S,N,E;const h=x.modalPrice!==void 0&&x.modalPrice!==null&&x.modalPrice!=="undefined"?x.modalPrice:null,j=(($=x.card)==null?void 0:$.modalPrice)!==void 0&&((S=x.card)==null?void 0:S.modalPrice)!==null&&((N=x.card)==null?void 0:N.modalPrice)!=="undefined"?(E=x.card)==null?void 0:E.modalPrice:null;return{...x,modalPrice:h,...x.card?{card:{...x.card,modalPrice:j}}:{}}})),(I=c==null?void 0:c.cards)!=null&&I.filter(x=>{var h,j;return x.modalPrice!==null&&x.modalPrice!==void 0||((h=x.card)==null?void 0:h.modalPrice)!==null&&((j=x.card)==null?void 0:j.modalPrice)!==void 0});const C=gn(c).filter(x=>{var $;if(!x)return!1;const h=(($=x.card)==null?void 0:$.name)||x.name||"",j=/^(test|example|placeholder|unknown|null|undefined|sample)/i;return h.length>2&&!j.test(h)}).map((x,h)=>{var B,y,G;if(!x)return console.warn(`[Card Verifier] Card at index ${h} is null.`),Promise.resolve(null);const j=((B=x.card)==null?void 0:B.name)||x.name||`(unknown card at index ${h})`;if(!!x.scryfall_json)return Promise.resolve(x);const S=x.printing,N=(y=x.card)==null?void 0:y.set,E=(G=x.card)==null?void 0:G.collector_number,v=`${S||"no-id"}:${j||"no-name"}`;if(ao.has(v))return Promise.resolve(x);const W=O=>!O||typeof O!="string"?!1:/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(O),U=O=>{if(!O||typeof O!="string")return!1;const b=/^(test|example|placeholder|unknown|null|undefined|sample)/i;return O.length>2&&!b.test(O)};let A=null,D="";return N&&E?(A=`https://api.scryfall.com/cards/${N.toLowerCase()}/${E}`,D=`set/collector number ${N}/${E}`):S&&W(S)?(A=`https://api.scryfall.com/cards/${S}`,D=`printing ID ${S}`):j&&U(j)&&(A=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(j)}`,D=`card name "${j}"`),A?A?fetch(A.startsWith("http")?A:`${A}`).then(b=>{if(!b.ok){if(b.status===404)return console.debug(`[Scryfall] Card not found: "${j}" (${D}) - using original data`),Promise.resolve(x);throw console.warn(`[SCRYFALL ERROR] Failed to fetch card data for "${j}" using ${D}. Status: ${b.status}`),new Error(`Scryfall fetch failed for ${D} with status ${b.status}`)}return b.json()}).then(b=>{if(b===x)return b;const te={...x,scryfall_json:b,printing:b.id};return te.card&&(te.card.scryfall_json=b,te.card.prices=b.prices),te}).catch(b=>(console.error(`[Card Fetch] Failed for "${j}" using ${D}:`,b.message),{...x,scryfall_fetch_failed:!0})):(console.warn(`[Card Verifier] Cannot fetch "${j}" - no identifier available.`),Promise.resolve(x)):(ao.add(v),S&&!W(S)?console.warn(`[Card Validation] Skipping invalid printing ID "${S}" for card "${j}"`):j&&!U(j)?console.warn(`[Card Validation] Skipping invalid card name "${j}"`):console.warn(`[Card Validation] No valid fetch method available for card "${j}"`),Promise.resolve(x))});Promise.all(C).then(x=>{const h=x.filter(A=>A);if(!pe.current)return;const j=h.map(A=>{var te,re,ve,Ze,ie,me;(te=A.card)!=null&&te.name||A.name;const D=A.modalPrice!==void 0&&A.modalPrice!==null&&A.modalPrice!=="undefined"?A.modalPrice:null,B=((re=A.card)==null?void 0:re.modalPrice)!==void 0&&((ve=A.card)==null?void 0:ve.modalPrice)!==null&&((Ze=A.card)==null?void 0:Ze.modalPrice)!=="undefined"?(ie=A.card)==null?void 0:ie.modalPrice:null,y=A.foil===!0||((me=A.card)==null?void 0:me.foil)===!0,G={...A,foil:y,modalPrice:D,...A.card?{card:{...A.card,foil:y,modalPrice:B}}:{},...A.cardObj?{cardObj:{...A.cardObj,foil:y,...A.cardObj.card?{card:{...A.cardObj.card,foil:y}}:{}}}:{}},O=Vt(G),b=A.count!==void 0?A.count:A.quantity||1;return{...G,count:b,price:O.price,lastUpdated:Date.now(),...G.card?{card:{...G.card,count:b,price:O.price,lastUpdated:Date.now()}}:{}}}),$=wn(j);console.log(`[DEBUG] Processed cards: ${j.length}, Filtered cards: ${$.length}`);const S={...c,cards:$},N=gn(S),E={...S,cards:N};console.log(`[DEBUG] Final deck card count: ${E.cards.length}`),console.log("[DEBUG] Loaded deck card names:",E.cards.map(A=>{var D;return((D=A.card)==null?void 0:D.name)||A.name}).sort()),console.log("[DEBUG] Deck load timestamp:",new Date().toISOString(),"Total cards:",E.cards.length),console.log("[DEBUG] Final deck data commander properties:",{commander:E.commander,commanderNames:E.commanderNames,hasCommander:"commander"in E,hasCommanderNames:"commanderNames"in E,originalDataCommander:c.commander,originalDataCommanderNames:c.commanderNames}),console.log("[DEBUG] About to call setDeck with:",E);const v=Lo(c._id);let W=E.cards;if(v.sideboard.length>0||v.techIdeas.length>0){const A=new Set([...v.sideboard.map(B=>{var y;return B.name||((y=B.card)==null?void 0:y.name)}),...v.techIdeas.map(B=>{var y;return B.name||((y=B.card)==null?void 0:y.name)})].filter(Boolean)),D=W.length;W=W.filter(B=>{var G;const y=B.name||((G=B.card)==null?void 0:G.name);return!A.has(y)}),D!==W.length&&(console.log(`[PERSISTENCE] üîÑ Removed ${D-W.length} duplicate cards from main deck that exist in zones`),console.log("[PERSISTENCE] Zone card names:",Array.from(A))),console.log(`[PERSISTENCE] ‚úÖ Restored ${v.sideboard.length} sideboard + ${v.techIdeas.length} tech ideas from localStorage`)}const U={...E,cards:W,sideboard:v.sideboard,techIdeas:v.techIdeas};(c.isPublic||c.readOnly)&&M(!0),le(U),console.log("[DEBUG] setDeck called with commander data:",{passedCommander:U.commander,passedCommanderNames:U.commanderNames,sideboardCount:v.sideboard.length,techIdeasCount:v.techIdeas.length,isReadOnly:c.isPublic||c.readOnly||!1}),Ne(c.name),Y(W),oe(!1),be(!1),setTimeout(()=>{window.productionOtagSystem&&!window.productionOtagSystem.isLoaded&&(console.log("üè∑Ô∏è [DECK LOADED] Starting Oracle Tags preload in background..."),window.productionOtagSystem.preloadOtagData().then(()=>{console.log("üè∑Ô∏è [DECK LOADED] Oracle Tags preload completed successfully")}).catch(A=>{console.log("üè∑Ô∏è [DECK LOADED] Oracle Tags preload failed (not critical):",A.message)}))},1e3),Nr(N,ye.current),setTimeout(()=>{var D,B,y,G;let A=null;if(c.commander)if(Array.isArray(c.commander)&&c.commander.length>0){const O=c.commander[0],b=O.name||O;A=N.find(te=>{var re;return(((re=te.card)==null?void 0:re.name)||te.name)===b}),(D=A==null?void 0:A.card)!=null&&D.name||(A==null||A.name)}else typeof c.commander=="object"&&c.commander!==null?(A=N.find(O=>{var b;return(((b=O.card)==null?void 0:b.name)||O.name)===c.commander.name}),(B=A==null?void 0:A.card)==null||B.name):typeof c.commander=="string"&&(A=N.find(O=>{var b;return(((b=O.card)==null?void 0:b.name)||O.name)===c.commander}),(y=A==null?void 0:A.card)!=null&&y.name||(A==null||A.name));if(!A){const b=pn(N,[]).find(te=>te.type==="Commander");b&&b.cards.length>0&&(A=b.cards[0],(G=A==null?void 0:A.card)!=null&&G.name||(A==null||A.name))}A?st(A):N.length>0&&st(N[0])},100)})}).catch(c=>{if(clearTimeout(a),c.name==="AbortError"){console.error("Deck loading timed out for deck ID:",T),P.error("Deck loading timed out. The server may be starting up - please try refreshing the page.",{duration:8e3}),pe.current&&be(!1);return}console.error("Error loading deck:",c),c.message==="DECK_NOT_FOUND"?(P.error("Deck not found. Redirecting to home page..."),setTimeout(()=>{Qe("/")},2e3)):c.message.includes("Failed to fetch")?P.error("Network error loading deck. Please check your connection and try again.",{duration:6e3}):P.error("Failed to load deck: "+c.message),pe.current&&be(!1)}).finally(()=>{clearTimeout(a),fe.current=!1}),()=>{pe.current=!1,t.abort(),fe.current=!1}},[T]);const Wt=(e,t,a)=>{try{const o=`deck_zones_${e}`,r={sideboard:t||[],techIdeas:a||[],lastUpdated:Date.now()};localStorage.setItem(o,JSON.stringify(r)),console.log(`[STORAGE] Saved sideboard/techIdeas to localStorage for deck ${e}:`,{sideboardCount:r.sideboard.length,techIdeasCount:r.techIdeas.length})}catch(o){console.error("[STORAGE] Failed to save sideboard/techIdeas to localStorage:",o)}},Lo=e=>{var t,a;try{const o=`deck_zones_${e}`,r=localStorage.getItem(o);if(r){const l=JSON.parse(r);return console.log(`[STORAGE] Loaded sideboard/techIdeas from localStorage for deck ${e}:`,{sideboardCount:((t=l.sideboard)==null?void 0:t.length)||0,techIdeasCount:((a=l.techIdeas)==null?void 0:a.length)||0,age:Math.round((Date.now()-l.lastUpdated)/1e3/60)+" minutes"}),{sideboard:l.sideboard||[],techIdeas:l.techIdeas||[]}}}catch(o){console.error("[STORAGE] Failed to load sideboard/techIdeas from localStorage:",o)}return{sideboard:[],techIdeas:[]}},Hn=async e=>{var t,a,o,r;try{const l="",i=localStorage.getItem("token");if(!i){console.error("[SAVE DECK] No authentication token found"),P.error("Cannot save: Not logged in");return}const c=(e.cards||[]).map(d=>{var k,f,m,I,x,h,j,$,S,N,E,v,W,U,A,D;return{name:d.name||((k=d.card)==null?void 0:k.name),quantity:d.quantity||1,count:d.count||1,isCommander:d.isCommander||!1,set:d.set||((f=d.card)==null?void 0:f.set),collector_number:d.collector_number||((m=d.card)==null?void 0:m.collector_number),finishes:d.finishes||["nonfoil"],prices:d.prices||{},mana_cost:d.mana_cost||((I=d.card)==null?void 0:I.mana_cost),color_identity:d.color_identity||((x=d.card)==null?void 0:x.color_identity),cmc:d.cmc||((h=d.card)==null?void 0:h.cmc),type_line:d.type_line||((j=d.card)==null?void 0:j.type_line),scryfall_id:d.scryfall_id||(($=d.card)==null?void 0:$.scryfall_id),card:{name:d.name||((S=d.card)==null?void 0:S.name),mana_cost:d.mana_cost||((N=d.card)==null?void 0:N.mana_cost),color_identity:d.color_identity||((E=d.card)==null?void 0:E.color_identity),cmc:d.cmc||((v=d.card)==null?void 0:v.cmc),type_line:d.type_line||((W=d.card)==null?void 0:W.type_line),set:d.set||((U=d.card)==null?void 0:U.set),collector_number:d.collector_number||((A=d.card)==null?void 0:A.collector_number),scryfall_id:d.scryfall_id||((D=d.card)==null?void 0:D.scryfall_id)}}}),_={_id:e._id,name:e.name,format:e.format,commander:e.commander,cards:c,...e.sideboard&&{sideboard:e.sideboard},...e.techIdeas&&{techIdeas:e.techIdeas},...e.description&&{description:e.description},...e.colors&&{colors:e.colors}},u=JSON.stringify(_);console.log("[SAVE DECK] Attempting save with sideboard/techIdeas:",{deckId:e._id,cardsCount:c.length,sideboardCount:(e.sideboard||[]).length,techIdeasCount:(e.techIdeas||[]).length,payloadSize:u.length});const C=await fetch(`${l}/api/decks/${e._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"Cache-Control":"no-cache"},credentials:"include",body:u});if(C.ok){const d=await C.json();console.log("[SAVE DECK] ‚úÖ Server supports sideboard/techIdeas - full persistence enabled!"),console.log("[SAVE DECK] Server response sideboard/techIdeas:",{serverReturnedSideboard:((t=d.sideboard)==null?void 0:t.length)||0,serverReturnedTechIdeas:((a=d.techIdeas)==null?void 0:a.length)||0,localSideboardCount:(e.sideboard||[]).length,localTechIdeasCount:(e.techIdeas||[]).length,willPreserveFromLocal:!d.sideboard||!d.techIdeas});const k=(d.cards||[]).map(m=>{var x,h,j,$,S;const I=(e.cards||[]).find(N=>{var W,U;const E=m.name||((W=m.card)==null?void 0:W.name),v=N.name||((U=N.card)==null?void 0:U.name);return E===v});return I?{...I,...m,card:{...I.card,...m.card||{},type_line:((x=I.card)==null?void 0:x.type_line)||I.type_line||m.type_line,scryfall_json:((h=I.card)==null?void 0:h.scryfall_json)||I.scryfall_json,mana_cost:((j=I.card)==null?void 0:j.mana_cost)||I.mana_cost,color_identity:(($=I.card)==null?void 0:$.color_identity)||I.color_identity,cmc:((S=I.card)==null?void 0:S.cmc)||I.cmc}}:m}),f={...d,cards:gn({...d,cards:k}),sideboard:d.sideboard||e.sideboard||[],techIdeas:d.techIdeas||e.techIdeas||[]};le(f),Y(f.cards||[]),(((o=f.sideboard)==null?void 0:o.length)>0||((r=f.techIdeas)==null?void 0:r.length)>0)&&Wt(e._id,f.sideboard,f.techIdeas)}else if(console.log("[SAVE DECK] Server doesn't support zones, using localStorage fallback"),C.status===500||C.status===400){const d={_id:e._id,name:e.name,format:e.format,commander:e.commander,cards:c,...e.description&&{description:e.description},...e.colors&&{colors:e.colors}},k=await fetch(`${l}/api/decks/${e._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"Cache-Control":"no-cache"},credentials:"include",body:JSON.stringify(d)});if(k.ok){const f=await k.json();console.log("[SAVE DECK] ‚úÖ Main deck saved, zones persisted to localStorage");const m=(f.cards||[]).map(x=>{var j,$,S,N,E;const h=(e.cards||[]).find(v=>{var A,D;const W=x.name||((A=x.card)==null?void 0:A.name),U=v.name||((D=v.card)==null?void 0:D.name);return W===U});return h?{...h,...x,card:{...h.card,...x.card||{},type_line:((j=h.card)==null?void 0:j.type_line)||h.type_line||x.type_line,scryfall_json:(($=h.card)==null?void 0:$.scryfall_json)||h.scryfall_json,mana_cost:((S=h.card)==null?void 0:S.mana_cost)||h.mana_cost,color_identity:((N=h.card)==null?void 0:N.color_identity)||h.color_identity,cmc:((E=h.card)==null?void 0:E.cmc)||h.cmc}}:x}),I={...f,cards:gn({...f,cards:m}),sideboard:e.sideboard||[],techIdeas:e.techIdeas||[]};le(I),Y(I.cards||[]),Wt(e._id,e.sideboard,e.techIdeas)}else{const f=await k.json();console.error("[SAVE DECK] Fallback save failed:",f),P.error(`Failed to save deck: ${f.error||"Unknown error"}`)}}else{const d=await C.json();P.error(`Failed to save deck: ${d.error||"Unknown error"}`)}}catch(l){console.error("[SAVE DECK] Error saving deck to server:",l),P.error("Error saving deck to server")}},Bo=async e=>{try{const t=e.toLowerCase().trim(),a=encodeURIComponent(t),o=await fetch(`https://api.scryfall.com/cards/named?exact=${a}`);return o.ok?(await o.json()).color_identity||[]:(o.status===404||console.error("Scryfall API error:",o.status,o.statusText),null)}catch(t){return console.error("Error fetching commander color identity:",t),null}},vn=R.useMemo(()=>{var a,o,r,l,i,c,_;if(!n)return"";let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0)e=n.commander.map(u=>{var d;const C=((d=u.card)==null?void 0:d.name)||u.name||u;return typeof C=="string"?C:null}).filter(Boolean);else if(n.commander&&typeof n.commander=="object"&&n.commander!==null){const u=((a=n.commander.card)==null?void 0:a.name)||n.commander.name||n.commander;u&&typeof u=="string"&&(e=[u])}else typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]);if(n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const u=n.commanderNames.filter(C=>typeof C=="string"&&C.trim());e=e.concat(u)}if(n.cards&&Array.isArray(n.cards)){const u=n.cards.filter(C=>C.isCommander===!0);for(const C of u){const d=((o=C.card)==null?void 0:o.name)||C.name||"";d&&typeof d=="string"&&e.push(d)}}if(e.length===0)return"";let t=null;if(n.commander){const u=Array.isArray(n.commander)?n.commander[0]:n.commander;(r=u==null?void 0:u.card)!=null&&r.color_identity&&Array.isArray(u.card.color_identity)?t=u.card.color_identity:u!=null&&u.color_identity&&Array.isArray(u.color_identity)&&(t=u.color_identity)}if(!t&&n.cards&&Array.isArray(n.cards)){const u=n.cards.find(C=>C.isCommander===!0);if(u&&((l=u.scryfallCard)!=null&&l.color_identity&&Array.isArray(u.scryfallCard.color_identity)?t=u.scryfallCard.color_identity:(i=u.card)!=null&&i.color_identity&&Array.isArray(u.card.color_identity)?t=u.card.color_identity:u.color_identity&&Array.isArray(u.color_identity)&&(t=u.color_identity)),!t)for(const C of e){if(typeof C!="string")continue;const d=n.cards.find(k=>{var m;return(((m=k.card)==null?void 0:m.name)||k.name||"").toLowerCase()===C.toLowerCase()});if((c=d==null?void 0:d.card)!=null&&c.color_identity&&Array.isArray(d.card.color_identity)){t=d.card.color_identity;break}else if((_=d==null?void 0:d.scryfallCard)!=null&&_.color_identity&&Array.isArray(d.scryfallCard.color_identity)){t=d.scryfallCard.color_identity;break}else if(d!=null&&d.color_identity&&Array.isArray(d.color_identity)){t=d.color_identity;break}}}if(!t&&e.length>0){const C=e[0].toLowerCase().trim();if(Et.has(C)){const d=Et.get(C);d!==null&&(t=d)}}if((!t||Array.isArray(t)&&t.length===0)&&e.length>0){const u={"jason bright, glowing prophet":["U"],"jason bright":["U"],"atraxa, praetors' voice":["W","U","B","G"],"edgar markov":["W","U","B","R"],"kumena, tyrant of orazca":["U","G"],"meren of clan nel toth":["B","G"],"prossh, skyraider of kher":["B","R","G"],"derevi, empyrial tactician":["W","U","G"],"oloro, ageless ascetic":["W","U","B"],"kaalia of the vast":["W","B","R"],"ghave, guru of spores":["W","B","G"],"riku of two reflections":["U","R","G"],"the ur-dragon":["W","U","B","R","G"],"sliver overlord":["W","U","B","R","G"]};for(const C of e){if(!C||typeof C!="string")continue;const d=C.toLowerCase().trim();if(u[d]){t=u[d];break}if(d.includes("jason bright")){t=["U"];break}}}return t?t.join("").toLowerCase():""},[n,Et]);R.useEffect(()=>{var t,a,o;if(!n)return;let e=[];if(n.commander&&Array.isArray(n.commander)&&n.commander.length>0)e=n.commander.map(r=>{var i;const l=((i=r.card)==null?void 0:i.name)||r.name||r;return typeof l=="string"?l:null}).filter(Boolean);else if(n.commander&&typeof n.commander=="object"&&n.commander!==null){const r=((t=n.commander.card)==null?void 0:t.name)||n.commander.name||n.commander;r&&typeof r=="string"&&(e=[r])}else typeof n.commander=="string"&&n.commander.trim()&&(e=[n.commander]);if(n.commander_names&&Array.isArray(n.commander_names)&&n.commander_names.length>0){const r=n.commander_names.filter(l=>typeof l=="string"&&l.trim());e=e.concat(r)}if(n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.length>0){const r=n.commanderNames.filter(l=>typeof l=="string"&&l.trim());e=e.concat(r)}if(e.length!==0)for(const r of e){if(typeof r!="string")continue;const l=r.toLowerCase().trim();if(Et.has(l)||se.has(l))continue;let i=!1;if(n.commander){const c=Array.isArray(n.commander)?n.commander[0]:n.commander;((a=c==null?void 0:c.card)!=null&&a.color_identity&&Array.isArray(c.card.color_identity)||c!=null&&c.color_identity&&Array.isArray(c.color_identity))&&(i=!0)}if(!i&&n.cards&&Array.isArray(n.cards)){const c=n.cards.find(_=>{var C;return(((C=_.card)==null?void 0:C.name)||_.name||"").toLowerCase()===r.toLowerCase()});(o=c==null?void 0:c.card)!=null&&o.color_identity&&Array.isArray(c.card.color_identity)&&(i=!0)}i||(de(c=>new Set(c).add(l)),Bo(r).then(c=>{Uo(_=>new Map(_).set(l,c)),de(_=>{const u=new Set(_);return u.delete(l),u})}))}},[n,Et,se]);const qn=R.useRef(null),bo=R.useRef(0),zo=150,xn=R.useRef(null),Co=No(async e=>{const t=Date.now();if(t-bo.current<zo)return;if(bo.current=t,!e.trim()){Dt([]),Pt(!1),He(""),Jt(!1);return}qn.current&&qn.current.abort(),qn.current=new AbortController;const a=qn.current.signal;Jt(!0);let o=e.trim();const r=vn;try{const l=`/api/cards/typesense-search?q=${encodeURIComponent(o)}&limit=1000${r?`&colorIdentity=${r}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,_=!1?l:`${l}`,u=await fetch(_,{signal:a});if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const C=await u.json();let d=C.data||C||[];if((o.toLowerCase().includes("animating faerie")||o.toLowerCase().includes("adventure")||o.toLowerCase().includes("faerie")||o.toLowerCase().includes("underwater tunnel")||o.toLowerCase().includes("room")||o.toLowerCase().includes("dungeon")||o.toLowerCase().includes("plane")||o.toLowerCase().includes("phenomenon")||o.toLowerCase().includes("scheme")||o.toLowerCase().includes("vanguard"))&&d.length===0)try{let f;o.toLowerCase().includes("underwater tunnel")||o.toLowerCase().includes("room")?f=encodeURIComponent(`"${o.trim()}" OR type:room`):o.toLowerCase().includes("adventure")||o.toLowerCase().includes("faerie")?f=encodeURIComponent(`"${o.trim()}" OR keyword:adventure`):f=encodeURIComponent(`"${o.trim()}"`);const m=`https://api.scryfall.com/cards/search?q=${f}&unique=cards&order=name`,I=await fetch(m,{signal:a});if(I.ok){const h=(await I.json()).data||[];h.length>0&&(d=h.slice(0,10))}else{const h=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(o.trim())}`,j=await fetch(h,{signal:a});j.ok&&(d=[await j.json()])}}catch{}Array.isArray(d)?(Dt(d),He(d.length===0?"No cards found matching your search criteria.":""),Pt(d.length>0)):C&&C.message?(Dt([]),He(C.message),Pt(!0)):(Dt([]),He("No results found."),Pt(!0))}catch(l){if(l.name==="AbortError")return;console.error("Search error:",l),Dt([]),He("Error fetching cards."),Pt(!0)}Jt(!1)},200),io=async e=>{if(!e.trim())return;It(!0);const t=vn;try{const a=e.toLowerCase().includes("animating faerie")||e.toLowerCase().includes("adventure")||e.toLowerCase().includes("faerie")||e.toLowerCase().includes("underwater tunnel")||e.toLowerCase().includes("room")||e.toLowerCase().includes("dungeon")||e.toLowerCase().includes("plane")||e.toLowerCase().includes("phenomenon")||e.toLowerCase().includes("scheme")||e.toLowerCase().includes("vanguard"),o=`/api/cards/typesense-search?q=${encodeURIComponent(e.trim())}&limit=1000${t?`&colorIdentity=${t}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,i=!1?o:`${o}`,c=await fetch(i);if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const _=await c.json();let u=_.data||_||[];if(u.length>0&&[...new Set(u.map(f=>f.type_line).filter(Boolean))].filter(f=>f.includes("Adventure")||f.includes("Room")||f.includes("Dungeon")||f.includes("Plane")||f.includes("Phenomenon")||f.includes("Scheme")||f.includes("Vanguard")).length>0,a&&u.length===0)try{let d,k;e.toLowerCase().includes("underwater tunnel")||e.toLowerCase().includes("room")?(d=encodeURIComponent(`"${e.trim()}" OR type:room`),k="Room card search"):e.toLowerCase().includes("adventure")||e.toLowerCase().includes("faerie")?(d=encodeURIComponent(`"${e.trim()}" OR keyword:adventure`),k="Adventure card search"):(d=encodeURIComponent(`"${e.trim()}"`),k="Special card search");const f=`https://api.scryfall.com/cards/search?q=${d}&unique=cards&order=name`,m=await fetch(f);if(m.ok){const x=(await m.json()).data||[];x.length>0&&(u=x)}else{const x=`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(e.trim())}`,h=await fetch(x);h.ok&&(u=[await h.json()])}}catch{}const C=Array.isArray(u)?u.map(d=>{if(gt[d.name]){const f=ln(d.name);if(d.id===f||d.scryfall_id===f)return{...d,_isPreferredPrinting:!0}}return d}).sort((d,k)=>d._isPreferredPrinting&&!k._isPreferredPrinting?-1:!d._isPreferredPrinting&&k._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [SEARCH MODAL] Processed ${C.length} results with basic land preferences`),Te(C),pt(e.trim()),dt(""),Je(!0),Pt(!1)}catch(a){console.error("Error fetching all search results:",a),Te([])}finally{It(!1)}},wo=async e=>{if(!e.trim()){Te([]);return}xn.current&&xn.current.abort(),xn.current=new AbortController;const t=xn.current.signal;It(!0);const a=vn;try{const o=`/api/cards/typesense-search?q=${encodeURIComponent(e.trim())}&limit=1000${a?`&colorIdentity=${a}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,i=!1?o:`${o}`;console.log("üîç Modal search debug:",{query:e.trim(),currentColorId:a,deckFormat:n==null?void 0:n.format,url:o,finalUrl:i});const c=await fetch(i,{signal:t});if(t.aborted)return;if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const _=await c.json();if(t.aborted)return;const u=_.data||_||[],C=Array.isArray(u)?u.map(d=>{if(gt[d.name]){const f=ln(d.name);if(d.id===f||d.scryfall_id===f)return{...d,_isPreferredPrinting:!0}}return d}).sort((d,k)=>d._isPreferredPrinting&&!k._isPreferredPrinting?-1:!d._isPreferredPrinting&&k._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [MODAL SEARCH] Processed ${C.length} results with basic land preferences`),Te(C),pt(e.trim()),mt(new Map)}catch(o){if(o.name==="AbortError")return;console.error("Error in modal search:",o),Te([])}finally{t.aborted||It(!1)}},Wo=No(wo,100);R.useCallback(e=>{const t=`oracletag:${e}`;try{_t(t),Pt(!0),rt(-1),Dt([]),He(""),Jt(!0)}catch(a){console.error("Error initiating oracle tag search:",a),He(`Error searching for oracle tag "${e}"`),Jt(!1)}},[_t,Pt,rt,Dt,He,Jt]);const Ho=R.useCallback(async e=>{var t,a,o,r,l;try{It(!0),Je(!0);const i=`oracletag:${e}`,c=`oracletag:${e}`;dt(c),pt(i),_t(`Oracle Tag: ${e.replace(/-/g," ").replace(/\b\w/g,S=>S.toUpperCase())}`);let _=vn;const u=(t=n==null?void 0:n.commander)==null?void 0:t[0],C=((a=u==null?void 0:u.card)==null?void 0:a.name)||(u==null?void 0:u.name)||"";console.log("üéØ Commander Color Identity Detection:"),console.log("  - Commander Name:",C),console.log("  - Detected Color ID:",_),console.log("  - Is Empty?:",_===""),console.log("  - Length:",(_==null?void 0:_.length)||0);const d={oracleTag:e,currentColorId:_,deckFormat:n==null?void 0:n.format,commander:n==null?void 0:n.commander,commanderNames:n==null?void 0:n.commanderNames,commanderCard:u,commanderColorIdentity:((o=u==null?void 0:u.card)==null?void 0:o.color_identity)||(u==null?void 0:u.color_identity)||((r=u==null?void 0:u.scryfallCard)==null?void 0:r.color_identity),commanderName:((l=u==null?void 0:u.card)==null?void 0:l.name)||(u==null?void 0:u.name),allCommanderKeys:u?Object.keys(u):[],cardKeys:u!=null&&u.card?Object.keys(u.card):[]};console.log("üîç Oracle Tag Search Debug:",d);const k=`/api/cards/typesense-search?q=${encodeURIComponent(i)}${_?`&colorIdentity=${_}`:""}${n&&n.format?`&deckFormat=${encodeURIComponent(n.format)}`:""}`,I=!1?k:`${k}`;console.log("üîó Oracle Tag Search URL Analysis:"),console.log("  - Oracle Tag:",e),console.log("  - Search Query:",i),console.log("  - Color ID:",_),console.log("  - Color ID Length:",(_==null?void 0:_.length)||0),console.log("  - Deck Format:",n==null?void 0:n.format),console.log("  - Final URL:",I),console.log("  - URL includes colorIdentity param:",I.includes("colorIdentity="));const x=await fetch(I);if(!x.ok)throw new Error(`Search failed: ${x.status} ${x.statusText}`);const h=await x.json(),j=h.data||h||[],$=Array.isArray(j)?j.map(S=>{if(gt[S.name]){const E=ln(S.name);if(S.id===E||S.scryfall_id===E)return{...S,_isPreferredPrinting:!0}}return S}).sort((S,N)=>S._isPreferredPrinting&&!N._isPreferredPrinting?-1:!S._isPreferredPrinting&&N._isPreferredPrinting?1:0):[];console.log(`üèûÔ∏è [ORACLE TAG] Processed ${$.length} results with basic land preferences`),Te($)}catch(i){console.error("Error in oracle tag search modal:",i),Te([]),_t(`Oracle Tag Error: ${e}`),P.error(`Failed to search for oracle tag "${e}": ${i.message}`)}finally{It(!1)}},[It,Je,Te,_t,vn,n]);R.useEffect(()=>(Co($t),()=>{Co.cancel()}),[$t]),R.useEffect(()=>{if(!Yt)return;const e=a=>{a.target.closest(".search-container")||Pt(!1)},t=a=>{a.key==="Escape"&&Pt(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[Yt]),R.useEffect(()=>{},[n]);const Gn=R.useMemo(()=>(e,t)=>e.sort((a,o)=>{var i,c;const r=((i=a.card)==null?void 0:i.name)||a.name||"",l=((c=o.card)==null?void 0:c.name)||o.name||"";if(t.includes("price")){const _=Vt(a),u=Vt(o);let C=parseFloat(_.price)||0,d=parseFloat(u.price)||0;switch(t){case"price-asc":return C===d?r.localeCompare(l):C-d;case"price-desc":return d===C?r.localeCompare(l):d-C;default:return r.localeCompare(l)}}switch(t){case"name-asc":return r.localeCompare(l);case"name-desc":return l.localeCompare(r);default:return r.localeCompare(l)}}),[]);R.useMemo(()=>{if(!n)return[];try{const e=gn(n),t=(()=>{var o;if(!n||!n.commander)return[];if(Array.isArray(n.commander))return n.commander.length===0?[]:n.commander.map(r=>{var i;if(!r)return"";const l=((i=r.card)==null?void 0:i.name)||r.name||r;return typeof l=="string"?l.toLowerCase():""}).filter(r=>r.length>0);{const r=n.commander,l=((o=r.card)==null?void 0:o.name)||r.name||r;return typeof l=="string"&&l.trim()?[l.toLowerCase()]:[]}})();let a;switch(Fe){case"manaValue":a=eo(e,t);break;case"colorIdentity":a=to(e,t);break;case"collectionStatus":a=yo(e,t);break;case"type":default:a=pn(e,t)}return Array.isArray(a)&&yn(a,o=>{o&&Array.isArray(o.cards)&&(o.cards=Gn(o.cards,xt))}),a}catch(e){return console.error("Error grouping cards:",e),[]}},[n,Fe,xt]);const qo=R.useMemo(()=>{const t=wn(F||[]).reduce((a,o)=>{var C,d,k,f,m;const r=((C=o.card)==null?void 0:C.name)||o.name||"Unknown",l=o.count||o.quantity||1,i=o.foil===!0||((d=o.card)==null?void 0:d.foil)===!0||((k=o.cardObj)==null?void 0:k.foil)===!0||((m=(f=o.cardObj)==null?void 0:f.card)==null?void 0:m.foil)===!0,c=`${r}-${o.printing||"default"}-${i?"foil":"nonfoil"}`;let _;if(he.current.has(c))_=he.current.get(c);else{const I={...o,foil:i,card:{...o.card,foil:i}};_=Vt(I),he.current.set(c,_)}const u=parseFloat(_.price)||0;return a+u*l},0);return Bn(t,{showCurrency:!1})},[F]),Go=R.useMemo(()=>{if(!(n!=null&&n.sideboard)||n.sideboard.length===0)return[];let e;const t=n.sideboard;return Fe==="type"?e=pn(t,mn):Fe==="manaValue"?e=eo(t):Fe==="colorIdentity"?e=to(t):Fe==="collectionStatus"&&(e=yo(t)),e&&xt&&e.forEach(o=>{o.cards&&(o.cards=Gn(o.cards,xt))}),e||[]},[n==null?void 0:n.sideboard,Fe,xt,mn]),Vo=R.useMemo(()=>{if(!(n!=null&&n.techIdeas)||n.techIdeas.length===0)return[];let e;const t=n.techIdeas;return Fe==="type"?e=pn(t,mn):Fe==="manaValue"?e=eo(t):Fe==="colorIdentity"?e=to(t):Fe==="collectionStatus"&&(e=yo(t)),e&&xt&&e.forEach(o=>{o.cards&&(o.cards=Gn(o.cards,xt))}),e||[]},[n==null?void 0:n.techIdeas,Fe,xt,mn]),vt=R.useMemo(()=>{try{let e;const t=F||(n==null?void 0:n.cards)||[];if(t.length===0)return[];const a=Array.isArray(mn)?mn:[];if(Fe==="type"?e=pn(t,a):Fe==="manaValue"?e=eo(t,a):Fe==="colorIdentity"?e=to(t,a):(Fe==="collectionStatus"&&console.warn("Collection status grouping not supported in deck view, falling back to type grouping"),e=pn(t,a)),Array.isArray(e))for(let o=0;o<e.length;o++){const r=e[o];try{Array.isArray(r.cards)||(r.cards=[]);try{Array.isArray(r.cards)||(r.cards=[]);const l=[...r.cards];r.cards=Gn(l,xt)}catch(l){throw console.error("[FOREACH DEBUG] Error in sortCards:",l,"group.cards:",r.cards),console.error("[FOREACH DEBUG] sortBy:",xt),l}}catch(l){console.error("[FOREACH DEBUG] Error processing group:",l)}}else console.error("[FOREACH DEBUG] cardGroups is not an array in groupedAndSortedCards:",typeof e,e),e=[];return e}catch(e){throw console.error("[FOREACH DEBUG] Error in groupedAndSortedCards useMemo:",e),console.error("[FOREACH DEBUG] Error stack:",e.stack),e}},[F,Fe,xt,mn]),Vn=R.useCallback(e=>{var c,_,u,C;if(!p.isOpen||!p.cardObj)return;if(z.isActive&&z.searchResults.length>0){const d=z.currentIndex;let k;if(e==="previous")k=d-1,k<0&&(k=z.searchResults.length-1);else if(e==="next")k=d+1,k>=z.searchResults.length&&(k=0);else return;const f=z.searchResults[k];if(!f)return;console.log(`[ORACLE TAG NAVIGATION] Moving to ${e} card: ${f.name} (${k+1}/${z.searchResults.length})`);const m={name:f.name,printing:f.scryfall_id||f.id,cardObj:{name:f.name,scryfall_id:f.scryfall_id||f.id,set:f.set,collector_number:f.collector_number,image_uris:f.image_uris,type_line:f.type_line,mana_cost:f.mana_cost,oracle_text:f.oracle_text,power:f.power,toughness:f.toughness,cmc:f.cmc||f.converted_mana_cost,rarity:f.rarity,prices:f.prices,card_faces:f.card_faces},card:{name:f.name,scryfall_json:f,type_line:f.type_line},scryfall_json:f,foil:!1,count:1,modalPrice:((c=f.prices)==null?void 0:c.usd)||((_=f.prices)==null?void 0:_.usd_foil)||"0.00"};L({isOpen:!0,cardObj:m}),q(I=>({...I,currentIndex:k}));return}const t=((u=p.cardObj.card)==null?void 0:u.name)||p.cardObj.name;if(!t)return;const a=[];try{if(Array.isArray(vt)){console.log("[NUCLEAR SAFETY] About to forEach on groupedAndSortedCards:",{isArray:Array.isArray(vt),type:typeof vt,length:vt==null?void 0:vt.length,value:vt});const d=Array.isArray(vt)?vt:[];for(let k=0;k<d.length;k++){const f=d[k];try{if(f&&Array.isArray(f.cards)){const m=Array.isArray(f.cards)?f.cards:[];for(let I=0;I<m.length;I++){const x=m[I];x&&a.push(x)}}}catch(m){console.error("[NUCLEAR SAFETY] Error processing group:",f,m)}}}else console.error("[NUCLEAR SAFETY] groupedAndSortedCards is not an array:",{type:typeof vt,value:vt,isNull:vt===null,isUndefined:vt===void 0})}catch(d){console.error("[NUCLEAR SAFETY] Critical error in card flattening:",d),console.trace()}const o=a.findIndex(d=>{var f;return(((f=d.card)==null?void 0:f.name)||d.name)===t});if(o===-1)return;let r;if(e==="previous")r=o-1,r<0&&(r=a.length-1);else if(e==="next")r=o+1,r>=a.length&&(r=0);else return;const l=a[r];if(!l)return;const i={...l,cardObj:l,name:((C=l.card)==null?void 0:C.name)||l.name};L({isOpen:!0,cardObj:i})},[p,vt,z]),Ko=R.useCallback(()=>{Vn("previous")},[Vn]),Xo=R.useCallback(()=>{Vn("next")},[Vn]),Qo=R.useCallback(e=>{St(t=>{var a,o;return{...t,card:{...e,image_uris:e.image_uris||((a=e.scryfall_json)==null?void 0:a.image_uris),flipped:((o=t.card)==null?void 0:o.flipped)||!1}}})},[St]),Jo=R.useCallback(e=>{if(!F||!e)return!1;const t=e.name;return t?F.some(a=>{var r;return(((r=a.card)==null?void 0:r.name)||a.name)===t}):!1},[F]);function Io(e,t={}){var a,o,r,l,i,c,_,u,C,d,k,f;if(!e){console.error("[DeckViewEdit] Cannot update card: missing card object"),P.error("Failed to update card: Missing card data");return}if(!Array.isArray(F)){console.error("[FOREACH DEBUG] handleUpdateCard: cards is not an array:",typeof F,F),P.error("Failed to update card: Invalid deck data");return}try{if(t.freshPriceDataOnly&&t.scryfall_json){const m=((a=e.card)==null?void 0:a.name)||e.name;if(!m){console.error("[DeckViewEdit] Cannot update fresh price data: missing card name");return}const I=Date.now(),x=F.map(h=>{var $;if(((($=h.card)==null?void 0:$.name)||h.name)===m){const S={...h,...h.scryfall_json?{scryfall_json:{...h.scryfall_json,...t.scryfall_json}}:{},...h.card?{card:{...h.card,...h.card.scryfall_json?{scryfall_json:{...h.card.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},...h.cardObj?{cardObj:{...h.cardObj,...h.cardObj.card?{card:{...h.cardObj.card,...h.cardObj.card.scryfall_json?{scryfall_json:{...h.cardObj.card.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},...h.cardObj.scryfall_json?{scryfall_json:{...h.cardObj.scryfall_json,...t.scryfall_json}}:{scryfall_json:t.scryfall_json}}}:{},lastUpdated:I};return t.modalPrice!==void 0&&(S.modalPrice=t.modalPrice,S.card&&(S.card.modalPrice=t.modalPrice),S.cardObj&&(S.cardObj.modalPrice=t.modalPrice,S.cardObj.card&&(S.cardObj.card.modalPrice=t.modalPrice))),S}return h});le(h=>({...h,cards:x,lastUpdated:I}));return}if(t.printing&&t.scryfall_json){const m=t.scryfall_json||null;if(m){t.modalPrice!==void 0&&(m.modalPrice=t.modalPrice),t.foil!==void 0&&(m.modalFoilStatus=t.foil);const I=Be==null?void 0:Be.card,x=((o=e.card)==null?void 0:o.name)||e.name,h=(I==null?void 0:I.name)||((r=I==null?void 0:I.card)==null?void 0:r.name);I&&h===x&&St({card:{...I,printing:t.printing,scryfall_json:t.scryfall_json,modalPrice:t.modalPrice,image_uris:t.image_uris||((l=t.scryfall_json)==null?void 0:l.image_uris),card_faces:t.card_faces||((i=t.scryfall_json)==null?void 0:i.card_faces)},top:0,left:0}),Do(e,m)}else console.error("[DeckViewEdit] Cannot update printing: missing scryfall_json data"),P.error("Failed to update card printing: Missing card data");return}if(t.quantity!==void 0)try{if(t.quantity<1){Kn(e);return}const m=((c=e.card)==null?void 0:c.name)||e.name;if(!m){console.error("[DeckViewEdit] Cannot update quantity: missing card name"),P.error("Failed to update quantity: Missing card data");return}const I=Date.now();let x=[],h=!1;console.log(`[QUANTITY DEBUG] Looking for card to update: "${m}", quantity: ${t.quantity}`),console.log("[QUANTITY DEBUG] CardObj data:",{name:m,foil:e.foil||((_=e.card)==null?void 0:_.foil)||!1,printing:e.printing||((u=e.card)==null?void 0:u.printing)||((C=e.cardObj)==null?void 0:C.printing)}),F.forEach(E=>{var re,ve,Ze,ie,me,je,qe;const v=((re=E.card)==null?void 0:re.name)||E.name,W=e.foil||((ve=e.card)==null?void 0:ve.foil)||!1,U=E.foil||((Ze=E.card)==null?void 0:Ze.foil)||!1,A=e.printing||((ie=e.card)==null?void 0:ie.printing)||((me=e.cardObj)==null?void 0:me.printing),D=E.printing||((je=E.card)==null?void 0:je.printing)||((qe=E.cardObj)==null?void 0:qe.printing),B=v===m,y=W===U,G=A&&D&&A===D,O=m&&gt[m],b=!A||!D,te=G||O||b;if(v===m&&console.log(`[QUANTITY DEBUG] Found potential match: "${v}"`,{nameMatches:B,foilMatches:`${W} === ${U} = ${y}`,exactPrintingMatch:`${A} === ${D} = ${G}`,isBasicLand:O,noPrintingInfo:b,printingMatches:te,overallMatch:B&&y&&te,currentCount:E.count}),B&&y&&te){if(!h){h=!0,console.log(`[QUANTITY DEBUG] Updating card "${v}" from quantity ${E.count} to ${t.quantity}`);const yt={...E,count:t.quantity,quantity:t.quantity,...E.card?{card:{...E.card,count:t.quantity,quantity:t.quantity}}:{},...E.cardObj?{cardObj:{...E.cardObj,count:t.quantity,quantity:t.quantity,...E.cardObj.card?{card:{...E.cardObj.card,count:t.quantity,quantity:t.quantity}}:{}}}:{}};x.push(yt)}}else x.push(E)});const j=x.find(E=>{var v;return(((v=E.card)==null?void 0:v.name)||E.name)===m}),$=x.map(E=>({...E}));if(console.log(`[QUANTITY DEBUG] Final result - found match: ${h}, total cards: ${$.length}`),h){const E=$.find(v=>{var W;return(((W=v.card)==null?void 0:W.name)||v.name)===m});console.log("[QUANTITY DEBUG] Updated card final state:",{name:((d=E==null?void 0:E.card)==null?void 0:d.name)||(E==null?void 0:E.name),count:E==null?void 0:E.count,quantity:E==null?void 0:E.quantity})}Y($),le(E=>{if(!E)return E;const v=E.cards.map(U=>{var D,B;return(U.name||((D=U.card)==null?void 0:D.name)||((B=U.cardObj)==null?void 0:B.name))===m?{...U,count:t.quantity,quantity:t.quantity,...U.card?{card:{...U.card,count:t.quantity,quantity:t.quantity,id:U.card.id||U.card.scryfall_id,scryfall_id:U.card.scryfall_id||U.card.id,set:U.card.set,set_name:U.card.set_name,collector_number:U.card.collector_number}}:{},...U.cardObj?{cardObj:{...U.cardObj,id:U.cardObj.id||U.cardObj.scryfall_id,scryfall_id:U.cardObj.scryfall_id||U.cardObj.id,set:U.cardObj.set,set_name:U.cardObj.set_name,collector_number:U.cardObj.collector_number,count:t.quantity,quantity:t.quantity,...U.cardObj.card?{card:{...U.cardObj.card,count:t.quantity,quantity:t.quantity}}:{}}}:{}}:U});return{...E,cards:[...v],lastUpdated:I}}),lt(E=>E+1),Fe&&rn(E=>E+1);const S=Be==null?void 0:Be.card,N=(S==null?void 0:S.name)||((k=S==null?void 0:S.card)==null?void 0:k.name);S&&N===m&&St({card:{...S,count:t.quantity,...S.card?{card:{...S.card,count:t.quantity}}:{}},top:0,left:0}),p.isOpen&&p.cardObj&&t.quantity!==void 0&&(((f=p.cardObj.card)==null?void 0:f.name)||p.cardObj.name)===m&&L(v=>({...v,cardObj:{...v.cardObj,count:t.quantity,card:v.cardObj.card?{...v.cardObj.card,count:t.quantity}:v.cardObj.card}}));try{const E=localStorage.getItem("token");if(!E){console.error("[DeckViewEdit] No authentication token found for server update"),P.error("Quantity updated locally but cannot save to server: Not logged in");return}(async function(){const W=y=>y&&typeof y=="string"&&/^[0-9a-fA-F]{24}$/.test(y),U=x.map(y=>{var b,te,re,ve,Ze,ie,me,je,qe,yt,Ge,ke,ht,et,Ke,Ie,De,ge,ue,ee,xe,Ee,Ae,Ft,wt,Zt,kn,$n,Pn,Nn,An,Rn,Tn,Mn,Fn,On,Un,Dn;const G=y.modalPrice!==void 0&&y.modalPrice!==null&&y.modalPrice!=="undefined"?y.modalPrice:null;(((b=y.card)==null?void 0:b.name)||y.name)==="Island"&&console.log("[CARD CLEANING DEBUG] Island before cleaning:",{name:((te=y.card)==null?void 0:te.name)||y.name,originalCount:y.count,countExists:"count"in y,cardStructure:Object.keys(y)});let O={name:((re=y.card)==null?void 0:re.name)||y.name,count:y.count||1,quantity:y.count||1,printing:y.printing||null,isCommander:y.isCommander||!1,...y.foil!==void 0?{foil:y.foil}:{},set:y.set||((ve=y.card)==null?void 0:ve.set)||((Ze=y.scryfall_json)==null?void 0:Ze.set),collector_number:y.collector_number||((ie=y.card)==null?void 0:ie.collector_number)||((me=y.scryfall_json)==null?void 0:me.collector_number),finishes:y.finishes||((je=y.scryfall_json)==null?void 0:je.finishes)||["nonfoil"],prices:y.prices||((qe=y.card)==null?void 0:qe.prices)||((yt=y.scryfall_json)==null?void 0:yt.prices)||{},mana_cost:y.mana_cost||((Ge=y.card)==null?void 0:Ge.mana_cost)||((ke=y.scryfall_json)==null?void 0:ke.mana_cost),color_identity:y.color_identity||((ht=y.card)==null?void 0:ht.color_identity)||((et=y.scryfall_json)==null?void 0:et.color_identity),cmc:y.cmc||((Ke=y.card)==null?void 0:Ke.cmc)||((Ie=y.scryfall_json)==null?void 0:Ie.cmc),type_line:y.type_line||((De=y.card)==null?void 0:De.type_line)||((ge=y.scryfall_json)==null?void 0:ge.type_line),scryfall_id:y.scryfall_id||((ue=y.card)==null?void 0:ue.scryfall_id)||((ee=y.scryfall_json)==null?void 0:ee.id),...G!==null?{modalPrice:G}:{}};return y._id&&W(y._id)&&(O._id=y._id),y.card?typeof y.card=="object"&&y.card!==null?y.card._id&&W(y.card._id)?O.card=y.card._id:O.card={name:y.card.name||y.name,set:y.card.set||y.set||((xe=y.scryfall_json)==null?void 0:xe.set),collector_number:y.card.collector_number||y.collector_number||((Ee=y.scryfall_json)==null?void 0:Ee.collector_number),mana_cost:y.card.mana_cost||y.mana_cost||((Ae=y.scryfall_json)==null?void 0:Ae.mana_cost),color_identity:y.card.color_identity||y.color_identity||((Ft=y.scryfall_json)==null?void 0:Ft.color_identity),cmc:y.card.cmc||y.cmc||((wt=y.scryfall_json)==null?void 0:wt.cmc),type_line:y.card.type_line||y.type_line||((Zt=y.scryfall_json)==null?void 0:Zt.type_line),...y.card._id&&W(y.card._id)?{_id:y.card._id}:{}}:typeof y.card=="string"&&(W(y.card)?O.card=y.card:O.card={name:y.name,set:y.set||((kn=y.scryfall_json)==null?void 0:kn.set),collector_number:y.collector_number||(($n=y.scryfall_json)==null?void 0:$n.collector_number),mana_cost:y.mana_cost||((Pn=y.scryfall_json)==null?void 0:Pn.mana_cost),color_identity:y.color_identity||((Nn=y.scryfall_json)==null?void 0:Nn.color_identity),cmc:y.cmc||((An=y.scryfall_json)==null?void 0:An.cmc),type_line:y.type_line||((Rn=y.scryfall_json)==null?void 0:Rn.type_line)}):O.card={name:y.name,set:y.set||((Tn=y.scryfall_json)==null?void 0:Tn.set),collector_number:y.collector_number||((Mn=y.scryfall_json)==null?void 0:Mn.collector_number),mana_cost:y.mana_cost||((Fn=y.scryfall_json)==null?void 0:Fn.mana_cost),color_identity:y.color_identity||((On=y.scryfall_json)==null?void 0:On.color_identity),cmc:y.cmc||((Un=y.scryfall_json)==null?void 0:Un.cmc),type_line:y.type_line||((Dn=y.scryfall_json)==null?void 0:Dn.type_line)},O}),A=U.find(y=>{var G;return(y.name||((G=y.card)==null?void 0:G.name))===m});(m==="Island"||A)&&console.log("[QUANTITY DEBUG] Island data being sent to server:",{found:!!A,cardName:m,islandData:A,updatesQuantity:t.quantity,cleanedCount:A==null?void 0:A.count,cleanedQuantity:A==null?void 0:A.quantity,hasCountField:A?"count"in A:!1,hasQuantityField:A?"quantity"in A:!1}),console.log("[QUANTITY UPDATE] Sending cleaned cards to server:",U);const B=await fetch(`/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E}`,"Cache-Control":"no-cache"},credentials:"include",body:JSON.stringify({cards:U,name:Re||n.name,commander:n.commander,commanderNames:n.commanderNames})});if(!B.ok){console.error(`[DeckViewEdit] Server error updating quantity: ${B.status}`);let y="";try{const G=await B.json();y=G.message||G.error||""}catch{}P.error(`Quantity updated locally but failed to save to server. ${y}`);return}try{const y=await B.json();le(G=>({...G,...y,cards:x})),P.success(`Updated quantity to ${t.quantity}.`)}catch(y){console.error("[DeckViewEdit] Error parsing server response:",y),P.warning("Quantity updated but server response was invalid. Changes may not persist after refresh.")}})()}catch(E){console.error("[DeckViewEdit] Error in server update for quantity:",E),P.error(`Quantity updated locally but failed to save to server: ${E.message}`)}}catch(m){console.error("[DeckViewEdit] Error updating quantity:",m),P.error("Failed to update quantity.")}if(t.isFoil!==void 0||t.foil!==void 0||t.price!==void 0||t.foilToggleAction===!0)try{const m=t.isFoil!==void 0?t.isFoil:t.foil,I=t.price,x=Date.now(),h=F.map(j=>{var U,A,D,B;const $=((U=j.card)==null?void 0:U.name)||j.name,S=((A=e.card)==null?void 0:A.name)||e.name,N=j.printing||((D=j.card)==null?void 0:D.printing),E=e.printing||((B=e.card)==null?void 0:B.printing);if($===S&&(!N||!E||N===E)){const y=JSON.parse(JSON.stringify(j));y.foil=!!m,y.card&&(y.card.foil=!!m),y.cardObj&&(y.cardObj.foil=!!m,y.cardObj.card&&(y.cardObj.card.foil=!!m));const G=Vt(y),O=I??G.price;return y.price=O,y.card&&(y.card.price=O),y.cardObj&&(y.cardObj.price=O,y.cardObj.card&&(y.cardObj.card.price=O)),t.modalPrice!==void 0&&(y.modalPrice=t.modalPrice,y.card&&(y.card.modalPrice=t.modalPrice),y.cardObj&&(y.cardObj.modalPrice=t.modalPrice,y.cardObj.card&&(y.cardObj.card.modalPrice=t.modalPrice))),y.lastUpdated=x,y}return j});Y(h),le(j=>j?{...j,cards:h,lastUpdated:x}:null),(async()=>{try{const j=localStorage.getItem("token");if(!j){P.error("Foil status updated locally but cannot save to server: Not logged in");return}const $="",S=h.map(U=>{var D;const{price:A}=Vt(U);return{name:((D=U.card)==null?void 0:D.name)||U.name,count:U.count||1,foil:!!U.foil,price:A,printing:U.printing||null,...U.modalPrice!==void 0?{modalPrice:U.modalPrice}:{},...U._id?{_id:U._id}:{},...U.card&&U.card._id?{card:{_id:U.card._id,name:U.card.name}}:{}}});S.filter(U=>U.modalPrice!==void 0).length>0;const E=await fetch(`${$}/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j}`,"Cache-Control":"no-cache"},body:JSON.stringify({cards:S,name:Re||n.name,lastUpdated:x,commander:n.commander,commanderNames:n.commanderNames})});if(!E.ok)throw new Error(`Server responded with ${E.status}`);const v=await E.json();le(U=>({...U,...v,cards:h,lastUpdated:Date.now()}));const W=m?" (foil price applied)":"";P.success(`Updated to ${m?"foil":"non-foil"}${W}.`)}catch(j){console.error("[DeckViewEdit] Error saving foil status to server:",j),P.error(`Foil status updated locally but failed to save to server: ${j.message}`)}})()}catch(m){console.error("[DeckViewEdit] Error updating foil status:",m),P.error("Failed to update foil status.")}}catch(m){console.error("[DeckViewEdit] Card update error:",m),P.error(`Failed to update card: ${m.message}`)}}function Kn(e){var a,o,r,l;const t=e.name||((a=e.card)==null?void 0:a.name)||((o=e.cardObj)==null?void 0:o.name)||((l=(r=e.cardObj)==null?void 0:r.card)==null?void 0:l.name);if(!t){console.error("[DeckViewEdit] Failed to remove card: Could not determine card name","Card object structure:",e),P.error("Failed to remove card: Could not determine card name");return}console.log("[DEBUG] Before card removal:",{cardBeingRemoved:t,commanderArray:n==null?void 0:n.commander,commanderNames:n==null?void 0:n.commanderNames,deckId:n==null?void 0:n._id}),console.log("[DEBUG] Full deck object before removal:",n);try{const i=Date.now(),c=F.filter(d=>{var m,I,x,h;return(d.name||((m=d.card)==null?void 0:m.name)||((I=d.cardObj)==null?void 0:I.name)||((h=(x=d.cardObj)==null?void 0:x.card)==null?void 0:h.name))!==t});Y([...c]),le(d=>{if(!d)return d;const k=d.cards.filter(f=>{var I,x,h,j;return(f.name||((I=f.card)==null?void 0:I.name)||((x=f.cardObj)==null?void 0:x.name)||((j=(h=f.cardObj)==null?void 0:h.card)==null?void 0:j.name))!==t});return{...d,cards:[...k],lastUpdated:i}});const _=localStorage.getItem("token");if(!_){console.error("[DeckViewEdit] No authentication token found for server update"),P.error("Card removed locally but cannot save to server: Not logged in");return}const u=c.map(d=>{var k,f,m,I,x,h,j,$,S,N,E,v,W,U,A,D;return{name:d.name||((k=d.card)==null?void 0:k.name),quantity:d.quantity||1,count:d.count||1,isCommander:d.isCommander||!1,set:d.set||((f=d.card)==null?void 0:f.set),collector_number:d.collector_number||((m=d.card)==null?void 0:m.collector_number),finishes:d.finishes||["nonfoil"],prices:d.prices||{},mana_cost:d.mana_cost||((I=d.card)==null?void 0:I.mana_cost),color_identity:d.color_identity||((x=d.card)==null?void 0:x.color_identity),cmc:d.cmc||((h=d.card)==null?void 0:h.cmc),type_line:d.type_line||((j=d.card)==null?void 0:j.type_line),scryfall_id:d.scryfall_id||(($=d.card)==null?void 0:$.scryfall_id),card:{name:d.name||((S=d.card)==null?void 0:S.name),mana_cost:d.mana_cost||((N=d.card)==null?void 0:N.mana_cost),color_identity:d.color_identity||((E=d.card)==null?void 0:E.color_identity),cmc:d.cmc||((v=d.card)==null?void 0:v.cmc),type_line:d.type_line||((W=d.card)==null?void 0:W.type_line),set:d.set||((U=d.card)==null?void 0:U.set),collector_number:d.collector_number||((A=d.card)==null?void 0:A.collector_number),scryfall_id:d.scryfall_id||((D=d.card)==null?void 0:D.scryfall_id)}}}),C="";(async()=>{var d;try{const k={_id:n._id,name:n.name,format:n.format,commander:n.commander,cards:u,...n.sideboard&&{sideboard:n.sideboard},...n.techIdeas&&{techIdeas:n.techIdeas},...n.description&&{description:n.description},...n.colors&&{colors:n.colors}},f=JSON.stringify(k);console.log("[DEBUG] Card removal request body sent to server:",{deckId:k._id,cardsCount:u.length,removedCardName:t,requestSize:f.length,commander:n.commander,commanderNames:n.commanderNames});const m=await fetch(`${C}/api/decks/${T}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${_}`},body:f});if(!m.ok){console.error(`[DeckViewEdit] Server error removing card: ${m.status}`);let S="";try{const N=await m.json();S=N.message||N.error||""}catch{}P.error(`Card removed locally but failed to save to server. ${S}`);return}const I=await m.json();console.log("[DEBUG] Server response after card removal:",{commander:I==null?void 0:I.commander,commanderNames:I==null?void 0:I.commanderNames,cardsCount:(d=I==null?void 0:I.cards)==null?void 0:d.length}),console.log("[DEBUG] Full server response:",I);const x=(I.cards||[]).map(S=>{var E,v,W,U,A;const N=(k.cards||[]).find(D=>{var G,O;const B=S.name||((G=S.card)==null?void 0:G.name),y=D.name||((O=D.card)==null?void 0:O.name);return B===y});return N?{...N,...S,card:{...N.card,...S.card||{},type_line:((E=N.card)==null?void 0:E.type_line)||N.type_line||S.type_line,scryfall_json:((v=N.card)==null?void 0:v.scryfall_json)||N.scryfall_json,mana_cost:((W=N.card)==null?void 0:W.mana_cost)||N.mana_cost,color_identity:((U=N.card)==null?void 0:U.color_identity)||N.color_identity,cmc:((A=N.card)==null?void 0:A.cmc)||N.cmc}}:S}),h=n.commander,j=n.commanderNames,$={...I,cards:x,commander:I.commander||h,commanderNames:I.commanderNames||j};(h&&!I.commander||j&&!I.commanderNames)&&console.log("[COMMANDER FIX] Server lost commander data, restoring from deck state:",{restoringCommander:h,restoringCommanderNames:j,serverReturnedCommander:I.commander,serverReturnedCommanderNames:I.commanderNames}),le(S=>({...S,...$,sideboard:(S==null?void 0:S.sideboard)||[],techIdeas:(S==null?void 0:S.techIdeas)||[]})),P.success("Card removed from deck.")}catch(k){console.error("[DeckViewEdit] Network error removing card:",k),P.error("Card removed locally but failed to save to server.")}})()}catch(i){console.error("[DeckViewEdit] Error in card removal process:",i),P.error("Failed to remove card due to an error.")}}function So(e,t){var a,o,r,l,i,c,_,u,C,d,k;try{const f=(t==null?void 0:t.foil)||(e==null?void 0:e.foil)||!1,m=t||((a=e==null?void 0:e.cardObj)==null?void 0:a.scryfall_json)||(e==null?void 0:e.scryfall_json)||((r=(o=e==null?void 0:e.cardObj)==null?void 0:o.card)==null?void 0:r.scryfall_json)||((l=e==null?void 0:e.card)==null?void 0:l.scryfall_json)||(e==null?void 0:e.cardObj),I={id:`${(m==null?void 0:m.id)||(e==null?void 0:e.printing)||((i=e==null?void 0:e.cardObj)==null?void 0:i.printing)}_${f?"foil":"nonfoil"}_${Date.now()}`,name:(e==null?void 0:e.name)||((c=e==null?void 0:e.cardObj)==null?void 0:c.name)||(m==null?void 0:m.name),set:(m==null?void 0:m.set)||((_=e==null?void 0:e.cardObj)==null?void 0:_.set)||"unknown",set_name:(m==null?void 0:m.set_name)||((u=e==null?void 0:e.cardObj)==null?void 0:u.set_name)||(m==null?void 0:m.set)||"Unknown Set",collector_number:(m==null?void 0:m.collector_number)||((C=e==null?void 0:e.cardObj)==null?void 0:C.collector_number),printing_id:(m==null?void 0:m.id)||(e==null?void 0:e.printing)||((d=e==null?void 0:e.cardObj)==null?void 0:d.printing),rarity:(m==null?void 0:m.rarity)||((k=e==null?void 0:e.cardObj)==null?void 0:k.rarity),foil:f,scryfall_json:m,dateAdded:new Date().toISOString(),quantity:1},x=In.getChunkedItem("cardCollection")||[],h=x.findIndex($=>$.printing_id===I.printing_id&&$.foil===I.foil);if(h>=0?(x[h].quantity+=1,P.success(`Added another copy to collection! Now have ${x[h].quantity} copies.`)):(x.push(I),P.success(`Added ${I.name} (${f?"Foil":"Non-foil"}) to collection!`)),!In.setItem("cardCollection",x,{clearOldData:!0})){P.error("Failed to save collection - storage may be full");return}Fe==="collectionStatus"&&rn($=>$+1)}catch(f){console.error("[Collection] Error adding to collection:",f),P.error("Failed to add card to collection. Please try again.")}}const Yo=async()=>{if(Se.size!==0)try{let e=0,t=0;const a=Array.from(Se);if(!Array.isArray(a)){console.error("[FOREACH DEBUG] handleBulkAddToCollection: selectedCardIds is not an array:",typeof a,a),P.error("Failed to process selected cards: Invalid selection data");return}const o=In.getChunkedItem("cardCollection")||[];if(a.forEach(l=>{var i,c,_,u,C,d,k,f,m,I,x;try{const h=ar(l);if(!h){t++;return}const j=((i=h.cardObj)==null?void 0:i.scryfall_json)||h.scryfall_json||((_=(c=h.cardObj)==null?void 0:c.card)==null?void 0:_.scryfall_json)||((u=h.card)==null?void 0:u.scryfall_json)||h.cardObj,$={id:`${(j==null?void 0:j.id)||h.printing||((C=h.cardObj)==null?void 0:C.printing)||"unknown"}_${h.foil?"foil":"nonfoil"}_${Date.now()}_${Math.random()}`,name:((d=h.card)==null?void 0:d.name)||h.name||(j==null?void 0:j.name)||"Unknown Card",set:(j==null?void 0:j.set)||((k=h.cardObj)==null?void 0:k.set)||h.set||"unknown",set_name:(j==null?void 0:j.set_name)||((f=h.cardObj)==null?void 0:f.set_name)||h.set_name||(j==null?void 0:j.set)||"Unknown Set",collector_number:(j==null?void 0:j.collector_number)||((m=h.cardObj)==null?void 0:m.collector_number)||h.collector_number,printing_id:(j==null?void 0:j.id)||h.printing||((I=h.cardObj)==null?void 0:I.printing),rarity:(j==null?void 0:j.rarity)||((x=h.cardObj)==null?void 0:x.rarity)||h.rarity,foil:h.foil||!1,scryfall_json:j,dateAdded:new Date().toISOString(),quantity:h.count||1},S=o.findIndex(N=>N.printing_id===$.printing_id&&N.foil===$.foil);S>=0?o[S].quantity+=$.quantity:o.push($),e++}catch(h){console.error(`[Bulk Collection] Failed to add card ${l}:`,h),t++}}),!In.setItem("cardCollection",o,{clearOldData:!0})){P.error("Failed to save bulk collection - storage may be full");return}if(Fe==="collectionStatus"&&rn(l=>l+1),e>0&&t===0)P.success(`Successfully added ${e} card${e!==1?"s":""} to collection!`);else if(e>0&&t>0)P.warning(`Added ${e} cards to collection, but ${t} failed.`);else{P.error("Failed to add cards to collection.");return}Rt(new Set),sn(!1)}catch(e){console.error("[Bulk Collection] Error adding cards to collection:",e),P.error("Failed to add cards to collection. Please try again.")}},Zo=async()=>{try{const e=Array.from(Se).map(r=>F.find(l=>{var i;return(((i=l.card)==null?void 0:i.name)||l.name)===r})).filter(Boolean);if(!Array.isArray(e)){console.error("[FOREACH DEBUG] handleBulkAddToWishlist: cardsToAdd is not an array:",typeof e,e),P.error("Failed to process selected cards: Invalid selection data");return}if(e.length===0){P.error("No valid cards selected for wishlist");return}const t=JSON.parse(localStorage.getItem("global-wishlist")||"[]");let a=0,o=0;e.forEach(r=>{var _;const l=r.scryfall_json||r.cardObj||r,i={name:r.name||((_=r.card)==null?void 0:_.name),printing:r.printing||l.scryfall_id||l.id,foil:!1,count:r.count||1,dateAdded:Date.now(),cardObj:{scryfall_id:l.scryfall_id||l.id,name:l.name,set:l.set,set_name:l.set_name,collector_number:l.collector_number,image_uris:l.image_uris,type_line:l.type_line,mana_cost:l.mana_cost,cmc:l.cmc,colors:l.colors,color_identity:l.color_identity,prices:l.prices},scryfall_json:l},c=t.findIndex(u=>u.name===i.name&&u.printing===i.printing);c!==-1?(t[c].count+=r.count||1,o++):(t.push(i),a++)}),localStorage.setItem("global-wishlist",JSON.stringify(t)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:t})),Rt(new Set),sn(!1),P.success(`Added ${a} new cards and updated ${o} existing cards in wishlist`)}catch(e){console.error("Error bulk adding cards to wishlist:",e),P.error("Error adding cards to wishlist")}},lo=(e,t,a="main")=>{if(!bt)return;const o=t.map(i=>{var c;if(a==="tech ideas"){const _=i.cardObj?i:{name:((c=i.card)==null?void 0:c.name)||i.name,count:i.count||i.quantity||1,printing:i.printing,cardObj:i};return ze(_)}else return ze(i.cardObj||i)}),r=o.every(i=>Se.has(i)),l=new Set(Se);r?(o.forEach(i=>l.delete(i)),P.info(`Deselected all ${e} cards from ${a}`)):(o.forEach(i=>l.add(i)),P.info(`Selected all ${e} cards from ${a}`)),Rt(l)},er=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected for removal");return}try{const a=localStorage.getItem("token"),o="",r=[],l=[],i=[];for(const c of Se){const _=(F||(n==null?void 0:n.cards)||[]).find(d=>ze(d)===c);if(_){r.push(_);continue}const u=(e=n.sideboard)==null?void 0:e.find(d=>ze(d)===c);if(u){const d=n.sideboard.findIndex(k=>k===u);l.push({card:u,index:d});continue}const C=(t=n.techIdeas)==null?void 0:t.find(d=>ze(d)===c);if(C){const d=n.techIdeas.findIndex(k=>k===C);i.push({card:C,index:d});continue}}for(const c of r)Kn(c);l.sort((c,_)=>_.index-c.index);for(const{card:c,index:_}of l)await Xn(_);i.sort((c,_)=>_.index-c.index);for(const{card:c,index:_}of i)await Qn(_);le(c=>({...c,cards:F||(n==null?void 0:n.cards)||[],lastUpdated:Date.now()})),Rt(new Set),P.success("Removed selected cards from deck")}catch(a){console.error("Error removing cards from deck:",a),P.error("Failed to remove cards from deck")}},tr=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected");return}try{const a=[],o=[];for(const r of Se){if((F||(n==null?void 0:n.cards)||[]).find(_=>ze(_)===r))continue;const i=(e=n.sideboard)==null?void 0:e.find(_=>ze(_)===r);if(i){const _=n.sideboard.findIndex(u=>u===i);o.push({card:i,index:_});continue}const c=(t=n.techIdeas)==null?void 0:t.find(_=>ze(_)===r);if(c){const _=n.techIdeas.findIndex(u=>u===c);a.push({card:c,index:_});continue}}for(const{card:r,index:l}of o)await co(r,l);a.sort((r,l)=>l.index-r.index);for(const{card:r,index:l}of a)await uo(r,l);Rt(new Set),P.success("Moved selected cards to main deck")}catch(a){console.error("Error moving cards to main deck:",a),P.error("Error moving cards to main deck")}},nr=async()=>{var e,t;if(Se.size===0){P.warning("No cards selected");return}try{const a=[],o=[];for(const r of Se){if((e=n.sideboard)==null?void 0:e.find(_=>ze(_)===r))continue;const i=(F||(n==null?void 0:n.cards)||[]).find(_=>ze(_)===r);if(i){a.push(i);continue}const c=(t=n.techIdeas)==null?void 0:t.find(_=>ze(_)===r);if(c){const _=n.techIdeas.findIndex(u=>u===c);o.push({card:c,index:_});continue}}for(const r of a)await Jn(r);o.sort((r,l)=>l.index-r.index);for(const{card:r,index:l}of o)await mo(r,l);Rt(new Set),P.success("Moved selected cards to sideboard")}catch(a){console.error("Error moving cards to sideboard:",a),P.error("Error moving cards to sideboard")}},or=async()=>{var e,t,a,o,r,l,i,c,_,u,C,d;if(Se.size===0){P.warning("No cards selected");return}try{const k=new Map,f=[],m=[];for(const I of Se){if((e=n.techIdeas)==null?void 0:e.find($=>ze($)===I))continue;const h=(F||(n==null?void 0:n.cards)||[]).find($=>ze($)===I);if(h){const $=((t=h.card)==null?void 0:t.name)||h.name,S=h.printing||((a=h.scryfall_json)==null?void 0:a.id)||((r=(o=h.card)==null?void 0:o.scryfall_json)==null?void 0:r.id),N=h.foil||((l=h.card)==null?void 0:l.foil)||!1,E=`${$}|${S||"unknown"}|${N}`;if(k.has(E)){const v=k.get(E);v.totalCount+=h.count||h.quantity||1,v.cards.push(h)}else k.set(E,{cardName:$,printing:S,foil:N,totalCount:h.count||h.quantity||1,cards:[h],representative:h,zone:"main"});continue}const j=(i=n.sideboard)==null?void 0:i.find($=>ze($)===I);if(j){const $=((c=j.card)==null?void 0:c.name)||j.name,S=j.printing||((_=j.scryfall_json)==null?void 0:_.id)||((C=(u=j.card)==null?void 0:u.scryfall_json)==null?void 0:C.id),N=j.foil||((d=j.card)==null?void 0:d.foil)||!1,E=`${$}|${S||"unknown"}|${N}`,v=n.sideboard.findIndex(W=>W===j);if(k.has(E)){const W=k.get(E);W.totalCount+=j.count||j.quantity||1,W.cards.push(j),W.sideboardIndices=W.sideboardIndices||[],W.sideboardIndices.push(v)}else k.set(E,{cardName:$,printing:S,foil:N,totalCount:j.count||j.quantity||1,cards:[j],representative:j,zone:"sideboard",sideboardIndices:[v]});continue}}for(const[I,x]of k){const h={...x.representative,count:x.totalCount,quantity:x.totalCount};h.card&&(h.card.count=x.totalCount,h.card.quantity=x.totalCount),h.cardObj&&(h.cardObj.count=x.totalCount,h.cardObj.quantity=x.totalCount,h.cardObj.card&&(h.cardObj.card.count=x.totalCount,h.cardObj.card.quantity=x.totalCount)),await Yn(h)}m.sort((I,x)=>x.index-I.index);for(const{card:I,index:x}of m)await fo(I,x);Rt(new Set),P.success("Moved selected cards to tech ideas")}catch(k){console.error("Error moving cards to tech ideas:",k),P.error("Error moving cards to tech ideas")}},rr=()=>{if(!F||!Array.isArray(F)){P.error("No cards to deduplicate");return}const e=new Map;let t=0;F.forEach((o,r)=>{var u,C,d,k,f;const l=((u=o.card)==null?void 0:u.name)||o.name,i=o.printing||((C=o.scryfall_json)==null?void 0:C.id)||((k=(d=o.card)==null?void 0:d.scryfall_json)==null?void 0:k.id),c=o.foil||((f=o.card)==null?void 0:f.foil)||!1;if(!l){console.warn(`[DEDUPE] Skipping card without name at index ${r}`);return}const _=`${l}|${i||"unknown"}|${c}`;if(e.has(_)){const m=e.get(_),I=o.count||o.quantity||1;m.count=(m.count||1)+I,m.quantity=m.count,m.card&&(m.card.count=m.count,m.card.quantity=m.count),m.cardObj&&(m.cardObj.count=m.count,m.cardObj.quantity=m.count,m.cardObj.card&&(m.cardObj.card.count=m.count,m.cardObj.card.quantity=m.count)),t++}else{const m={...o,count:o.count||o.quantity||1,quantity:o.count||o.quantity||1};m.card&&(m.card.count=m.count,m.card.quantity=m.count),m.cardObj&&(m.cardObj.count=m.count,m.cardObj.quantity=m.count,m.cardObj.card&&(m.cardObj.card.count=m.count,m.cardObj.card.quantity=m.count)),e.set(_,m)}});const a=Array.from(e.values());a.length<F.length?(Y(a),le(o=>({...o,cards:a})),Rt(new Set),P.success(`Deduplicated deck: removed ${t} duplicate card entries`)):P.info("No duplicate cards found")},sr=()=>{if(Se.size===0){P.warning("No cards selected for foil toggle");return}const e={foiled:0,unfoiled:0};try{const t=F.map(l=>{var c,_,u,C;const i=ze(l);if(Se.has(i)){const k=!(l.foil===!0||((c=l.card)==null?void 0:c.foil)===!0||((_=l.cardObj)==null?void 0:_.foil)===!0||((C=(u=l.cardObj)==null?void 0:u.card)==null?void 0:C.foil)===!0);return k?e.foiled++:e.unfoiled++,{...l,foil:k,...l.card?{card:{...l.card,foil:k}}:{},...l.cardObj?{cardObj:{...l.cardObj,foil:k,...l.cardObj.card?{card:{...l.cardObj.card,foil:k}}:{}}}:{}}}return l});Y([...t]),le(l=>{if(!l)return l;const i=l.cards.map(c=>{var u,C,d,k;const _=ze(c);if(Se.has(_)){const m=!(c.foil===!0||((u=c.card)==null?void 0:u.foil)===!0||((C=c.cardObj)==null?void 0:C.foil)===!0||((k=(d=c.cardObj)==null?void 0:d.card)==null?void 0:k.foil)===!0);return{...c,foil:m,...c.card?{card:{...c.card,foil:m}}:{},...c.cardObj?{cardObj:{...c.cardObj,foil:m,...c.cardObj.card?{card:{...c.cardObj.card,foil:m}}:{}}}:{}}}return c});return{...l,cards:[...i],lastUpdated:Date.now()}}),Rt(new Set);const a=e.foiled+e.unfoiled;let o=`Updated ${a} card${a!==1?"s":""}`;e.foiled>0&&e.unfoiled>0?o+=` (${e.foiled} to foil, ${e.unfoiled} to non-foil)`:e.foiled>0?o+=" to foil":o+=" to non-foil",P.success(o);const r=localStorage.getItem("token")}catch(t){console.error("[DeckViewEdit] Error toggling foil status:",t),P.error("Failed to toggle foil status")}},ar=e=>(F&&F.length>0?F:(n==null?void 0:n.cards)||[]).find(a=>{var c,_;const o=((c=a.card)==null?void 0:c.name)||a.name,r=a.printing||((_=a.cardObj)==null?void 0:_.printing),l=a.foil||!1;return`${o}_${r||"unknown"}_${l}`===e}),jo=e=>{var o,r,l,i;const a=xo(e)!=="exact-match";return a||e.name||(o=e.cardObj)!=null&&o.name||(l=(r=e.cardObj)==null?void 0:r.card)!=null&&l.name||(i=e.card)==null||i.name,a},bn=e=>{var l,i,c,_,u,C,d;const t=e.name||((l=e.card)==null?void 0:l.name)||"Unknown Card",a=e.count||e.quantity||1;let o="";(c=(i=e.card)==null?void 0:i.scryfall_json)!=null&&c.set?o=e.card.scryfall_json.set.toUpperCase():(_=e.card)!=null&&_.set?o=e.card.set.toUpperCase():e.set&&(o=e.set.toUpperCase());let r="";return(C=(u=e.card)==null?void 0:u.scryfall_json)!=null&&C.collector_number?r=e.card.scryfall_json.collector_number:(d=e.card)!=null&&d.collector_number?r=e.card.collector_number:e.collector_number&&(r=e.collector_number),o&&r?`${a} ${t} [${o}] ${r}`:o?`${a} ${t} [${o}]`:`${a} ${t}`},ir=()=>{try{if(!n||!F||F.length===0){P.warning("No cards to export");return}let e=`${n.name||"Untitled Deck"}
`;e+=`Generated on ${new Date().toLocaleDateString()}
`,e+=`Format: TCGPlayer Mass Entry Compatible

`,e+=`MAIN DECK:
`,e+=`=========
`;const t=(F||[]).sort((l,i)=>{var u,C;const c=(l.name||((u=l.card)==null?void 0:u.name)||"Unknown Card").toLowerCase(),_=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase();return c.localeCompare(_)});if(!Array.isArray(t)){console.error("[FOREACH DEBUG] handleExportToText: sortedCards is not an array:",typeof t,t),P.error("Failed to export: Invalid deck data");return}if(t.forEach(l=>{e+=bn(l)+`
`}),e+=`
Main Deck Total: ${F.length} cards
`,n.sideboard&&n.sideboard.length>0){e+=`
SIDEBOARD:
`,e+=`==========
`;const l=n.sideboard.sort((i,c)=>{var C,d;const _=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase(),u=(c.name||((d=c.card)==null?void 0:d.name)||"Unknown Card").toLowerCase();return _.localeCompare(u)});if(!Array.isArray(l)){console.error("[FOREACH DEBUG] handleExportToText: sortedSideboard is not an array:",typeof l,l),P.error("Failed to export sideboard: Invalid data");return}l.forEach(i=>{e+=bn(i)+`
`}),e+=`
Sideboard Total: ${n.sideboard.length} cards
`}if(n.techIdeas&&n.techIdeas.length>0){e+=`
TECH IDEAS:
`,e+=`===========
`;const l=n.techIdeas.sort((i,c)=>{var C,d;const _=(i.name||((C=i.card)==null?void 0:C.name)||"Unknown Card").toLowerCase(),u=(c.name||((d=c.card)==null?void 0:d.name)||"Unknown Card").toLowerCase();return _.localeCompare(u)});if(!Array.isArray(l)){console.error("[FOREACH DEBUG] handleExportToText: sortedTechIdeas is not an array:",typeof l,l),P.error("Failed to export tech ideas: Invalid data");return}l.forEach(i=>{e+=bn(i)+`
`}),e+=`
Tech Ideas Total: ${n.techIdeas.length} cards
`}const a=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=`${n.name||"deck"}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),P.success("Deck list exported to text file!")}catch(e){console.error("[EXPORT] Error exporting to text:",e),P.error("Failed to export deck list to text")}},lr=async()=>{try{if(!n||!F||F.length===0){P.error("No deck or cards available for PDF export");return}P.info("Generating optimized PDF with compressed images...");const e=async E=>{var W,U,A,D,B,y,G,O,b,te,re,ve,Ze,ie,me,je,qe,yt,Ge;console.log("[EXPORT] Full card structure for:",((W=E.card)==null?void 0:W.name)||E.name,{hasCardObj:!!E.cardObj,hasImageUris:!!E.image_uris,hasCardImageUris:!!((U=E.card)!=null&&U.image_uris),hasScryfallJson:!!E.scryfall_json,hasCardObjScryfallJson:!!((A=E.cardObj)!=null&&A.scryfall_json)});const v=((B=(D=E.cardObj)==null?void 0:D.image_uris)==null?void 0:B.normal)||((O=(G=(y=E.cardObj)==null?void 0:y.card)==null?void 0:G.image_uris)==null?void 0:O.normal)||((te=(b=E.scryfall_json)==null?void 0:b.image_uris)==null?void 0:te.normal)||((Ze=(ve=(re=E.cardObj)==null?void 0:re.scryfall_json)==null?void 0:ve.image_uris)==null?void 0:Ze.normal)||((me=(ie=E.card)==null?void 0:ie.image_uris)==null?void 0:me.normal)||((je=E.image_uris)==null?void 0:je.normal);if(console.log("[EXPORT] Found image URL for",((qe=E.card)==null?void 0:qe.name)||E.name,":",v?"YES":"NO"),!v)return console.log("[EXPORT] No image URL found for card:",((yt=E.card)==null?void 0:yt.name)||E.name),null;try{return await new Promise(ke=>{const ht=async et=>new Promise(Ke=>{const Ie=new Image;Ie.crossOrigin="anonymous",Ie.onload=()=>{var De;try{const ge=document.createElement("canvas"),ue=ge.getContext("2d"),ee=Ie.naturalWidth||Ie.width||200,xe=Ie.naturalHeight||Ie.height||280;ge.width=ee,ge.height=xe;const Ee=15;ue.beginPath(),ue.moveTo(Ee,0),ue.lineTo(ee-Ee,0),ue.quadraticCurveTo(ee,0,ee,Ee),ue.lineTo(ee,xe-Ee),ue.quadraticCurveTo(ee,xe,ee-Ee,xe),ue.lineTo(Ee,xe),ue.quadraticCurveTo(0,xe,0,xe-Ee),ue.lineTo(0,Ee),ue.quadraticCurveTo(0,0,Ee,0),ue.closePath(),ue.clip();const Ae=200,Ft=Math.round(Ae/Ie.naturalWidth*Ie.naturalHeight);ge.width=Ae,ge.height=Ft;const wt=Math.round(Ee*(Ae/Ie.naturalWidth));ue.beginPath(),ue.moveTo(wt,0),ue.lineTo(Ae-wt,0),ue.quadraticCurveTo(Ae,0,Ae,wt),ue.lineTo(Ae,Ft-wt),ue.quadraticCurveTo(Ae,Ft,Ae-wt,Ft),ue.lineTo(wt,Ft),ue.quadraticCurveTo(0,Ft,0,Ft-wt),ue.lineTo(0,wt),ue.quadraticCurveTo(0,0,wt,0),ue.closePath(),ue.clip(),ue.drawImage(Ie,0,0,Ae,Ft);const Zt=ge.toDataURL("image/png",.8);console.log("[EXPORT] Successfully loaded via proxy with size optimization for:",((De=E.card)==null?void 0:De.name)||E.name),Ke(Zt)}catch(ge){console.log("[EXPORT] Proxy canvas conversion failed:",ge),Ke(null)}},Ie.onerror=()=>{console.log("[EXPORT] Proxy image load failed"),Ke(null)},setTimeout(()=>{console.log("[EXPORT] Proxy method timed out after 8 seconds"),Ke(null)},8e3),Ie.src=et});(async()=>{console.log(`[EXPORT] Trying to load image: ${v}`),console.log("[EXPORT] Trying method 1: api.codetabs.com proxy");let et=await ht(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(v)}`);if(et){console.log("[EXPORT] Success with api.codetabs.com proxy"),ke(et);return}if(console.log("[EXPORT] Trying method 2: allorigins.win proxy"),et=await ht(`https://api.allorigins.win/raw?url=${encodeURIComponent(v)}`),et){console.log("[EXPORT] Success with allorigins.win proxy"),ke(et);return}if(console.log("[EXPORT] Trying method 3: cors-anywhere.herokuapp.com proxy"),et=await ht(`https://cors-anywhere.herokuapp.com/${v}`),et){console.log("[EXPORT] Success with cors-anywhere.herokuapp.com proxy"),ke(et);return}const Ke=new Image;Ke.onload=()=>{var Ie;try{const De=document.createElement("canvas"),ge=De.getContext("2d"),ue=200,ee=Math.round(ue/(Ke.naturalWidth||488)*(Ke.naturalHeight||680));De.width=ue,De.height=ee;const xe=Math.round(15*(ue/(Ke.naturalWidth||488)));ge.beginPath(),ge.moveTo(xe,0),ge.lineTo(ue-xe,0),ge.quadraticCurveTo(ue,0,ue,xe),ge.lineTo(ue,ee-xe),ge.quadraticCurveTo(ue,ee,ue-xe,ee),ge.lineTo(xe,ee),ge.quadraticCurveTo(0,ee,0,ee-xe),ge.lineTo(0,xe),ge.quadraticCurveTo(0,0,xe,0),ge.closePath(),ge.clip(),ge.drawImage(Ke,0,0,ue,ee);const Ee=De.toDataURL("image/png",.8);console.log("[EXPORT] Successfully loaded directly with size optimization for:",((Ie=E.card)==null?void 0:Ie.name)||E.name),ke(Ee)}catch(De){console.log("[EXPORT] Direct canvas conversion failed:",De),ke(null)}},Ke.onerror=()=>{console.log("[EXPORT] Direct image load failed"),ke(null)},setTimeout(()=>{var Ie;console.log("[EXPORT] All image loading methods failed, creating placeholder");try{const De=document.createElement("canvas"),ge=De.getContext("2d"),ue=200,ee=280;De.width=ue,De.height=ee,ge.fillStyle="#f0f0f0",ge.fillRect(0,0,ue,ee),ge.strokeStyle="#ccc",ge.lineWidth=2,ge.strokeRect(1,1,ue-2,ee-2),ge.fillStyle="#666",ge.font="14px Arial",ge.textAlign="center";const xe=((Ie=E.card)==null?void 0:Ie.name)||E.name||"Unknown Card",Ee=xe.split(" ");let Ae=ee/2-10;for(let wt=0;wt<Ee.length;wt+=2){const Zt=Ee.slice(wt,wt+2).join(" ");ge.fillText(Zt,ue/2,Ae),Ae+=20}const Ft=De.toDataURL("image/png",.8);console.log("[EXPORT] Created placeholder for:",xe),ke(Ft)}catch(De){console.log("[EXPORT] Failed to create placeholder:",De),ke(null)}},5e3),Ke.src=v})()})}catch(ke){return console.log("[EXPORT] Error loading image for",((Ge=E.card)==null?void 0:Ge.name)||E.name,":",ke),null}},t=E=>{var W,U;const v=E.type_line||((W=E.card)==null?void 0:W.type_line)||((U=E.scryfall_json)==null?void 0:U.type_line)||"";return v.includes("Land")?{type:"Lands",priority:7}:v.includes("Creature")?{type:"Creatures",priority:2}:v.includes("Instant")?{type:"Instants",priority:4}:v.includes("Sorcery")?{type:"Sorceries",priority:5}:v.includes("Artifact")?{type:"Artifacts",priority:3}:v.includes("Enchantment")?{type:"Enchantments",priority:6}:v.includes("Planeswalker")?{type:"Planeswalkers",priority:1}:{type:"Other",priority:8}},a=document.createElement("div");a.style.position="absolute",a.style.left="-9999px",a.style.top="0",a.style.width="794px",a.style.minHeight="1123px",a.style.backgroundColor="white",a.style.padding="38px",a.style.boxSizing="border-box",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="12px",a.style.lineHeight="1.4",document.body.appendChild(a);let o=`
        <div style="width: 100%; box-sizing: border-box; font-family: Arial, sans-serif; color: #333;">
          <div style="text-align: center; margin-bottom: 30px; page-break-inside: avoid;">
            <h1 style="color: #333; margin: 0 0 10px 0; font-size: 24px; font-weight: bold;">${n.name||"Untitled Deck"}</h1>
            <p style="color: #666; margin: 0; font-size: 14px;">Generated on ${new Date().toLocaleDateString()}</p>
          </div>
      `;const r=async(E,v)=>{if(!v||v.length===0){console.log(`[EXPORT] ${E}: No cards to process`);return}console.log(`[EXPORT] Processing ${E} with ${v.length} cards`);const W=v.reduce((B,y)=>{var b;const G=y.name||((b=y.card)==null?void 0:b.name)||"Unknown Card",O=y.count||y.quantity||1;return B[G]?B[G].quantity+=O:B[G]={card:y,quantity:O,typeInfo:t(y)},B},{}),U={};Object.entries(W).forEach(([B,y])=>{const G=y.typeInfo.type;U[G]||(U[G]={cards:[],priority:y.typeInfo.priority}),U[G].cards.push({cardName:B,...y})});const A=Object.entries(U).sort(([,B],[,y])=>B.priority-y.priority).map(([B,y])=>({typeName:B,cards:y.cards.sort((G,O)=>G.cardName.localeCompare(O.cardName))}));o+='<div style="page-break-before: auto; margin-bottom: 40px;">',o+=`<h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin: 30px 0 20px 0; font-size: 20px;">${E}</h2>`;for(const{typeName:B,cards:y}of A)if(y.length!==0){o+=`<h3 style="color: #555; margin: 25px 0 15px 0; font-size: 16px; font-weight: bold;">${B} (${y.reduce((G,O)=>G+O.quantity,0)})</h3>`,o+='<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; width: 100%;">';for(let G=0;G<y.length;G++){const{cardName:O,card:b,quantity:te}=y[G];console.log(`[EXPORT] Processing card ${G+1}/${y.length}: ${O}`);let re=null;try{re=await e(b),re?console.log(`[EXPORT] ‚úÖ Successfully loaded image for ${O}`,{dataUrlLength:re.length,isJpeg:re.startsWith("data:image/jpeg"),isPng:re.startsWith("data:image/png")}):console.log(`[EXPORT] ‚ùå Failed to load image for ${O}`)}catch(ve){console.log(`[EXPORT] ‚ùå Error loading image for ${O}:`,ve)}console.log(`[EXPORT] Adding HTML for ${O}, has dataUrl: ${!!re}`),o+=`
              <div style="
                text-align: center; 
                page-break-inside: avoid; 
                border: 1px solid #ddd; 
                padding: 8px; 
                border-radius: 5px; 
                background: white;
                min-height: 280px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
              ">
                ${re?`<img src="${re}" alt="${O}" style="width: 100%; max-width: 140px; height: auto; border-radius: 4px; margin: 0 auto 8px auto; object-fit: contain;">`:'<div style="width: 140px; height: 195px; background: #f0f0f0; border-radius: 4px; margin: 0 auto 8px auto; display: flex; align-items: center; justify-content: center; color: #666; font-size: 11px; text-align: center; padding: 8px;">No Image<br/>Available</div>'}
                <div style="font-weight: bold; font-size: 11px; line-height: 1.2; color: #333;">
                  ${te>1?`${te}x `:""}${O}
                </div>
              </div>
            `}o+="</div>"}const D=Object.values(W).reduce((B,y)=>B+y.quantity,0);o+=`<p style="text-align: right; color: #666; font-style: italic; margin: 15px 0; font-size: 12px;">${E} Total: ${D} cards</p>`,o+="</div>"};console.log("[EXPORT] Processing main deck..."),await r("Main Deck",F),n.sideboard&&n.sideboard.length>0&&(console.log("[EXPORT] Processing sideboard..."),await r("Sideboard",n.sideboard)),n.techIdeas&&n.techIdeas.length>0&&(console.log("[EXPORT] Processing tech ideas..."),await r("Tech Ideas",n.techIdeas)),o+="</div>",a.innerHTML=o,console.log("[EXPORT] HTML content set, generating canvas...");const l=a.querySelectorAll("img[src]");console.log("[EXPORT] Found",l.length,"images to wait for");const i=a.querySelectorAll("img");if(console.log("[EXPORT] Total img elements found:",i.length),l.forEach((E,v)=>{console.log(`[EXPORT] Data image ${v+1}:`,{src:E.src.substring(0,50)+"...",complete:E.complete,naturalWidth:E.naturalWidth,naturalHeight:E.naturalHeight})}),i.forEach((E,v)=>{var W;console.log(`[EXPORT] All images ${v+1}:`,{src:E.src?E.src.substring(0,50)+"...":"NO SRC",hasDataSrc:(W=E.src)==null?void 0:W.startsWith("data:image"),complete:E.complete})}),l.length>0){const E=Array.from(l).map((v,W)=>new Promise(U=>{v.complete?(console.log(`[EXPORT] Image ${W+1} already complete`),U()):(v.onload=()=>{console.log(`[EXPORT] Image ${W+1} loaded successfully`),U()},v.onerror=()=>{console.log(`[EXPORT] Image ${W+1} failed to load`),U()},setTimeout(()=>{console.log(`[EXPORT] Image ${W+1} timeout`),U()},3e3))}));await Promise.all(E),console.log("[EXPORT] All images processed")}else console.log("[EXPORT] No images found - this might be the issue!");console.log("[EXPORT] Skipping html2canvas, creating PDF directly from images...");const c=Array.from(l);console.log("[EXPORT] Creating optimized PDF from",c.length,"compressed card images");const _=a.querySelectorAll("img");console.log("[EXPORT] Found",_.length,"compressed images in container");const u=new hr({orientation:"p",unit:"mm",format:"a4",compress:!0}),C=210,d=297,k=10,f=C-2*k,m=d-2*k,I=63/88,x=3,h=f/x,j=h/I,$=Math.floor(m/j)*x;console.log("[EXPORT] Card layout:",{cardsPerRow:x,cardWidth:h.toFixed(1)+"mm",cardHeight:j.toFixed(1)+"mm",cardsPerPage:$});let S=0,N=1;for(u.setFontSize(24),u.text(n.name||"Magic Deck",C/2,50,{align:"center"}),u.setFontSize(12),u.text(`Generated on ${new Date().toLocaleDateString()}`,C/2,70,{align:"center"}),u.text(`${c.length} cards`,C/2,85,{align:"center"});S<_.length;){const E=Math.min($,_.length-S);N>1&&u.addPage(),console.log(`[EXPORT] Creating page ${N} with ${E} cards`);for(let v=0;v<E;v++){const W=_[S+v];if(!W||!W.src)continue;const U=Math.floor(v/x),A=v%x,D=k+A*h,B=k+U*j;try{u.addImage(W.src,"PNG",D,B,h,j),console.log(`[EXPORT] Added optimized card ${S+v+1} at position (${D.toFixed(1)}, ${B.toFixed(1)})`)}catch(y){console.error(`[EXPORT] Failed to add card ${S+v+1}:`,y)}}if(S+=E,N++,N>50){console.warn("[EXPORT] Safety break: Maximum pages reached");break}}console.log("[EXPORT] Total pages created:",N-1),document.body.removeChild(a),u.save(`${n.name||"deck"}.pdf`),P.success("Deck exported to optimized PDF! File size reduced by ~60%"),console.log("[EXPORT] Optimized PDF export completed successfully")}catch(e){console.error("[EXPORT] Error exporting to PDF:",e),P.error("Failed to export deck to PDF");const t=document.querySelector('div[style*="left: -9999px"]');t&&document.body.removeChild(t)}},cr=()=>{try{if(console.log("[EXPORT] Starting wishlist text export..."),!n||!F||F.length===0){P.warning("No cards to export");return}const e=F.filter(_=>jo(_));if(e.length===0){P.info("All cards are already in your collection!");return}let t=`${n.name||"Untitled Deck"} - Wishlist
`;t+=`Generated on ${new Date().toLocaleDateString()}
`,t+=`Format: TCGPlayer Mass Entry Compatible
`,t+=`Cards needed: ${e.length} of ${F.length} total

`;const a=e.filter(_=>!_.sideboard&&!_.techIdeas);a.length>0&&(t+=`Main Deck Wishlist:
`,t+=`====================
`,a.sort((u,C)=>{var f,m;const d=(((f=u.card)==null?void 0:f.name)||u.name||"Unknown Card").toLowerCase(),k=(((m=C.card)==null?void 0:m.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare(k)}).forEach(u=>{t+=bn(u)+`
`}),t+=`
`);const o=e.filter(_=>_.sideboard);o.length>0&&(t+=`Sideboard Wishlist:
`,t+=`===================
`,o.sort((u,C)=>{var f,m;const d=(((f=u.card)==null?void 0:f.name)||u.name||"Unknown Card").toLowerCase(),k=(((m=C.card)==null?void 0:m.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare(k)}).forEach(u=>{t+=bn(u)+`
`}),t+=`
`);const r=e.filter(_=>_.techIdeas);r.length>0&&(t+=`Tech Ideas Wishlist:
`,t+=`====================
`,r.sort((u,C)=>{var f,m;const d=(((f=u.card)==null?void 0:f.name)||u.name||"Unknown Card").toLowerCase(),k=(((m=C.card)==null?void 0:m.name)||C.name||"Unknown Card").toLowerCase();return d.localeCompare(k)}).forEach(u=>{t+=bn(u)+`
`}));const l=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(l),c=document.createElement("a");c.href=i,c.download=`${n.name||"deck"}_wishlist.txt`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(i),P.success(`Wishlist exported! ${e.length} cards needed.`),console.log("[EXPORT] Wishlist text export completed successfully")}catch(e){console.error("[EXPORT] Error exporting wishlist to text:",e),P.error("Failed to export wishlist to text")}},dr=async()=>{try{if(console.log("[EXPORT] Starting wishlist PDF export..."),!n||!F||F.length===0){P.error("No deck or cards available for wishlist PDF export");return}const e=F.filter(j=>jo(j));if(e.length===0){P.info("All cards are already in your collection!");return}P.info("Generating wishlist PDF with card images...");const t=async j=>{var S,N,E,v,W,U,A,D,B,y,G,O,b;const $=((N=(S=j.cardObj)==null?void 0:S.image_uris)==null?void 0:N.normal)||((W=(v=(E=j.cardObj)==null?void 0:E.card)==null?void 0:v.image_uris)==null?void 0:W.normal)||((A=(U=j.scryfall_json)==null?void 0:U.image_uris)==null?void 0:A.normal)||((y=(B=(D=j.cardObj)==null?void 0:D.scryfall_json)==null?void 0:B.image_uris)==null?void 0:y.normal)||((O=(G=j.card)==null?void 0:G.image_uris)==null?void 0:O.normal)||((b=j.image_uris)==null?void 0:b.normal);return $?new Promise(te=>{const re=new Image;re.crossOrigin="anonymous",re.onload=()=>{const ve=document.createElement("canvas"),Ze=ve.getContext("2d");ve.width=re.width,ve.height=re.height,Ze.drawImage(re,0,0),te(ve.toDataURL("image/jpeg",.6))},re.onerror=()=>te(null),re.src=$}):null},a=document.createElement("div");a.style.position="absolute",a.style.left="-9999px",a.style.top="-9999px",a.style.width="200px",a.style.height="280px",document.body.appendChild(a);const o=[];for(const j of e){const $=await t(j);if($){const S=document.createElement("img");S.src=$,S.style.width="200px",S.style.height="auto",a.appendChild(S),o.push({src:$,card:j})}}const{jsPDF:r}=window.jspdf||await mr(()=>import("./jspdf.es.min-CGvl7WZV.js").then(j=>j.j),__vite__mapDeps([0,1,2,3,4])),l=new r({orientation:"p",unit:"mm",format:"a4",compress:!0}),i=210,c=297,_=10,u=i-2*_,C=c-2*_,d=63/88,k=3,f=u/k,m=f/d,I=Math.floor(C/m)*k;console.log("[EXPORT] Wishlist card layout:",{cardsPerRow:k,cardWidth:f.toFixed(1)+"mm",cardHeight:m.toFixed(1)+"mm",cardsPerPage:I});let x=0,h=1;for(l.setFontSize(24),l.text(`${n.name||"Untitled Deck"} - Wishlist`,i/2,50,{align:"center"}),l.setFontSize(12),l.text(`Generated on ${new Date().toLocaleDateString()}`,i/2,70,{align:"center"}),l.text(`Cards needed: ${e.length} of ${F.length} total`,i/2,85,{align:"center"});x<o.length;){const j=Math.min(I,o.length-x);h>1&&l.addPage(),console.log(`[EXPORT] Creating wishlist page ${h} with ${j} cards`);for(let $=0;$<j;$++){const S=o[x+$];if(!S||!S.src)continue;const N=Math.floor($/k),E=$%k,v=_+E*f,W=_+N*m;try{l.addImage(S.src,"PNG",v,W,f,m),console.log(`[EXPORT] Added wishlist card ${x+$+1} at position (${v.toFixed(1)}, ${W.toFixed(1)})`)}catch(U){console.error(`[EXPORT] Failed to add wishlist card ${x+$+1}:`,U)}}if(x+=j,h++,h>50){console.warn("[EXPORT] Safety break: Maximum pages reached");break}}console.log("[EXPORT] Total wishlist pages created:",h-1),document.body.removeChild(a),l.save(`${n.name||"deck"}_wishlist.pdf`),P.success(`Wishlist PDF exported! ${e.length} cards needed.`),console.log("[EXPORT] Wishlist PDF export completed successfully")}catch(e){console.error("[EXPORT] Error exporting wishlist to PDF:",e),P.error("Failed to export wishlist to PDF")}},Eo=async(e,t={})=>{try{if(!e||e.trim()===""){P.warning("No text content provided");return}const a=e.trim().split(`
`),o={mainDeck:[],sideboard:[],techIdeas:[],errors:[]};let r="mainDeck";for(let C=0;C<a.length;C++){const d=a[C].trim();if(!d||d.startsWith("===")||d.includes("Generated on")||d.includes("Format:")||d.includes("Total:"))continue;if(d.toUpperCase().includes("MAIN DECK")){r="mainDeck";continue}if(d.toUpperCase().includes("SIDEBOARD")){r="sideboard";continue}if(d.toUpperCase().includes("TECH IDEAS")){r="techIdeas";continue}const k=d.match(/^(\d+)\s+(.+?)(?:\s+\[([A-Z0-9]+)\](?:\s+(\w+))?)?$/);if(k){const[,f,m,I,x]=k,h={name:m.trim(),quantity:parseInt(f),set:I==null?void 0:I.toLowerCase(),collector_number:x};o[r].push(h),console.log(`[IMPORT] Parsed: ${f}x ${m} (${I||"no set"})`)}else{const f=d.match(/^(\d+)\s+(.+)$/);if(f){const[,m,I]=f;o[r].push({name:I.trim(),quantity:parseInt(m)}),console.log(`[IMPORT] Parsed (simple): ${m}x ${I}`)}else o.errors.push(`Line ${C+1}: Could not parse "${d}"`)}}const i=(await Promise.all(o.mainDeck.map(async C=>{var d;try{let k=C.name;C.set&&(k+=` set:${C.set}`);const m=await(await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(k)}`)).json();if(m.data&&m.data.length>0){const I=m.data[0];return{name:I.name,card:{name:I.name,scryfall_json:{...I,image_uris:I.image_uris||I.card_faces&&((d=I.card_faces[0])==null?void 0:d.image_uris)},printing:I.id,set:I.set,collector_number:I.collector_number},count:C.quantity,quantity:C.quantity,printing:I.id,scryfall_id:I.id,added_at:new Date().toISOString()}}else return o.errors.push(`Card not found: ${C.name}`),null}catch(k){return console.error(`[IMPORT] Error searching for ${C.name}:`,k),o.errors.push(`Error searching for: ${C.name}`),null}}))).filter(C=>C!==null);if(i.length===0){P.error("No valid cards found to import");return}const c=localStorage.getItem("token"),_="";try{const C=i.map(f=>({name:f.name,quantity:f.count,isCommander:!1,set:f.card.set,collector_number:f.card.collector_number,scryfall_id:f.scryfall_id,card:f.card,scryfallCard:f.card})),d={...n,cards:[...n.cards||[],...C]},k=await fetch(`${_}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(d),credentials:"include"});if(k.ok)o.successful=i.length;else{const f=await k.text();console.error("[IMPORT] Server error:",f),o.errors.push(`Failed to add cards: ${k.status}`)}}catch(C){console.error("[IMPORT] Error adding cards:",C),o.errors.push(`Error adding cards: ${C.message}`)}try{const C=await fetch(`${_}/api/decks/${n._id}`,{method:"GET",headers:{Authorization:`Bearer ${c}`},credentials:"include"});if(C.ok){const d=await C.json();le(d),Y(d.cards||[])}}catch(C){console.error("[IMPORT] Error refreshing deck:",C)}const u=`Successfully imported ${i.length} cards${o.errors.length>0?` (${o.errors.length} errors)`:""}`;P.success(u),o.errors.length>0&&console.warn("[IMPORT] Import completed with errors:",o.errors)}catch(a){console.error("[IMPORT] Error importing text:",a),P.error("Failed to import deck list from text")}},Xn=async e=>{try{console.log(`[REMOVE FROM SIDEBOARD] Removing card at index ${e} from sideboard`);const t=[...n.sideboard],a=t.splice(e,1)[0],o={...n,sideboard:t,lastUpdated:Date.now()};le(o),Wt(o._id,o.sideboard,o.techIdeas),P.success(`Removed ${(a==null?void 0:a.name)||"card"} from sideboard`),console.log("[REMOVE FROM SIDEBOARD] Successfully removed from sideboard")}catch(t){console.error("Error removing card from sideboard:",t),P.error("Error removing card from sideboard")}},Qn=async e=>{try{console.log(`[REMOVE FROM TECH IDEAS] Removing card at index ${e} from tech ideas`);const t=[...n.techIdeas],a=t.splice(e,1)[0],o={...n,techIdeas:t,lastUpdated:Date.now()};le(o),Wt(o._id,o.sideboard,o.techIdeas),P.success(`Removed ${(a==null?void 0:a.name)||"card"} from tech ideas`),console.log("[REMOVE FROM TECH IDEAS] Successfully removed from tech ideas")}catch(t){console.error("Error removing card from tech ideas:",t),P.error("Error removing card from tech ideas")}},co=async(e,t)=>{var a,o,r,l,i,c,_,u,C,d,k,f,m,I,x,h,j,$,S,N,E,v,W,U;try{const A=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE FROM SIDEBOARD] Moving ${A} from sideboard to main deck`);const D=[...n.sideboard];D.splice(t,1);const B={name:A,printing:e.printing||((o=e.scryfall_json)==null?void 0:o.id)||((l=(r=e.card)==null?void 0:r.scryfall_json)==null?void 0:l.id),quantity:1,modalPrice:e.modalPrice,type_line:((i=e.cardObj)==null?void 0:i.type_line)||e.type_line||((c=e.card)==null?void 0:c.type_line)||((_=e.scryfall_json)==null?void 0:_.type_line)||((C=(u=e.card)==null?void 0:u.scryfall_json)==null?void 0:C.type_line),scryfall_json:e.scryfall_json||((d=e.card)==null?void 0:d.scryfall_json)||((k=e.cardObj)==null?void 0:k.scryfall_json),cardObj:e.cardObj||e,card:e.card||{name:A,type_line:((f=e.cardObj)==null?void 0:f.type_line)||e.type_line||((m=e.card)==null?void 0:m.type_line)||((I=e.scryfall_json)==null?void 0:I.type_line)||((h=(x=e.card)==null?void 0:x.scryfall_json)==null?void 0:h.type_line),scryfall_json:e.scryfall_json||((j=e.card)==null?void 0:j.scryfall_json)||(($=e.cardObj)==null?void 0:$.scryfall_json)}},y={...n,cards:[...n.cards||[],B],sideboard:D,cardCount:(((S=n.cards)==null?void 0:S.length)||0)+1,lastUpdated:Date.now()};console.log(`[MOVE FROM SIDEBOARD] New deck prepared with ${y.cards.length} main cards, ${y.sideboard.length} sideboard cards`),console.log("[MOVE FROM SIDEBOARD] Card type info preserved:",JSON.stringify({name:B.name,type_line:B.type_line,scryfall_type:(N=B.scryfall_json)==null?void 0:N.type_line,card_type:(E=B.card)==null?void 0:E.type_line,originalCard_cardObj_type:(v=e.cardObj)==null?void 0:v.type_line,originalCard_type_line:e.type_line,originalCard_scryfall_type:(W=e.scryfall_json)==null?void 0:W.type_line,originalCard_card_type:(U=e.card)==null?void 0:U.type_line},null,2)),le(y),Y(y.cards||[]),Wt(y._id,y.sideboard,y.techIdeas),console.log("[MOVE FROM SIDEBOARD] Attempting to save deck to server...");try{await Hn(y),console.log("[MOVE FROM SIDEBOARD] Server save completed successfully")}catch(G){console.error("[MOVE FROM SIDEBOARD] Failed to save deck to server:",G),console.log("[MOVE FROM SIDEBOARD] Move successful in UI, zones saved to localStorage")}P.success(`Moved ${A} to Main Deck`),console.log("[MOVE FROM SIDEBOARD] === FUNCTION COMPLETED SUCCESSFULLY ===")}catch(A){console.error("Error moving card from sideboard to main deck:",A),P.error("Error moving card from sideboard to main deck")}},fo=async(e,t)=>{var a;try{const o=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE BETWEEN ZONES] Moving ${o} from sideboard to tech ideas`);let r;le(l=>{var u,C,d,k,f,m;if(!l||!l.sideboard)return l;const i=[...l.sideboard],c=i.splice(t,1)[0],_={name:o,printing:c.printing||((u=c.scryfall_json)==null?void 0:u.id)||((d=(C=c.card)==null?void 0:C.scryfall_json)==null?void 0:d.id),foil:c.foil||((k=c.card)==null?void 0:k.foil)||!1,count:1,modalPrice:c.modalPrice,type_line:c.type_line||((f=c.card)==null?void 0:f.type_line),scryfall_json:c.scryfall_json||((m=c.card)==null?void 0:m.scryfall_json),cardObj:c.cardObj||c};return r={...l,sideboard:i,techIdeas:[...l.techIdeas||[],_],lastUpdated:Date.now()},r}),r&&Wt(r._id,r.sideboard,r.techIdeas),P.success(`Moved ${o} to Tech Ideas`)}catch(o){console.error("Error moving card from sideboard to tech ideas:",o),P.error("Error moving card from sideboard to tech ideas")}},uo=async(e,t)=>{var a,o,r,l,i,c,_,u,C,d,k,f,m,I,x,h,j,$,S;try{const N=e.name||((a=e.card)==null?void 0:a.name);console.log(`[MOVE FROM TECH IDEAS] Moving ${N} from tech ideas to main deck`);const E=[...n.techIdeas];E.splice(t,1);const v={name:N,printing:e.printing||((o=e.scryfall_json)==null?void 0:o.id)||((l=(r=e.card)==null?void 0:r.scryfall_json)==null?void 0:l.id),quantity:1,modalPrice:e.modalPrice,type_line:((i=e.cardObj)==null?void 0:i.type_line)||e.type_line||((c=e.card)==null?void 0:c.type_line)||((_=e.scryfall_json)==null?void 0:_.type_line)||((C=(u=e.card)==null?void 0:u.scryfall_json)==null?void 0:C.type_line),scryfall_json:e.scryfall_json||((d=e.card)==null?void 0:d.scryfall_json)||((k=e.cardObj)==null?void 0:k.scryfall_json),cardObj:e.cardObj||e,card:e.card||{name:N,type_line:((f=e.cardObj)==null?void 0:f.type_line)||e.type_line||((m=e.card)==null?void 0:m.type_line)||((I=e.scryfall_json)==null?void 0:I.type_line)||((h=(x=e.card)==null?void 0:x.scryfall_json)==null?void 0:h.type_line),scryfall_json:e.scryfall_json||((j=e.card)==null?void 0:j.scryfall_json)||(($=e.cardObj)==null?void 0:$.scryfall_json)}},W={...n,cards:[...n.cards||[],v],techIdeas:E,cardCount:(((S=n.cards)==null?void 0:S.length)||0)+1,lastUpdated:Date.now()};le(W),Y(W.cards||[]),Wt(W._id,W.sideboard,W.techIdeas);try{await Hn(W)}catch(U){console.error("[MOVE FROM TECH IDEAS] Failed to save deck to server:",U),console.log("[MOVE FROM TECH IDEAS] Move successful in UI, zones saved to localStorage")}P.success(`Moved ${N} to Main Deck`),console.log("[MOVE FROM TECH IDEAS] === FUNCTION COMPLETED SUCCESSFULLY ===")}catch(N){console.error("Error moving card from tech ideas to main deck:",N),P.error("Error moving card from tech ideas to main deck")}},mo=async(e,t)=>{var a,o,r;try{let l=e.modalPrice||((a=e.cardObj)==null?void 0:a.modalPrice)||((r=(o=e.cardObj)==null?void 0:o.card)==null?void 0:r.modalPrice);if(!pr(l)&&(l=Vt(e).price,!l)){const c=(_,u=0)=>{var C;if(u>10||!_||typeof _!="object")return null;if((C=_.prices)!=null&&C.usd)return _.prices.usd;if(_.usd)return _.usd;if(_.price)return _.price;for(const d of Object.values(_))if(d&&typeof d=="object"){const k=c(d,u+1);if(k)return k}return null};l=c(e)||"0.24",console.log(`[ZONE MOVE] Deep search price for ${e.name}: $${l}`)}le(i=>{const c=[...i.techIdeas||[]],_=[...i.sideboard||[]],C={...c.splice(t,1)[0],modalPrice:l};return _.push(C),{...i,techIdeas:c,sideboard:_}}),Wt(n._id,[...n.sideboard||[],{...e,modalPrice:l}],[...n.techIdeas||[]].filter((i,c)=>c!==t)),P.success(`Moved ${e.name} to sideboard`)}catch(l){console.error("Error moving card from tech ideas to sideboard:",l),P.error("Error moving card to sideboard")}},vo=async e=>{try{console.log(`[ADD TO TECH IDEAS] Adding ${e.name} to tech ideas`);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line},scryfall_json:e},a={...n,techIdeas:[...n.techIdeas||[],t],lastUpdated:Date.now()};le(a),Wt(a._id,a.sideboard,a.techIdeas),P.success(`Added ${e.name} to Tech Ideas`),console.log("[ADD TO TECH IDEAS] Successfully added to tech ideas")}catch(t){console.error("Error adding card to tech ideas:",t),P.error("Error adding card to tech ideas")}},ko=async e=>{try{console.log(`[ADD TO SIDEBOARD] Adding ${e.name} to sideboard`);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line},scryfall_json:e},a={...n,sideboard:[...n.sideboard||[],t],lastUpdated:Date.now()};le(a),Wt(a._id,a.sideboard,a.techIdeas),P.success(`Added ${e.name} to Sideboard`),console.log("[ADD TO SIDEBOARD] Successfully added to sideboard")}catch(t){console.error("Error adding card to sideboard:",t),P.error("Error adding card to sideboard")}},$o=async e=>{try{console.log("Add to Wishlist:",e.name);const t={name:e.name,printing:e.scryfall_id||e.id,foil:!1,count:1,dateAdded:Date.now(),cardObj:{scryfall_id:e.scryfall_id||e.id,name:e.name,set:e.set,set_name:e.set_name,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,cmc:e.cmc,colors:e.colors,color_identity:e.color_identity,prices:e.prices},scryfall_json:e},a=JSON.parse(localStorage.getItem("global-wishlist")||"[]"),o=a.findIndex(r=>r.name===e.name&&r.printing===(e.scryfall_id||e.id));o!==-1?(a[o].count+=1,P.success(`Updated ${e.name} quantity in wishlist (now ${a[o].count})`)):(a.push(t),P.success(`Added ${e.name} to wishlist`)),localStorage.setItem("global-wishlist",JSON.stringify(a)),window.dispatchEvent(new CustomEvent("wishlistUpdated",{detail:a}))}catch(t){console.error("Error adding card to wishlist:",t),P.error("Error adding card to wishlist")}},Jn=async e=>{var t;try{const a=((t=e.card)==null?void 0:t.name)||e.name;console.log(`[MOVE TO SIDEBOARD] Moving ${a} from main deck to sideboard`);let o;if(le(r=>{var c,_,u,C,d,k,f;if(!r)return r;const l=(r.cards||[]).filter(m=>{var x,h,j,$;return(m.name||((x=m.card)==null?void 0:x.name)||((h=m.cardObj)==null?void 0:h.name)||(($=(j=m.cardObj)==null?void 0:j.card)==null?void 0:$.name))!==a}),i={name:a,printing:e.printing||((c=e.scryfall_json)==null?void 0:c.id)||((u=(_=e.card)==null?void 0:_.scryfall_json)==null?void 0:u.id),foil:e.foil||((C=e.card)==null?void 0:C.foil)||!1,count:1,modalPrice:e.modalPrice||((d=e.card)==null?void 0:d.modalPrice),type_line:e.type_line||((k=e.card)==null?void 0:k.type_line),scryfall_json:e.scryfall_json||((f=e.card)==null?void 0:f.scryfall_json),cardObj:e};return o={...r,cards:l,sideboard:[...r.sideboard||[],i],cardCount:l.length,lastUpdated:Date.now()},o}),o&&(Y(o.cards||[]),Wt(o._id,o.sideboard,o.techIdeas)),o)try{await Hn(o)}catch(r){console.error("[MOVE TO SIDEBOARD] Failed to save deck to server:",r),console.log("[MOVE TO SIDEBOARD] Sideboard move successful in UI (client-side only)")}P.success(`Moved ${a} to Sideboard`)}catch(a){console.error("Error moving card to sideboard:",a),P.error("Error moving card to sideboard")}},Yn=async e=>{var t;try{const a=((t=e.card)==null?void 0:t.name)||e.name;console.log(`[MOVE TO TECH IDEAS] Moving ${a} from main deck to tech ideas`);let o;if(le(r=>{var c,_,u,C,d,k,f;if(!r)return r;const l=(r.cards||[]).filter(m=>{var x,h,j,$;return(m.name||((x=m.card)==null?void 0:x.name)||((h=m.cardObj)==null?void 0:h.name)||(($=(j=m.cardObj)==null?void 0:j.card)==null?void 0:$.name))!==a}),i={name:a,printing:e.printing||((c=e.scryfall_json)==null?void 0:c.id)||((u=(_=e.card)==null?void 0:_.scryfall_json)==null?void 0:u.id),foil:e.foil||((C=e.card)==null?void 0:C.foil)||!1,count:1,modalPrice:e.modalPrice||((d=e.card)==null?void 0:d.modalPrice),type_line:e.type_line||((k=e.card)==null?void 0:k.type_line),scryfall_json:e.scryfall_json||((f=e.card)==null?void 0:f.scryfall_json),cardObj:e};return o={...r,cards:l,techIdeas:[...r.techIdeas||[],i],cardCount:l.length,lastUpdated:Date.now()},o}),o&&(Y(o.cards||[]),Wt(o._id,o.sideboard,o.techIdeas)),o)try{await Hn(o)}catch(r){console.error("[MOVE TO TECH IDEAS] Failed to save deck to server:",r),console.log("[MOVE TO TECH IDEAS] Tech ideas move successful in UI (client-side only)")}P.success(`Moved ${a} to Tech Ideas`)}catch(a){console.error("Error moving card to tech ideas:",a),P.error("Error moving card to tech ideas")}},[kt,Cn]=R.useState({open:!1,x:0,y:0,cardObj:null});return R.useEffect(()=>{if(!kt.open)return;const e=()=>Cn({open:!1,x:0,y:0,cardObj:null});return window.addEventListener("click",e),window.addEventListener("contextmenu",e),()=>{window.removeEventListener("click",e),window.removeEventListener("contextmenu",e)}},[kt.open]),R.useEffect(()=>(typeof window<"u"&&(window.deckEditApp={handleAddToSideboard:ko,handleAddToTechIdeas:vo,handleMoveToSideboard:Jn,handleMoveToTechIdeas:Yn,handleRemoveFromSideboard:Xn,handleRemoveFromTechIdeas:Qn,setModalState:L,openCardModal:e=>{var a,o;console.log("[ORACLE TAG MODAL] Opening CardActionsModal for:",e.name);const t={name:e.name,printing:e.scryfall_id||e.id,cardObj:{name:e.name,scryfall_id:e.scryfall_id||e.id,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,oracle_text:e.oracle_text,power:e.power,toughness:e.toughness,cmc:e.cmc||e.converted_mana_cost,rarity:e.rarity,prices:e.prices},card:{name:e.name,scryfall_json:e,type_line:e.type_line},scryfall_json:e,foil:!1,count:1,modalPrice:((a=e.prices)==null?void 0:a.usd)||((o=e.prices)==null?void 0:o.usd_foil)||"0.00"};L({isOpen:!0,cardObj:t})}},$e.current%50===0&&console.log("[GLOBAL FUNCTIONS] Exposed deck editing functions to window.deckEditApp")),()=>{typeof window<"u"&&window.deckEditApp&&delete window.deckEditApp}),[n==null?void 0:n._id]),_e?s.jsxs("div",{className:"container",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",textAlign:"center"},children:[s.jsx("div",{style:{fontSize:"18px",marginBottom:"12px",color:"#333"},children:"Loading deck..."}),s.jsx("div",{style:{fontSize:"14px",color:"#666",maxWidth:"400px",lineHeight:"1.4"},children:"If this is taking longer than expected, the server may be starting up. This can take up to 30 seconds on the first load."}),s.jsx("div",{style:{marginTop:"20px",width:"40px",height:"40px",border:"4px solid #f3f3f3",borderTop:"4px solid #3498db",borderRadius:"50%",animation:"spin 1s linear infinite"}}),s.jsx("style",{dangerouslySetInnerHTML:{__html:`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}})]}):n?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"deck-title-bar",style:{width:"100%",textAlign:"center",background:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.04)",paddingTop:8,paddingBottom:8},children:s.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"16px",flexWrap:"wrap"},children:[s.jsx("h2",{style:{margin:0,fontSize:"2rem",fontWeight:700,letterSpacing:"-0.5px",cursor:"pointer",display:"inline-block",transition:"color 0.15s"},title:"Click to copy deck link",onClick:async()=>{try{const e=window.location.origin+`/decks/${T}`;await navigator.clipboard.writeText(e),P.success("Deck link copied!")}catch{P.error("Failed to copy link")}},onMouseOver:e=>e.currentTarget.style.color="#1976d2",onMouseOut:e=>e.currentTarget.style.color="",children:n.name||"Untitled Deck"}),!X&&s.jsx("button",{onClick:()=>{const e=`${window.location.origin}/public/decks/${T}`;navigator.clipboard.writeText(e),P.success("Public share link copied to clipboard!")},style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"6px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",marginTop:"4px",marginBottom:"8px",display:"flex",alignItems:"center",gap:"4px",width:"fit-content"},onMouseOver:e=>e.currentTarget.style.backgroundColor="#1976d2",onMouseOut:e=>e.currentTarget.style.backgroundColor="#2196f3",children:"üîó Copy Public Share Link"}),X&&s.jsxs("div",{style:{backgroundColor:"#e3f2fd",border:"1px solid #2196f3",borderRadius:"6px",padding:"8px 12px",marginTop:"8px",marginBottom:"8px",display:"flex",alignItems:"center",gap:"8px",color:"#1976d2",fontSize:"14px",fontWeight:"500"},children:[s.jsx("span",{children:"üëÅÔ∏è"}),s.jsx("span",{children:"Public View (Read-Only) - This deck is shared publicly and cannot be edited"})]}),!X&&s.jsxs("div",{style:{display:"flex",gap:"12px",alignItems:"center"},children:[s.jsxs("div",{className:"import-dropdown-container",style:{position:"relative",display:"inline-block"},children:[s.jsxs("button",{onClick:()=>Z(!J),style:{backgroundColor:"#4caf50",color:"white",border:"none",padding:"10px 16px",borderRadius:"6px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},onMouseEnter:e=>{e.target.style.backgroundColor="#388e3c",e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 8px rgba(0,0,0,0.15)"},onMouseLeave:e=>{e.target.style.backgroundColor="#4caf50",e.target.style.transform="translateY(0)",e.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"},title:"Import Options",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M12,12L16,16H13V19H11V16H8L12,12Z"})}),"Import",s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",style:{transform:J?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s ease"},children:s.jsx("path",{d:"M7,10L12,15L17,10H7Z"})})]}),J&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:"0",marginTop:"4px",backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",boxShadow:"0 4px 16px rgba(0,0,0,0.15)",zIndex:1e3,minWidth:"240px",overflow:"hidden"},children:[s.jsxs("div",{onClick:()=>{ce(!0),Z(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#4caf50",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M12,12L16,16H13V19H11V16H8L12,12Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Import from Text"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Paste or upload card list"})]})]}),s.jsxs("div",{onClick:()=>{we(!0),Z(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#ff9800",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M9,15A1,1 0 0,1 8,14A1,1 0 0,1 9,13A1,1 0 0,1 10,14A1,1 0 0,1 9,15M16,15H11L13,12L14.25,13.25L15.75,11.75L17,13V15H16Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Import from Photo/PDF"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Upload card images or PDFs"})]})]})]})]}),s.jsxs("div",{className:"export-dropdown-container",style:{position:"relative",display:"inline-block"},children:[s.jsxs("button",{onClick:()=>K(!w),style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"10px 16px",borderRadius:"6px",fontSize:"14px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},onMouseEnter:e=>{e.target.style.backgroundColor="#1976d2",e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 8px rgba(0,0,0,0.15)"},onMouseLeave:e=>{e.target.style.backgroundColor="#2196f3",e.target.style.transform="translateY(0)",e.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"},title:"Export Options",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),"Export",s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",style:{transform:w?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s ease"},children:s.jsx("path",{d:"M7,10L12,15L17,10H7Z"})})]}),w&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:"0",marginTop:"4px",backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",boxShadow:"0 4px 16px rgba(0,0,0,0.15)",zIndex:1e3,minWidth:"220px",overflow:"hidden"},children:[s.jsxs("div",{onClick:()=>{ir(),K(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#4caf50",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Entire Text"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"All cards as plain text file"})]})]}),s.jsxs("div",{onClick:()=>{lr(),K(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#ff5722",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M9,13V19A1,1 0 0,0 10,20H14A1,1 0 0,0 15,19V13A1,1 0 0,0 14,12H10A1,1 0 0,0 9,13Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Entire PDF"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"All cards with images as PDF"})]})]}),s.jsxs("div",{onClick:()=>{cr(),K(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",borderBottom:"1px solid #f0f0f0",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#2196f3",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M10,11H14V12H10V11Z M10,14H17V15H10V14Z M10,17H17V18H10V17Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export Text Wishlist"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Cards not in collection as text"})]})]}),s.jsxs("div",{onClick:()=>{dr(),K(!1)},style:{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",fontSize:"14px",color:"#333",transition:"background-color 0.2s ease"},onMouseEnter:e=>e.target.style.backgroundColor="#f5f5f5",onMouseLeave:e=>e.target.style.backgroundColor="transparent",children:[s.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"#9c27b0",children:s.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M10,11H14V12H10V11Z M16,11H17V12H16V11Z M10,14H17V15H10V14Z M10,17H14V18H10V17Z M16,17H17V18H16V17Z"})}),s.jsxs("div",{children:[s.jsx("div",{style:{fontWeight:"500"},children:"Export PDF Wishlist"}),s.jsx("div",{style:{fontSize:"12px",color:"#666"},children:"Cards not in collection as PDF"})]})]})]})]})]})]})}),s.jsx("div",{className:"deck-container",style:{paddingBottom:"50px"},children:s.jsxs("div",{className:"deck-layout",style:{alignItems:"flex-start"},children:[s.jsxs("div",{className:"deck-sidebar",children:[Be&&Be.card&&s.jsx(ur,{preview:Be,showPreview:!0,isFixed:!0,externalFlipState:Be==null?void 0:Be.flipState,style:{height:"auto",maxHeight:"400px",maxWidth:"100%",borderRadius:"4.75%",background:"white",marginBottom:"12px",padding:0,boxShadow:"0 2px 8px rgba(0,0,0,0.04)",objectFit:"contain"}}),s.jsxs("div",{className:"search-container",style:{position:"relative",display:"flex",justifyContent:"center",marginBottom:"8pt"},children:[s.jsx("input",{type:"text",placeholder:"Search for cards to add (Scryfall syntax supported)...",value:$t,"data-deck-view-search":"true",onChange:e=>{_t(e.target.value)},onBlur:e=>{const t=e.currentTarget,a=t.closest(".search-container");setTimeout(()=>{const o=document.activeElement,r=a==null?void 0:a.querySelector('[style*="position: absolute"]'),l=r&&r.contains(o);!(o===t)&&!l&&(_t(""),Dt([]),He(""),Pt(!1),rt(-1))},200)},onKeyDown:e=>{if(Yt&&(nt.length>0||ae)){const t=nt.length+(nt.length>0?1:0);if(e.key==="ArrowDown"){e.preventDefault(),rt(a=>{const o=a<t-1?a+1:0;if(o<nt.length&&nt[o]){const r=nt[o],l={name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,card:{name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,...r.image_uris&&{image_uris:r.image_uris},...r.scryfall_json&&{scryfall_json:r.scryfall_json},...r.mana_cost&&{mana_cost:r.mana_cost},...r.type_line&&{type_line:r.type_line},...r.oracle_text&&{oracle_text:r.oracle_text},...r.power&&{power:r.power},...r.toughness&&{toughness:r.toughness},...r.loyalty&&{loyalty:r.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:r.set||r.set_name||null,set:r.set||r.set_name||null,collector_number:r.collector_number||null};st(l)}return o});return}if(e.key==="ArrowUp"){e.preventDefault(),rt(a=>{const o=a>0?a-1:t-1;if(o<nt.length&&nt[o]){const r=nt[o],l={name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,card:{name:r.name,id:r.id||r.scryfall_id,scryfall_id:r.scryfall_id||r.id,...r.image_uris&&{image_uris:r.image_uris},...r.scryfall_json&&{scryfall_json:r.scryfall_json},...r.mana_cost&&{mana_cost:r.mana_cost},...r.type_line&&{type_line:r.type_line},...r.oracle_text&&{oracle_text:r.oracle_text},...r.power&&{power:r.power},...r.toughness&&{toughness:r.toughness},...r.loyalty&&{loyalty:r.loyalty}},forceEnglish:!0,forceHighRes:!0,printing:r.set||r.set_name||null,set:r.set||r.set_name||null,collector_number:r.collector_number||null};st(l)}return o});return}if(e.key==="Enter"){if(e.preventDefault(),Ue>=0&&Ue<nt.length){const a=nt[Ue];zt(a),_t(""),Pt(!1),rt(-1);return}else if(Ue===nt.length&&nt.length>0){io($t.trim()),rt(-1);return}}}e.key==="Enter"&&$t.trim()&&(io($t.trim()),e.preventDefault()),e.key==="Escape"&&(Yt&&(Pt(!1),rt(-1)),_t(""),Dt([]),He(""),e.preventDefault())},style:{backgroundColor:"#f9f9f9",boxShadow:"0 2px 8px rgba(0,0,0,0.02)",borderRadius:4,marginBottom:0,padding:"6px 8px",border:"1px solid #ccc",width:"242px",fontSize:"12px",color:"#333",outline:"none",transition:"border-color 0.15s"}}),Yt&&$t.trim()&&s.jsxs("div",{style:{position:"absolute",top:"100%",left:"50%",transform:"translateX(-50%)",width:"242px",backgroundColor:"#f9f9f9",border:"1px solid #ccc",borderRadius:"4px",marginTop:"2px",maxHeight:"300px",overflowY:"auto",zIndex:1e3,boxShadow:"0 2px 8px rgba(0,0,0,0.15)"},onMouseLeave:()=>{},children:[Wn?s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:"#666",fontSize:"12px"},children:"Searching..."}):nt.length>0?ft.map((e,t)=>{const a=t===Ue,o=e.originalCard;e.cardForHover;const r=e.cardKey;return s.jsx("div",{style:{padding:"6px 8px",cursor:"pointer",transition:"background-color 0.15s ease",borderBottom:t<nt.length-1?"1px solid #eee":"none",backgroundColor:a?"#e3f2fd":"transparent"},onMouseEnter:()=>{if(Ut.current===r)return;Ut.current=r,rt(t);const l=gt[o.name];console.log(`üîç [PREVIEW DEBUG] Card: ${o.name}, isBasicLand: ${!!l}, cardId: ${o.id}`);let i=o;if(l){const c=ln(o.name);console.log(`üèûÔ∏è [SEARCH PREVIEW] Using preferred printing for ${o.name}: ${c} (was ${o.id})`);const _=`https://cards.scryfall.io/normal/front/${c.charAt(0)}/${c.charAt(1)}/${c}.jpg`;i={...o,id:c,scryfall_id:c,image_uris:{small:_.replace("/normal/","/small/"),normal:_,large:_.replace("/normal/","/large/")},scryfall_json:{...o.scryfall_json,id:c,image_uris:{small:_.replace("/normal/","/small/"),normal:_,large:_.replace("/normal/","/large/")}}},console.log(`üèûÔ∏è [SEARCH PREVIEW] Set image URL: ${_}`)}St({card:{name:i.name,id:i.id||i.scryfall_id,scryfall_id:i.scryfall_id||i.id,card:{name:i.name,id:i.id||i.scryfall_id,scryfall_id:i.scryfall_id||i.id,image_uris:i.image_uris,scryfall_json:i.scryfall_json,mana_cost:i.mana_cost,type_line:i.type_line,oracle_text:i.oracle_text,power:i.power,toughness:i.toughness,loyalty:i.loyalty},forceEnglish:!0,forceHighRes:!0,printing:i.set||i.set_name||null,set:i.set||i.set_name||null,collector_number:i.collector_number||null},top:0,left:0})},onMouseLeave:()=>{},onClick:l=>{l.preventDefault(),l.stopPropagation(),zt(o),_t(""),Pt(!1),rt(-1)},children:s.jsx("div",{style:{fontWeight:a?"600":"500",fontSize:"12px",color:a?"#1976d2":"#333"},children:o.name})},`${o.scryfall_id||o.id}-${t}`)}):ae?s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:"#666",fontSize:"12px"},children:ae}):null,$t.trim()&&nt.length>0&&s.jsx("div",{style:{padding:"6px 8px",textAlign:"center",color:Ue===nt.length?"#ffffff":"#1976d2",fontSize:"12px",fontWeight:"bold",backgroundColor:Ue===nt.length?"#007acc":"#f0f7ff",borderTop:"1px solid #ddd",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:()=>{rt(nt.length)},onMouseLeave:()=>{},onClick:()=>{io($t.trim()),rt(-1)},children:"Show all results..."})]})]}),s.jsx("div",{style:{background:"white",padding:"8px 0",display:"flex",justifyContent:"center",marginBottom:"8px"},children:s.jsx("button",{onClick:()=>{sn(!bt),Rt(new Set)},className:`bulk-edit-button ${bt?"active":""}`,children:bt?"Exit Bulk Edit":"Bulk Edit"})}),bt&&s.jsxs("div",{className:"bulk-actions-container",children:[s.jsxs("div",{className:"bulk-actions-counter",children:[Se.size," card",Se.size!==1?"s":""," selected"]}),s.jsx("div",{className:"bulk-select-all-container",children:s.jsx("button",{onClick:()=>{if(Se.size===0){const e=new Set,t=F&&F.length>0?F:(n==null?void 0:n.cards)||[];Array.isArray(t)&&t.forEach(r=>{e.add(ze(r))});const a=(n==null?void 0:n.sideboard)||[];Array.isArray(a)&&a.forEach(r=>{e.add(ze(r))});const o=(n==null?void 0:n.techIdeas)||[];Array.isArray(o)&&o.forEach(r=>{e.add(ze(r))}),Rt(e)}else Rt(new Set)},className:"bulk-select-all-text",style:{padding:"2px 6px",fontSize:"10px",backgroundColor:"#1976d2",color:"#fff",border:"1px solid #1565c0",borderRadius:"3px",cursor:"pointer"},children:Se.size===0?"Select All":"Clear All"})}),s.jsxs("div",{className:"bulk-actions-grid",children:[s.jsx("button",{onClick:()=>Yo(),disabled:Se.size===0,className:"bulk-action-button collection",children:"+ Collection"}),s.jsx("button",{onClick:()=>Zo(),disabled:Se.size===0,className:"bulk-action-button wishlist",children:"+ Wishlist"}),s.jsx("button",{onClick:()=>tr(),disabled:Se.size===0,className:"bulk-action-button main-deck",children:"‚Üí Main Deck"}),s.jsx("button",{onClick:()=>nr(),disabled:Se.size===0,className:"bulk-action-button sideboard",children:"‚Üí Sideboard"}),s.jsx("button",{onClick:()=>or(),disabled:Se.size===0,className:"bulk-action-button tech-ideas",children:"‚Üí Tech Ideas"}),s.jsx("button",{onClick:()=>er(),disabled:Se.size===0,className:"bulk-action-button remove",children:"Remove from Deck"}),s.jsx("button",{onClick:()=>sr(),disabled:Se.size===0,className:"bulk-action-button foil",children:"Toggle Foil"}),s.jsx("button",{onClick:()=>rr(),className:"bulk-action-button utility",title:"Remove duplicate card entries and consolidate quantities",children:"üîß Fix Duplicates"})]})]}),s.jsx("div",{style:{background:"white",boxShadow:"0 2px 8px rgba(0,0,0,0.02)",borderRadius:8,marginBottom:8},children:s.jsx(Ir,{groupBy:Fe,setGroupBy:dn,sortBy:xt,setSortBy:nn,hidePrices:Ht,setHidePrices:ut,showMana:jt,setShowMana:qt,viewMode:Ot,setViewMode:on})})]}),s.jsxs("div",{className:"deck-main-content",children:[s.jsx("div",{className:"mobile-view-controls",style:{display:"none",marginBottom:"1rem",padding:"12px",backgroundColor:"white",borderRadius:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.04)"},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",flexWrap:"wrap"},children:[s.jsx("span",{style:{fontSize:"14px",fontWeight:"500",color:"#666"},children:"View:"}),s.jsxs("div",{style:{display:"flex",gap:"4px"},children:[s.jsx("button",{onClick:()=>on("list"),style:{padding:"6px 12px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:Ot==="list"?"#1976d2":"white",color:Ot==="list"?"white":"#333",fontSize:"12px",cursor:"pointer",transition:"all 0.2s ease"},children:"üìã List"}),s.jsx("button",{onClick:()=>on("grid"),style:{padding:"6px 12px",border:"1px solid #ddd",borderRadius:"4px",backgroundColor:Ot==="grid"?"#1976d2":"white",color:Ot==="grid"?"white":"#333",fontSize:"12px",cursor:"pointer",transition:"all 0.2s ease"},children:"üî≥ Grid"})]})]})}),s.jsxs("h3",{style:{margin:"1rem 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #1976d2",paddingBottom:"0.5rem"},children:["Main Deck (",Array.isArray(vt)?vt.reduce((e,t)=>e+(Array.isArray(t.cards)?t.cards.reduce((a,o)=>{const r=o.count||o.quantity||1;return a+r},0):0),0):0," cards)"]}),s.jsxs("div",{className:"card-sections-container",children:[Array.isArray(vt)?vt.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"main deck"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var f,m,I,x,h,j,$,S,N,E,v,W,U,A;const o=D=>{var B,y,G,O,b,te,re,ve;return D.count||D.quantity||((B=D.card)==null?void 0:B.count)||((y=D.card)==null?void 0:y.quantity)||((G=D.cardObj)==null?void 0:G.count)||((O=D.cardObj)==null?void 0:O.quantity)||((te=(b=D.cardObj)==null?void 0:b.card)==null?void 0:te.count)||((ve=(re=D.cardObj)==null?void 0:re.card)==null?void 0:ve.quantity)||1},r=t.cardObj?{...t,count:o(t)}:{name:((f=t.card)==null?void 0:f.name)||t.name,count:o(t),printing:t.printing,cardObj:t};r.foil===!0||t.foil===!0||((m=r.cardObj)==null?void 0:m.foil)===!0||((x=(I=r.cardObj)==null?void 0:I.card)==null?void 0:x.foil)===!0||((h=t.card)==null||h.foil);const l=r.cardObj||t,i=JSON.parse(JSON.stringify(l)),c=r.foil===!0||t.foil===!0||((j=r.cardObj)==null?void 0:j.foil)===!0||((S=($=r.cardObj)==null?void 0:$.card)==null?void 0:S.foil)===!0||((N=t.card)==null?void 0:N.foil)===!0||((v=(E=r.cardObj)==null?void 0:E.cardObj)==null?void 0:v.foil)===!0||((A=(U=(W=r.cardObj)==null?void 0:W.cardObj)==null?void 0:U.card)==null?void 0:A.foil)===!0;if(i.foil=c,i.card&&(i.card.foil=c),i.cardObj&&(i.cardObj.foil=c,i.cardObj.card&&(i.cardObj.card.foil=c)),gt[r.name]){const D=gt[r.name];i.printing=D,i.card&&(i.card.printing=D)}else r.printing&&!i.printing&&(i.printing=r.printing),r.printing&&i.card&&!i.card.printing&&(i.card.printing=r.printing);const u=`${r.name}-${r.printing||"default"}-${c?"foil":"nonfoil"}`;if(!he.current.has(u)){const D={...i,foil:c,card:{...i.card,foil:c}},B=Vt(D);console.log(`[PRICE CACHE] New price for ${r.name}: $${B.price} (${B.isFoil?"foil":"non-foil"}, source: ${B.source})`),he.current.set(u,B)}const{price:C,isFoil:d,source:k}=he.current.get(u);return Ot==="grid"?s.jsx(Oo,{cardData:r,isExplicitlyFoil:c,price:C,deckFlipStates:Ct,setDeckFlipStates:tt,onMouseEnter:()=>{var b,te;const D=gt[r.name];let B=r.printing||((b=r.cardObj)==null?void 0:b.printing);D&&(B=gt[r.name]);const y=`${r.name}-${r.printing||((te=r.cardObj)==null?void 0:te.scryfall_id)||"default"}`,G=Ct.get(y)||!1,O={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:B,showBackFace:G,_flipState:G};st(O)},onClick:()=>{var O,b,te;const D=JSON.parse(JSON.stringify(r.cardObj||{})),B=gt[r.name];let y=r.printing||D.printing;B&&(y=gt[r.name]);const G={...D,name:r.name,foil:c,count:r.count||1,price:C||null,printing:y,_debug_cardData:{printing:r.printing,name:r.name,baseObjPrinting:D.printing,preferredPrinting:y,isBasicLand:!!B,cardObjCard:D.card,cardObjCardPrinting:(O=D.card)==null?void 0:O.printing,cardObjCardScryfallId:(te=(b=D.card)==null?void 0:b.scryfall_json)==null?void 0:te.id}};G.card&&(G.card.foil=c,B&&(G.card.printing=y)),L({isOpen:!0,cardObj:G})},onContextMenu:D=>{var y;D.preventDefault(),D.stopPropagation();const B={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:r.printing||((y=r.cardObj)==null?void 0:y.printing),count:r.count||1,price:C||null};Cn({open:!0,x:D.clientX,y:D.clientY,cardObj:B})},bulkEditMode:bt,isSelected:Se.has(ze(r)),onToggleSelection:()=>Me(r)},`${r.name}-${r.printing||""}-${r.count}-${c?"foil":"nonfoil"}-${C||"na"}-${a}-${Le}`):s.jsx(ro,{cardData:r,isFoil:d,price:C,index:a,deckFlipStates:Ct,setDeckFlipStates:tt,onMouseEnter:()=>at(r,c,Ct),onClick:()=>En(r,c,C,L),showMana:jt,hidePrices:Ht,isExplicitlyFoil:c,bulkEditMode:bt,isSelected:Se.has(ze(r)),onToggleSelection:()=>Me(r),onContextMenu:D=>{var y;D.preventDefault(),D.stopPropagation();const B={...r.cardObj,foil:c,isFoil:c,name:r.name,printing:r.printing||((y=r.cardObj)==null?void 0:y.printing),count:r.count||1,price:C||null};Cn({open:!0,x:D.clientX,y:D.clientY,cardObj:B})},setFixedPreview:St},`${r.name}-${r.printing||""}-${r.count}-${c?"foil":"nonfoil"}-${C||"na"}-${a}-${Le}`)}):null})]},e.type)):null,kt.open&&s.jsx(Ar,{x:kt.x,y:kt.y,cardObj:kt.cardObj,onClose:()=>Cn({open:!1,x:0,y:0,cardObj:null}),onUseForDeckImage:async()=>{var t,a,o,r,l,i,c,_;const e=kt.cardObj;if(!e||!n){P.error("Unable to set deck image");return}try{let u=null;if((o=(a=(t=e.card)==null?void 0:t.scryfall_json)==null?void 0:a.image_uris)!=null&&o.art_crop?u=e.card.scryfall_json.image_uris.art_crop:(l=(r=e.scryfall_json)==null?void 0:r.image_uris)!=null&&l.art_crop?u=e.scryfall_json.image_uris.art_crop:(c=(i=e.card)==null?void 0:i.image_uris)!=null&&c.art_crop?u=e.card.image_uris.art_crop:(_=e.image_uris)!=null&&_.art_crop&&(u=e.image_uris.art_crop),u){const C=localStorage.getItem("token"),d="",k={name:n.name,format:n.format,cards:n.cards,customPreviewImage:u,commander:n.commander,commanderNames:n.commanderNames},f=await fetch(`${d}/api/decks/${n._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${C}`},body:JSON.stringify(k),credentials:"include"});if(f.ok){const m=await f.json();console.log("‚úÖ Server response for deck update:",m),le(m),P.success(`Set "${e.name}" as deck image!`),localStorage.setItem("deck-updated-timestamp",Date.now().toString()),window.dispatchEvent(new CustomEvent("deck-updated",{detail:{deckId:n._id,action:"custom-image-set"}}))}else{const m=await f.text();console.error("‚ùå Failed to update deck:",f.status,m),P.error("Failed to update deck image")}}else P.error("No suitable image found for this card")}catch(u){console.error("Error setting deck image:",u),P.error("Failed to set deck image")}},onAddToWishlist:async()=>{const e=kt.cardObj;if(!e){P.error("Unable to add card to wishlist");return}await $o(e)},onAddToCollection:async()=>{const e=kt.cardObj;if(!e){P.error("Unable to add card to collection");return}await So(e)},onCopyScryfallLink:async()=>{var a,o,r,l,i;const e=kt.cardObj;let t=null;if((o=(a=e==null?void 0:e.card)==null?void 0:a.scryfall_json)!=null&&o.scryfall_uri?t=e.card.scryfall_json.scryfall_uri:(r=e==null?void 0:e.scryfall_json)!=null&&r.scryfall_uri?t=e.scryfall_json.scryfall_uri:(l=e==null?void 0:e.card)!=null&&l.scryfall_uri?t=e.card.scryfall_uri:e!=null&&e.scryfall_uri?t=e.scryfall_uri:(i=e==null?void 0:e.card)!=null&&i.name?t=`https://scryfall.com/search?q=${encodeURIComponent(e.card.name)}`:e!=null&&e.name&&(t=`https://scryfall.com/search?q=${encodeURIComponent(e.name)}`),t)try{await navigator.clipboard.writeText(t),P.success("Scryfall link copied to clipboard!")}catch{P.error("Failed to copy Scryfall link.")}else P.error("Could not determine Scryfall link for this card.")},onRemoveFromDeck:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card");return}Kn(e)},onAddToSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to sideboard");return}Jn(e)},onAddToTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to tech ideas");return}Yn(e)},onMoveToMainDeck:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to main deck");return}e.section==="sideboard"?co(e,e.sideboardIndex):e.section==="techIdeas"&&uo(e,e.techIdeasIndex)},onMoveFromSideboardToTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to tech ideas");return}fo(e,e.sideboardIndex)},onMoveFromTechIdeasToSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to move card to sideboard");return}mo(e,e.techIdeasIndex)},onRemoveFromSideboard:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card from sideboard");return}Xn(e.sideboardIndex)},onRemoveFromTechIdeas:()=>{const e=kt.cardObj;if(!e){P.error("Unable to remove card from tech ideas");return}Qn(e.techIdeasIndex)}})]}),n.sideboard&&n.sideboard.length>0&&s.jsxs(s.Fragment,{children:[s.jsxs("h3",{style:{margin:"2rem 0 1rem 0",fontSize:"1.5rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #0ea5e9",paddingBottom:"0.5rem"},children:["Sideboard (",n.sideboard.length," cards)"]}),s.jsx("div",{className:"card-sections-container",children:Go.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"sideboard"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var u,C,d,k;const o=t.cardObj?t:{name:((u=t.card)==null?void 0:u.name)||t.name,count:t.count||t.quantity||1,printing:t.printing,cardObj:t},r=o.foil===!0||t.foil===!0||((C=o.cardObj)==null?void 0:C.foil)===!0||((k=(d=o.cardObj)==null?void 0:d.card)==null?void 0:k.foil)===!0,l=JSON.parse(JSON.stringify(o.cardObj||{}));l.foil=r;const{price:i,isFoil:c}=Vt(l);o.name;const _=n.sideboard.findIndex((f,m)=>f.name===o.name&&m>=a);return s.jsx(ro,{cardData:o,isFoil:c,price:i,index:a,bulkEditMode:bt,isSelected:Se.has(ze(o)),onToggleSelection:()=>Me(o),deckFlipStates:Ct,setDeckFlipStates:tt,onContextMenu:f=>{f.preventDefault(),f.stopPropagation();const m={...l,name:o.name,printing:o.printing,foil:r,count:o.count||1,price:i,section:"sideboard",sideboardIndex:_};Cn({open:!0,x:f.clientX,y:f.clientY,cardObj:m})},onMouseEnter:()=>at(o,r,Ct),onClick:()=>At(o,r,i,bt,Xt,L),customButtons:bt?null:s.jsxs("div",{style:{display:"flex",gap:"0.1rem",alignItems:"center"},children:[s.jsx("button",{onClick:f=>{f.stopPropagation(),console.log("[SIDEBOARD MAIN BUTTON] Button clicked for card:",t),console.log("[SIDEBOARD MAIN BUTTON] Sideboard index:",_),co(t,_)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to main deck",children:"Main"}),s.jsx("button",{onClick:f=>{f.stopPropagation(),fo(t,_)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#7c3aed",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to tech ideas",children:"Tech"}),s.jsx("button",{onClick:f=>{f.stopPropagation(),Xn(_)},style:{padding:"0.2rem 0.4rem",fontSize:"0.7rem",backgroundColor:"#ef4444",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Remove from sideboard",children:"‚úï"})]}),showMana:!1,hidePrices:Ht,setFixedPreview:St},`sideboard-row-${o.name}-${o.printing||""}-${a}-${Le}`)}):null})]},`sideboard-${e.type}`))})]}),n.techIdeas&&n.techIdeas.length>0&&s.jsxs(s.Fragment,{children:[s.jsxs("h3",{style:{margin:"2rem 0 1rem 0",fontSize:"1.5rem",fontWeight:"600",color:"#333",borderBottom:"2px solid #7c3aed",paddingBottom:"0.5rem"},children:["Tech Ideas (",n.techIdeas.length," cards)"]}),s.jsx("div",{className:"card-sections-container",children:Vo.map(e=>s.jsxs("div",{className:"card-type-section",children:[s.jsx(go,{type:e.type,count:Array.isArray(e.cards)?e.cards.reduce((t,a)=>{const o=a.count||a.quantity||1;return t+o},0):0,onClick:()=>lo(e.type,e.cards,"tech ideas"),isClickable:bt}),s.jsx("div",{className:"card-type-list",children:Array.isArray(e.cards)?e.cards.map((t,a)=>{var u,C,d,k,f,m;!t.modalPrice&&t.modalPrice!==0&&(t.modalPrice=((u=t.cardObj)==null?void 0:u.modalPrice)||((C=t.card)==null?void 0:C.modalPrice)||t.modalPrice);const o=t.cardObj?t:{name:((d=t.card)==null?void 0:d.name)||t.name,count:t.count||t.quantity||1,printing:t.printing,cardObj:t},r=o.foil===!0||t.foil===!0||((k=o.cardObj)==null?void 0:k.foil)===!0||((m=(f=o.cardObj)==null?void 0:f.card)==null?void 0:m.foil)===!0,l=JSON.parse(JSON.stringify(o.cardObj||{}));l.foil=r;let i,c;if(o.name==="In the Trenches")i="0.31",c=r;else if(t.modalPrice&&t.modalPrice!=="N/A"&&t.modalPrice!==null&&t.modalPrice!==void 0)i=t.modalPrice.toString().replace(/^\$/,""),parseFloat(i)>100&&(console.warn(`[TECH DISPLAY] üö® SUSPICIOUS HIGH PRICE for ${o.name}: $${i} from modalPrice: ${t.modalPrice}`),console.warn("[TECH DISPLAY] üö® Card object:",t)),c=r;else{const I=Vt(l);i=I.price,parseFloat(i)>100&&(console.warn(`[TECH DISPLAY] üö® SUSPICIOUS HIGH PRICE from extractPrice for ${o.name}: $${i} (source: ${I.source})`),console.warn("[TECH DISPLAY] üö® Card object:",l)),c=I.isFoil}const _=n.techIdeas.findIndex((I,x)=>I.name===o.name&&x>=a);return s.jsx(ro,{cardData:o,isFoil:c,price:i,index:a,bulkEditMode:bt,isSelected:Se.has(ze(o)),onToggleSelection:()=>Me(o),deckFlipStates:Ct,setDeckFlipStates:tt,onContextMenu:I=>{I.preventDefault(),I.stopPropagation();const x={...l,name:o.name,printing:o.printing,foil:r,count:o.count||1,price:i,section:"techIdeas",techIdeasIndex:_};Cn({open:!0,x:I.clientX,y:I.clientY,cardObj:x})},onMouseEnter:()=>at(o,r,Ct),onClick:()=>At(o,r,i,bt,Xt,L),customButtons:bt?null:s.jsxs("div",{style:{display:"flex",gap:"0.1rem",alignItems:"center"},children:[s.jsx("button",{onClick:I=>{I.stopPropagation(),console.log("[TECH IDEAS MAIN BUTTON] Button clicked for card:",t),console.log("[TECH IDEAS MAIN BUTTON] Tech ideas index:",_),uo(t,_)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to main deck",children:"Main"}),s.jsx("button",{onClick:I=>{I.stopPropagation(),mo(t,_)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#0ea5e9",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Move to sideboard",children:"Side"}),s.jsx("button",{onClick:I=>{I.stopPropagation(),Qn(_)},style:{padding:"0.2rem 0.3rem",fontSize:"0.65rem",backgroundColor:"#ef4444",color:"white",border:"none",borderRadius:"3px",cursor:"pointer"},title:"Remove from tech ideas",children:"‚úï"})]}),showMana:!1,hidePrices:Ht,setFixedPreview:St},`tech-ideas-row-${o.name}-${o.printing||""}-${a}-${Le}`)}):null})]},`tech-ideas-${e.type}`))})]}),Nt&&s.jsx("div",{"data-search-modal":"true",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1e4,display:"flex",justifyContent:"center",alignItems:"center",padding:"20px"},onClick:e=>{e.target===e.currentTarget&&Bt()},onKeyDown:e=>{e.key==="Escape"&&Bt()},tabIndex:-1,children:s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"8px",width:"90%",maxWidth:"1200px",height:"80%",maxHeight:"800px",display:"flex",flexDirection:"column",boxShadow:"0 10px 25px rgba(0, 0, 0, 0.2)"},onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{style:{padding:"20px",borderBottom:"1px solid #eee",position:"relative"},children:[s.jsx("button",{onClick:Bt,className:"close-button",style:{position:"absolute",top:"10px",right:"10px",width:"30px",height:"30px",borderRadius:"50%",border:"none",backgroundColor:"#f5f5f5",color:"#666",fontSize:"18px",fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease",zIndex:10},onMouseEnter:e=>{e.target.style.backgroundColor="#e0e0e0",e.target.style.color="#333"},onMouseLeave:e=>{e.target.style.backgroundColor="#f5f5f5",e.target.style.color="#666"},children:"√ó"}),s.jsx("input",{type:"text",placeholder:"Search for cards (Scryfall syntax supported)...",value:Lt,"data-deck-view-search":"true",onChange:e=>{dt(e.target.value),Wo(e.target.value)},onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),wo(Lt))},style:{width:"50%",padding:"8px 16px",border:"1px solid #ccc",borderRadius:"6px",fontSize:"16px",backgroundColor:"#ffffff",color:"#333",outline:"none",transition:"border-color 0.15s",marginRight:"50px"},onFocus:e=>{e.target.style.borderColor="#1976d2",e.target.style.boxShadow="0 0 0 2px rgba(25, 118, 210, 0.1)"},onBlur:e=>{e.target.style.borderColor="#ccc",e.target.style.boxShadow="none"},autoFocus:!0})]}),s.jsx("div",{style:{flex:1,padding:"20px",overflowY:"auto"},children:Tt?s.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"200px",fontSize:"16px",color:"#666"},children:"Loading search results..."}):ct.length>0?s.jsxs(s.Fragment,{children:[Math.random()<.1&&console.log("üé≠ Modal rendering with",ct.length,"results"),s.jsxs("div",{style:{marginBottom:"16px",fontSize:"14px",color:"#666"},children:["Found ",ct.length," result",ct.length!==1?"s":""]}),s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(220px, 220px))",gap:"16px",justifyContent:"center"},children:ct.map((e,t)=>s.jsxs("div",{style:{border:"1px solid #ddd",borderRadius:"8px",padding:"12px",backgroundColor:"#fafafa",transition:"all 0.2s ease",display:"flex",flexDirection:"column",alignItems:"center"},onMouseEnter:a=>{a.currentTarget.style.borderColor="#1976d2",a.currentTarget.style.boxShadow="0 2px 8px rgba(25, 118, 210, 0.15)",a.currentTarget.style.backgroundColor="#f8fbff"},onMouseLeave:a=>{a.currentTarget.style.borderColor="#ddd",a.currentTarget.style.boxShadow="none",a.currentTarget.style.backgroundColor="#fafafa"},children:[(()=>{var _,u,C,d,k,f,m,I,x,h,j;const a=e.card_faces&&e.card_faces.length>=2,o=`${e.scryfall_id||e.id}-${t}`,r=Ye.get(o)||!1;let l=null,i=e.name;if(a){const $=r?1:0;l=((u=(_=e.card_faces[$])==null?void 0:_.image_uris)==null?void 0:u.normal)||((d=(C=e.card_faces[$])==null?void 0:C.image_uris)==null?void 0:d.small),i=((k=e.card_faces[$])==null?void 0:k.name)||e.name,l||(l=((f=e.image_uris)==null?void 0:f.normal)||((m=e.image_uris)==null?void 0:m.small))}else if(gt[i]){const $=ln(i);$&&$!==(e.scryfall_id||e.id)?(console.log(`üèûÔ∏è [SEARCH MODAL] Using preferred printing for ${i}: ${$} (was ${e.scryfall_id||e.id})`),l=`https://cards.scryfall.io/normal/front/${$.substring(0,1)}/${$.substring(1,2)}/${$}.jpg`,console.log(`üèûÔ∏è [SEARCH MODAL] Set image URL: ${l}`)):l=((I=e.image_uris)==null?void 0:I.normal)||((x=e.image_uris)==null?void 0:x.small)}else l=((h=e.image_uris)==null?void 0:h.normal)||((j=e.image_uris)==null?void 0:j.small);l=Mo(l);const c=$=>{$.stopPropagation(),mt(S=>{const N=new Map(S);return N.set(o,!r),N})};return s.jsxs(s.Fragment,{children:[l&&s.jsxs("div",{style:{position:"relative",width:"100%",maxWidth:"200px",margin:"0 auto"},children:[s.jsx("div",{style:{width:"100%",maxWidth:"200px",aspectRatio:"5/7",backgroundColor:"#f0f0f0",borderRadius:"6px",marginBottom:"12px",backgroundImage:`url(${l})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",cursor:"zoom-in"},onClick:()=>{var N,E;console.log("üé¥ Opening CardActionsModal for:",i);const $=ct.findIndex(v=>v.name===i||v.scryfall_id===e.scryfall_id||v.id===e.id),S={name:i,printing:e.scryfall_id||e.id,cardObj:{name:i,scryfall_id:e.scryfall_id||e.id,set:e.set,collector_number:e.collector_number,image_uris:e.image_uris,type_line:e.type_line,mana_cost:e.mana_cost,oracle_text:e.oracle_text,power:e.power,toughness:e.toughness,cmc:e.cmc||e.converted_mana_cost,rarity:e.rarity,prices:e.prices,card_faces:e.card_faces},card:{name:i,scryfall_json:e,type_line:e.type_line},scryfall_json:e,foil:!1,count:1,modalPrice:((N=e.prices)==null?void 0:N.usd)||((E=e.prices)==null?void 0:E.usd_foil)||"0.00"};console.log("[ORACLE TAG MODAL] Opening CardActionsModal with data:",S),console.log(`[ORACLE TAG NAVIGATION] Setting up navigation context - current card: ${i} (${$+1}/${ct.length})`),q({isActive:!0,searchResults:[...ct],currentIndex:$>=0?$:0}),Te([]),Je(!1),L({isOpen:!0,cardObj:S})},title:`${i} - Click to view larger`}),Jo(e)&&s.jsx("div",{style:{position:"absolute",top:"8px",left:"8px",background:"rgba(76, 175, 80, 0.95)",color:"white",borderRadius:"12px",padding:"4px 8px",fontSize:"10px",fontWeight:"bold",boxShadow:"0 2px 4px rgba(0,0,0,0.3)",zIndex:10,display:"flex",alignItems:"center",gap:"3px"},title:"This card is already in your deck",children:"‚úì In Deck"}),a&&s.jsx("span",{onClick:c,style:{position:"absolute",top:"8px",right:"8px",background:"rgba(255, 255, 255, 0.9)",borderRadius:"50%",padding:"6px",cursor:"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:"background 0.2s ease"},title:`Flip to ${r?"front":"back"} face`,onMouseEnter:$=>{$.target.style.background="rgba(255, 255, 255, 1)"},onMouseLeave:$=>{$.target.style.background="rgba(255, 255, 255, 0.9)"},children:s.jsx(Fo,{size:10,color:"#1976d2"})})]}),s.jsx("div",{style:{fontSize:"14px",fontWeight:"bold",textAlign:"center",marginBottom:"8px",color:"#333"},children:i})]})})(),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px",width:"100%"},children:[s.jsx("button",{onClick:a=>{a.stopPropagation(),console.log("üéØ Add to Deck button clicked for card:",e),zt(e)},style:{backgroundColor:"#1976d2",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#1565c0"},onMouseLeave:a=>{a.target.style.backgroundColor="#1976d2"},children:"Add to Deck"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),vo(e)},style:{backgroundColor:"#9c27b0",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#7b1fa2"},onMouseLeave:a=>{a.target.style.backgroundColor="#9c27b0"},children:"Add to Tech Ideas"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),ko(e)},style:{backgroundColor:"#2196f3",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#1976d2"},onMouseLeave:a=>{a.target.style.backgroundColor="#2196f3"},children:"Add to Sideboard"}),s.jsx("button",{onClick:a=>{a.stopPropagation(),$o(e)},style:{backgroundColor:"#ff9800",color:"white",border:"none",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s ease",width:"100%"},onMouseEnter:a=>{a.target.style.backgroundColor="#f57c00"},onMouseLeave:a=>{a.target.style.backgroundColor="#ff9800"},children:"Add to Wishlist"})]})]},`${e.scryfall_id||e.id}-${t}`))})]}):s.jsx("div",{style:{textAlign:"center",padding:"40px",color:"#666",fontSize:"16px"},children:"No cards found matching your search criteria."})})]})}),Ce&&s.jsx(br,{isOpen:Ce,onClose:()=>ce(!1),onImport:Eo}),We&&s.jsx(Cr,{isOpen:We,onClose:()=>we(!1),onImport:Eo}),s.jsx("div",{className:"deck-stats-sticky-bar",style:{position:"fixed",bottom:0,left:0,right:0,width:"100%",background:"white",boxShadow:"0 -2px 8px rgba(0,0,0,0.1)",borderTop:"1px solid #e0e0e0",zIndex:1e3},children:s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",maxWidth:"1200px",margin:"0 auto",gap:"24px",flexWrap:"wrap",padding:"8px 24px"},children:[s.jsxs("div",{style:{display:"flex",gap:"24px",alignItems:"center",flex:"0 0 auto"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Total Value:"}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"bold",color:"#2c5530"},children:["$",qo]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"In Collection:"}),s.jsx("span",{style:{fontSize:"12px",fontWeight:"bold",color:"#1976d2"},children:(()=>{const e=JSON.parse(localStorage.getItem("cardCollection")||"[]"),t=new Map;yn(e,l=>{const i=`${l.printing_id}_${l.foil}`;t.set(i,(t.get(i)||0)+l.quantity)});let a=0,o=0;return(F||(n==null?void 0:n.cards)||[]).forEach(l=>{var u,C,d,k,f,m,I,x,h,j,$,S,N,E,v,W;const i=l.count||l.quantity||1;a+=i;const c=l.printing||((u=l.cardObj)==null?void 0:u.printing)||((d=(C=l.cardObj)==null?void 0:C.card)==null?void 0:d.printing)||((k=l.card)==null?void 0:k.printing)||l.scryfall_id||l.id||((f=l.cardObj)==null?void 0:f.scryfall_id)||((m=l.cardObj)==null?void 0:m.id)||((x=(I=l.cardObj)==null?void 0:I.card)==null?void 0:x.scryfall_id)||((j=(h=l.cardObj)==null?void 0:h.card)==null?void 0:j.id),_=l.foil===!0||l.isFoil===!0||(($=l.cardObj)==null?void 0:$.foil)===!0||((S=l.cardObj)==null?void 0:S.isFoil)===!0||((E=(N=l.cardObj)==null?void 0:N.card)==null?void 0:E.foil)===!0||((W=(v=l.cardObj)==null?void 0:v.card)==null?void 0:W.isFoil)===!0;if(c){const U=`${c}_true`,A=`${c}_false`,D=t.get(U)||0,B=t.get(A)||0,y=_?D>0:B>0,G=D+B>0;(y||G)&&(o+=i)}}),`${a>0?Math.round(o/a*100):0}%`})()})]})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flex:"0 0 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Mana:"}),s.jsx("div",{style:{display:"flex",gap:"4px",alignItems:"center"},children:(()=>{const e={W:0,U:0,B:0,R:0,G:0};return(F||(n==null?void 0:n.cards)||[]).forEach(a=>{var i,c,_,u;const o=a.count||a.quantity||1;((((i=a==null?void 0:a.scryfall_json)==null?void 0:i.mana_cost)||((_=(c=a==null?void 0:a.card)==null?void 0:c.scryfall_json)==null?void 0:_.mana_cost)||(a==null?void 0:a.mana_cost)||((u=a==null?void 0:a.card)==null?void 0:u.mana_cost)||"").match(/\{([^}]+)\}/g)||[]).forEach(C=>{const d=C.replace(/[{}]/g,"");d==="W"?e.W+=o:d==="U"?e.U+=o:d==="B"?e.B+=o:d==="R"?e.R+=o:d==="G"?e.G+=o:d.includes("/")&&d.split("/").forEach(f=>{f==="W"?e.W+=o:f==="U"?e.U+=o:f==="B"?e.B+=o:f==="R"?e.R+=o:f==="G"&&(e.G+=o)})})}),[{symbol:"W",count:e.W},{symbol:"U",count:e.U},{symbol:"B",count:e.B},{symbol:"R",count:e.R},{symbol:"G",count:e.G}].filter(a=>a.count>0).map(a=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"2px"},children:[s.jsx("img",{src:`/svgs/${a.symbol.toLowerCase()}.svg`,alt:`{${a.symbol}}`,style:{width:"14px",height:"14px",filter:"drop-shadow(0 1px 2px rgba(0,0,0,0.3))"},title:`${a.symbol} mana`,onError:o=>{o.target.outerHTML=`{${a.symbol}}`},"data-no-qr-scan":"true",loading:"lazy"}),s.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#333"},children:a.count})]},a.symbol))})()})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",flex:"0 0 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Curve:"}),s.jsx("div",{style:{display:"flex",gap:"1px",alignItems:"end"},children:(()=>{const e={};let t=0;return(F||(n==null?void 0:n.cards)||[]).forEach(o=>{var c,_,u,C;const r=o.count||o.quantity||1,l=((c=o==null?void 0:o.scryfall_json)==null?void 0:c.cmc)||((u=(_=o==null?void 0:o.card)==null?void 0:_.scryfall_json)==null?void 0:u.cmc)||(o==null?void 0:o.cmc)||((C=o==null?void 0:o.card)==null?void 0:C.cmc)||0,i=l>=7?"7+":l.toString();e[i]=(e[i]||0)+r,t=Math.max(t,e[i])}),["0","1","2","3","4","5","6","7+"].map(o=>{const r=e[o]||0,l=t>0?Math.max(2,r/t*20):2;return s.jsx("div",{style:{width:"8px",height:`${l}px`,backgroundColor:r>0?"#4caf50":"#e8e8e8",borderRadius:"1px",transition:"height 0.2s ease"},title:`${r} cards with CMC ${o}`},`mini-bar-${o}`)})})()})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",flex:"1 1 auto"},children:[s.jsx("span",{style:{fontSize:"12px",color:"#666"},children:"Types:"}),s.jsx("div",{style:{display:"flex",gap:"8px",alignItems:"center",flexWrap:"wrap"},children:(()=>{const e={},a=(()=>{const l=new Set;return n!=null&&n.commander&&(Array.isArray(n.commander)?n.commander.forEach(i=>{var c;i!=null&&i.name&&l.add(i.name.toLowerCase()),(c=i==null?void 0:i.card)!=null&&c.name&&l.add(i.card.name.toLowerCase())}):typeof n.commander=="object"&&n.commander.name?l.add(n.commander.name.toLowerCase()):typeof n.commander=="string"&&l.add(n.commander.toLowerCase())),n!=null&&n.commanderNames&&Array.isArray(n.commanderNames)&&n.commanderNames.forEach(i=>{i&&typeof i=="string"&&l.add(i.toLowerCase())}),l})();wn(F||[]).forEach(l=>{var d,k,f,m,I,x,h,j,$;const i=l.count||l.quantity||1,c=((d=l==null?void 0:l.card)==null?void 0:d.name)||(l==null?void 0:l.name)||"Unknown",_=a.has(c.toLowerCase())||l.isCommander===!0||((k=l.card)==null?void 0:k.isCommander)===!0,u=((f=l==null?void 0:l.scryfall_json)==null?void 0:f.type_line)||((I=(m=l==null?void 0:l.card)==null?void 0:m.scryfall_json)==null?void 0:I.type_line)||(l==null?void 0:l.type_line)||((x=l==null?void 0:l.card)==null?void 0:x.type_line)||"",C=u.toLowerCase();if(_&&(!u||u.trim()==="")){const N={"jason bright, glowing prophet":"Legendary Creature ‚Äî Human Mutant"}[c.toLowerCase()];if(N){window.commanderTypeLogged||(console.log(`[DEBUG] Commander "${c}" using known type: ${N}`),window.commanderTypeLogged=!0),N.toLowerCase().includes("creature")?e.Creature=(e.Creature||0)+i:N.toLowerCase().includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:N.toLowerCase().includes("artifact")?e.Artifact=(e.Artifact||0)+i:e.Other=(e.Other||0)+i;return}Math.random()<.1&&console.log(`[DEBUG] Commander "${c}" missing type info, defaulting to Creature`),e.Creature=(e.Creature||0)+i;return}if(!u||u.trim()===""){const S=((h=l==null?void 0:l.scryfall_json)==null?void 0:h.type_line)||(($=(j=l==null?void 0:l.card)==null?void 0:j.scryfall_json)==null?void 0:$.type_line)||"";if(S){const N=S.toLowerCase();N.includes("creature")?e.Creature=(e.Creature||0)+i:N.includes("instant")?e.Instant=(e.Instant||0)+i:N.includes("sorcery")?e.Sorcery=(e.Sorcery||0)+i:N.includes("enchantment")?e.Enchantment=(e.Enchantment||0)+i:N.includes("artifact")?e.Artifact=(e.Artifact||0)+i:N.includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:N.includes("land")?e.Land=(e.Land||0)+i:N.includes("battle")?e.Battle=(e.Battle||0)+i:(console.log(`[DEBUG] Card with empty type_line counted as Other: "${c}" (Scryfall: "${S}")`),e.Other=(e.Other||0)+i)}else e.Other=(e.Other||0)+i}else C.includes("creature")?e.Creature=(e.Creature||0)+i:C.includes("instant")?e.Instant=(e.Instant||0)+i:C.includes("sorcery")?e.Sorcery=(e.Sorcery||0)+i:C.includes("enchantment")?e.Enchantment=(e.Enchantment||0)+i:C.includes("artifact")?e.Artifact=(e.Artifact||0)+i:C.includes("planeswalker")?e.Planeswalker=(e.Planeswalker||0)+i:C.includes("land")?e.Land=(e.Land||0)+i:C.includes("battle")?e.Battle=(e.Battle||0)+i:(console.log(`[DEBUG] Card counted as Other: "${c}" with type_line: "${u}"`),e.Other=(e.Other||0)+i)});const r=l=>{const c={Creature:"creature.svg",Instant:"instant.svg",Sorcery:"sorcery.svg",Enchantment:"enchantment.svg",Artifact:"artifact.svg",Planeswalker:"planeswalker.svg",Land:"land.svg",Battle:"artifact.svg",Other:"artifact.svg"}[l]||"artifact.svg";return s.jsx("img",{src:`/svgs/${c}`,alt:l,style:{width:"14px",height:"14px",filter:"brightness(0)",opacity:.8},title:`${l} symbol`})};return Object.entries(e).filter(([l,i])=>i>0).sort(([,l],[,i])=>i-l).map(([l,i])=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"2px"},children:[r(l),s.jsx("span",{style:{fontSize:"10px",fontWeight:"bold",color:"#333"},children:i})]},l))})()})]})]})}),p.isOpen&&p.cardObj&&s.jsx(xr,{isOpen:p.isOpen,onClose:()=>{L({isOpen:!1,cardObj:null}),q({isActive:!1,searchResults:[],currentIndex:-1})},card:p.cardObj,onAddCard:zt,onUpdateCard:Io,onRemoveCard:Kn,onMoveToSideboard:Jn,onMoveToTechIdeas:Yn,onAddToCollection:So,updatingPrinting:ot,onOracleTagSearch:Ho,onNavigateToPrevious:Ko,onNavigateToNext:Xo,onPreviewUpdate:Qo})]})]})})]}):s.jsx("div",{className:"container",children:"Deck not found."})}typeof window<"u"&&(window.clearTechIdeasCache=()=>{if(window.fixedTechIdeasCache){const g=window.fixedTechIdeasCache.size;return window.fixedTechIdeasCache.clear(),console.log(`[CACHE] Cleared ${g} cached tech ideas entries`),g}return 0},window.validateTechIdeasCache=()=>{if(window.fixedTechIdeasCache){const g=[];for(const[T,p]of window.fixedTechIdeasCache.entries())if(p.modalPrice){const L=parseFloat(p.modalPrice.toString().replace(/^\$/,""));(L>100||L<=0)&&g.push({name:T,price:p.modalPrice,priceNum:L})}return console.log(`[CACHE] Found ${g.length} suspicious cached prices:`,g),g}return[]},window.testQuantityUpdate=(g="Island",T=null)=>{var de,pe,fe,Q;console.log(`[QUANTITY TEST] Testing quantity update for "${g}"`);let p=[],L="unknown";if(typeof deck<"u"&&(deck!=null&&deck.cards))p=deck.cards,L="deck variable";else if((de=window.deck)!=null&&de.cards)p=window.deck.cards,L="window.deck";else{const ye=document.querySelector('[data-testid="deck-view-edit"]')||document.querySelector("main");if(ye&&ye._reactInternalFiber)try{const he=ye._reactInternalFiber;console.log("[QUANTITY TEST] Found React component, trying to access state...")}catch{console.log("[QUANTITY TEST] Could not access React state")}}if(console.log(`[QUANTITY TEST] Found ${p.length} cards in deck (source: ${L})`),p.length===0)return console.log("[QUANTITY TEST] No cards found. Available globals:",Object.keys(window).filter(ye=>ye.toLowerCase().includes("deck")||ye.toLowerCase().includes("card"))),null;const z=p.find(ye=>{var $e;return((($e=ye.card)==null?void 0:$e.name)||ye.name)===g});if(!z)return console.log(`[QUANTITY TEST] Card "${g}" not found in deck`),console.log("[QUANTITY TEST] Available card names:",p.slice(0,10).map(ye=>{var he;return((he=ye.card)==null?void 0:he.name)||ye.name})),null;const q=z.count||1,se=T!==null?T:q+1;console.log(`[QUANTITY TEST] Found "${g}" with quantity ${q}, updating to ${se}`),console.log("[QUANTITY TEST] Target card data:",{name:((pe=z.card)==null?void 0:pe.name)||z.name,count:z.count,foil:z.foil||((fe=z.card)==null?void 0:fe.foil),printing:z.printing||((Q=z.card)==null?void 0:Q.printing)});try{if(typeof handleUpdateCard<"u")handleUpdateCard(z,{quantity:se}),console.log(`[QUANTITY TEST] Called handleUpdateCard for "${g}" with quantity ${se}`);else return console.log("[QUANTITY TEST] handleUpdateCard function not accessible"),null;return{cardName:g,oldQuantity:q,newQuantity:se}}catch(ye){return console.error("[QUANTITY TEST] Error calling handleUpdateCard:",ye),null}});export{Lr as default};
